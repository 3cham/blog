<!DOCTYPE html>
<html>
<head>

<meta http-equiv="Content-type" content="text/html; charset=utf-8" /> 
<title>Create or edit a post</title>
<style>
body.private {
    background-color: #f00;
}
</style>

<script type="text/javascript" src="{{ jquery_url }}"></script>
<script type="text/javascript">

// fix for ie resize, from http://noteslog.com/post/how-to-fix-the-resize-event-in-ie/
( function( $ )  {
    $.fn.wresize = function( f )
    {
      version = '1.1';
      wresize = {fired: false, width: 0};
      function resizeOnce()
      {
          if ( $.browser.msie )
          {
              if ( ! wresize.fired )
                  wresize.fired = true;
              else
              {
                  var version = parseInt( $.browser.version, 10 );
                  wresize.fired = false;
                  if ( version < 7 )
                      return false;
                  else if ( version == 7 )
                  {
                      //a vertical resize is fired once, an horizontal resize twice
                      var width = $( window ).width();
                      if ( width != wresize.width )
                      {
                          wresize.width = width;
                          return false;
                      }
                  }
              }
          }
          return true;
      }
      function handleWResize( e )
      {
          if ( resizeOnce() )
              return f.apply(this, [e]);
      }
      this.each( function()
      {
          if ( this == window )
              $( this ).resize( handleWResize );
          else
              $( this ).resize( f );
      } );
      return this;
     };
} ) ( jQuery );

var has_preview = false;

function _wnd_resize() {
  // TODO: figure out a better way to calculate the 32/112 magic constants
  var dy = $(window).height() - 122 + 'px';
  var total_dx = $(window).width() - 36;
  var note_dx = total_dx;
  var preview_dx = 0;
  if (has_preview) {
    note_dx = total_dx / 2;
    preview_dx = total_dx / 2;
  }
  $('textarea#note').width(note_dx + 'px').height(dy);
  $('#preview').width(preview_dx + 'px').height(dy);
  $('#title').width(note_dx);     
  $('#tags').width(note_dx);
}

function preview_html() {
  var txt = $("#note").val();
  $("#preview").html(txt);
}

function preview_all_but_html() {
  function preview_callback(data, status) {
    $("#preview").html(data);
  }

  var note = $("#note").val();
  var format = $("input[@name='format']:checked").val();
  var data = { "format" : format, "note" : note };
  $.post("/app/preview", data, preview_callback, "html");
}

function preview()  {
  var format = $("input[@name='format']:checked").val();
  if (format == "html") {
    preview_html();
  } else {
    preview_all_but_html();
  }

  has_preview = true;
  _wnd_resize();
  return false;
}

function clean_html() {
  var format = $("input[@name='format']:checked").val();
  if (format == "html") {
    function clean_callback(data, status) {
      $("#note").val(data);
      $("input[@name='format']:nth(1)").attr("checked","checked");
    }
    var data = { "note" : $("#note").val() };
    $.post("/app/cleanhtml", data, clean_callback, "html");
  } else {
    alert("Only html can be cleaned up, not " + format)
  }
  return false;
}

function update_private_status() {
    if ($("#checkbox-private").is(":checked")) {
        $("body").addClass("private");
    } else {
        $("body").removeClass("private");
    }
}

$(document).ready(function() {
  $("#title").focus();
  $(window).wresize(_wnd_resize);
  _wnd_resize();
  update_private_status();
});

</script>

</head>

<body class="private">
  <form action="/app/edit" method="post" id="myform">
  <input name="article_id" type="hidden" value="{{ article.key.id }}">
  <input id="title" type="text" maxlength="1024" name="title" style="width:90%" value = "{{ article.title|escape }}"/><br>
  <input id="tags" type="text" maxlength="1024" name="tags" style="width:90%" value = "{{ tags|escape }}"/>
  <table id="input_and_sidebar" cellspacing=0 cellpadding=0>
  <tbody>
    <tr>
      <td id="input">
       <textarea id="note" name="note" wrap="soft" rows="10" cols="80" style="background-color: #F5F5F5; color: #090909;">{{ article.body|escape }}</textarea>
     </td>
     <td id="sidebar" style="background-color: #eeeeee;">
       <div id="preview"></div>
     </td>
    </tr>
  </tbody>
  </table>
  <input type="submit" value="{{ submit_button_text }}"/>

  <select id="privateOrPublic">
    <option value="private">Private</option>
    <option value="public">Public</option>
  </select>

  <select id="format">
    <option value="textile">Textile</option>
    <option value="markdown">Markdown</option>
    <option value="html">Html</option>
    <option value="text">Text</option>
  </select>
  | 
   <input type="checkbox" name="update_published_on" {{ update_published_on_checkbox_checked }}>
   update published on
   &nbsp; | &nbsp;<a onclick="return clean_html();" href="/invalid">clean html</a>
  | <a href="/">cancel</a>. 
  </form>
</body>
</html>
