<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>

<meta http-equiv="Content-type" content="text/html; charset=utf-8"> 
<link  href="{{ prettify_css_url }}" type="text/css" rel="stylesheet">
<title>Create or edit a post</title>

{% include "inline_css.html" %}

<style type="text/css">

#header.private {
  background-color: #F2D0DC;
  font-size: 120%;
  font-weight: bold;
}

#preview, #note {
  border: 1px solid #adadad !important;
}

textarea {
  font-family: Georgia;
  font-size: 14px;
}

</style>

<script type="text/javascript" src="{{ jquery_url }}"></script>
<script src="{{ prettify_js_url }}" type="text/javascript"></script>
<script type="text/javascript">

var previewTimerId = 0;
// true if we started the ajax call to do the preview
var previewInProgress = false;

function onWndResize() {
  // TODO: figure out a better way to calculate the magic numbers
  var dy = $(window).height() - 122 + 'px';
  var dx = $(window).width() - 32;
  $('#note').width(dx/2).height(dy);
  $('#sep').width(8);
  $('#preview').width(dx/2).height(dy);

  $('#title').width(dx/2);     
  $('#tags').width(dx/2);
  $('#sep2').width(8);
  $('#progress').width(dx/2);
}

function noteFormat() { return $("#format").val(); }

function schedulePreview() {
  // reschedule the timer for doing the preview
  clearTimeout(previewTimerId);
  previewTimerId = setTimeout(preview, 2000);
}

function startInProgress() {
  previewInProgress = true;
  $("#progress2").show();
}

function stopInProgress() {
  previewInProgress = false;
  $("#progress2").hide();
}

function previewAllButHtml() {
  function preview_callback(data, status) {
    data = data.replace(/<p>(.*)<\/p>/, "$1");
    $("#preview").html(data);
    stopInProgress();
    prettyPrint();
  }

  var note = $("#note").val();
  var data = { "format" : noteFormat(), "note" : note };
  $.post("/app/preview", data, preview_callback, "html");
  startInProgress();
}

function preview()  {
  if (previewInProgress) { schedulePreview(); return; }
  if (noteFormat() == "html") {
    $("#preview").html($("#note").val());
  } else {
    previewAllButHtml();
  }
  return false;
}

function cleanHtml() {
  function cleanCallback(data, status) {
    $("#note").val(data);
    $("#format").val("textile");
  }
  var data = { "note" : $("#note").val() };
  $.post("/app/cleanhtml", data, cleanCallback, "html");
  return false;
}

function onFormatChanged() {
  if (noteFormat() == "html") { $("#cleanHtml").show(); }
  else                        { $("#cleanHtml").hide(); }
  preview();
}

function updatePrivateStatus() {
  if ($("#privateOrPublic").val() == "private") {
    $("#header").show();
  } else {
    $("#header").hide();
  }
}

$(document).ready(function() {
  $("#title").focus();
  $(window).resize(onWndResize);
  onWndResize();
  updatePrivateStatus();
  onFormatChanged();
  $("#privateOrPublic").change(updatePrivateStatus);
  $("#format").change(onFormatChanged);
  $('#note').keyup(schedulePreview);
  stopInProgress();
});

</script>

</head>

<body>
  <form action="/app/edit" method="post" id="myform">

  <input name="article_id" type="hidden" value="{{ article.key.id }}">

  <table cellspacing=0 cellpadding=0>
  <tr>
    <td id="title2">
      <input id="title" type="text" width=100% maxlength="1024" name="title" value = "{{ article.title|escape }}"/><br>
      <input id="tags" type="text" width=100%  maxlength="1024" name="tags" value = "{{ tags|escape }}"/>
   </td>
   <td id="sep2"></td>
   <td id="progress" valign=bottom>
      <span id="progress2"><img src="/static/gfx/in-progress.gif"></span>
   <td>
  </tr>
  </table>

  <table cellspacing=0 cellpadding=0>
  <tbody>
    <tr>
      <td id="input" >
       <textarea id="note" name="note" wrap="soft">{{ article.body|escape }}</textarea>
     </td>
     <td id="sep"></td>
     <td>
       <div id="preview"></div>
     </td>
    </tr>
  </tbody>
  </table>

  <input type="submit" value="{{ submit_button_text }}"/>

  <select id="privateOrPublic" name="private_or_public">
    <option value="private" {{ type_private }}>Private</option>
    <option value="public" {{ type_public }}>Public</option>
  </select>

  <select id="format" name="format">
    <option value="textile" {{ format_textile_checked }}>Textile</option>
    <option value="markdown" {{ format_markdown_checked }}>Markdown</option>
    <option value="html" {{ format_html_checked }}>Html</option>
    <option value="text" {{ format_text_checked }}>Text</option>
  </select>
  | 
   <input type="checkbox" name="update_published_on" {{ update_published_on_checkbox_checked }}>
   update published on <span id="cleanHtml">| <a onclick="cleanHtml(); return false;" href="#">clean html</a></span>
  | <a href="/">cancel</a> 
  </form>
  <div id="header" class="private" width=100%>
  <center>This post is private!</center>
  </div>
</body>
</html>
