
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type=text/css> 
pre,code {font-size:9pt; font:Consolas,Monaco,"Courier New","DejaVu Sans Mono","Bitstream Vera Sans Mono",monospace;}
.c { background-color: #96EBA6; }
</style>
</head>
<body>
<pre><a href="index.html">Home</a> : csharp\src\impl\StorageImpl.cs</pre>
<table cellpadding="0" cellspacing="0">
<tbody>
  <tr>
  <td style="margin:0px; vertical-align:top">
  <pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span>
<span>8</span>
<span>9</span>
<span>10</span>
<span>11</span>
<span>12</span>
<span>13</span>
<span>14</span>
<span>15</span>
<span>16</span>
<span>17</span>
<span>18</span>
<span>19</span>
<span>20</span>
<span>21</span>
<span>22</span>
<span>23</span>
<span>24</span>
<span>25</span>
<span>26</span>
<span>27</span>
<span>28</span>
<span>29</span>
<span>30</span>
<span>31</span>
<span>32</span>
<span>33</span>
<span>34</span>
<span>35</span>
<span>36</span>
<span>37</span>
<span>38</span>
<span>39</span>
<span>40</span>
<span>41</span>
<span>42</span>
<span>43</span>
<span>44</span>
<span>45</span>
<span>46</span>
<span>47</span>
<span>48</span>
<span>49</span>
<span>50</span>
<span>51</span>
<span>52</span>
<span>53</span>
<span>54</span>
<span>55</span>
<span>56</span>
<span>57</span>
<span>58</span>
<span>59</span>
<span>60</span>
<span>61</span>
<span>62</span>
<span>63</span>
<span>64</span>
<span>65</span>
<span>66</span>
<span>67</span>
<span>68</span>
<span>69</span>
<span>70</span>
<span>71</span>
<span>72</span>
<span>73</span>
<span>74</span>
<span>75</span>
<span>76</span>
<span>77</span>
<span>78</span>
<span>79</span>
<span>80</span>
<span>81</span>
<span>82</span>
<span>83</span>
<span>84</span>
<span>85</span>
<span>86</span>
<span>87</span>
<span>88</span>
<span>89</span>
<span>90</span>
<span>91</span>
<span>92</span>
<span>93</span>
<span>94</span>
<span>95</span>
<span>96</span>
<span>97</span>
<span>98</span>
<span>99</span>
<span>100</span>
<span>101</span>
<span>102</span>
<span>103</span>
<span>104</span>
<span>105</span>
<span>106</span>
<span>107</span>
<span>108</span>
<span>109</span>
<span>110</span>
<span>111</span>
<span>112</span>
<span>113</span>
<span>114</span>
<span>115</span>
<span>116</span>
<span>117</span>
<span>118</span>
<span>119</span>
<span>120</span>
<span>121</span>
<span>122</span>
<span>123</span>
<span>124</span>
<span>125</span>
<span>126</span>
<span>127</span>
<span>128</span>
<span>129</span>
<span>130</span>
<span>131</span>
<span>132</span>
<span>133</span>
<span>134</span>
<span>135</span>
<span>136</span>
<span>137</span>
<span>138</span>
<span>139</span>
<span>140</span>
<span>141</span>
<span>142</span>
<span>143</span>
<span>144</span>
<span>145</span>
<span>146</span>
<span>147</span>
<span>148</span>
<span>149</span>
<span>150</span>
<span>151</span>
<span>152</span>
<span>153</span>
<span>154</span>
<span>155</span>
<span>156</span>
<span>157</span>
<span>158</span>
<span>159</span>
<span>160</span>
<span>161</span>
<span>162</span>
<span>163</span>
<span>164</span>
<span>165</span>
<span>166</span>
<span>167</span>
<span>168</span>
<span>169</span>
<span>170</span>
<span>171</span>
<span>172</span>
<span>173</span>
<span>174</span>
<span>175</span>
<span>176</span>
<span>177</span>
<span>178</span>
<span>179</span>
<span>180</span>
<span>181</span>
<span>182</span>
<span>183</span>
<span>184</span>
<span>185</span>
<span>186</span>
<span>187</span>
<span>188</span>
<span>189</span>
<span>190</span>
<span>191</span>
<span>192</span>
<span>193</span>
<span>194</span>
<span>195</span>
<span>196</span>
<span>197</span>
<span>198</span>
<span>199</span>
<span>200</span>
<span>201</span>
<span>202</span>
<span>203</span>
<span>204</span>
<span>205</span>
<span>206</span>
<span>207</span>
<span>208</span>
<span>209</span>
<span>210</span>
<span>211</span>
<span>212</span>
<span>213</span>
<span>214</span>
<span>215</span>
<span>216</span>
<span>217</span>
<span>218</span>
<span>219</span>
<span>220</span>
<span>221</span>
<span>222</span>
<span>223</span>
<span>224</span>
<span>225</span>
<span>226</span>
<span>227</span>
<span>228</span>
<span>229</span>
<span>230</span>
<span>231</span>
<span>232</span>
<span>233</span>
<span>234</span>
<span>235</span>
<span>236</span>
<span>237</span>
<span>238</span>
<span>239</span>
<span>240</span>
<span>241</span>
<span>242</span>
<span>243</span>
<span>244</span>
<span>245</span>
<span>246</span>
<span>247</span>
<span>248</span>
<span>249</span>
<span>250</span>
<span>251</span>
<span>252</span>
<span>253</span>
<span>254</span>
<span>255</span>
<span>256</span>
<span>257</span>
<span>258</span>
<span>259</span>
<span>260</span>
<span>261</span>
<span>262</span>
<span>263</span>
<span>264</span>
<span>265</span>
<span>266</span>
<span>267</span>
<span>268</span>
<span>269</span>
<span>270</span>
<span>271</span>
<span>272</span>
<span>273</span>
<span>274</span>
<span>275</span>
<span>276</span>
<span>277</span>
<span>278</span>
<span>279</span>
<span>280</span>
<span>281</span>
<span>282</span>
<span>283</span>
<span>284</span>
<span>285</span>
<span>286</span>
<span>287</span>
<span>288</span>
<span>289</span>
<span>290</span>
<span>291</span>
<span>292</span>
<span>293</span>
<span>294</span>
<span>295</span>
<span>296</span>
<span>297</span>
<span>298</span>
<span>299</span>
<span>300</span>
<span>301</span>
<span>302</span>
<span>303</span>
<span>304</span>
<span>305</span>
<span>306</span>
<span>307</span>
<span>308</span>
<span>309</span>
<span>310</span>
<span>311</span>
<span>312</span>
<span>313</span>
<span>314</span>
<span>315</span>
<span>316</span>
<span>317</span>
<span>318</span>
<span>319</span>
<span>320</span>
<span>321</span>
<span>322</span>
<span>323</span>
<span>324</span>
<span>325</span>
<span>326</span>
<span>327</span>
<span>328</span>
<span>329</span>
<span>330</span>
<span>331</span>
<span>332</span>
<span>333</span>
<span>334</span>
<span>335</span>
<span>336</span>
<span>337</span>
<span>338</span>
<span>339</span>
<span>340</span>
<span>341</span>
<span>342</span>
<span>343</span>
<span>344</span>
<span>345</span>
<span>346</span>
<span>347</span>
<span>348</span>
<span>349</span>
<span>350</span>
<span>351</span>
<span>352</span>
<span>353</span>
<span>354</span>
<span>355</span>
<span>356</span>
<span>357</span>
<span>358</span>
<span>359</span>
<span>360</span>
<span>361</span>
<span>362</span>
<span>363</span>
<span>364</span>
<span>365</span>
<span>366</span>
<span>367</span>
<span>368</span>
<span>369</span>
<span>370</span>
<span>371</span>
<span>372</span>
<span>373</span>
<span>374</span>
<span>375</span>
<span>376</span>
<span>377</span>
<span>378</span>
<span>379</span>
<span>380</span>
<span>381</span>
<span>382</span>
<span>383</span>
<span>384</span>
<span>385</span>
<span>386</span>
<span>387</span>
<span>388</span>
<span>389</span>
<span>390</span>
<span>391</span>
<span>392</span>
<span>393</span>
<span>394</span>
<span>395</span>
<span>396</span>
<span>397</span>
<span>398</span>
<span>399</span>
<span>400</span>
<span>401</span>
<span>402</span>
<span>403</span>
<span>404</span>
<span>405</span>
<span>406</span>
<span>407</span>
<span>408</span>
<span>409</span>
<span>410</span>
<span>411</span>
<span>412</span>
<span>413</span>
<span>414</span>
<span>415</span>
<span>416</span>
<span>417</span>
<span>418</span>
<span>419</span>
<span>420</span>
<span>421</span>
<span>422</span>
<span>423</span>
<span>424</span>
<span>425</span>
<span>426</span>
<span>427</span>
<span>428</span>
<span>429</span>
<span>430</span>
<span>431</span>
<span>432</span>
<span>433</span>
<span>434</span>
<span>435</span>
<span>436</span>
<span>437</span>
<span>438</span>
<span>439</span>
<span>440</span>
<span>441</span>
<span>442</span>
<span>443</span>
<span>444</span>
<span>445</span>
<span>446</span>
<span>447</span>
<span>448</span>
<span>449</span>
<span>450</span>
<span>451</span>
<span>452</span>
<span>453</span>
<span>454</span>
<span>455</span>
<span>456</span>
<span>457</span>
<span>458</span>
<span>459</span>
<span>460</span>
<span>461</span>
<span>462</span>
<span>463</span>
<span>464</span>
<span>465</span>
<span>466</span>
<span>467</span>
<span>468</span>
<span>469</span>
<span>470</span>
<span>471</span>
<span>472</span>
<span>473</span>
<span>474</span>
<span>475</span>
<span>476</span>
<span>477</span>
<span>478</span>
<span>479</span>
<span>480</span>
<span>481</span>
<span>482</span>
<span>483</span>
<span>484</span>
<span>485</span>
<span>486</span>
<span>487</span>
<span>488</span>
<span>489</span>
<span>490</span>
<span>491</span>
<span>492</span>
<span>493</span>
<span>494</span>
<span>495</span>
<span>496</span>
<span>497</span>
<span>498</span>
<span>499</span>
<span>500</span>
<span>501</span>
<span>502</span>
<span>503</span>
<span>504</span>
<span>505</span>
<span>506</span>
<span>507</span>
<span>508</span>
<span>509</span>
<span>510</span>
<span>511</span>
<span>512</span>
<span>513</span>
<span>514</span>
<span>515</span>
<span>516</span>
<span>517</span>
<span>518</span>
<span>519</span>
<span>520</span>
<span>521</span>
<span>522</span>
<span>523</span>
<span>524</span>
<span>525</span>
<span>526</span>
<span>527</span>
<span>528</span>
<span>529</span>
<span>530</span>
<span>531</span>
<span>532</span>
<span>533</span>
<span>534</span>
<span>535</span>
<span>536</span>
<span>537</span>
<span>538</span>
<span>539</span>
<span>540</span>
<span>541</span>
<span>542</span>
<span>543</span>
<span>544</span>
<span>545</span>
<span>546</span>
<span>547</span>
<span>548</span>
<span>549</span>
<span>550</span>
<span>551</span>
<span>552</span>
<span>553</span>
<span>554</span>
<span>555</span>
<span>556</span>
<span>557</span>
<span>558</span>
<span>559</span>
<span>560</span>
<span>561</span>
<span>562</span>
<span>563</span>
<span>564</span>
<span>565</span>
<span>566</span>
<span>567</span>
<span>568</span>
<span>569</span>
<span>570</span>
<span>571</span>
<span>572</span>
<span>573</span>
<span>574</span>
<span>575</span>
<span>576</span>
<span>577</span>
<span>578</span>
<span>579</span>
<span>580</span>
<span>581</span>
<span>582</span>
<span>583</span>
<span>584</span>
<span>585</span>
<span>586</span>
<span>587</span>
<span>588</span>
<span>589</span>
<span>590</span>
<span>591</span>
<span>592</span>
<span>593</span>
<span>594</span>
<span>595</span>
<span>596</span>
<span>597</span>
<span>598</span>
<span>599</span>
<span>600</span>
<span>601</span>
<span>602</span>
<span>603</span>
<span>604</span>
<span>605</span>
<span>606</span>
<span>607</span>
<span>608</span>
<span>609</span>
<span>610</span>
<span>611</span>
<span>612</span>
<span>613</span>
<span>614</span>
<span>615</span>
<span>616</span>
<span>617</span>
<span>618</span>
<span>619</span>
<span>620</span>
<span>621</span>
<span>622</span>
<span>623</span>
<span>624</span>
<span>625</span>
<span>626</span>
<span>627</span>
<span>628</span>
<span>629</span>
<span>630</span>
<span>631</span>
<span>632</span>
<span>633</span>
<span>634</span>
<span>635</span>
<span>636</span>
<span>637</span>
<span>638</span>
<span>639</span>
<span>640</span>
<span>641</span>
<span>642</span>
<span>643</span>
<span>644</span>
<span>645</span>
<span>646</span>
<span>647</span>
<span>648</span>
<span>649</span>
<span>650</span>
<span>651</span>
<span>652</span>
<span>653</span>
<span>654</span>
<span>655</span>
<span>656</span>
<span>657</span>
<span>658</span>
<span>659</span>
<span>660</span>
<span>661</span>
<span>662</span>
<span>663</span>
<span>664</span>
<span>665</span>
<span>666</span>
<span>667</span>
<span>668</span>
<span>669</span>
<span>670</span>
<span>671</span>
<span>672</span>
<span>673</span>
<span>674</span>
<span>675</span>
<span>676</span>
<span>677</span>
<span>678</span>
<span>679</span>
<span>680</span>
<span>681</span>
<span>682</span>
<span>683</span>
<span>684</span>
<span>685</span>
<span>686</span>
<span>687</span>
<span>688</span>
<span>689</span>
<span>690</span>
<span>691</span>
<span>692</span>
<span>693</span>
<span>694</span>
<span>695</span>
<span>696</span>
<span>697</span>
<span>698</span>
<span>699</span>
<span>700</span>
<span>701</span>
<span>702</span>
<span>703</span>
<span>704</span>
<span>705</span>
<span>706</span>
<span>707</span>
<span>708</span>
<span>709</span>
<span>710</span>
<span>711</span>
<span>712</span>
<span>713</span>
<span>714</span>
<span>715</span>
<span>716</span>
<span>717</span>
<span>718</span>
<span>719</span>
<span>720</span>
<span>721</span>
<span>722</span>
<span>723</span>
<span>724</span>
<span>725</span>
<span>726</span>
<span>727</span>
<span>728</span>
<span>729</span>
<span>730</span>
<span>731</span>
<span>732</span>
<span>733</span>
<span>734</span>
<span>735</span>
<span>736</span>
<span>737</span>
<span>738</span>
<span>739</span>
<span>740</span>
<span>741</span>
<span>742</span>
<span>743</span>
<span>744</span>
<span>745</span>
<span>746</span>
<span>747</span>
<span>748</span>
<span>749</span>
<span>750</span>
<span>751</span>
<span>752</span>
<span>753</span>
<span>754</span>
<span>755</span>
<span>756</span>
<span>757</span>
<span>758</span>
<span>759</span>
<span>760</span>
<span>761</span>
<span>762</span>
<span>763</span>
<span>764</span>
<span>765</span>
<span>766</span>
<span>767</span>
<span>768</span>
<span>769</span>
<span>770</span>
<span>771</span>
<span>772</span>
<span>773</span>
<span>774</span>
<span>775</span>
<span>776</span>
<span>777</span>
<span>778</span>
<span>779</span>
<span>780</span>
<span>781</span>
<span>782</span>
<span>783</span>
<span>784</span>
<span>785</span>
<span>786</span>
<span>787</span>
<span>788</span>
<span>789</span>
<span>790</span>
<span>791</span>
<span>792</span>
<span>793</span>
<span>794</span>
<span>795</span>
<span>796</span>
<span>797</span>
<span>798</span>
<span>799</span>
<span>800</span>
<span>801</span>
<span>802</span>
<span>803</span>
<span>804</span>
<span>805</span>
<span>806</span>
<span>807</span>
<span>808</span>
<span>809</span>
<span>810</span>
<span>811</span>
<span>812</span>
<span>813</span>
<span>814</span>
<span>815</span>
<span>816</span>
<span>817</span>
<span>818</span>
<span>819</span>
<span>820</span>
<span>821</span>
<span>822</span>
<span>823</span>
<span>824</span>
<span>825</span>
<span>826</span>
<span>827</span>
<span>828</span>
<span>829</span>
<span>830</span>
<span>831</span>
<span>832</span>
<span>833</span>
<span>834</span>
<span>835</span>
<span>836</span>
<span>837</span>
<span>838</span>
<span>839</span>
<span>840</span>
<span>841</span>
<span>842</span>
<span>843</span>
<span>844</span>
<span>845</span>
<span>846</span>
<span>847</span>
<span>848</span>
<span>849</span>
<span>850</span>
<span>851</span>
<span>852</span>
<span>853</span>
<span>854</span>
<span>855</span>
<span>856</span>
<span>857</span>
<span>858</span>
<span>859</span>
<span>860</span>
<span>861</span>
<span>862</span>
<span>863</span>
<span>864</span>
<span>865</span>
<span>866</span>
<span>867</span>
<span>868</span>
<span>869</span>
<span>870</span>
<span>871</span>
<span>872</span>
<span>873</span>
<span>874</span>
<span>875</span>
<span>876</span>
<span>877</span>
<span>878</span>
<span>879</span>
<span>880</span>
<span>881</span>
<span>882</span>
<span>883</span>
<span>884</span>
<span>885</span>
<span>886</span>
<span>887</span>
<span>888</span>
<span>889</span>
<span>890</span>
<span>891</span>
<span>892</span>
<span>893</span>
<span>894</span>
<span>895</span>
<span>896</span>
<span>897</span>
<span>898</span>
<span>899</span>
<span>900</span>
<span>901</span>
<span>902</span>
<span>903</span>
<span>904</span>
<span>905</span>
<span>906</span>
<span>907</span>
<span>908</span>
<span>909</span>
<span>910</span>
<span>911</span>
<span>912</span>
<span>913</span>
<span>914</span>
<span>915</span>
<span>916</span>
<span>917</span>
<span>918</span>
<span>919</span>
<span>920</span>
<span>921</span>
<span>922</span>
<span>923</span>
<span>924</span>
<span>925</span>
<span>926</span>
<span>927</span>
<span>928</span>
<span>929</span>
<span>930</span>
<span>931</span>
<span>932</span>
<span>933</span>
<span>934</span>
<span>935</span>
<span>936</span>
<span>937</span>
<span>938</span>
<span>939</span>
<span>940</span>
<span>941</span>
<span>942</span>
<span>943</span>
<span>944</span>
<span>945</span>
<span>946</span>
<span>947</span>
<span>948</span>
<span>949</span>
<span>950</span>
<span>951</span>
<span>952</span>
<span>953</span>
<span>954</span>
<span>955</span>
<span>956</span>
<span>957</span>
<span>958</span>
<span>959</span>
<span>960</span>
<span>961</span>
<span>962</span>
<span>963</span>
<span>964</span>
<span>965</span>
<span>966</span>
<span>967</span>
<span>968</span>
<span>969</span>
<span>970</span>
<span>971</span>
<span>972</span>
<span>973</span>
<span>974</span>
<span>975</span>
<span>976</span>
<span>977</span>
<span>978</span>
<span>979</span>
<span>980</span>
<span>981</span>
<span>982</span>
<span>983</span>
<span>984</span>
<span>985</span>
<span>986</span>
<span>987</span>
<span>988</span>
<span>989</span>
<span>990</span>
<span>991</span>
<span>992</span>
<span>993</span>
<span>994</span>
<span>995</span>
<span>996</span>
<span>997</span>
<span>998</span>
<span>999</span>
<span>1000</span>
<span>1001</span>
<span>1002</span>
<span>1003</span>
<span>1004</span>
<span>1005</span>
<span>1006</span>
<span>1007</span>
<span>1008</span>
<span>1009</span>
<span>1010</span>
<span>1011</span>
<span>1012</span>
<span>1013</span>
<span>1014</span>
<span>1015</span>
<span>1016</span>
<span>1017</span>
<span>1018</span>
<span>1019</span>
<span>1020</span>
<span>1021</span>
<span>1022</span>
<span>1023</span>
<span>1024</span>
<span>1025</span>
<span>1026</span>
<span>1027</span>
<span>1028</span>
<span>1029</span>
<span>1030</span>
<span>1031</span>
<span>1032</span>
<span>1033</span>
<span>1034</span>
<span>1035</span>
<span>1036</span>
<span>1037</span>
<span>1038</span>
<span>1039</span>
<span>1040</span>
<span>1041</span>
<span>1042</span>
<span>1043</span>
<span>1044</span>
<span>1045</span>
<span>1046</span>
<span>1047</span>
<span>1048</span>
<span>1049</span>
<span>1050</span>
<span>1051</span>
<span>1052</span>
<span>1053</span>
<span>1054</span>
<span>1055</span>
<span>1056</span>
<span>1057</span>
<span>1058</span>
<span>1059</span>
<span>1060</span>
<span>1061</span>
<span>1062</span>
<span>1063</span>
<span>1064</span>
<span>1065</span>
<span>1066</span>
<span>1067</span>
<span>1068</span>
<span>1069</span>
<span>1070</span>
<span>1071</span>
<span>1072</span>
<span>1073</span>
<span>1074</span>
<span>1075</span>
<span>1076</span>
<span>1077</span>
<span>1078</span>
<span>1079</span>
<span>1080</span>
<span>1081</span>
<span>1082</span>
<span>1083</span>
<span>1084</span>
<span>1085</span>
<span>1086</span>
<span>1087</span>
<span>1088</span>
<span>1089</span>
<span>1090</span>
<span>1091</span>
<span>1092</span>
<span>1093</span>
<span>1094</span>
<span>1095</span>
<span>1096</span>
<span>1097</span>
<span>1098</span>
<span>1099</span>
<span>1100</span>
<span>1101</span>
<span>1102</span>
<span>1103</span>
<span>1104</span>
<span>1105</span>
<span>1106</span>
<span>1107</span>
<span>1108</span>
<span>1109</span>
<span>1110</span>
<span>1111</span>
<span>1112</span>
<span>1113</span>
<span>1114</span>
<span>1115</span>
<span>1116</span>
<span>1117</span>
<span>1118</span>
<span>1119</span>
<span>1120</span>
<span>1121</span>
<span>1122</span>
<span>1123</span>
<span>1124</span>
<span>1125</span>
<span>1126</span>
<span>1127</span>
<span>1128</span>
<span>1129</span>
<span>1130</span>
<span>1131</span>
<span>1132</span>
<span>1133</span>
<span>1134</span>
<span>1135</span>
<span>1136</span>
<span>1137</span>
<span>1138</span>
<span>1139</span>
<span>1140</span>
<span>1141</span>
<span>1142</span>
<span>1143</span>
<span>1144</span>
<span>1145</span>
<span>1146</span>
<span>1147</span>
<span>1148</span>
<span>1149</span>
<span>1150</span>
<span>1151</span>
<span>1152</span>
<span>1153</span>
<span>1154</span>
<span>1155</span>
<span>1156</span>
<span>1157</span>
<span>1158</span>
<span>1159</span>
<span>1160</span>
<span>1161</span>
<span>1162</span>
<span>1163</span>
<span>1164</span>
<span>1165</span>
<span>1166</span>
<span>1167</span>
<span>1168</span>
<span>1169</span>
<span>1170</span>
<span>1171</span>
<span>1172</span>
<span>1173</span>
<span>1174</span>
<span>1175</span>
<span>1176</span>
<span>1177</span>
<span>1178</span>
<span>1179</span>
<span>1180</span>
<span>1181</span>
<span>1182</span>
<span>1183</span>
<span>1184</span>
<span>1185</span>
<span>1186</span>
<span>1187</span>
<span>1188</span>
<span>1189</span>
<span>1190</span>
<span>1191</span>
<span>1192</span>
<span>1193</span>
<span>1194</span>
<span>1195</span>
<span>1196</span>
<span>1197</span>
<span>1198</span>
<span>1199</span>
<span>1200</span>
<span>1201</span>
<span>1202</span>
<span>1203</span>
<span>1204</span>
<span>1205</span>
<span>1206</span>
<span>1207</span>
<span>1208</span>
<span>1209</span>
<span>1210</span>
<span>1211</span>
<span>1212</span>
<span>1213</span>
<span>1214</span>
<span>1215</span>
<span>1216</span>
<span>1217</span>
<span>1218</span>
<span>1219</span>
<span>1220</span>
<span>1221</span>
<span>1222</span>
<span>1223</span>
<span>1224</span>
<span>1225</span>
<span>1226</span>
<span>1227</span>
<span>1228</span>
<span>1229</span>
<span>1230</span>
<span>1231</span>
<span>1232</span>
<span>1233</span>
<span>1234</span>
<span>1235</span>
<span>1236</span>
<span>1237</span>
<span>1238</span>
<span>1239</span>
<span>1240</span>
<span>1241</span>
<span>1242</span>
<span>1243</span>
<span>1244</span>
<span>1245</span>
<span>1246</span>
<span>1247</span>
<span>1248</span>
<span>1249</span>
<span>1250</span>
<span>1251</span>
<span>1252</span>
<span>1253</span>
<span>1254</span>
<span>1255</span>
<span>1256</span>
<span>1257</span>
<span>1258</span>
<span>1259</span>
<span>1260</span>
<span>1261</span>
<span>1262</span>
<span>1263</span>
<span>1264</span>
<span>1265</span>
<span>1266</span>
<span>1267</span>
<span>1268</span>
<span>1269</span>
<span>1270</span>
<span>1271</span>
<span>1272</span>
<span>1273</span>
<span>1274</span>
<span>1275</span>
<span>1276</span>
<span>1277</span>
<span>1278</span>
<span>1279</span>
<span>1280</span>
<span>1281</span>
<span>1282</span>
<span>1283</span>
<span>1284</span>
<span>1285</span>
<span>1286</span>
<span>1287</span>
<span>1288</span>
<span>1289</span>
<span>1290</span>
<span>1291</span>
<span>1292</span>
<span>1293</span>
<span>1294</span>
<span>1295</span>
<span>1296</span>
<span>1297</span>
<span>1298</span>
<span>1299</span>
<span>1300</span>
<span>1301</span>
<span>1302</span>
<span>1303</span>
<span>1304</span>
<span>1305</span>
<span>1306</span>
<span>1307</span>
<span>1308</span>
<span>1309</span>
<span>1310</span>
<span>1311</span>
<span>1312</span>
<span>1313</span>
<span>1314</span>
<span>1315</span>
<span>1316</span>
<span>1317</span>
<span>1318</span>
<span>1319</span>
<span>1320</span>
<span>1321</span>
<span>1322</span>
<span>1323</span>
<span>1324</span>
<span>1325</span>
<span>1326</span>
<span>1327</span>
<span>1328</span>
<span>1329</span>
<span>1330</span>
<span>1331</span>
<span>1332</span>
<span>1333</span>
<span>1334</span>
<span>1335</span>
<span>1336</span>
<span>1337</span>
<span>1338</span>
<span>1339</span>
<span>1340</span>
<span>1341</span>
<span>1342</span>
<span>1343</span>
<span>1344</span>
<span>1345</span>
<span>1346</span>
<span>1347</span>
<span>1348</span>
<span>1349</span>
<span>1350</span>
<span>1351</span>
<span>1352</span>
<span>1353</span>
<span>1354</span>
<span>1355</span>
<span>1356</span>
<span>1357</span>
<span>1358</span>
<span>1359</span>
<span>1360</span>
<span>1361</span>
<span>1362</span>
<span>1363</span>
<span>1364</span>
<span>1365</span>
<span>1366</span>
<span>1367</span>
<span>1368</span>
<span>1369</span>
<span>1370</span>
<span>1371</span>
<span>1372</span>
<span>1373</span>
<span>1374</span>
<span>1375</span>
<span>1376</span>
<span>1377</span>
<span>1378</span>
<span>1379</span>
<span>1380</span>
<span>1381</span>
<span>1382</span>
<span>1383</span>
<span>1384</span>
<span>1385</span>
<span>1386</span>
<span>1387</span>
<span>1388</span>
<span>1389</span>
<span>1390</span>
<span>1391</span>
<span>1392</span>
<span>1393</span>
<span>1394</span>
<span>1395</span>
<span>1396</span>
<span>1397</span>
<span>1398</span>
<span>1399</span>
<span>1400</span>
<span>1401</span>
<span>1402</span>
<span>1403</span>
<span>1404</span>
<span>1405</span>
<span>1406</span>
<span>1407</span>
<span>1408</span>
<span>1409</span>
<span>1410</span>
<span>1411</span>
<span>1412</span>
<span>1413</span>
<span>1414</span>
<span>1415</span>
<span>1416</span>
<span>1417</span>
<span>1418</span>
<span>1419</span>
<span>1420</span>
<span>1421</span>
<span>1422</span>
<span>1423</span>
<span>1424</span>
<span>1425</span>
<span>1426</span>
<span>1427</span>
<span>1428</span>
<span>1429</span>
<span>1430</span>
<span>1431</span>
<span>1432</span>
<span>1433</span>
<span>1434</span>
<span>1435</span>
<span>1436</span>
<span>1437</span>
<span>1438</span>
<span>1439</span>
<span>1440</span>
<span>1441</span>
<span>1442</span>
<span>1443</span>
<span>1444</span>
<span>1445</span>
<span>1446</span>
<span>1447</span>
<span>1448</span>
<span>1449</span>
<span>1450</span>
<span>1451</span>
<span>1452</span>
<span>1453</span>
<span>1454</span>
<span>1455</span>
<span>1456</span>
<span>1457</span>
<span>1458</span>
<span>1459</span>
<span>1460</span>
<span>1461</span>
<span>1462</span>
<span>1463</span>
<span>1464</span>
<span>1465</span>
<span>1466</span>
<span>1467</span>
<span>1468</span>
<span>1469</span>
<span>1470</span>
<span>1471</span>
<span>1472</span>
<span>1473</span>
<span>1474</span>
<span>1475</span>
<span>1476</span>
<span>1477</span>
<span>1478</span>
<span>1479</span>
<span>1480</span>
<span>1481</span>
<span>1482</span>
<span>1483</span>
<span>1484</span>
<span>1485</span>
<span>1486</span>
<span>1487</span>
<span>1488</span>
<span>1489</span>
<span>1490</span>
<span>1491</span>
<span>1492</span>
<span>1493</span>
<span>1494</span>
<span>1495</span>
<span>1496</span>
<span>1497</span>
<span>1498</span>
<span>1499</span>
<span>1500</span>
<span>1501</span>
<span>1502</span>
<span>1503</span>
<span>1504</span>
<span>1505</span>
<span>1506</span>
<span>1507</span>
<span>1508</span>
<span>1509</span>
<span>1510</span>
<span>1511</span>
<span>1512</span>
<span>1513</span>
<span>1514</span>
<span>1515</span>
<span>1516</span>
<span>1517</span>
<span>1518</span>
<span>1519</span>
<span>1520</span>
<span>1521</span>
<span>1522</span>
<span>1523</span>
<span>1524</span>
<span>1525</span>
<span>1526</span>
<span>1527</span>
<span>1528</span>
<span>1529</span>
<span>1530</span>
<span>1531</span>
<span>1532</span>
<span>1533</span>
<span>1534</span>
<span>1535</span>
<span>1536</span>
<span>1537</span>
<span>1538</span>
<span>1539</span>
<span>1540</span>
<span>1541</span>
<span>1542</span>
<span>1543</span>
<span>1544</span>
<span>1545</span>
<span>1546</span>
<span>1547</span>
<span>1548</span>
<span>1549</span>
<span>1550</span>
<span>1551</span>
<span>1552</span>
<span>1553</span>
<span>1554</span>
<span>1555</span>
<span>1556</span>
<span>1557</span>
<span>1558</span>
<span>1559</span>
<span>1560</span>
<span>1561</span>
<span>1562</span>
<span>1563</span>
<span>1564</span>
<span>1565</span>
<span>1566</span>
<span>1567</span>
<span>1568</span>
<span>1569</span>
<span>1570</span>
<span>1571</span>
<span>1572</span>
<span>1573</span>
<span>1574</span>
<span>1575</span>
<span>1576</span>
<span>1577</span>
<span>1578</span>
<span>1579</span>
<span>1580</span>
<span>1581</span>
<span>1582</span>
<span>1583</span>
<span>1584</span>
<span>1585</span>
<span>1586</span>
<span>1587</span>
<span>1588</span>
<span>1589</span>
<span>1590</span>
<span>1591</span>
<span>1592</span>
<span>1593</span>
<span>1594</span>
<span>1595</span>
<span>1596</span>
<span>1597</span>
<span>1598</span>
<span>1599</span>
<span>1600</span>
<span>1601</span>
<span>1602</span>
<span>1603</span>
<span>1604</span>
<span>1605</span>
<span>1606</span>
<span>1607</span>
<span>1608</span>
<span>1609</span>
<span>1610</span>
<span>1611</span>
<span>1612</span>
<span>1613</span>
<span>1614</span>
<span>1615</span>
<span>1616</span>
<span>1617</span>
<span>1618</span>
<span>1619</span>
<span>1620</span>
<span>1621</span>
<span>1622</span>
<span>1623</span>
<span>1624</span>
<span>1625</span>
<span>1626</span>
<span>1627</span>
<span>1628</span>
<span>1629</span>
<span>1630</span>
<span>1631</span>
<span>1632</span>
<span>1633</span>
<span>1634</span>
<span>1635</span>
<span>1636</span>
<span>1637</span>
<span>1638</span>
<span>1639</span>
<span>1640</span>
<span>1641</span>
<span>1642</span>
<span>1643</span>
<span>1644</span>
<span>1645</span>
<span>1646</span>
<span>1647</span>
<span>1648</span>
<span>1649</span>
<span>1650</span>
<span>1651</span>
<span>1652</span>
<span>1653</span>
<span>1654</span>
<span>1655</span>
<span>1656</span>
<span>1657</span>
<span>1658</span>
<span>1659</span>
<span>1660</span>
<span>1661</span>
<span>1662</span>
<span>1663</span>
<span>1664</span>
<span>1665</span>
<span>1666</span>
<span>1667</span>
<span>1668</span>
<span>1669</span>
<span>1670</span>
<span>1671</span>
<span>1672</span>
<span>1673</span>
<span>1674</span>
<span>1675</span>
<span>1676</span>
<span>1677</span>
<span>1678</span>
<span>1679</span>
<span>1680</span>
<span>1681</span>
<span>1682</span>
<span>1683</span>
<span>1684</span>
<span>1685</span>
<span>1686</span>
<span>1687</span>
<span>1688</span>
<span>1689</span>
<span>1690</span>
<span>1691</span>
<span>1692</span>
<span>1693</span>
<span>1694</span>
<span>1695</span>
<span>1696</span>
<span>1697</span>
<span>1698</span>
<span>1699</span>
<span>1700</span>
<span>1701</span>
<span>1702</span>
<span>1703</span>
<span>1704</span>
<span>1705</span>
<span>1706</span>
<span>1707</span>
<span>1708</span>
<span>1709</span>
<span>1710</span>
<span>1711</span>
<span>1712</span>
<span>1713</span>
<span>1714</span>
<span>1715</span>
<span>1716</span>
<span>1717</span>
<span>1718</span>
<span>1719</span>
<span>1720</span>
<span>1721</span>
<span>1722</span>
<span>1723</span>
<span>1724</span>
<span>1725</span>
<span>1726</span>
<span>1727</span>
<span>1728</span>
<span>1729</span>
<span>1730</span>
<span>1731</span>
<span>1732</span>
<span>1733</span>
<span>1734</span>
<span>1735</span>
<span>1736</span>
<span>1737</span>
<span>1738</span>
<span>1739</span>
<span>1740</span>
<span>1741</span>
<span>1742</span>
<span>1743</span>
<span>1744</span>
<span>1745</span>
<span>1746</span>
<span>1747</span>
<span>1748</span>
<span>1749</span>
<span>1750</span>
<span>1751</span>
<span>1752</span>
<span>1753</span>
<span>1754</span>
<span>1755</span>
<span>1756</span>
<span>1757</span>
<span>1758</span>
<span>1759</span>
<span>1760</span>
<span>1761</span>
<span>1762</span>
<span>1763</span>
<span>1764</span>
<span>1765</span>
<span>1766</span>
<span>1767</span>
<span>1768</span>
<span>1769</span>
<span>1770</span>
<span>1771</span>
<span>1772</span>
<span>1773</span>
<span>1774</span>
<span>1775</span>
<span>1776</span>
<span>1777</span>
<span>1778</span>
<span>1779</span>
<span>1780</span>
<span>1781</span>
<span>1782</span>
<span>1783</span>
<span>1784</span>
<span>1785</span>
<span>1786</span>
<span>1787</span>
<span>1788</span>
<span>1789</span>
<span>1790</span>
<span>1791</span>
<span>1792</span>
<span>1793</span>
<span>1794</span>
<span>1795</span>
<span>1796</span>
<span>1797</span>
<span>1798</span>
<span>1799</span>
<span>1800</span>
<span>1801</span>
<span>1802</span>
<span>1803</span>
<span>1804</span>
<span>1805</span>
<span>1806</span>
<span>1807</span>
<span>1808</span>
<span>1809</span>
<span>1810</span>
<span>1811</span>
<span>1812</span>
<span>1813</span>
<span>1814</span>
<span>1815</span>
<span>1816</span>
<span>1817</span>
<span>1818</span>
<span>1819</span>
<span>1820</span>
<span>1821</span>
<span>1822</span>
<span>1823</span>
<span>1824</span>
<span>1825</span>
<span>1826</span>
<span>1827</span>
<span>1828</span>
<span>1829</span>
<span>1830</span>
<span>1831</span>
<span>1832</span>
<span>1833</span>
<span>1834</span>
<span>1835</span>
<span>1836</span>
<span>1837</span>
<span>1838</span>
<span>1839</span>
<span>1840</span>
<span>1841</span>
<span>1842</span>
<span>1843</span>
<span>1844</span>
<span>1845</span>
<span>1846</span>
<span>1847</span>
<span>1848</span>
<span>1849</span>
<span>1850</span>
<span>1851</span>
<span>1852</span>
<span>1853</span>
<span>1854</span>
<span>1855</span>
<span>1856</span>
<span>1857</span>
<span>1858</span>
<span>1859</span>
<span>1860</span>
<span>1861</span>
<span>1862</span>
<span>1863</span>
<span>1864</span>
<span>1865</span>
<span>1866</span>
<span>1867</span>
<span>1868</span>
<span>1869</span>
<span>1870</span>
<span>1871</span>
<span>1872</span>
<span>1873</span>
<span>1874</span>
<span>1875</span>
<span>1876</span>
<span>1877</span>
<span>1878</span>
<span>1879</span>
<span>1880</span>
<span>1881</span>
<span>1882</span>
<span>1883</span>
<span>1884</span>
<span>1885</span>
<span>1886</span>
<span>1887</span>
<span>1888</span>
<span>1889</span>
<span>1890</span>
<span>1891</span>
<span>1892</span>
<span>1893</span>
<span>1894</span>
<span>1895</span>
<span>1896</span>
<span>1897</span>
<span>1898</span>
<span>1899</span>
<span>1900</span>
<span>1901</span>
<span>1902</span>
<span>1903</span>
<span>1904</span>
<span>1905</span>
<span>1906</span>
<span>1907</span>
<span>1908</span>
<span>1909</span>
<span>1910</span>
<span>1911</span>
<span>1912</span>
<span>1913</span>
<span>1914</span>
<span>1915</span>
<span>1916</span>
<span>1917</span>
<span>1918</span>
<span>1919</span>
<span>1920</span>
<span>1921</span>
<span>1922</span>
<span>1923</span>
<span>1924</span>
<span>1925</span>
<span>1926</span>
<span>1927</span>
<span>1928</span>
<span>1929</span>
<span>1930</span>
<span>1931</span>
<span>1932</span>
<span>1933</span>
<span>1934</span>
<span>1935</span>
<span>1936</span>
<span>1937</span>
<span>1938</span>
<span>1939</span>
<span>1940</span>
<span>1941</span>
<span>1942</span>
<span>1943</span>
<span>1944</span>
<span>1945</span>
<span>1946</span>
<span>1947</span>
<span>1948</span>
<span>1949</span>
<span>1950</span>
<span>1951</span>
<span>1952</span>
<span>1953</span>
<span>1954</span>
<span>1955</span>
<span>1956</span>
<span>1957</span>
<span>1958</span>
<span>1959</span>
<span>1960</span>
<span>1961</span>
<span>1962</span>
<span>1963</span>
<span>1964</span>
<span>1965</span>
<span>1966</span>
<span>1967</span>
<span>1968</span>
<span>1969</span>
<span>1970</span>
<span>1971</span>
<span>1972</span>
<span>1973</span>
<span>1974</span>
<span>1975</span>
<span>1976</span>
<span>1977</span>
<span>1978</span>
<span>1979</span>
<span>1980</span>
<span>1981</span>
<span>1982</span>
<span>1983</span>
<span>1984</span>
<span>1985</span>
<span>1986</span>
<span>1987</span>
<span>1988</span>
<span>1989</span>
<span>1990</span>
<span>1991</span>
<span>1992</span>
<span>1993</span>
<span>1994</span>
<span>1995</span>
<span>1996</span>
<span>1997</span>
<span>1998</span>
<span>1999</span>
<span>2000</span>
<span>2001</span>
<span>2002</span>
<span>2003</span>
<span>2004</span>
<span>2005</span>
<span>2006</span>
<span>2007</span>
<span>2008</span>
<span>2009</span>
<span>2010</span>
<span>2011</span>
<span>2012</span>
<span>2013</span>
<span>2014</span>
<span>2015</span>
<span>2016</span>
<span>2017</span>
<span>2018</span>
<span>2019</span>
<span>2020</span>
<span>2021</span>
<span>2022</span>
<span>2023</span>
<span>2024</span>
<span>2025</span>
<span>2026</span>
<span>2027</span>
<span>2028</span>
<span>2029</span>
<span>2030</span>
<span>2031</span>
<span>2032</span>
<span>2033</span>
<span>2034</span>
<span>2035</span>
<span>2036</span>
<span>2037</span>
<span>2038</span>
<span>2039</span>
<span>2040</span>
<span>2041</span>
<span>2042</span>
<span>2043</span>
<span>2044</span>
<span>2045</span>
<span>2046</span>
<span>2047</span>
<span>2048</span>
<span>2049</span>
<span>2050</span>
<span>2051</span>
<span>2052</span>
<span>2053</span>
<span>2054</span>
<span>2055</span>
<span>2056</span>
<span>2057</span>
<span>2058</span>
<span>2059</span>
<span>2060</span>
<span>2061</span>
<span>2062</span>
<span>2063</span>
<span>2064</span>
<span>2065</span>
<span>2066</span>
<span>2067</span>
<span>2068</span>
<span>2069</span>
<span>2070</span>
<span>2071</span>
<span>2072</span>
<span>2073</span>
<span>2074</span>
<span>2075</span>
<span>2076</span>
<span>2077</span>
<span>2078</span>
<span>2079</span>
<span>2080</span>
<span>2081</span>
<span>2082</span>
<span>2083</span>
<span>2084</span>
<span>2085</span>
<span>2086</span>
<span>2087</span>
<span>2088</span>
<span>2089</span>
<span>2090</span>
<span>2091</span>
<span>2092</span>
<span>2093</span>
<span>2094</span>
<span>2095</span>
<span>2096</span>
<span>2097</span>
<span>2098</span>
<span>2099</span>
<span>2100</span>
<span>2101</span>
<span>2102</span>
<span>2103</span>
<span>2104</span>
<span>2105</span>
<span>2106</span>
<span>2107</span>
<span>2108</span>
<span>2109</span>
<span>2110</span>
<span>2111</span>
<span>2112</span>
<span>2113</span>
<span>2114</span>
<span>2115</span>
<span>2116</span>
<span>2117</span>
<span>2118</span>
<span>2119</span>
<span>2120</span>
<span>2121</span>
<span>2122</span>
<span>2123</span>
<span>2124</span>
<span>2125</span>
<span>2126</span>
<span>2127</span>
<span>2128</span>
<span>2129</span>
<span>2130</span>
<span>2131</span>
<span>2132</span>
<span>2133</span>
<span>2134</span>
<span>2135</span>
<span>2136</span>
<span>2137</span>
<span>2138</span>
<span>2139</span>
<span>2140</span>
<span>2141</span>
<span>2142</span>
<span>2143</span>
<span>2144</span>
<span>2145</span>
<span>2146</span>
<span>2147</span>
<span>2148</span>
<span>2149</span>
<span>2150</span>
<span>2151</span>
<span>2152</span>
<span>2153</span>
<span>2154</span>
<span>2155</span>
<span>2156</span>
<span>2157</span>
<span>2158</span>
<span>2159</span>
<span>2160</span>
<span>2161</span>
<span>2162</span>
<span>2163</span>
<span>2164</span>
<span>2165</span>
<span>2166</span>
<span>2167</span>
<span>2168</span>
<span>2169</span>
<span>2170</span>
<span>2171</span>
<span>2172</span>
<span>2173</span>
<span>2174</span>
<span>2175</span>
<span>2176</span>
<span>2177</span>
<span>2178</span>
<span>2179</span>
<span>2180</span>
<span>2181</span>
<span>2182</span>
<span>2183</span>
<span>2184</span>
<span>2185</span>
<span>2186</span>
<span>2187</span>
<span>2188</span>
<span>2189</span>
<span>2190</span>
<span>2191</span>
<span>2192</span>
<span>2193</span>
<span>2194</span>
<span>2195</span>
<span>2196</span>
<span>2197</span>
<span>2198</span>
<span>2199</span>
<span>2200</span>
<span>2201</span>
<span>2202</span>
<span>2203</span>
<span>2204</span>
<span>2205</span>
<span>2206</span>
<span>2207</span>
<span>2208</span>
<span>2209</span>
<span>2210</span>
<span>2211</span>
<span>2212</span>
<span>2213</span>
<span>2214</span>
<span>2215</span>
<span>2216</span>
<span>2217</span>
<span>2218</span>
<span>2219</span>
<span>2220</span>
<span>2221</span>
<span>2222</span>
<span>2223</span>
<span>2224</span>
<span>2225</span>
<span>2226</span>
<span>2227</span>
<span>2228</span>
<span>2229</span>
<span>2230</span>
<span>2231</span>
<span>2232</span>
<span>2233</span>
<span>2234</span>
<span>2235</span>
<span>2236</span>
<span>2237</span>
<span>2238</span>
<span>2239</span>
<span>2240</span>
<span>2241</span>
<span>2242</span>
<span>2243</span>
<span>2244</span>
<span>2245</span>
<span>2246</span>
<span>2247</span>
<span>2248</span>
<span>2249</span>
<span>2250</span>
<span>2251</span>
<span>2252</span>
<span>2253</span>
<span>2254</span>
<span>2255</span>
<span>2256</span>
<span>2257</span>
<span>2258</span>
<span>2259</span>
<span>2260</span>
<span>2261</span>
<span>2262</span>
<span>2263</span>
<span>2264</span>
<span>2265</span>
<span>2266</span>
<span>2267</span>
<span>2268</span>
<span>2269</span>
<span>2270</span>
<span>2271</span>
<span>2272</span>
<span>2273</span>
<span>2274</span>
<span>2275</span>
<span>2276</span>
<span>2277</span>
<span>2278</span>
<span>2279</span>
<span>2280</span>
<span>2281</span>
<span>2282</span>
<span>2283</span>
<span>2284</span>
<span>2285</span>
<span>2286</span>
<span>2287</span>
<span>2288</span>
<span>2289</span>
<span>2290</span>
<span>2291</span>
<span>2292</span>
<span>2293</span>
<span>2294</span>
<span>2295</span>
<span>2296</span>
<span>2297</span>
<span>2298</span>
<span>2299</span>
<span>2300</span>
<span>2301</span>
<span>2302</span>
<span>2303</span>
<span>2304</span>
<span>2305</span>
<span>2306</span>
<span>2307</span>
<span>2308</span>
<span>2309</span>
<span>2310</span>
<span>2311</span>
<span>2312</span>
<span>2313</span>
<span>2314</span>
<span>2315</span>
<span>2316</span>
<span>2317</span>
<span>2318</span>
<span>2319</span>
<span>2320</span>
<span>2321</span>
<span>2322</span>
<span>2323</span>
<span>2324</span>
<span>2325</span>
<span>2326</span>
<span>2327</span>
<span>2328</span>
<span>2329</span>
<span>2330</span>
<span>2331</span>
<span>2332</span>
<span>2333</span>
<span>2334</span>
<span>2335</span>
<span>2336</span>
<span>2337</span>
<span>2338</span>
<span>2339</span>
<span>2340</span>
<span>2341</span>
<span>2342</span>
<span>2343</span>
<span>2344</span>
<span>2345</span>
<span>2346</span>
<span>2347</span>
<span>2348</span>
<span>2349</span>
<span>2350</span>
<span>2351</span>
<span>2352</span>
<span>2353</span>
<span>2354</span>
<span>2355</span>
<span>2356</span>
<span>2357</span>
<span>2358</span>
<span>2359</span>
<span>2360</span>
<span>2361</span>
<span>2362</span>
<span>2363</span>
<span>2364</span>
<span>2365</span>
<span>2366</span>
<span>2367</span>
<span>2368</span>
<span>2369</span>
<span>2370</span>
<span>2371</span>
<span>2372</span>
<span>2373</span>
<span>2374</span>
<span>2375</span>
<span>2376</span>
<span>2377</span>
<span>2378</span>
<span>2379</span>
<span>2380</span>
<span>2381</span>
<span>2382</span>
<span>2383</span>
<span>2384</span>
<span>2385</span>
<span>2386</span>
<span>2387</span>
<span>2388</span>
<span>2389</span>
<span>2390</span>
<span>2391</span>
<span>2392</span>
<span>2393</span>
<span>2394</span>
<span>2395</span>
<span>2396</span>
<span>2397</span>
<span>2398</span>
<span>2399</span>
<span>2400</span>
<span>2401</span>
<span>2402</span>
<span>2403</span>
<span>2404</span>
<span>2405</span>
<span>2406</span>
<span>2407</span>
<span>2408</span>
<span>2409</span>
<span>2410</span>
<span>2411</span>
<span>2412</span>
<span>2413</span>
<span>2414</span>
<span>2415</span>
<span>2416</span>
<span>2417</span>
<span>2418</span>
<span>2419</span>
<span>2420</span>
<span>2421</span>
<span>2422</span>
<span>2423</span>
<span>2424</span>
<span>2425</span>
<span>2426</span>
<span>2427</span>
<span>2428</span>
<span>2429</span>
<span>2430</span>
<span>2431</span>
<span>2432</span>
<span>2433</span>
<span>2434</span>
<span>2435</span>
<span>2436</span>
<span>2437</span>
<span>2438</span>
<span>2439</span>
<span>2440</span>
<span>2441</span>
<span>2442</span>
<span>2443</span>
<span>2444</span>
<span>2445</span>
<span>2446</span>
<span>2447</span>
<span>2448</span>
<span>2449</span>
<span>2450</span>
<span>2451</span>
<span>2452</span>
<span>2453</span>
<span>2454</span>
<span>2455</span>
<span>2456</span>
<span>2457</span>
<span>2458</span>
<span>2459</span>
<span>2460</span>
<span>2461</span>
<span>2462</span>
<span>2463</span>
<span>2464</span>
<span>2465</span>
<span>2466</span>
<span>2467</span>
<span>2468</span>
<span>2469</span>
<span>2470</span>
<span>2471</span>
<span>2472</span>
<span>2473</span>
<span>2474</span>
<span>2475</span>
<span>2476</span>
<span>2477</span>
<span>2478</span>
<span>2479</span>
<span>2480</span>
<span>2481</span>
<span>2482</span>
<span>2483</span>
<span>2484</span>
<span>2485</span>
<span>2486</span>
<span>2487</span>
<span>2488</span>
<span>2489</span>
<span>2490</span>
<span>2491</span>
<span>2492</span>
<span>2493</span>
<span>2494</span>
<span>2495</span>
<span>2496</span>
<span>2497</span>
<span>2498</span>
<span>2499</span>
<span>2500</span>
<span>2501</span>
<span>2502</span>
<span>2503</span>
<span>2504</span>
<span>2505</span>
<span>2506</span>
<span>2507</span>
<span>2508</span>
<span>2509</span>
<span>2510</span>
<span>2511</span>
<span>2512</span>
<span>2513</span>
<span>2514</span>
<span>2515</span>
<span>2516</span>
<span>2517</span>
<span>2518</span>
<span>2519</span>
<span>2520</span>
<span>2521</span>
<span>2522</span>
<span>2523</span>
<span>2524</span>
<span>2525</span>
<span>2526</span>
<span>2527</span>
<span>2528</span>
<span>2529</span>
<span>2530</span>
<span>2531</span>
<span>2532</span>
<span>2533</span>
<span>2534</span>
<span>2535</span>
<span>2536</span>
<span>2537</span>
<span>2538</span>
<span>2539</span>
<span>2540</span>
<span>2541</span>
<span>2542</span>
<span>2543</span>
<span>2544</span>
<span>2545</span>
<span>2546</span>
<span>2547</span>
<span>2548</span>
<span>2549</span>
<span>2550</span>
<span>2551</span>
<span>2552</span>
<span>2553</span>
<span>2554</span>
<span>2555</span>
<span>2556</span>
<span>2557</span>
<span>2558</span>
<span>2559</span>
<span>2560</span>
<span>2561</span>
<span>2562</span>
<span>2563</span>
<span>2564</span>
<span>2565</span>
<span>2566</span>
<span>2567</span>
<span>2568</span>
<span>2569</span>
<span>2570</span>
<span>2571</span>
<span>2572</span>
<span>2573</span>
<span>2574</span>
<span>2575</span>
<span>2576</span>
<span>2577</span>
<span>2578</span>
<span>2579</span>
<span>2580</span>
<span>2581</span>
<span>2582</span>
<span>2583</span>
<span>2584</span>
<span>2585</span>
<span>2586</span>
<span>2587</span>
<span>2588</span>
<span>2589</span>
<span>2590</span>
<span>2591</span>
<span>2592</span>
<span>2593</span>
<span>2594</span>
<span>2595</span>
<span>2596</span>
<span>2597</span>
<span>2598</span>
<span>2599</span>
<span>2600</span>
<span>2601</span>
<span>2602</span>
<span>2603</span>
<span>2604</span>
<span>2605</span>
<span>2606</span>
<span>2607</span>
<span>2608</span>
<span>2609</span>
<span>2610</span>
<span>2611</span>
<span>2612</span>
<span>2613</span>
<span>2614</span>
<span>2615</span>
<span>2616</span>
<span>2617</span>
<span>2618</span>
<span>2619</span>
<span>2620</span>
<span>2621</span>
<span>2622</span>
<span>2623</span>
<span>2624</span>
<span>2625</span>
<span>2626</span>
<span>2627</span>
<span>2628</span>
<span>2629</span>
<span>2630</span>
<span>2631</span>
<span>2632</span>
<span>2633</span>
<span>2634</span>
<span>2635</span>
<span>2636</span>
<span>2637</span>
<span>2638</span>
<span>2639</span>
<span>2640</span>
<span>2641</span>
<span>2642</span>
<span>2643</span>
<span>2644</span>
<span>2645</span>
<span>2646</span>
<span>2647</span>
<span>2648</span>
<span>2649</span>
<span>2650</span>
<span>2651</span>
<span>2652</span>
<span>2653</span>
<span>2654</span>
<span>2655</span>
<span>2656</span>
<span>2657</span>
<span>2658</span>
<span>2659</span>
<span>2660</span>
<span>2661</span>
<span>2662</span>
<span>2663</span>
<span>2664</span>
<span>2665</span>
<span>2666</span>
<span>2667</span>
<span>2668</span>
<span>2669</span>
<span>2670</span>
<span>2671</span>
<span>2672</span>
<span>2673</span>
<span>2674</span>
<span>2675</span>
<span>2676</span>
<span>2677</span>
<span>2678</span>
<span>2679</span>
<span>2680</span>
<span>2681</span>
<span>2682</span>
<span>2683</span>
<span>2684</span>
<span>2685</span>
<span>2686</span>
<span>2687</span>
<span>2688</span>
<span>2689</span>
<span>2690</span>
<span>2691</span>
<span>2692</span>
<span>2693</span>
<span>2694</span>
<span>2695</span>
<span>2696</span>
<span>2697</span>
<span>2698</span>
<span>2699</span>
<span>2700</span>
<span>2701</span>
<span>2702</span>
<span>2703</span>
<span>2704</span>
<span>2705</span>
<span>2706</span>
<span>2707</span>
<span>2708</span>
<span>2709</span>
<span>2710</span>
<span>2711</span>
<span>2712</span>
<span>2713</span>
<span>2714</span>
<span>2715</span>
<span>2716</span>
<span>2717</span>
<span>2718</span>
<span>2719</span>
<span>2720</span>
<span>2721</span>
<span>2722</span>
<span>2723</span>
<span>2724</span>
<span>2725</span>
<span>2726</span>
<span>2727</span>
<span>2728</span>
<span>2729</span>
<span>2730</span>
<span>2731</span>
<span>2732</span>
<span>2733</span>
<span>2734</span>
<span>2735</span>
<span>2736</span>
<span>2737</span>
<span>2738</span>
<span>2739</span>
<span>2740</span>
<span>2741</span>
<span>2742</span>
<span>2743</span>
<span>2744</span>
<span>2745</span>
<span>2746</span>
<span>2747</span>
<span>2748</span>
<span>2749</span>
<span>2750</span>
<span>2751</span>
<span>2752</span>
<span>2753</span>
<span>2754</span>
<span>2755</span>
<span>2756</span>
<span>2757</span>
<span>2758</span>
<span>2759</span>
<span>2760</span>
<span>2761</span>
<span>2762</span>
<span>2763</span>
<span>2764</span>
<span>2765</span>
<span>2766</span>
<span>2767</span>
<span>2768</span>
<span>2769</span>
<span>2770</span>
<span>2771</span>
<span>2772</span>
<span>2773</span>
<span>2774</span>
<span>2775</span>
<span>2776</span>
<span>2777</span>
<span>2778</span>
<span>2779</span>
<span>2780</span>
<span>2781</span>
<span>2782</span>
<span>2783</span>
<span>2784</span>
<span>2785</span>
<span>2786</span>
<span>2787</span>
<span>2788</span>
<span>2789</span>
<span>2790</span>
<span>2791</span>
<span>2792</span>
<span>2793</span>
<span>2794</span>
<span>2795</span>
<span>2796</span>
<span>2797</span>
<span>2798</span>
<span>2799</span>
<span>2800</span>
<span>2801</span>
<span>2802</span>
<span>2803</span>
<span>2804</span>
<span>2805</span>
<span>2806</span>
<span>2807</span>
<span>2808</span>
<span>2809</span>
<span>2810</span>
<span>2811</span>
<span>2812</span>
<span>2813</span>
<span>2814</span>
<span>2815</span>
<span>2816</span>
<span>2817</span>
<span>2818</span>
<span>2819</span>
<span>2820</span>
<span>2821</span>
<span>2822</span>
<span>2823</span>
<span>2824</span>
<span>2825</span>
<span>2826</span>
<span>2827</span>
<span>2828</span>
<span>2829</span>
<span>2830</span>
<span>2831</span>
<span>2832</span>
<span>2833</span>
<span>2834</span>
<span>2835</span>
<span>2836</span>
<span>2837</span>
<span>2838</span>
<span>2839</span>
<span>2840</span>
<span>2841</span>
<span>2842</span>
<span>2843</span>
<span>2844</span>
<span>2845</span>
<span>2846</span>
<span>2847</span>
<span>2848</span>
<span>2849</span>
<span>2850</span>
<span>2851</span>
<span>2852</span>
<span>2853</span>
<span>2854</span>
<span>2855</span>
<span>2856</span>
<span>2857</span>
<span>2858</span>
<span>2859</span>
<span>2860</span>
<span>2861</span>
<span>2862</span>
<span>2863</span>
<span>2864</span>
<span>2865</span>
<span>2866</span>
<span>2867</span>
<span>2868</span>
<span>2869</span>
<span>2870</span>
<span>2871</span>
<span>2872</span>
<span>2873</span>
<span>2874</span>
<span>2875</span>
<span>2876</span>
<span>2877</span>
<span>2878</span>
<span>2879</span>
<span>2880</span>
<span>2881</span>
<span>2882</span>
<span>2883</span>
<span>2884</span>
<span>2885</span>
<span>2886</span>
<span>2887</span>
<span>2888</span>
<span>2889</span>
<span>2890</span>
<span>2891</span>
<span>2892</span>
<span>2893</span>
<span>2894</span>
<span>2895</span>
<span>2896</span>
<span>2897</span>
<span>2898</span>
<span>2899</span>
<span>2900</span>
<span>2901</span>
<span>2902</span>
<span>2903</span>
<span>2904</span>
<span>2905</span>
<span>2906</span>
<span>2907</span>
<span>2908</span>
<span>2909</span>
<span>2910</span>
<span>2911</span>
<span>2912</span>
<span>2913</span>
<span>2914</span>
<span>2915</span>
<span>2916</span>
<span>2917</span>
<span>2918</span>
<span>2919</span>
<span>2920</span>
<span>2921</span>
<span>2922</span>
<span>2923</span>
<span>2924</span>
<span>2925</span>
<span>2926</span>
<span>2927</span>
<span>2928</span>
<span>2929</span>
<span>2930</span>
<span>2931</span>
<span>2932</span>
<span>2933</span>
<span>2934</span>
<span>2935</span>
<span>2936</span>
<span>2937</span>
<span>2938</span>
<span>2939</span>
<span>2940</span>
<span>2941</span>
<span>2942</span>
<span>2943</span>
<span>2944</span>
<span>2945</span>
<span>2946</span>
<span>2947</span>
<span>2948</span>
<span>2949</span>
<span>2950</span>
<span>2951</span>
<span>2952</span>
<span>2953</span>
<span>2954</span>
<span>2955</span>
<span>2956</span>
<span>2957</span>
<span>2958</span>
<span>2959</span>
<span>2960</span>
<span>2961</span>
<span>2962</span>
<span>2963</span>
<span>2964</span>
<span>2965</span>
<span>2966</span>
<span>2967</span>
<span>2968</span>
<span>2969</span>
<span>2970</span>
<span>2971</span>
<span>2972</span>
<span>2973</span>
<span>2974</span>
<span>2975</span>
<span>2976</span>
<span>2977</span>
<span>2978</span>
<span>2979</span>
<span>2980</span>
<span>2981</span>
<span>2982</span>
<span>2983</span>
<span>2984</span>
<span>2985</span>
<span>2986</span>
<span>2987</span>
<span>2988</span>
<span>2989</span>
<span>2990</span>
<span>2991</span>
<span>2992</span>
<span>2993</span>
<span>2994</span>
<span>2995</span>
<span>2996</span>
<span>2997</span>
<span>2998</span>
<span>2999</span>
<span>3000</span>
<span>3001</span>
<span>3002</span>
<span>3003</span>
<span>3004</span>
<span>3005</span>
<span>3006</span>
<span>3007</span>
<span>3008</span>
<span>3009</span>
<span>3010</span>
<span>3011</span>
<span>3012</span>
<span>3013</span>
<span>3014</span>
<span>3015</span>
<span>3016</span>
<span>3017</span>
<span>3018</span>
<span>3019</span>
<span>3020</span>
<span>3021</span>
<span>3022</span>
<span>3023</span>
<span>3024</span>
<span>3025</span>
<span>3026</span>
<span>3027</span>
<span>3028</span>
<span>3029</span>
<span>3030</span>
<span>3031</span>
<span>3032</span>
<span>3033</span>
<span>3034</span>
<span>3035</span>
<span>3036</span>
<span>3037</span>
<span>3038</span>
<span>3039</span>
<span>3040</span>
<span>3041</span>
<span>3042</span>
<span>3043</span>
<span>3044</span>
<span>3045</span>
<span>3046</span>
<span>3047</span>
<span>3048</span>
<span>3049</span>
<span>3050</span>
<span>3051</span>
<span>3052</span>
<span>3053</span>
<span>3054</span>
<span>3055</span>
<span>3056</span>
<span>3057</span>
<span>3058</span>
<span>3059</span>
<span>3060</span>
<span>3061</span>
<span>3062</span>
<span>3063</span>
<span>3064</span>
<span>3065</span>
<span>3066</span>
<span>3067</span>
<span>3068</span>
<span>3069</span>
<span>3070</span>
<span>3071</span>
<span>3072</span>
<span>3073</span>
<span>3074</span>
<span>3075</span>
<span>3076</span>
<span>3077</span>
<span>3078</span>
<span>3079</span>
<span>3080</span>
<span>3081</span>
<span>3082</span>
<span>3083</span>
<span>3084</span>
<span>3085</span>
<span>3086</span>
<span>3087</span>
<span>3088</span>
<span>3089</span>
<span>3090</span>
<span>3091</span>
<span>3092</span>
<span>3093</span>
<span>3094</span>
<span>3095</span>
<span>3096</span>
<span>3097</span>
<span>3098</span>
<span>3099</span>
<span>3100</span>
<span>3101</span>
<span>3102</span>
<span>3103</span>
<span>3104</span>
<span>3105</span>
<span>3106</span>
<span>3107</span>
<span>3108</span>
<span>3109</span>
<span>3110</span>
<span>3111</span>
<span>3112</span>
<span>3113</span>
<span>3114</span>
<span>3115</span>
<span>3116</span>
<span>3117</span>
<span>3118</span>
<span>3119</span>
<span>3120</span>
<span>3121</span>
<span>3122</span>
<span>3123</span>
<span>3124</span>
<span>3125</span>
<span>3126</span>
<span>3127</span>
<span>3128</span>
<span>3129</span>
<span>3130</span>
<span>3131</span>
<span>3132</span>
<span>3133</span>
<span>3134</span>
<span>3135</span>
<span>3136</span>
<span>3137</span>
<span>3138</span>
<span>3139</span>
<span>3140</span>
<span>3141</span>
<span>3142</span>
<span>3143</span>
<span>3144</span>
<span>3145</span>
<span>3146</span>
<span>3147</span>
<span>3148</span>
<span>3149</span>
<span>3150</span>
<span>3151</span>
<span>3152</span>
<span>3153</span>
<span>3154</span>
<span>3155</span>
<span>3156</span>
<span>3157</span>
<span>3158</span>
<span>3159</span>
<span>3160</span>
<span>3161</span>
<span>3162</span>
<span>3163</span>
<span>3164</span>
<span>3165</span>
<span>3166</span>
<span>3167</span>
<span>3168</span>
<span>3169</span>
<span>3170</span>
<span>3171</span>
<span>3172</span>
<span>3173</span>
<span>3174</span>
<span>3175</span>
<span>3176</span>
<span>3177</span>
<span>3178</span>
<span>3179</span>
<span>3180</span>
<span>3181</span>
<span>3182</span>
<span>3183</span>
<span>3184</span>
<span>3185</span>
<span>3186</span>
<span>3187</span>
<span>3188</span>
<span>3189</span>
<span>3190</span>
<span>3191</span>
<span>3192</span>
<span>3193</span>
<span>3194</span>
<span>3195</span>
<span>3196</span>
<span>3197</span>
<span>3198</span>
<span>3199</span>
<span>3200</span>
<span>3201</span>
<span>3202</span>
<span>3203</span>
<span>3204</span>
<span>3205</span>
<span>3206</span>
<span>3207</span>
<span>3208</span>
<span>3209</span>
<span>3210</span>
<span>3211</span>
<span>3212</span>
<span>3213</span>
<span>3214</span>
<span>3215</span>
<span>3216</span>
<span>3217</span>
<span>3218</span>
<span>3219</span>
<span>3220</span>
<span>3221</span>
<span>3222</span>
<span>3223</span>
<span>3224</span>
<span>3225</span>
<span>3226</span>
<span>3227</span>
<span>3228</span>
<span>3229</span>
<span>3230</span>
<span>3231</span>
<span>3232</span>
<span>3233</span>
<span>3234</span>
<span>3235</span>
<span>3236</span>
<span>3237</span>
<span>3238</span>
<span>3239</span>
<span>3240</span>
<span>3241</span>
<span>3242</span>
<span>3243</span>
<span>3244</span>
<span>3245</span>
<span>3246</span>
<span>3247</span>
<span>3248</span>
<span>3249</span>
<span>3250</span>
<span>3251</span>
<span>3252</span>
<span>3253</span>
<span>3254</span>
<span>3255</span>
<span>3256</span>
<span>3257</span>
<span>3258</span>
<span>3259</span>
<span>3260</span>
<span>3261</span>
<span>3262</span>
<span>3263</span>
<span>3264</span>
<span>3265</span>
<span>3266</span>
<span>3267</span>
<span>3268</span>
<span>3269</span>
<span>3270</span>
<span>3271</span>
<span>3272</span>
<span>3273</span>
<span>3274</span>
<span>3275</span>
<span>3276</span>
<span>3277</span>
<span>3278</span>
<span>3279</span>
<span>3280</span>
<span>3281</span>
<span>3282</span>
<span>3283</span>
<span>3284</span>
<span>3285</span>
<span>3286</span>
<span>3287</span>
<span>3288</span>
<span>3289</span>
<span>3290</span>
<span>3291</span>
<span>3292</span>
<span>3293</span>
<span>3294</span>
<span>3295</span>
<span>3296</span>
<span>3297</span>
<span>3298</span>
<span>3299</span>
<span>3300</span>
<span>3301</span>
<span>3302</span>
<span>3303</span>
<span>3304</span>
<span>3305</span>
<span>3306</span>
<span>3307</span>
<span>3308</span>
<span>3309</span>
<span>3310</span>
<span>3311</span>
<span>3312</span>
<span>3313</span>
<span>3314</span>
<span>3315</span>
<span>3316</span>
<span>3317</span>
<span>3318</span>
<span>3319</span>
<span>3320</span>
<span>3321</span>
<span>3322</span>
<span>3323</span>
<span>3324</span>
<span>3325</span>
<span>3326</span>
<span>3327</span>
<span>3328</span>
<span>3329</span>
<span>3330</span>
<span>3331</span>
<span>3332</span>
<span>3333</span>
<span>3334</span>
<span>3335</span>
<span>3336</span>
<span>3337</span>
<span>3338</span>
<span>3339</span>
<span>3340</span>
<span>3341</span>
<span>3342</span>
<span>3343</span>
<span>3344</span>
<span>3345</span>
<span>3346</span>
<span>3347</span>
<span>3348</span>
<span>3349</span>
<span>3350</span>
<span>3351</span>
<span>3352</span>
<span>3353</span>
<span>3354</span>
<span>3355</span>
<span>3356</span>
<span>3357</span>
<span>3358</span>
<span>3359</span>
<span>3360</span>
<span>3361</span>
<span>3362</span>
<span>3363</span>
<span>3364</span>
<span>3365</span>
<span>3366</span>
<span>3367</span>
<span>3368</span>
<span>3369</span>
<span>3370</span>
<span>3371</span>
<span>3372</span>
<span>3373</span>
<span>3374</span>
<span>3375</span>
<span>3376</span>
<span>3377</span>
<span>3378</span>
<span>3379</span>
<span>3380</span>
<span>3381</span>
<span>3382</span>
<span>3383</span>
<span>3384</span>
<span>3385</span>
<span>3386</span>
<span>3387</span>
<span>3388</span>
<span>3389</span>
<span>3390</span>
<span>3391</span>
<span>3392</span>
<span>3393</span>
<span>3394</span>
<span>3395</span>
<span>3396</span>
<span>3397</span>
<span>3398</span>
<span>3399</span>
<span>3400</span>
<span>3401</span>
<span>3402</span>
<span>3403</span>
<span>3404</span>
<span>3405</span>
<span>3406</span>
<span>3407</span>
<span>3408</span>
<span>3409</span>
<span>3410</span>
<span>3411</span>
<span>3412</span>
<span>3413</span>
<span>3414</span>
<span>3415</span>
<span>3416</span>
<span>3417</span>
<span>3418</span>
<span>3419</span>
<span>3420</span>
<span>3421</span>
<span>3422</span>
<span>3423</span>
<span>3424</span>
<span>3425</span>
<span>3426</span>
<span>3427</span>
<span>3428</span>
<span>3429</span>
<span>3430</span>
<span>3431</span>
<span>3432</span>
<span>3433</span>
<span>3434</span>
<span>3435</span>
<span>3436</span>
<span>3437</span>
<span>3438</span>
<span>3439</span>
<span>3440</span>
<span>3441</span>
<span>3442</span>
<span>3443</span>
<span>3444</span>
<span>3445</span>
<span>3446</span>
<span>3447</span>
<span>3448</span>
<span>3449</span>
<span>3450</span>
<span>3451</span>
<span>3452</span>
<span>3453</span>
<span>3454</span>
<span>3455</span>
<span>3456</span>
<span>3457</span>
<span>3458</span>
<span>3459</span>
<span>3460</span>
<span>3461</span>
<span>3462</span>
<span>3463</span>
<span>3464</span>
<span>3465</span>
<span>3466</span>
<span>3467</span>
<span>3468</span>
<span>3469</span>
<span>3470</span>
<span>3471</span>
<span>3472</span>
<span>3473</span>
<span>3474</span>
<span>3475</span>
<span>3476</span>
<span>3477</span>
<span>3478</span>
<span>3479</span>
<span>3480</span>
<span>3481</span>
<span>3482</span>
<span>3483</span>
<span>3484</span>
<span>3485</span>
<span>3486</span>
<span>3487</span>
<span>3488</span>
<span>3489</span>
<span>3490</span>
<span>3491</span>
<span>3492</span>
<span>3493</span>
<span>3494</span>
<span>3495</span>
<span>3496</span>
<span>3497</span>
<span>3498</span>
<span>3499</span>
<span>3500</span>
<span>3501</span>
<span>3502</span>
<span>3503</span>
<span>3504</span>
<span>3505</span>
<span>3506</span>
<span>3507</span>
<span>3508</span>
<span>3509</span>
<span>3510</span>
<span>3511</span>
<span>3512</span>
<span>3513</span>
<span>3514</span>
<span>3515</span>
<span>3516</span>
<span>3517</span>
<span>3518</span>
<span>3519</span>
<span>3520</span>
<span>3521</span>
<span>3522</span>
<span>3523</span>
<span>3524</span>
<span>3525</span>
<span>3526</span>
<span>3527</span>
<span>3528</span>
<span>3529</span>
<span>3530</span>
<span>3531</span>
<span>3532</span>
<span>3533</span>
<span>3534</span>
<span>3535</span>
<span>3536</span>
<span>3537</span>
<span>3538</span>
<span>3539</span>
<span>3540</span>
<span>3541</span>
<span>3542</span>
<span>3543</span>
<span>3544</span>
<span>3545</span>
<span>3546</span>
<span>3547</span>
<span>3548</span>
<span>3549</span>
<span>3550</span>
<span>3551</span>
<span>3552</span>
<span>3553</span>
<span>3554</span>
<span>3555</span>
<span>3556</span>
<span>3557</span>
<span>3558</span>
<span>3559</span>
<span>3560</span>
<span>3561</span>
<span>3562</span>
<span>3563</span>
<span>3564</span>
<span>3565</span>
<span>3566</span>
<span>3567</span>
<span>3568</span>
<span>3569</span>
<span>3570</span>
<span>3571</span>
<span>3572</span>
<span>3573</span>
<span>3574</span>
<span>3575</span>
<span>3576</span>
<span>3577</span>
<span>3578</span>
<span>3579</span>
<span>3580</span>
<span>3581</span>
<span>3582</span>
<span>3583</span>
<span>3584</span>
<span>3585</span>
<span>3586</span>
<span>3587</span>
<span>3588</span>
<span>3589</span>
<span>3590</span>
<span>3591</span>
<span>3592</span>
<span>3593</span>
<span>3594</span>
<span>3595</span>
<span>3596</span>
<span>3597</span>
<span>3598</span>
<span>3599</span>
<span>3600</span>
<span>3601</span>
<span>3602</span>
<span>3603</span>
<span>3604</span>
<span>3605</span>
<span>3606</span>
<span>3607</span>
<span>3608</span>
<span>3609</span>
<span>3610</span>
<span>3611</span>
<span>3612</span>
<span>3613</span>
<span>3614</span>
<span>3615</span>
<span>3616</span>
<span>3617</span>
<span>3618</span>
<span>3619</span>
<span>3620</span>
<span>3621</span>
<span>3622</span>
<span>3623</span>
<span>3624</span>
<span>3625</span>
<span>3626</span>
<span>3627</span>
<span>3628</span>
<span>3629</span>
<span>3630</span>
<span>3631</span>
<span>3632</span>
<span>3633</span>
<span>3634</span>
<span>3635</span>
<span>3636</span>
<span>3637</span>
<span>3638</span>
<span>3639</span>
<span>3640</span>
<span>3641</span>
<span>3642</span>
<span>3643</span>
<span>3644</span>
<span>3645</span>
<span>3646</span>
<span>3647</span>
<span>3648</span>
<span>3649</span>
<span>3650</span>
<span>3651</span>
<span>3652</span>
<span>3653</span>
<span>3654</span>
<span>3655</span>
<span>3656</span>
<span>3657</span>
<span>3658</span>
<span>3659</span>
<span>3660</span>
<span>3661</span>
<span>3662</span>
<span>3663</span>
<span>3664</span>
<span>3665</span>
<span>3666</span>
<span>3667</span>
<span>3668</span>
<span>3669</span>
<span>3670</span>
<span>3671</span>
<span>3672</span>
<span>3673</span>
<span>3674</span>
<span>3675</span>
<span>3676</span>
<span>3677</span>
<span>3678</span>
<span>3679</span>
<span>3680</span>
<span>3681</span>
<span>3682</span>
<span>3683</span>
<span>3684</span>
<span>3685</span>
<span>3686</span>
<span>3687</span>
<span>3688</span>
<span>3689</span>
<span>3690</span>
<span>3691</span>
<span>3692</span>
<span>3693</span>
<span>3694</span>
<span>3695</span>
<span>3696</span>
<span>3697</span>
<span>3698</span>
<span>3699</span>
<span>3700</span>
<span>3701</span>
<span>3702</span>
<span>3703</span>
<span>3704</span>
<span>3705</span>
<span>3706</span>
<span>3707</span>
<span>3708</span>
<span>3709</span>
<span>3710</span>
<span>3711</span>
<span>3712</span>
<span>3713</span>
<span>3714</span>
<span>3715</span>
<span>3716</span>
<span>3717</span>
<span>3718</span>
<span>3719</span>
<span>3720</span>
<span>3721</span>
<span>3722</span>
<span>3723</span>
<span>3724</span>
<span>3725</span>
<span>3726</span>
<span>3727</span>
<span>3728</span>
<span>3729</span>
<span>3730</span>
<span>3731</span>
<span>3732</span>
<span>3733</span>
<span>3734</span>
<span>3735</span>
<span>3736</span>
<span>3737</span>
<span>3738</span>
<span>3739</span>
<span>3740</span>
<span>3741</span>
<span>3742</span>
<span>3743</span>
<span>3744</span>
<span>3745</span>
<span>3746</span>
<span>3747</span>
<span>3748</span>
<span>3749</span>
<span>3750</span>
<span>3751</span>
<span>3752</span>
<span>3753</span>
<span>3754</span>
<span>3755</span>
<span>3756</span>
<span>3757</span>
<span>3758</span>
<span>3759</span>
<span>3760</span>
<span>3761</span>
<span>3762</span>
<span>3763</span>
<span>3764</span>
<span>3765</span>
<span>3766</span>
<span>3767</span>
<span>3768</span>
<span>3769</span>
<span>3770</span>
<span>3771</span>
<span>3772</span>
<span>3773</span>
<span>3774</span>
<span>3775</span>
<span>3776</span>
<span>3777</span>
<span>3778</span>
<span>3779</span>
<span>3780</span>
<span>3781</span>
<span>3782</span>
<span>3783</span>
<span>3784</span>
<span>3785</span>
<span>3786</span>
<span>3787</span>
<span>3788</span>
<span>3789</span>
<span>3790</span>
<span>3791</span>
<span>3792</span>
<span>3793</span>
<span>3794</span>
<span>3795</span>
<span>3796</span>
<span>3797</span>
<span>3798</span>
<span>3799</span>
<span>3800</span>
<span>3801</span>
<span>3802</span>
<span>3803</span>
<span>3804</span>
<span>3805</span>
<span>3806</span>
<span>3807</span>
<span>3808</span>
<span>3809</span>
<span>3810</span>
<span>3811</span>
<span>3812</span>
<span>3813</span>
<span>3814</span>
<span>3815</span>
<span>3816</span>
<span>3817</span>
<span>3818</span>
<span>3819</span>
<span>3820</span>
<span>3821</span>
<span>3822</span>
<span>3823</span>
<span>3824</span>
<span>3825</span>
<span>3826</span>
<span>3827</span>
<span>3828</span>
<span>3829</span>
<span>3830</span>
<span>3831</span>
<span>3832</span>
<span>3833</span>
<span>3834</span>
<span>3835</span>
<span>3836</span>
<span>3837</span>
<span>3838</span>
<span>3839</span>
<span>3840</span>
<span>3841</span>
<span>3842</span>
<span>3843</span>
<span>3844</span>
<span>3845</span>
<span>3846</span>
<span>3847</span>
<span>3848</span>
<span>3849</span>
<span>3850</span>
<span>3851</span>
<span>3852</span>
<span>3853</span>
<span>3854</span>
<span>3855</span>
<span>3856</span>
<span>3857</span>
<span>3858</span>
<span>3859</span>
<span>3860</span>
<span>3861</span>
<span>3862</span>
<span>3863</span>
<span>3864</span>
<span>3865</span>
<span>3866</span>
<span>3867</span>
<span>3868</span>
<span>3869</span>
<span>3870</span>
<span>3871</span>
<span>3872</span>
<span>3873</span>
<span>3874</span>
<span>3875</span>
<span>3876</span>
<span>3877</span>
<span>3878</span>
<span>3879</span>
<span>3880</span>
<span>3881</span>
<span>3882</span>
<span>3883</span>
<span>3884</span>
<span>3885</span>
<span>3886</span>
<span>3887</span>
<span>3888</span>
<span>3889</span>
<span>3890</span>
<span>3891</span>
<span>3892</span>
<span>3893</span>
<span>3894</span>
<span>3895</span>
<span>3896</span>
<span>3897</span>
<span>3898</span>
<span>3899</span>
<span>3900</span>
<span>3901</span>
<span>3902</span>
<span>3903</span>
<span>3904</span>
<span>3905</span>
<span>3906</span>
<span>3907</span>
<span>3908</span>
<span>3909</span>
<span>3910</span>
<span>3911</span>
<span>3912</span>
<span>3913</span>
<span>3914</span>
<span>3915</span>
<span>3916</span>
<span>3917</span>
<span>3918</span>
<span>3919</span>
<span>3920</span>
<span>3921</span>
<span>3922</span>
<span>3923</span>
<span>3924</span>
<span>3925</span>
<span>3926</span>
<span>3927</span>
<span>3928</span>
<span>3929</span>
<span>3930</span>
<span>3931</span>
<span>3932</span>
<span>3933</span>
<span>3934</span>
<span>3935</span>
<span>3936</span>
<span>3937</span>
<span>3938</span>
<span>3939</span>
<span>3940</span>
<span>3941</span>
<span>3942</span>
<span>3943</span>
<span>3944</span>
<span>3945</span>
<span>3946</span>
<span>3947</span>
<span>3948</span>
<span>3949</span>
<span>3950</span>
<span>3951</span>
<span>3952</span>
<span>3953</span>
<span>3954</span>
<span>3955</span>
<span>3956</span>
<span>3957</span>
<span>3958</span>
<span>3959</span>
<span>3960</span>
<span>3961</span>
<span>3962</span>
<span>3963</span>
<span>3964</span>
<span>3965</span>
<span>3966</span>
<span>3967</span>
<span>3968</span>
<span>3969</span>
<span>3970</span>
<span>3971</span>
<span>3972</span>
<span>3973</span>
<span>3974</span>
<span>3975</span>
<span>3976</span>
<span>3977</span>
<span>3978</span>
<span>3979</span>
<span>3980</span>
<span>3981</span>
<span>3982</span>
<span>3983</span>
<span>3984</span>
<span>3985</span>
<span>3986</span>
<span>3987</span>
<span>3988</span>
<span>3989</span>
<span>3990</span>
<span>3991</span>
<span>3992</span>
<span>3993</span>
<span>3994</span>
<span>3995</span>
<span>3996</span>
<span>3997</span>
<span>3998</span>
<span>3999</span>
<span>4000</span>
<span>4001</span>
<span>4002</span>
<span>4003</span>
<span>4004</span>
<span>4005</span>
<span>4006</span>
<span>4007</span>
<span>4008</span>
<span>4009</span>
<span>4010</span>
<span>4011</span>
<span>4012</span>
<span>4013</span>
<span>4014</span>
<span>4015</span>
<span>4016</span>
<span>4017</span>
<span>4018</span>
<span>4019</span>
<span>4020</span>
<span>4021</span>
<span>4022</span>
<span>4023</span>
<span>4024</span>
<span>4025</span>
<span>4026</span>
<span>4027</span>
<span>4028</span>
<span>4029</span>
<span>4030</span>
<span>4031</span>
<span>4032</span>
<span>4033</span>
<span>4034</span>
<span>4035</span>
<span>4036</span>
<span>4037</span>
<span>4038</span>
<span>4039</span>
<span>4040</span>
<span>4041</span>
<span>4042</span>
<span>4043</span>
<span>4044</span>
<span>4045</span>
<span>4046</span>
<span>4047</span>
<span>4048</span>
<span>4049</span>
<span>4050</span>
<span>4051</span>
<span>4052</span>
<span>4053</span>
<span>4054</span>
<span>4055</span>
<span>4056</span>
<span>4057</span>
<span>4058</span>
<span>4059</span>
<span>4060</span>
<span>4061</span>
<span>4062</span>
<span>4063</span>
<span>4064</span>
<span>4065</span>
<span>4066</span>
<span>4067</span>
<span>4068</span>
<span>4069</span>
<span>4070</span>
<span>4071</span>
<span>4072</span>
<span>4073</span>
<span>4074</span>
<span>4075</span>
<span>4076</span>
<span>4077</span>
<span>4078</span>
<span>4079</span>
<span>4080</span>
<span>4081</span>
<span>4082</span>
<span>4083</span>
<span>4084</span>
<span>4085</span>
<span>4086</span>
<span>4087</span>
<span>4088</span>
<span>4089</span>
<span>4090</span>
<span>4091</span>
<span>4092</span>
<span>4093</span>
<span>4094</span>
<span>4095</span>
<span>4096</span>
<span>4097</span>
<span>4098</span>
<span>4099</span>
<span>4100</span>
<span>4101</span>
<span>4102</span>
<span>4103</span>
<span>4104</span>
<span>4105</span>
<span>4106</span>
<span>4107</span>
<span>4108</span>
<span>4109</span>
<span>4110</span>
<span>4111</span>
<span>4112</span>
<span>4113</span>
<span>4114</span>
<span>4115</span>
<span>4116</span>
<span>4117</span>
<span>4118</span>
<span>4119</span>
<span>4120</span>
<span>4121</span>
<span>4122</span>
<span>4123</span>
<span>4124</span>
<span>4125</span>
<span>4126</span>
<span>4127</span>
<span>4128</span>
<span>4129</span>
<span>4130</span>
<span>4131</span>
<span>4132</span>
<span>4133</span>
<span>4134</span>
<span>4135</span>
<span>4136</span>
<span>4137</span>
<span>4138</span>
<span>4139</span>
<span>4140</span>
<span>4141</span>
<span>4142</span>
<span>4143</span>
<span>4144</span>
<span>4145</span>
<span>4146</span>
<span>4147</span>
<span>4148</span>
<span>4149</span>
<span>4150</span>
<span>4151</span>
<span>4152</span>
<span>4153</span>
<span>4154</span>
<span>4155</span>
<span>4156</span>
<span>4157</span>
<span>4158</span>
<span>4159</span>
<span>4160</span>
<span>4161</span>
<span>4162</span>
<span>4163</span>
<span>4164</span>
<span>4165</span>
<span>4166</span>
<span>4167</span>
<span>4168</span>
<span>4169</span>
<span>4170</span>
<span>4171</span>
<span>4172</span>
<span>4173</span>
<span>4174</span>
<span>4175</span>
<span>4176</span>
<span>4177</span>
<span>4178</span>
<span>4179</span>
<span>4180</span>
<span>4181</span>
<span>4182</span>
<span>4183</span>
<span>4184</span>
<span>4185</span>
<span>4186</span>
<span>4187</span>
<span>4188</span>
<span>4189</span>
<span>4190</span>
<span>4191</span>
<span>4192</span>
<span>4193</span>
<span>4194</span>
<span>4195</span>
<span>4196</span>
<span>4197</span>
<span>4198</span>
<span>4199</span>
<span>4200</span>
<span>4201</span>
<span>4202</span>
<span>4203</span>
<span>4204</span>
<span>4205</span>
<span>4206</span>
<span>4207</span>
<span>4208</span>
<span>4209</span>
<span>4210</span>
<span>4211</span>
<span>4212</span>
<span>4213</span>
<span>4214</span>
<span>4215</span>
<span>4216</span>
<span>4217</span>
<span>4218</span>
<span>4219</span>
<span>4220</span>
<span>4221</span>
<span>4222</span>
<span>4223</span>
<span>4224</span>
<span>4225</span>
<span>4226</span>
<span>4227</span>
<span>4228</span>
<span>4229</span>
<span>4230</span>
<span>4231</span>
<span>4232</span>
<span>4233</span>
<span>4234</span>
<span>4235</span>
<span>4236</span>
<span>4237</span>
<span>4238</span>
<span>4239</span>
<span>4240</span>
<span>4241</span>
<span>4242</span>
<span>4243</span>
<span>4244</span>
<span>4245</span>
<span>4246</span>
<span>4247</span>
<span>4248</span>
<span>4249</span>
<span>4250</span>
<span>4251</span>
<span>4252</span>
<span>4253</span>
<span>4254</span>
<span>4255</span>
<span>4256</span>
<span>4257</span>
<span>4258</span>
<span>4259</span>
<span>4260</span>
<span>4261</span>
<span>4262</span>
<span>4263</span>
<span>4264</span>
<span>4265</span>
<span>4266</span>
<span>4267</span>
<span>4268</span>
<span>4269</span>
<span>4270</span>
<span>4271</span>
<span>4272</span>
<span>4273</span>
<span>4274</span>
<span>4275</span>
<span>4276</span>
<span>4277</span>
<span>4278</span>
<span>4279</span>
<span>4280</span>
<span>4281</span>
<span>4282</span>
<span>4283</span>
<span>4284</span>
<span>4285</span>
<span>4286</span>
<span>4287</span>
<span>4288</span>
<span>4289</span>
<span>4290</span>
<span>4291</span>
<span>4292</span>
<span>4293</span>
<span>4294</span>
<span>4295</span>
<span>4296</span>
<span>4297</span>
<span>4298</span>
<span>4299</span>
<span>4300</span>
<span>4301</span>
<span>4302</span>
<span>4303</span>
<span>4304</span>
<span>4305</span>
<span>4306</span>
<span>4307</span>
<span>4308</span>
<span>4309</span>
<span>4310</span>
<span>4311</span>
<span>4312</span>
<span>4313</span>
<span>4314</span>
<span>4315</span>
<span>4316</span>
<span>4317</span>
<span>4318</span>
<span>4319</span>
<span>4320</span>
<span>4321</span>
<span>4322</span>
<span>4323</span>
<span>4324</span>
<span>4325</span>
<span>4326</span>
<span>4327</span>
<span>4328</span>
<span>4329</span>
<span>4330</span>
<span>4331</span>
<span>4332</span>
<span>4333</span>
<span>4334</span>
<span>4335</span>
<span>4336</span>
<span>4337</span>
<span>4338</span>
<span>4339</span>
<span>4340</span>
<span>4341</span>
<span>4342</span>
<span>4343</span>
<span>4344</span>
<span>4345</span>
<span>4346</span>
<span>4347</span>
<span>4348</span>
<span>4349</span>
<span>4350</span>
<span>4351</span>
<span>4352</span>
<span>4353</span>
<span>4354</span>
<span>4355</span>
<span>4356</span>
<span>4357</span>
<span>4358</span>
<span>4359</span>
<span>4360</span>
<span>4361</span>
<span>4362</span>
<span>4363</span>
<span>4364</span>
<span>4365</span>
<span>4366</span>
<span>4367</span>
<span>4368</span>
<span>4369</span>
<span>4370</span>
<span>4371</span>
<span>4372</span>
<span>4373</span>
<span>4374</span>
<span>4375</span>
<span>4376</span>
<span>4377</span>
<span>4378</span>
<span>4379</span>
<span>4380</span>
<span>4381</span>
<span>4382</span>
<span>4383</span>
<span>4384</span>
<span>4385</span>
<span>4386</span>
<span>4387</span>
<span>4388</span>
<span>4389</span>
<span>4390</span>
<span>4391</span>
<span>4392</span>
<span>4393</span>
<span>4394</span>
<span>4395</span>
<span>4396</span>
<span>4397</span>
<span>4398</span>
<span>4399</span>
<span>4400</span>
<span>4401</span>
<span>4402</span>
<span>4403</span>
<span>4404</span>
<span>4405</span>
<span>4406</span>
<span>4407</span>
<span>4408</span>
<span>4409</span>
<span>4410</span>
<span>4411</span>
<span>4412</span>
<span>4413</span>
<span>4414</span>
<span>4415</span>
<span>4416</span>
<span>4417</span>
<span>4418</span>
<span>4419</span>
<span>4420</span>
<span>4421</span>
<span>4422</span>
<span>4423</span>
<span>4424</span>
<span>4425</span>
<span>4426</span>
<span>4427</span>
<span>4428</span>
<span>4429</span>
<span>4430</span>
<span>4431</span>
<span>4432</span>
<span>4433</span>
<span>4434</span>
<span>4435</span>
<span>4436</span>
<span>4437</span>
<span>4438</span>
<span>4439</span>
<span>4440</span>
<span>4441</span>
<span>4442</span>
<span>4443</span>
<span>4444</span>
<span>4445</span>
<span>4446</span>
<span>4447</span>
<span>4448</span>
<span>4449</span>
<span>4450</span>
<span>4451</span>
<span>4452</span>
<span>4453</span>
<span>4454</span>
<span>4455</span>
<span>4456</span>
<span>4457</span>
<span>4458</span>
<span>4459</span>
<span>4460</span>
<span>4461</span>
<span>4462</span>
<span>4463</span>
<span>4464</span>
<span>4465</span>
<span>4466</span>
<span>4467</span>
<span>4468</span>
<span>4469</span>
<span>4470</span>
<span>4471</span>
<span>4472</span>
<span>4473</span>
<span>4474</span>
<span>4475</span>
<span>4476</span>
<span>4477</span>
<span>4478</span>
<span>4479</span>
<span>4480</span>
<span>4481</span>
<span>4482</span>
<span>4483</span>
<span>4484</span>
<span>4485</span>
<span>4486</span>
<span>4487</span>
<span>4488</span>
<span>4489</span>
<span>4490</span>
<span>4491</span>
<span>4492</span>
<span>4493</span>
<span>4494</span>
<span>4495</span>
<span>4496</span>
<span>4497</span>
<span>4498</span>
<span>4499</span>
<span>4500</span>
<span>4501</span>
<span>4502</span>
<span>4503</span>
<span>4504</span>
<span>4505</span>
<span>4506</span>
<span>4507</span>
<span>4508</span>
<span>4509</span>
<span>4510</span>
<span>4511</span>
<span>4512</span>
<span>4513</span>
<span>4514</span>
<span>4515</span>
<span>4516</span>
<span>4517</span>
<span>4518</span>
<span>4519</span>
<span>4520</span>
<span>4521</span>
<span>4522</span>
<span>4523</span>
<span>4524</span>
<span>4525</span>
<span>4526</span>
<span>4527</span>
<span>4528</span>
<span>4529</span>
<span>4530</span>
<span>4531</span>
<span>4532</span>
<span>4533</span>
<span>4534</span>
<span>4535</span>
<span>4536</span>
<span>4537</span>
<span>4538</span>
<span>4539</span>
<span>4540</span>
<span>4541</span>
<span>4542</span>
<span>4543</span>
<span>4544</span>
<span>4545</span>
<span>4546</span>
<span>4547</span>
<span>4548</span>
<span>4549</span>
<span>4550</span>
<span>4551</span>
<span>4552</span>
<span>4553</span>
<span>4554</span>
<span>4555</span>
<span>4556</span>
<span>4557</span>
<span>4558</span>
<span>4559</span>
<span>4560</span>
<span>4561</span>
<span>4562</span>
<span>4563</span>
<span>4564</span>
<span>4565</span>
<span>4566</span>
<span>4567</span>
<span>4568</span>
<span>4569</span>
<span>4570</span>
<span>4571</span>
<span>4572</span>
<span>4573</span>
<span>4574</span>
<span>4575</span>
<span>4576</span>
<span>4577</span>
<span>4578</span>
<span>4579</span>
<span>4580</span>
<span>4581</span>
<span>4582</span>
<span>4583</span>
<span>4584</span>
<span>4585</span>
<span>4586</span>
<span>4587</span>
<span>4588</span>
<span>4589</span>
<span>4590</span>
<span>4591</span>
<span>4592</span>
<span>4593</span>
<span>4594</span>
<span>4595</span>
<span>4596</span>
<span>4597</span>
<span>4598</span>
<span>4599</span>
<span>4600</span>
<span>4601</span>
<span>4602</span>
<span>4603</span>
<span>4604</span>
<span>4605</span>
<span>4606</span>
<span>4607</span>
<span>4608</span>
<span>4609</span>
<span>4610</span>
<span>4611</span>
<span>4612</span>
<span>4613</span>
<span>4614</span>
<span>4615</span>
<span>4616</span>
<span>4617</span>
<span>4618</span>
<span>4619</span>
<span>4620</span>
<span>4621</span>
<span>4622</span>
<span>4623</span>
<span>4624</span>
<span>4625</span>
<span>4626</span>
<span>4627</span>
<span>4628</span>
<span>4629</span>
<span>4630</span>
<span>4631</span>
<span>4632</span>
<span>4633</span>
<span>4634</span>
<span>4635</span>
<span>4636</span>
<span>4637</span>
<span>4638</span>
<span>4639</span>
<span>4640</span>
<span>4641</span>
<span>4642</span>
<span>4643</span>
<span>4644</span>
<span>4645</span>
<span>4646</span>
<span>4647</span>
<span>4648</span>
<span>4649</span>
<span>4650</span>
<span>4651</span>
<span>4652</span>
<span>4653</span>
<span>4654</span>
<span>4655</span>
<span>4656</span>
<span>4657</span>
<span>4658</span>
<span>4659</span>
<span>4660</span>
<span>4661</span>
<span>4662</span>
<span>4663</span>
<span>4664</span>
<span>4665</span>
<span>4666</span>
<span>4667</span>
<span>4668</span>
<span>4669</span>
<span>4670</span>
<span>4671</span>
<span>4672</span>
<span>4673</span>
<span>4674</span>
<span>4675</span>
<span>4676</span>
<span>4677</span>
<span>4678</span>
<span>4679</span>
<span>4680</span>
<span>4681</span>
<span>4682</span>
<span>4683</span>
<span>4684</span>
<span>4685</span>
<span>4686</span>
<span>4687</span>
<span>4688</span>
<span>4689</span>
<span>4690</span>
<span>4691</span>
<span>4692</span>
<span>4693</span>
<span>4694</span>
<span>4695</span>
<span>4696</span>
<span>4697</span>
<span>4698</span>
<span>4699</span>
<span>4700</span>
<span>4701</span>
<span>4702</span>
<span>4703</span>
<span>4704</span>
<span>4705</span>
<span>4706</span>
<span>4707</span>
<span>4708</span>
<span>4709</span>
<span>4710</span>
<span>4711</span>
<span>4712</span>
<span>4713</span>
<span>4714</span>
<span>4715</span>
<span>4716</span>
<span>4717</span>
<span>4718</span>
<span>4719</span>
<span>4720</span>
<span>4721</span>
<span>4722</span>
<span>4723</span>
<span>4724</span>
<span>4725</span>
<span>4726</span>
<span>4727</span>
<span>4728</span>
<span>4729</span>
<span>4730</span>
<span>4731</span>
<span>4732</span>
<span>4733</span>
<span>4734</span>
<span>4735</span>
<span>4736</span>
<span>4737</span>
<span>4738</span>
<span>4739</span>
<span>4740</span>
<span>4741</span>
<span>4742</span>
<span>4743</span>
<span>4744</span>
<span>4745</span>
<span>4746</span>
<span>4747</span>
<span>4748</span>
<span>4749</span>
<span>4750</span>
<span>4751</span>
<span>4752</span>
<span>4753</span>
<span>4754</span>
<span>4755</span>
<span>4756</span>
<span>4757</span>
<span>4758</span>
<span>4759</span>
<span>4760</span>
<span>4761</span>
<span>4762</span>
<span>4763</span>
<span>4764</span>
<span>4765</span>
<span>4766</span>
<span>4767</span>
<span>4768</span>
<span>4769</span>
<span>4770</span>
<span>4771</span>
<span>4772</span>
<span>4773</span>
<span>4774</span>
<span>4775</span>
<span>4776</span>
<span>4777</span>
<span>4778</span>
<span>4779</span>
<span>4780</span>
<span>4781</span>
<span>4782</span>
<span>4783</span>
<span>4784</span>
<span>4785</span>
<span>4786</span>
<span>4787</span>
<span>4788</span>
<span>4789</span>
<span>4790</span>
<span>4791</span>
<span>4792</span>
<span>4793</span>
<span>4794</span>
<span>4795</span>
<span>4796</span>
<span>4797</span>
<span>4798</span>
<span>4799</span>
<span>4800</span>
<span>4801</span>
<span>4802</span>
<span>4803</span>
<span>4804</span>
<span>4805</span>
<span>4806</span>
<span>4807</span>
<span>4808</span>
<span>4809</span>
<span>4810</span>
<span>4811</span>
<span>4812</span>
<span>4813</span>
<span>4814</span>
<span>4815</span>
<span>4816</span>
<span>4817</span>
<span>4818</span>
<span>4819</span>
<span>4820</span>
<span>4821</span>
<span>4822</span>
<span>4823</span>
<span>4824</span>
<span>4825</span>
<span>4826</span>
<span>4827</span>
<span>4828</span>
<span>4829</span>
<span>4830</span>
<span>4831</span>
<span>4832</span>
<span>4833</span>
<span>4834</span>
<span>4835</span>
<span>4836</span>
<span>4837</span>
<span>4838</span>
<span>4839</span>
<span>4840</span>
<span>4841</span>
<span>4842</span>
<span>4843</span>
<span>4844</span>
<span>4845</span>
<span>4846</span>
<span>4847</span>
<span>4848</span>
<span>4849</span>
<span>4850</span>
<span>4851</span>
<span>4852</span>
<span>4853</span>
<span>4854</span>
<span>4855</span>
<span>4856</span>
<span>4857</span>
<span>4858</span>
<span>4859</span>
<span>4860</span>
<span>4861</span>
<span>4862</span>
<span>4863</span>
<span>4864</span>
<span>4865</span>
<span>4866</span>
<span>4867</span>
<span>4868</span>
<span>4869</span>
<span>4870</span>
<span>4871</span>
<span>4872</span>
<span>4873</span>
<span>4874</span>
<span>4875</span>
<span>4876</span>
<span>4877</span>
<span>4878</span>
<span>4879</span>
<span>4880</span>
<span>4881</span>
<span>4882</span>
<span>4883</span>
<span>4884</span>
<span>4885</span>
<span>4886</span>
<span>4887</span>
<span>4888</span>
<span>4889</span>
<span>4890</span>
<span>4891</span>
<span>4892</span>
<span>4893</span>
<span>4894</span>
<span>4895</span>
<span>4896</span>
<span>4897</span>
<span>4898</span>
<span>4899</span>
<span>4900</span>
<span>4901</span>
<span>4902</span>
<span>4903</span>
<span>4904</span>
<span>4905</span>
<span>4906</span>
<span>4907</span>
<span>4908</span>
<span>4909</span>
<span>4910</span>
<span>4911</span>
<span>4912</span>
<span>4913</span>
<span>4914</span>
<span>4915</span>
<span>4916</span>
<span>4917</span>
<span>4918</span>
<span>4919</span>
<span>4920</span>
<span>4921</span>
<span>4922</span>
<span>4923</span>
<span>4924</span>
<span>4925</span>
<span>4926</span>
<span>4927</span>
<span>4928</span>
<span>4929</span>
<span>4930</span>
<span>4931</span>
<span>4932</span>
<span>4933</span>
<span>4934</span>
<span>4935</span>
<span>4936</span>
<span>4937</span>
<span>4938</span>
<span>4939</span>
<span>4940</span>
<span>4941</span>
<span>4942</span>
<span>4943</span>
<span>4944</span>
<span>4945</span>
<span>4946</span>
<span>4947</span>
<span>4948</span>
<span>4949</span>
<span>4950</span>
<span>4951</span>
<span>4952</span>
<span>4953</span>
<span>4954</span>
<span>4955</span>
<span>4956</span>
<span>4957</span>
<span>4958</span>
<span>4959</span>
<span>4960</span>
<span>4961</span>
<span>4962</span>
<span>4963</span>
<span>4964</span>
<span>4965</span>
<span>4966</span>
<span>4967</span>
<span>4968</span>
<span>4969</span>
<span>4970</span>
<span>4971</span>
<span>4972</span>
<span>4973</span>
<span>4974</span>
<span>4975</span>
<span>4976</span>
<span>4977</span>
<span>4978</span>
<span>4979</span>
<span>4980</span>
<span>4981</span>
<span>4982</span>
<span>4983</span>
<span>4984</span>
<span>4985</span>
<span>4986</span>
<span>4987</span>
<span>4988</span>
<span>4989</span>
<span>4990</span>
<span>4991</span>
<span>4992</span>
<span>4993</span>
<span>4994</span>
<span>4995</span>
<span>4996</span>
<span>4997</span>
<span>4998</span>
<span>4999</span>
<span>5000</span>
<span>5001</span>
<span>5002</span>
<span>5003</span>
<span>5004</span>
<span>5005</span>
<span>5006</span>
<span>5007</span>
<span>5008</span>
<span>5009</span>
<span>5010</span>
<span>5011</span>
<span>5012</span>
<span>5013</span>
<span>5014</span>
<span>5015</span>
<span>5016</span>
<span>5017</span>
<span>5018</span>
<span>5019</span>
<span>5020</span>
<span>5021</span>
<span>5022</span>
<span>5023</span>
<span>5024</span>
<span>5025</span>
<span>5026</span>
<span>5027</span>
<span>5028</span>
<span>5029</span>
<span>5030</span>
<span>5031</span>
<span>5032</span>
<span>5033</span>
<span>5034</span>
<span>5035</span>
<span>5036</span>
<span>5037</span>
<span>5038</span>
<span>5039</span>
<span>5040</span>
<span>5041</span>
<span>5042</span>
<span>5043</span>
<span>5044</span>
<span>5045</span>
<span>5046</span>
<span>5047</span>
<span>5048</span>
<span>5049</span>
<span>5050</span>
<span>5051</span>
<span>5052</span>
<span>5053</span>
<span>5054</span>
<span>5055</span>
<span>5056</span>
<span>5057</span>
<span>5058</span>
<span>5059</span>
<span>5060</span>
<span>5061</span>
<span>5062</span>
<span>5063</span>

  </pre>
  </td>

  <td  style="margin:0px; padding-left:8px; vertical-align:top" width="100%">
  <pre><div class="line" id="l1">namespace NachoDB.Impl    
</div><div class="line" id="l2">{
</div><div class="line" id="l3">    using System;
</div><div class="line" id="l4">    using System.Collections;
</div><div class="line" id="l5">    using System.Reflection;
</div><div class="line" id="l6">    using System.Threading;
</div><div class="line" id="l7">    using System.Diagnostics;
</div><div class="line" id="l8">    using System.Text;
</div><div class="line" id="l9">    using NachoDB;
</div><div class="line" id="l10"><br></div><div class="line" id="l11">    public class StorageImpl : Storage
</div><div class="line" id="l12">    {
</div><div class="line" id="l13">        public const int DEFAULT_PAGE_POOL_SIZE = 4*1024*1024;
</div><div class="line" id="l14"><br></div><div class="line" id="l15">#if COMPACT_NET_FRAMEWORK
</div><div class="line" id="l16">        static StorageImpl() 
</div><div class="line" id="l17">        {
</div><div class="line" id="l18">            assemblies = new System.Collections.ArrayList();
</div><div class="line" id="l19">        }
</div><div class="line" id="l20">        public StorageImpl(Assembly callingAssembly) 
</div><div class="line" id="l21">        {
</div><div class="line" id="l22">            assemblies.Add(callingAssembly);
</div><div class="line" id="l23">            assemblies.Add(Assembly.GetExecutingAssembly());
</div><div class="line" id="l24">        }
</div><div class="line" id="l25">#endif
</div><div class="line" id="l26"><br></div><div class="line" id="l27">        public IPersistent Root
</div><div class="line" id="l28">        {
</div><div class="line" id="l29">            get
</div><div class="line" id="l30">            {
</div><div class="line" id="l31">                <span class="c">lock (this)</span></div><div class="line" id="l32">                {
</div><div class="line" id="l33">                    <span class="c">ensureOpened();</span></div><div class="line" id="l34">                    <span class="c">int rootOid = header.root[1 - currIndex].rootObject;</span></div><div class="line" id="l35">                    <span class="c">return (rootOid == 0) ? null : lookupObject(rootOid, null);</span></div><div class="line" id="l36">                }
</div><div class="line" id="l37">            <span class="c">}</span></div><div class="line" id="l38"><br></div><div class="line" id="l39">            set
</div><div class="line" id="l40">            {
</div><div class="line" id="l41">                <span class="c">lock (this)</span></div><div class="line" id="l42">                {
</div><div class="line" id="l43">                    <span class="c">ensureOpened();</span></div><div class="line" id="l44">                    <span class="c">if (!value.IsPersistent())</span></div><div class="line" id="l45">                    {
</div><div class="line" id="l46">                        <span class="c">storeObject0(value);</span></div><div class="line" id="l47">                    }
</div><div class="line" id="l48">                    <span class="c">header.root[1 - currIndex].rootObject = value.Oid;</span></div><div class="line" id="l49">                    <span class="c">modified = true;</span></div><div class="line" id="l50">                }
</div><div class="line" id="l51">            <span class="c">}</span></div><div class="line" id="l52">        }
</div><div class="line" id="l53"><br></div><div class="line" id="l54">        /// &lt;summary&gt; Initialial database index size - increasing it reduce number of inde reallocation but increase
</div><div class="line" id="l55">        /// initial database size. Should be set before openning connection.
</div><div class="line" id="l56">        /// &lt;/summary&gt;
</div><div class="line" id="l57">        const int dbDefaultInitIndexSize = 1024;
</div><div class="line" id="l58"><br></div><div class="line" id="l59">        /// &lt;summary&gt; Initial capacity of object hash
</div><div class="line" id="l60">        /// &lt;/summary&gt;
</div><div class="line" id="l61">        const int dbDefaultObjectCacheInitSize = 1319;
</div><div class="line" id="l62"><br></div><div class="line" id="l63">        /// &lt;summary&gt; Database extension quantum. Memory is allocate by scanning bitmap. If there is no
</div><div class="line" id="l64">        /// large enough hole, then database is extended by the value of dbDefaultExtensionQuantum 
</div><div class="line" id="l65">        /// This parameter should not be smaller than dbFirstUserId
</div><div class="line" id="l66">        /// &lt;/summary&gt;
</div><div class="line" id="l67">        <span class="c">static long dbDefaultExtensionQuantum = 1024 * 1024;</span></div><div class="line" id="l68"><br></div><div class="line" id="l69">        const int dbDatabaseOffsetBits = 32; // up to 4 gigabyte
</div><div class="line" id="l70">        const int dbLargeDatabaseOffsetBits = 40; // up to 1 terabyte
</div><div class="line" id="l71"><br></div><div class="line" id="l72">        const int dbAllocationQuantumBits = 5;
</div><div class="line" id="l73">        const int dbAllocationQuantum = 1 &lt;&lt; dbAllocationQuantumBits;
</div><div class="line" id="l74">        const int dbBitmapSegmentBits = Page.pageBits + 3 + dbAllocationQuantumBits;
</div><div class="line" id="l75">        const int dbBitmapSegmentSize = 1 &lt;&lt; dbBitmapSegmentBits;
</div><div class="line" id="l76">        const int dbBitmapPages = 1 &lt;&lt; (dbDatabaseOffsetBits - dbBitmapSegmentBits);
</div><div class="line" id="l77">        const int dbLargeBitmapPages = 1 &lt;&lt; (dbLargeDatabaseOffsetBits - dbBitmapSegmentBits);
</div><div class="line" id="l78">        const int dbHandlesPerPageBits = Page.pageBits - 3;
</div><div class="line" id="l79">        const int dbHandlesPerPage = 1 &lt;&lt; dbHandlesPerPageBits;
</div><div class="line" id="l80">        const int dbDirtyPageBitmapSize = 1 &lt;&lt; (32 - dbHandlesPerPageBits - 3);
</div><div class="line" id="l81"><br></div><div class="line" id="l82">        const int dbInvalidId = 0;
</div><div class="line" id="l83">        const int dbBitmapId = 1;
</div><div class="line" id="l84">        const int dbFirstUserId = dbBitmapId + dbBitmapPages;
</div><div class="line" id="l85"><br></div><div class="line" id="l86">        internal const int dbPageObjectFlag = 1;
</div><div class="line" id="l87">        internal const int dbModifiedFlag = 2;
</div><div class="line" id="l88">        internal const int dbFreeHandleFlag = 4;
</div><div class="line" id="l89">        internal const int dbFlagsMask = 7;
</div><div class="line" id="l90">        internal const int dbFlagsBits = 3;
</div><div class="line" id="l91"><br></div><div class="line" id="l92">        internal void ensureOpened()
</div><div class="line" id="l93">        {
</div><div class="line" id="l94">            <span class="c">if (!opened)</span></div><div class="line" id="l95">            {
</div><div class="line" id="l96">                <span class="c">throw new StorageError(StorageError.ErrorCode.STORAGE_NOT_OPENED);</span></div><div class="line" id="l97">            }
</div><div class="line" id="l98">        <span class="c">}</span></div><div class="line" id="l99"><br></div><div class="line" id="l100">        int getBitmapPageId(int i) 
</div><div class="line" id="l101">        { 
</div><div class="line" id="l102">            <span class="c">return i &lt; dbBitmapPages ? dbBitmapId + i : header.root[1-currIndex].bitmapExtent + i;</span></div><div class="line" id="l103">        }
</div><div class="line" id="l104"><br></div><div class="line" id="l105">        internal long getPos(int oid)
</div><div class="line" id="l106">        {
</div><div class="line" id="l107">            <span class="c">lock (objectCache)</span></div><div class="line" id="l108">            {
</div><div class="line" id="l109">                <span class="c">if (oid == 0 || oid &gt;= currIndexSize)</span></div><div class="line" id="l110">                {
</div><div class="line" id="l111">                    <span class="c">throw new StorageError(StorageError.ErrorCode.INVALID_OID);</span></div><div class="line" id="l112">                }
</div><div class="line" id="l113">                <span class="c">Page pg = pool.getPage(header.root[1 - currIndex].index + ((long)(oid &gt;&gt; dbHandlesPerPageBits) &lt;&lt; Page.pageBits));</span></div><div class="line" id="l114">                <span class="c">long pos = Bytes.unpack8(pg.data, (oid &amp; (dbHandlesPerPage - 1)) &lt;&lt; 3);</span></div><div class="line" id="l115">                <span class="c">pool.unfix(pg);</span></div><div class="line" id="l116">                <span class="c">return pos;</span></div><div class="line" id="l117">            }
</div><div class="line" id="l118">        <span class="c">}</span></div><div class="line" id="l119"><br></div><div class="line" id="l120">        internal void setPos(int oid, long pos)
</div><div class="line" id="l121">        {
</div><div class="line" id="l122">            <span class="c">lock (objectCache)</span></div><div class="line" id="l123">            {
</div><div class="line" id="l124">                <span class="c">dirtyPagesMap[oid &gt;&gt; (dbHandlesPerPageBits + 5)] |= 1 &lt;&lt; ((oid &gt;&gt; dbHandlesPerPageBits) &amp; 31);</span></div><div class="line" id="l125">                <span class="c">Page pg = pool.putPage(header.root[1 - currIndex].index + ((long)(oid &gt;&gt; dbHandlesPerPageBits) &lt;&lt; Page.pageBits));</span></div><div class="line" id="l126">                <span class="c">Bytes.pack8(pg.data, (oid &amp; (dbHandlesPerPage - 1)) &lt;&lt; 3, pos);</span></div><div class="line" id="l127">                <span class="c">pool.unfix(pg);</span></div><div class="line" id="l128">            }
</div><div class="line" id="l129">        <span class="c">}</span></div><div class="line" id="l130"><br></div><div class="line" id="l131">        internal byte[] get(int oid)
</div><div class="line" id="l132">        {
</div><div class="line" id="l133">            <span class="c">long pos = getPos(oid);</span></div><div class="line" id="l134">            <span class="c">if ((pos &amp; (dbFreeHandleFlag | dbPageObjectFlag)) != 0)</span></div><div class="line" id="l135">            {
</div><div class="line" id="l136">                <span class="c">throw new StorageError(StorageError.ErrorCode.INVALID_OID);</span></div><div class="line" id="l137">            }
</div><div class="line" id="l138">            <span class="c">return pool.get(pos &amp; ~ dbFlagsMask);</span></div><div class="line" id="l139">        }
</div><div class="line" id="l140"><br></div><div class="line" id="l141">        internal Page getPage(int oid)
</div><div class="line" id="l142">        {
</div><div class="line" id="l143">            <span class="c">long pos = getPos(oid);</span></div><div class="line" id="l144">            <span class="c">if ((pos &amp; (dbFreeHandleFlag | dbPageObjectFlag)) != dbPageObjectFlag)</span></div><div class="line" id="l145">            {
</div><div class="line" id="l146">                <span class="c">throw new StorageError(StorageError.ErrorCode.DELETED_OBJECT);</span></div><div class="line" id="l147">            }
</div><div class="line" id="l148">            <span class="c">return pool.getPage(pos &amp; ~ dbFlagsMask);</span></div><div class="line" id="l149">        }
</div><div class="line" id="l150"><br></div><div class="line" id="l151">        internal Page putPage(int oid)
</div><div class="line" id="l152">        {
</div><div class="line" id="l153">            <span class="c">lock (objectCache)</span></div><div class="line" id="l154">            {
</div><div class="line" id="l155">                <span class="c">long pos = getPos(oid);</span></div><div class="line" id="l156">                <span class="c">if ((pos &amp; (dbFreeHandleFlag | dbPageObjectFlag)) != dbPageObjectFlag)</span></div><div class="line" id="l157">                {
</div><div class="line" id="l158">                    <span class="c">throw new StorageError(StorageError.ErrorCode.DELETED_OBJECT);</span></div><div class="line" id="l159">                }
</div><div class="line" id="l160">                <span class="c">if ((pos &amp; dbModifiedFlag) == 0)</span></div><div class="line" id="l161">                {
</div><div class="line" id="l162">                    <span class="c">dirtyPagesMap[oid &gt;&gt; (dbHandlesPerPageBits + 5)] |= 1 &lt;&lt; ((oid &gt;&gt; dbHandlesPerPageBits) &amp; 31);</span></div><div class="line" id="l163">                    <span class="c">allocate(Page.pageSize, oid);</span></div><div class="line" id="l164">                    <span class="c">cloneBitmap(pos &amp; ~ dbFlagsMask, Page.pageSize);</span></div><div class="line" id="l165">                    <span class="c">pos = getPos(oid);</span></div><div class="line" id="l166">                }
</div><div class="line" id="l167">                <span class="c">modified = true;</span></div><div class="line" id="l168">                <span class="c">return pool.putPage(pos &amp; ~ dbFlagsMask);</span></div><div class="line" id="l169">            }
</div><div class="line" id="l170">        <span class="c">}</span></div><div class="line" id="l171"><br></div><div class="line" id="l172">        internal int allocatePage()
</div><div class="line" id="l173">        {
</div><div class="line" id="l174">            <span class="c">int oid = allocateId();</span></div><div class="line" id="l175">            <span class="c">setPos(oid, allocate(Page.pageSize, 0) | dbPageObjectFlag | dbModifiedFlag);</span></div><div class="line" id="l176">            <span class="c">return oid;</span></div><div class="line" id="l177">        }
</div><div class="line" id="l178"><br></div><div class="line" id="l179">        public void  deallocateObject(IPersistent obj)
</div><div class="line" id="l180">        {
</div><div class="line" id="l181">            lock (this)
</div><div class="line" id="l182">            {
</div><div class="line" id="l183">                lock (objectCache) 
</div><div class="line" id="l184">                { 
</div><div class="line" id="l185">                    int oid = obj.Oid;
</div><div class="line" id="l186">                    if (oid == 0) 
</div><div class="line" id="l187">                    { 
</div><div class="line" id="l188">                        return;
</div><div class="line" id="l189">                    }       
</div><div class="line" id="l190">                    long pos = getPos(oid);
</div><div class="line" id="l191">                    objectCache.remove(oid);
</div><div class="line" id="l192">                    int offs = (int) pos &amp; (Page.pageSize - 1);
</div><div class="line" id="l193">                    if ((offs &amp; (dbFreeHandleFlag | dbPageObjectFlag)) != 0)
</div><div class="line" id="l194">                    {
</div><div class="line" id="l195">                        throw new StorageError(StorageError.ErrorCode.DELETED_OBJECT);
</div><div class="line" id="l196">                    }
</div><div class="line" id="l197">                    Page pg = pool.getPage(pos - offs);
</div><div class="line" id="l198">                    offs &amp;= ~ dbFlagsMask;
</div><div class="line" id="l199">                    int size = ObjectHeader.getSize(pg.data, offs);
</div><div class="line" id="l200">                    pool.unfix(pg);
</div><div class="line" id="l201">                    freeId(oid);
</div><div class="line" id="l202">                    if ((pos &amp; dbModifiedFlag) != 0) 
</div><div class="line" id="l203">                    {
</div><div class="line" id="l204">                        free(pos &amp; ~ dbFlagsMask, size);
</div><div class="line" id="l205">                    }
</div><div class="line" id="l206">                    else
</div><div class="line" id="l207">                    {
</div><div class="line" id="l208">                        cloneBitmap(pos, size);
</div><div class="line" id="l209">                    }
</div><div class="line" id="l210">                    obj.AssignOid(this, 0, false);
</div><div class="line" id="l211">                }
</div><div class="line" id="l212">            }
</div><div class="line" id="l213">        }
</div><div class="line" id="l214"><br></div><div class="line" id="l215">        internal void  freePage(int oid)
</div><div class="line" id="l216">        {
</div><div class="line" id="l217">            long pos = getPos(oid);
</div><div class="line" id="l218">            Debug.Assert((pos &amp; (dbFreeHandleFlag | dbPageObjectFlag)) == dbPageObjectFlag);
</div><div class="line" id="l219">            if ((pos &amp; dbModifiedFlag) != 0)
</div><div class="line" id="l220">            {
</div><div class="line" id="l221">                free(pos &amp; ~ dbFlagsMask, Page.pageSize);
</div><div class="line" id="l222">            }
</div><div class="line" id="l223">            else
</div><div class="line" id="l224">            {
</div><div class="line" id="l225">                cloneBitmap(pos &amp; ~ dbFlagsMask, Page.pageSize);
</div><div class="line" id="l226">            }
</div><div class="line" id="l227">            freeId(oid);
</div><div class="line" id="l228">        }
</div><div class="line" id="l229"><br></div><div class="line" id="l230">        virtual protected bool isDirty()
</div><div class="line" id="l231">        { 
</div><div class="line" id="l232">             <span class="c">return header.dirty;</span></div><div class="line" id="l233">        }
</div><div class="line" id="l234"><br></div><div class="line" id="l235">        internal void setDirty() 
</div><div class="line" id="l236">        {
</div><div class="line" id="l237">            <span class="c">modified = true;</span></div><div class="line" id="l238">            <span class="c">if (!header.dirty)</span></div><div class="line" id="l239">            { 
</div><div class="line" id="l240">                <span class="c">header.dirty = true;</span></div><div class="line" id="l241">                <span class="c">Page pg = pool.putPage(0);</span></div><div class="line" id="l242">                <span class="c">header.pack(pg.data);</span></div><div class="line" id="l243">                <span class="c">pool.flush();</span></div><div class="line" id="l244">                <span class="c">pool.unfix(pg);</span></div><div class="line" id="l245">            }
</div><div class="line" id="l246">        <span class="c">}</span></div><div class="line" id="l247"><br></div><div class="line" id="l248">        internal int allocateId()
</div><div class="line" id="l249">        {
</div><div class="line" id="l250">            <span class="c">lock (objectCache)</span></div><div class="line" id="l251">            {
</div><div class="line" id="l252">                int oid;
</div><div class="line" id="l253">                <span class="c">int curr = 1 - currIndex;</span></div><div class="line" id="l254">                <span class="c">setDirty();</span></div><div class="line" id="l255">                <span class="c">if ((oid = header.root[curr].freeList) != 0)</span></div><div class="line" id="l256">                {
</div><div class="line" id="l257">                    <span class="c">header.root[curr].freeList = (int) (getPos(oid) &gt;&gt; dbFlagsBits);</span></div><div class="line" id="l258">                    Debug.Assert(header.root[curr].freeList &gt;= 0);
</div><div class="line" id="l259">                    <span class="c">dirtyPagesMap[oid &gt;&gt; (dbHandlesPerPageBits + 5)]</span></div><div class="line" id="l260">                        |= 1 &lt;&lt; ((oid &gt;&gt; dbHandlesPerPageBits) &amp; 31)<span class="c">;</span></div><div class="line" id="l261">                    <span class="c">return oid;</span></div><div class="line" id="l262">                }
</div><div class="line" id="l263"><br></div><div class="line" id="l264">                <span class="c">if (currIndexSize &gt;= header.root[curr].indexSize)</span></div><div class="line" id="l265">                {
</div><div class="line" id="l266">                    <span class="c">int oldIndexSize = header.root[curr].indexSize;</span></div><div class="line" id="l267">                    <span class="c">int newIndexSize = oldIndexSize * 2;</span></div><div class="line" id="l268">                    <span class="c">if (newIndexSize &lt; oldIndexSize)</span></div><div class="line" id="l269">                    { 
</div><div class="line" id="l270">                        <span class="c">newIndexSize = int.MaxValue &amp; ~(dbHandlesPerPage-1);</span></div><div class="line" id="l271">                        <span class="c">if (newIndexSize &lt;= oldIndexSize)</span></div><div class="line" id="l272">                        { 
</div><div class="line" id="l273">                            <span class="c">throw new StorageError(StorageError.ErrorCode.NOT_ENOUGH_SPACE);</span></div><div class="line" id="l274">                        }
</div><div class="line" id="l275">                    }
</div><div class="line" id="l276">                    <span class="c">long newIndex = allocate(newIndexSize*8L, 0);</span></div><div class="line" id="l277">                    <span class="c">if (currIndexSize &gt;= header.root[curr].indexSize)</span></div><div class="line" id="l278">                    {
</div><div class="line" id="l279">                        <span class="c">long oldIndex = header.root[curr].index;</span></div><div class="line" id="l280">                        <span class="c">pool.copy(newIndex, oldIndex, currIndexSize*8L);</span></div><div class="line" id="l281">                        <span class="c">header.root[curr].index = newIndex;</span></div><div class="line" id="l282">                        <span class="c">header.root[curr].indexSize = newIndexSize;</span></div><div class="line" id="l283">                        <span class="c">free(oldIndex, oldIndexSize*8L);</span></div><div class="line" id="l284">                    } 
</div><div class="line" id="l285">                    else 
</div><div class="line" id="l286">                    { 
</div><div class="line" id="l287">                        // index was already reallocated
</div><div class="line" id="l288">                        <span class="c">free(newIndex, newIndexSize*8L);</span></div><div class="line" id="l289">                    }
</div><div class="line" id="l290">                }
</div><div class="line" id="l291">                <span class="c">oid = currIndexSize;</span></div><div class="line" id="l292">                <span class="c">header.root[curr].indexUsed = ++currIndexSize;</span></div><div class="line" id="l293">                <span class="c">modified = true;</span></div><div class="line" id="l294">                <span class="c">return oid;</span></div><div class="line" id="l295">            }
</div><div class="line" id="l296">        <span class="c">}</span></div><div class="line" id="l297"><br></div><div class="line" id="l298">        internal void freeId(int oid)
</div><div class="line" id="l299">        {
</div><div class="line" id="l300">            lock (objectCache) 
</div><div class="line" id="l301">            {
</div><div class="line" id="l302">                setPos(oid, ((long) (header.root[1 - currIndex].freeList) &lt;&lt; dbFlagsBits) | dbFreeHandleFlag);
</div><div class="line" id="l303">                header.root[1 - currIndex].freeList = oid;
</div><div class="line" id="l304">            }
</div><div class="line" id="l305">        }
</div><div class="line" id="l306"><br></div><div class="line" id="l307">        <span class="c">internal static byte[] firstHoleSize = new byte[]{8, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0, 4, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0, 5, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0, 4, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0, 6, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0, 4, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0, 5, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0, 4, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0, 7, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0, 4, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0, 5, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0, 4, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0, 6, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0, 4, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0, 5, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0, 4, 0, 1, 0, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0};</span></div><div class="line" id="l308">        <span class="c">internal static byte[] lastHoleSize = new byte[]{8, 7, 6, 6, 5, 5, 5, 5, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};</span></div><div class="line" id="l309">        <span class="c">internal static byte[] maxHoleSize = new byte[]{8, 7, 6, 6, 5, 5, 5, 5, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 5, 4, 3, 3, 2, 2, 2, 2, 3, 2, 2, 2, 2, 2, 2, 2, 4, 3, 2, 2, 2, 2, 2, 2, 3, 2, 2, 2, 2, 2, 2, 2, 6, 5, 4, 4, 3, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2, 2, 4, 3, 2, 2, 2, 1, 1, 1, 3, 2, 1, 1, 2, 1, 1, 1, 5, 4, 3, 3, 2, 2, 2, 2, 3, 2, 1, 1, 2, 1, 1, 1, 4, 3, 2, 2, 2, 1, 1, 1, 3, 2, 1, 1, 2, 1, 1, 1, 7, 6, 5, 5, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 4, 3, 2, 2, 2, 2, 2, 2, 3, 2, 2, 2, 2, 2, 2, 2, 5, 4, 3, 3, 2, 2, 2, 2, 3, 2, 1, 1, 2, 1, 1, 1, 4, 3, 2, 2, 2, 1, 1, 1, 3, 2, 1, 1, 2, 1, 1, 1, 6, 5, 4, 4, 3, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2, 2, 4, 3, 2, 2, 2, 1, 1, 1, 3, 2, 1, 1, 2, 1, 1, 1, 5, 4, 3, 3, 2, 2, 2, 2, 3, 2, 1, 1, 2, 1, 1, 1, 4, 3, 2, 2, 2, 1, 1, 1, 3, 2, 1, 1, 2, 1, 1, 0};</span></div><div class="line" id="l310">        <span class="c">internal static byte[] maxHoleOffset = new byte[]{0, 1, 2, 2, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 0, 1, 5, 5, 5, 5, 5, 5, 0, 5, 5, 5, 5, 5, 5, 5, 0, 1, 2, 2, 0, 3, 3, 3, 0, 1, 6, 6, 0, 6, 6, 6, 0, 1, 2, 2, 0, 6, 6, 6, 0, 1, 6, 6, 0, 6, 6, 6, 0, 1, 2, 2, 3, 3, 3, 3, 0, 1, 4, 4, 0, 4, 4, 4, 0, 1, 2, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0, 5, 0, 1, 2, 2, 0, 3, 3, 3, 0, 1, 0, 2, 0, 1, 0, 4, 0, 1, 2, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0, 7, 0, 1, 2, 2, 3, 3, 3, 3, 0, 4, 4, 4, 4, 4, 4, 4, 0, 1, 2, 2, 0, 5, 5, 5, 0, 1, 5, 5, 0, 5, 5, 5, 0, 1, 2, 2, 0, 3, 3, 3, 0, 1, 0, 2, 0, 1, 0, 4, 0, 1, 2, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0, 6, 0, 1, 2, 2, 3, 3, 3, 3, 0, 1, 4, 4, 0, 4, 4, 4, 0, 1, 2, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0, 5, 0, 1, 2, 2, 0, 3, 3, 3, 0, 1, 0, 2, 0, 1, 0, 4, 0, 1, 2, 2, 0, 1, 0, 3, 0, 1, 0, 2, 0, 1, 0, 0};</span></div><div class="line" id="l311"><br></div><div class="line" id="l312">        internal const int pageBits = Page.pageSize * 8;
</div><div class="line" id="l313">        internal const int inc = Page.pageSize / dbAllocationQuantum / 8;
</div><div class="line" id="l314"><br></div><div class="line" id="l315">        internal static void memset(Page pg, int offs, int pattern, int len)
</div><div class="line" id="l316">        {
</div><div class="line" id="l317">            <span class="c">byte[] arr = pg.data;</span></div><div class="line" id="l318">            <span class="c">byte pat = (byte) pattern;</span></div><div class="line" id="l319">            <span class="c">while (--len &gt;= 0)</span></div><div class="line" id="l320">            {
</div><div class="line" id="l321">                <span class="c">arr[offs++] = pat;</span></div><div class="line" id="l322">            }
</div><div class="line" id="l323">        <span class="c">}</span></div><div class="line" id="l324"><br></div><div class="line" id="l325">        public long UsedSize
</div><div class="line" id="l326">        { 
</div><div class="line" id="l327">            get       
</div><div class="line" id="l328">            { 
</div><div class="line" id="l329">                return usedSize;
</div><div class="line" id="l330">            }
</div><div class="line" id="l331">        }
</div><div class="line" id="l332"><br></div><div class="line" id="l333">        public long DatabaseSize
</div><div class="line" id="l334">        { 
</div><div class="line" id="l335">            get 
</div><div class="line" id="l336">            { 
</div><div class="line" id="l337">                return header.root[1-currIndex].size;
</div><div class="line" id="l338">            }
</div><div class="line" id="l339">        }
</div><div class="line" id="l340"><br></div><div class="line" id="l341">        internal void  extend(long size)
</div><div class="line" id="l342">        {
</div><div class="line" id="l343">            <span class="c">if (size &gt; header.root[1 - currIndex].size)</span></div><div class="line" id="l344">            {
</div><div class="line" id="l345">                <span class="c">header.root[1 - currIndex].size = size;</span></div><div class="line" id="l346">            }
</div><div class="line" id="l347">        <span class="c">}</span></div><div class="line" id="l348"><br></div><div class="line" id="l349">        internal class Location
</div><div class="line" id="l350">        {
</div><div class="line" id="l351">            internal long pos;
</div><div class="line" id="l352">            internal long size;
</div><div class="line" id="l353">            internal Location next;
</div><div class="line" id="l354">        }
</div><div class="line" id="l355"><br></div><div class="line" id="l356">        internal bool wasReserved(long pos, long size)
</div><div class="line" id="l357">        {
</div><div class="line" id="l358">            for (<span class="c">Location location = reservedChain;</span> <span class="c">location != null</span>; <span class="c">location = location.next</span>)</div><div class="line" id="l359">            {
</div><div class="line" id="l360">                <span class="c">if ((pos &gt;= location.pos &amp;&amp; pos - location.pos &lt; location.size) || (pos &lt;= location.pos &amp;&amp; location.pos - pos &lt; size))</span></div><div class="line" id="l361">                {
</div><div class="line" id="l362">                    <span class="c">return true;</span></div><div class="line" id="l363">                }
</div><div class="line" id="l364">            }
</div><div class="line" id="l365">            <span class="c">return false;</span></div><div class="line" id="l366">        }
</div><div class="line" id="l367"><br></div><div class="line" id="l368">        internal void reserveLocation(long pos, long size)
</div><div class="line" id="l369">        {
</div><div class="line" id="l370">            <span class="c">Location location = new Location();</span></div><div class="line" id="l371">            <span class="c">location.pos = pos;</span></div><div class="line" id="l372">            <span class="c">location.size = size;</span></div><div class="line" id="l373">            <span class="c">location.next = reservedChain;</span></div><div class="line" id="l374">            <span class="c">reservedChain = location;</span></div><div class="line" id="l375">        <span class="c">}</span></div><div class="line" id="l376"><br></div><div class="line" id="l377">        internal void commitLocation()
</div><div class="line" id="l378">        {
</div><div class="line" id="l379">            <span class="c">reservedChain = reservedChain.next;</span></div><div class="line" id="l380">        <span class="c">}</span></div><div class="line" id="l381"><br></div><div class="line" id="l382">        Page putBitmapPage(int i) 
</div><div class="line" id="l383">        { 
</div><div class="line" id="l384">            <span class="c">return putPage(getBitmapPageId(i));</span></div><div class="line" id="l385">        }
</div><div class="line" id="l386"><br></div><div class="line" id="l387">        Page getBitmapPage(int i) 
</div><div class="line" id="l388">        { 
</div><div class="line" id="l389">            <span class="c">return getPage(getBitmapPageId(i));</span></div><div class="line" id="l390">        }
</div><div class="line" id="l391"><br></div><div class="line" id="l392">        internal long allocate(long size, int oid)
</div><div class="line" id="l393">        {
</div><div class="line" id="l394">            <span class="c">lock (objectCache)</span></div><div class="line" id="l395">            {
</div><div class="line" id="l396">                <span class="c">setDirty();</span></div><div class="line" id="l397">                <span class="c">size = (size + dbAllocationQuantum - 1) &amp; ~ (dbAllocationQuantum - 1);</span></div><div class="line" id="l398">                Debug.Assert(size != 0);
</div><div class="line" id="l399">                <span class="c">allocatedDelta += size;</span></div><div class="line" id="l400">                <span class="c">if (allocatedDelta &gt; gcThreshold)</span></div><div class="line" id="l401">                {
</div><div class="line" id="l402">                    <span class="c">gc0();</span></div><div class="line" id="l403">                }
</div><div class="line" id="l404">                <span class="c">int objBitSize = (int)(size &gt;&gt; dbAllocationQuantumBits);</span></div><div class="line" id="l405">                Debug.Assert(objBitSize == (size &gt;&gt; dbAllocationQuantumBits));
</div><div class="line" id="l406">                long pos;
</div><div class="line" id="l407">                <span class="c">int holeBitSize = 0;</span></div><div class="line" id="l408">                <span class="c">int alignment = (int)size &amp; (Page.pageSize - 1);</span></div><div class="line" id="l409">                int offs, firstPage, lastPage, i, j;
</div><div class="line" id="l410">                <span class="c">int holeBeforeFreePage = 0;</span></div><div class="line" id="l411">                <span class="c">int freeBitmapPage = 0;</span></div><div class="line" id="l412">                <span class="c">int  curr = 1 - currIndex;</span></div><div class="line" id="l413">                Page pg;
</div><div class="line" id="l414"><br></div><div class="line" id="l415">                <span class="c">lastPage = header.root[curr].bitmapEnd - dbBitmapId;</span></div><div class="line" id="l416">                <span class="c">usedSize += size;</span></div><div class="line" id="l417"><br></div><div class="line" id="l418">                <span class="c">if (alignment == 0)</span></div><div class="line" id="l419">                {
</div><div class="line" id="l420">                    <span class="c">firstPage = currPBitmapPage;</span></div><div class="line" id="l421">                    <span class="c">offs = (currPBitmapOffs + inc - 1) &amp; ~ (inc - 1);</span></div><div class="line" id="l422">                }
</div><div class="line" id="l423">                else
</div><div class="line" id="l424">                {
</div><div class="line" id="l425">                    <span class="c">firstPage = currRBitmapPage;</span></div><div class="line" id="l426">                    <span class="c">offs = currRBitmapOffs;</span></div><div class="line" id="l427">                }
</div><div class="line" id="l428"><br></div><div class="line" id="l429">                <span class="c">while (true)</span></div><div class="line" id="l430">                {
</div><div class="line" id="l431">                    <span class="c">if (alignment == 0)</span></div><div class="line" id="l432">                    { 
</div><div class="line" id="l433">                        // allocate page object 
</div><div class="line" id="l434">                        for (<span class="c">i = firstPage</span>; <span class="c">i &lt; lastPage</span>; <span class="c">i++</span>)</div><div class="line" id="l435">                        {
</div><div class="line" id="l436">                            <span class="c">int spaceNeeded = objBitSize - holeBitSize &lt; pageBits</span></div><div class="line" id="l437">                                ? objBitSize - holeBitSize : pageBits<span class="c">;</span></div><div class="line" id="l438">                            <span class="c">if (bitmapPageAvailableSpace[i] &lt;= spaceNeeded)</span></div><div class="line" id="l439">                            {
</div><div class="line" id="l440">                                <span class="c">holeBitSize = 0;</span></div><div class="line" id="l441">                                <span class="c">offs = 0;</span></div><div class="line" id="l442">                                <span class="c">continue;</span></div><div class="line" id="l443">                            }
</div><div class="line" id="l444">                            <span class="c">pg = getBitmapPage(i);</span></div><div class="line" id="l445">                            <span class="c">int startOffs = offs;</span></div><div class="line" id="l446">                            <span class="c">while (offs &lt; Page.pageSize)</span></div><div class="line" id="l447">                            { 
</div><div class="line" id="l448">                                <span class="c">if (pg.data[offs++] != 0)</span></div><div class="line" id="l449">                                { 
</div><div class="line" id="l450">                                    <span class="c">offs = (offs + inc - 1) &amp; ~(inc-1);</span></div><div class="line" id="l451">                                    <span class="c">holeBitSize = 0;</span></div><div class="line" id="l452">                                } 
</div><div class="line" id="l453">                                else <span class="c">if ((holeBitSize += 8) == objBitSize)</span></div><div class="line" id="l454">                                { 
</div><div class="line" id="l455">                                    <span class="c">pos = (((long)i*Page.pageSize + offs)*8 - holeBitSize)</span></div><div class="line" id="l456">                                        &lt;&lt; dbAllocationQuantumBits<span class="c">;</span></div><div class="line" id="l457">                                    <span class="c">if (wasReserved(pos, size))</span></div><div class="line" id="l458">                                    { 
</div><div class="line" id="l459">                                        <span class="c">offs += objBitSize &gt;&gt; 3;</span></div><div class="line" id="l460">                                        <span class="c">startOffs = offs = (offs+inc-1) &amp; ~(inc-1);</span></div><div class="line" id="l461">                                        <span class="c">holeBitSize = 0;</span></div><div class="line" id="l462">                                        <span class="c">continue;</span></div><div class="line" id="l463">                                    }       
</div><div class="line" id="l464">                                    <span class="c">reserveLocation(pos, size);</span></div><div class="line" id="l465">                                    <span class="c">currPBitmapPage = i;</span></div><div class="line" id="l466">                                    <span class="c">currPBitmapOffs = offs;</span></div><div class="line" id="l467">                                    <span class="c">extend(pos + size);</span></div><div class="line" id="l468">                                    <span class="c">if (oid != 0)</span></div><div class="line" id="l469">                                    { 
</div><div class="line" id="l470">                                        <span class="c">long prev = getPos(oid);</span></div><div class="line" id="l471">                                        <span class="c">uint marker = (uint)prev &amp; dbFlagsMask;</span></div><div class="line" id="l472">                                        <span class="c">pool.copy(pos, prev - marker, size);</span></div><div class="line" id="l473">                                        <span class="c">setPos(oid, pos | marker | dbModifiedFlag);</span></div><div class="line" id="l474">                                    }
</div><div class="line" id="l475">                                    <span class="c">pool.unfix(pg);</span></div><div class="line" id="l476">                                    <span class="c">pg = putBitmapPage(i);</span></div><div class="line" id="l477">                                    <span class="c">int holeBytes = holeBitSize &gt;&gt; 3;</span></div><div class="line" id="l478">                                    <span class="c">if (holeBytes &gt; offs)</span></div><div class="line" id="l479">                                    { 
</div><div class="line" id="l480">                                        <span class="c">memset(pg, 0, 0xFF, offs);</span></div><div class="line" id="l481">                                        <span class="c">holeBytes -= offs;</span></div><div class="line" id="l482">                                        <span class="c">pool.unfix(pg);</span></div><div class="line" id="l483">                                        <span class="c">pg = putBitmapPage(--i);</span></div><div class="line" id="l484">                                        <span class="c">offs = Page.pageSize;</span></div><div class="line" id="l485">                                    }
</div><div class="line" id="l486">                                    <span class="c">while (holeBytes &gt; Page.pageSize)</span></div><div class="line" id="l487">                                    { 
</div><div class="line" id="l488">                                        <span class="c">memset(pg, 0, 0xFF, Page.pageSize);</span></div><div class="line" id="l489">                                        <span class="c">holeBytes -= Page.pageSize;</span></div><div class="line" id="l490">                                        <span class="c">bitmapPageAvailableSpace[i] = 0;</span></div><div class="line" id="l491">                                        <span class="c">pool.unfix(pg);</span></div><div class="line" id="l492">                                        <span class="c">pg = putBitmapPage(--i);</span></div><div class="line" id="l493">                                    }
</div><div class="line" id="l494">                                    <span class="c">memset(pg, offs-holeBytes, 0xFF, holeBytes);</span></div><div class="line" id="l495">                                    <span class="c">commitLocation();</span></div><div class="line" id="l496">                                    <span class="c">pool.unfix(pg);</span></div><div class="line" id="l497">                                    <span class="c">return pos;</span></div><div class="line" id="l498">                                }
</div><div class="line" id="l499">                            }
</div><div class="line" id="l500">                            <span class="c">if (startOffs == 0 &amp;&amp; holeBitSize == 0</span></div><div class="line" id="l501">                                &amp;&amp; spaceNeeded &lt; bitmapPageAvailableSpace[i]<span class="c">)</span></div><div class="line" id="l502">                            { 
</div><div class="line" id="l503">                                <span class="c">bitmapPageAvailableSpace[i] = spaceNeeded;</span></div><div class="line" id="l504">                            }
</div><div class="line" id="l505">                            <span class="c">offs = 0;</span></div><div class="line" id="l506">                            <span class="c">pool.unfix(pg);</span></div><div class="line" id="l507">                        }
</div><div class="line" id="l508">                    } 
</div><div class="line" id="l509">                    else 
</div><div class="line" id="l510">                    { 
</div><div class="line" id="l511">                        for (<span class="c">i = firstPage</span>; <span class="c">i &lt; lastPage</span>; <span class="c">i++</span>)</div><div class="line" id="l512">                        {
</div><div class="line" id="l513">                            <span class="c">int spaceNeeded = objBitSize - holeBitSize &lt; pageBits</span></div><div class="line" id="l514">                                ? objBitSize - holeBitSize : pageBits<span class="c">;</span></div><div class="line" id="l515">                            <span class="c">if (bitmapPageAvailableSpace[i] &lt;= spaceNeeded)</span></div><div class="line" id="l516">                            {
</div><div class="line" id="l517">                                <span class="c">holeBitSize = 0;</span></div><div class="line" id="l518">                                <span class="c">offs = 0;</span></div><div class="line" id="l519">                                <span class="c">continue;</span></div><div class="line" id="l520">                            }
</div><div class="line" id="l521">                            <span class="c">pg = getBitmapPage(i);</span></div><div class="line" id="l522">                            <span class="c">int startOffs = offs;</span></div><div class="line" id="l523">                            <span class="c">while (offs &lt; Page.pageSize)</span></div><div class="line" id="l524">                            { 
</div><div class="line" id="l525">                                <span class="c">int mask = pg.data[offs] &amp; 0xFF;</span></div><div class="line" id="l526">                                <span class="c">if (holeBitSize + firstHoleSize[mask] &gt;= objBitSize)</span></div><div class="line" id="l527">                                { 
</div><div class="line" id="l528">                                    <span class="c">pos = (((long)i*Page.pageSize + offs)*8</span></div><div class="line" id="l529">                                        - holeBitSize) &lt;&lt; dbAllocationQuantumBits<span class="c">;</span></div><div class="line" id="l530">                                    <span class="c">if (wasReserved(pos, size))</span></div><div class="line" id="l531">                                    {                       
</div><div class="line" id="l532">                                        <span class="c">startOffs = offs += (objBitSize + 7) &gt;&gt; 3;</span></div><div class="line" id="l533">                                        <span class="c">holeBitSize = 0;</span></div><div class="line" id="l534">                                        <span class="c">continue;</span></div><div class="line" id="l535">                                    }       
</div><div class="line" id="l536">                                    <span class="c">reserveLocation(pos, size);</span></div><div class="line" id="l537">                                    <span class="c">currRBitmapPage = i;</span></div><div class="line" id="l538">                                    <span class="c">currRBitmapOffs = offs;</span></div><div class="line" id="l539">                                    <span class="c">extend(pos + size);</span></div><div class="line" id="l540">                                    <span class="c">if (oid != 0)</span></div><div class="line" id="l541">                                    { 
</div><div class="line" id="l542">                                        <span class="c">long prev = getPos(oid);</span></div><div class="line" id="l543">                                        <span class="c">uint marker = (uint)prev &amp; dbFlagsMask;</span></div><div class="line" id="l544">                                        <span class="c">pool.copy(pos, prev - marker, size);</span></div><div class="line" id="l545">                                        <span class="c">setPos(oid, pos | marker | dbModifiedFlag);</span></div><div class="line" id="l546">                                    }
</div><div class="line" id="l547">                                    <span class="c">pool.unfix(pg);</span></div><div class="line" id="l548">                                    <span class="c">pg = putBitmapPage(i);</span></div><div class="line" id="l549">                                    <span class="c">pg.data[offs] |= (byte)((1 &lt;&lt; (objBitSize - holeBitSize)) - 1);</span></div><div class="line" id="l550">                                    <span class="c">if (holeBitSize != 0)</span></div><div class="line" id="l551">                                    { 
</div><div class="line" id="l552">                                        <span class="c">if (holeBitSize &gt; offs*8)</span></div><div class="line" id="l553">                                        { 
</div><div class="line" id="l554">                                            <span class="c">memset(pg, 0, 0xFF, offs);</span></div><div class="line" id="l555">                                            <span class="c">holeBitSize -= offs*8;</span></div><div class="line" id="l556">                                            <span class="c">pool.unfix(pg);</span></div><div class="line" id="l557">                                            <span class="c">pg = putBitmapPage(--i);</span></div><div class="line" id="l558">                                            <span class="c">offs = Page.pageSize;</span></div><div class="line" id="l559">                                        }
</div><div class="line" id="l560">                                        <span class="c">while (holeBitSize &gt; pageBits)</span></div><div class="line" id="l561">                                        { 
</div><div class="line" id="l562">                                            <span class="c">memset(pg, 0, 0xFF, Page.pageSize);</span></div><div class="line" id="l563">                                            <span class="c">holeBitSize -= pageBits;</span></div><div class="line" id="l564">                                            <span class="c">bitmapPageAvailableSpace[i] = 0;</span></div><div class="line" id="l565">                                            <span class="c">pool.unfix(pg);</span></div><div class="line" id="l566">                                            <span class="c">pg = putBitmapPage(--i);</span></div><div class="line" id="l567">                                        }
</div><div class="line" id="l568">                                        <span class="c">while ((holeBitSize -= 8) &gt; 0)</span></div><div class="line" id="l569">                                        { 
</div><div class="line" id="l570">                                            <span class="c">pg.data[--offs] = (byte)0xFF;</span></div><div class="line" id="l571">                                        }
</div><div class="line" id="l572">                                        <span class="c">pg.data[offs-1] |= (byte)~((1 &lt;&lt; -holeBitSize) - 1);</span></div><div class="line" id="l573">                                    }
</div><div class="line" id="l574">                                    <span class="c">pool.unfix(pg);</span></div><div class="line" id="l575">                                    <span class="c">commitLocation();</span></div><div class="line" id="l576">                                    <span class="c">return pos;</span></div><div class="line" id="l577">                                } 
</div><div class="line" id="l578">                                else <span class="c">if (maxHoleSize[mask] &gt;= objBitSize)</span></div><div class="line" id="l579">                                { 
</div><div class="line" id="l580">                                    <span class="c">int holeBitOffset = maxHoleOffset[mask];</span></div><div class="line" id="l581">                                    <span class="c">pos = (((long)i*Page.pageSize + offs)*8 + holeBitOffset) &lt;&lt; dbAllocationQuantumBits;</span></div><div class="line" id="l582">                                    <span class="c">if (wasReserved(pos, size))</span></div><div class="line" id="l583">                                    { 
</div><div class="line" id="l584">                                        <span class="c">startOffs = offs += (objBitSize + 7) &gt;&gt; 3;</span></div><div class="line" id="l585">                                        <span class="c">holeBitSize = 0;</span></div><div class="line" id="l586">                                        <span class="c">continue;</span></div><div class="line" id="l587">                                    }       
</div><div class="line" id="l588">                                    <span class="c">reserveLocation(pos, size);</span></div><div class="line" id="l589">                                    <span class="c">currRBitmapPage = i;</span></div><div class="line" id="l590">                                    <span class="c">currRBitmapOffs = offs;</span></div><div class="line" id="l591">                                    <span class="c">extend(pos + size);</span></div><div class="line" id="l592">                                    <span class="c">if (oid != 0)</span></div><div class="line" id="l593">                                    { 
</div><div class="line" id="l594">                                        <span class="c">long prev = getPos(oid);</span></div><div class="line" id="l595">                                        <span class="c">uint marker = (uint)prev &amp; dbFlagsMask;</span></div><div class="line" id="l596">                                        <span class="c">pool.copy(pos, prev - marker, size);</span></div><div class="line" id="l597">                                        <span class="c">setPos(oid, pos | marker | dbModifiedFlag);</span></div><div class="line" id="l598">                                    }
</div><div class="line" id="l599">                                    <span class="c">pool.unfix(pg);</span></div><div class="line" id="l600">                                    <span class="c">pg = putBitmapPage(i);</span></div><div class="line" id="l601">                                    <span class="c">pg.data[offs] |= (byte)(((1&lt;&lt;objBitSize) - 1) &lt;&lt; holeBitOffset);</span></div><div class="line" id="l602">                                    <span class="c">pool.unfix(pg);</span></div><div class="line" id="l603">                                    <span class="c">commitLocation();</span></div><div class="line" id="l604">                                    <span class="c">return pos;</span></div><div class="line" id="l605">                                }
</div><div class="line" id="l606">                                <span class="c">offs += 1;</span></div><div class="line" id="l607">                                <span class="c">if (lastHoleSize[mask] == 8)</span></div><div class="line" id="l608">                                { 
</div><div class="line" id="l609">                                    <span class="c">holeBitSize += 8;</span></div><div class="line" id="l610">                                } 
</div><div class="line" id="l611">                                else 
</div><div class="line" id="l612">                                { 
</div><div class="line" id="l613">                                    <span class="c">holeBitSize = lastHoleSize[mask];</span></div><div class="line" id="l614">                                }
</div><div class="line" id="l615">                            }
</div><div class="line" id="l616">                            <span class="c">if (startOffs == 0 &amp;&amp; holeBitSize == 0</span></div><div class="line" id="l617">                                &amp;&amp; spaceNeeded &lt; bitmapPageAvailableSpace[i]<span class="c">)</span></div><div class="line" id="l618">                            {
</div><div class="line" id="l619">                                <span class="c">bitmapPageAvailableSpace[i] = spaceNeeded;</span></div><div class="line" id="l620">                            }
</div><div class="line" id="l621">                            <span class="c">offs = 0;</span></div><div class="line" id="l622">                            <span class="c">pool.unfix(pg);</span></div><div class="line" id="l623">                        }
</div><div class="line" id="l624">                    }
</div><div class="line" id="l625">                    <span class="c">if (firstPage == 0)</span></div><div class="line" id="l626">                    { 
</div><div class="line" id="l627">                        <span class="c">if (freeBitmapPage &gt; i)</span></div><div class="line" id="l628">                        { 
</div><div class="line" id="l629">                            <span class="c">i = freeBitmapPage;</span></div><div class="line" id="l630">                            <span class="c">holeBitSize = holeBeforeFreePage;</span></div><div class="line" id="l631">                        }
</div><div class="line" id="l632">                        <span class="c">objBitSize -= holeBitSize;</span></div><div class="line" id="l633">                        // number of bits reserved for the object and aligned on page boundary
</div><div class="line" id="l634">                        <span class="c">int skip = (objBitSize + Page.pageSize/dbAllocationQuantum - 1)</span></div><div class="line" id="l635">                            &amp; ~(Page.pageSize/dbAllocationQuantum - 1)<span class="c">;</span></div><div class="line" id="l636">                        // page aligned position after allocated object
</div><div class="line" id="l637">                        <span class="c">pos = ((long)i &lt;&lt; dbBitmapSegmentBits) + ((long)skip &lt;&lt; dbAllocationQuantumBits);</span></div><div class="line" id="l638"><br></div><div class="line" id="l639">                        <span class="c">long extension = (size &gt; extensionQuantum) ? size : extensionQuantum;</span></div><div class="line" id="l640">                        <span class="c">int oldIndexSize = 0;</span></div><div class="line" id="l641">                        <span class="c">long oldIndex = 0;</span></div><div class="line" id="l642">                        <span class="c">int morePages = (int)((extension + Page.pageSize*(dbAllocationQuantum*8-1) - 1)</span></div><div class="line" id="l643">                            / (Page.pageSize*(dbAllocationQuantum*8-1)))<span class="c">;</span></div><div class="line" id="l644">                        <span class="c">if (i + morePages &gt; dbLargeBitmapPages)</span></div><div class="line" id="l645">                        { 
</div><div class="line" id="l646">                            <span class="c">throw new StorageError(StorageError.ErrorCode.NOT_ENOUGH_SPACE);</span></div><div class="line" id="l647">                        }
</div><div class="line" id="l648">                        <span class="c">if (i &lt;= dbBitmapPages &amp;&amp; i + morePages &gt; dbBitmapPages)</span></div><div class="line" id="l649">                        {   
</div><div class="line" id="l650">                            // We are out of space mapped by memory default allocation bitmap
</div><div class="line" id="l651">                            <span class="c">oldIndexSize = header.root[curr].indexSize;</span></div><div class="line" id="l652">                            <span class="c">if (oldIndexSize &lt;= currIndexSize + dbLargeBitmapPages - dbBitmapPages)</span></div><div class="line" id="l653">                            {
</div><div class="line" id="l654">                                <span class="c">int newIndexSize = oldIndexSize;</span></div><div class="line" id="l655">                                <span class="c">oldIndex = header.root[curr].index;</span></div><div class="line" id="l656">                                do 
</div><div class="line" id="l657">                                { 
</div><div class="line" id="l658">                                    <span class="c">newIndexSize &lt;&lt;= 1;</span></div><div class="line" id="l659">                                    <span class="c">if (newIndexSize &lt; 0)</span></div><div class="line" id="l660">                                    { 
</div><div class="line" id="l661">                                        <span class="c">newIndexSize = int.MaxValue &amp; ~(dbHandlesPerPage-1);</span></div><div class="line" id="l662">                                        <span class="c">if (newIndexSize &lt; currIndexSize + dbLargeBitmapPages - dbBitmapPages)</span></div><div class="line" id="l663">                                        {
</div><div class="line" id="l664">                                            <span class="c">throw new StorageError(StorageError.ErrorCode.NOT_ENOUGH_SPACE);</span></div><div class="line" id="l665">                                        }
</div><div class="line" id="l666">                                        break;
</div><div class="line" id="l667">                                    }
</div><div class="line" id="l668">                                } <span class="c">while (newIndexSize &lt;= currIndexSize + dbLargeBitmapPages - dbBitmapPages);</span></div><div class="line" id="l669"><br></div><div class="line" id="l670">                                <span class="c">if (size + newIndexSize*8L &gt; extensionQuantum)</span></div><div class="line" id="l671">                                { 
</div><div class="line" id="l672">                                    <span class="c">extension = size + newIndexSize*8L;</span></div><div class="line" id="l673">                                    <span class="c">morePages = (int)((extension + Page.pageSize*(dbAllocationQuantum*8-1) - 1)</span></div><div class="line" id="l674">                                        / (Page.pageSize*(dbAllocationQuantum*8-1)))<span class="c">;</span></div><div class="line" id="l675">                                }
</div><div class="line" id="l676">                                <span class="c">extend(pos + (long)morePages*Page.pageSize + newIndexSize*8L);</span></div><div class="line" id="l677">                                <span class="c">long newIndex = pos + (long)morePages*Page.pageSize;</span></div><div class="line" id="l678">                                <span class="c">fillBitmap(pos + (skip&gt;&gt;3) + (long)morePages * (Page.pageSize/dbAllocationQuantum/8),</span></div><div class="line" id="l679">                                    newIndexSize &gt;&gt; dbAllocationQuantumBits)<span class="c">;</span></div><div class="line" id="l680">                                <span class="c">pool.copy(newIndex, oldIndex, oldIndexSize*8L);</span></div><div class="line" id="l681">                                <span class="c">header.root[curr].index = newIndex;</span></div><div class="line" id="l682">                                <span class="c">header.root[curr].indexSize = newIndexSize;</span></div><div class="line" id="l683">                            }
</div><div class="line" id="l684">                            <span class="c">int[] newBitmapPageAvailableSpace = new int[dbLargeBitmapPages];</span></div><div class="line" id="l685">                            <span class="c">Array.Copy(bitmapPageAvailableSpace, 0, newBitmapPageAvailableSpace, 0, dbBitmapPages);</span></div><div class="line" id="l686">                            for (<span class="c">j = dbBitmapPages</span>; <span class="c">j &lt; dbLargeBitmapPages</span>; <span class="c">j++</span>)</div><div class="line" id="l687">                            { 
</div><div class="line" id="l688">                                <span class="c">newBitmapPageAvailableSpace[j] = int.MaxValue;</span></div><div class="line" id="l689">                            }
</div><div class="line" id="l690">                            <span class="c">bitmapPageAvailableSpace = newBitmapPageAvailableSpace;</span></div><div class="line" id="l691"><br></div><div class="line" id="l692">                            for (<span class="c">j = 0</span>; <span class="c">j &lt; dbLargeBitmapPages - dbBitmapPages</span>; <span class="c">j++</span>)</div><div class="line" id="l693">                            { 
</div><div class="line" id="l694">                                <span class="c">setPos(currIndexSize + j, dbFreeHandleFlag);</span></div><div class="line" id="l695">                            }
</div><div class="line" id="l696"><br></div><div class="line" id="l697">                            <span class="c">header.root[curr].bitmapExtent = currIndexSize;</span></div><div class="line" id="l698">                            <span class="c">header.root[curr].indexUsed = currIndexSize += dbLargeBitmapPages - dbBitmapPages;</span></div><div class="line" id="l699">                        }
</div><div class="line" id="l700">                        <span class="c">extend(pos + (long)morePages*Page.pageSize);</span></div><div class="line" id="l701">                        <span class="c">long adr = pos;</span></div><div class="line" id="l702">                        <span class="c">int len = objBitSize &gt;&gt; 3;</span></div><div class="line" id="l703">                        // fill bitmap pages used for allocation of object space with 0xFF 
</div><div class="line" id="l704">                        <span class="c">while (len &gt;= Page.pageSize)</span></div><div class="line" id="l705">                        { 
</div><div class="line" id="l706">                            <span class="c">pg = pool.putPage(adr);</span></div><div class="line" id="l707">                            <span class="c">memset(pg, 0, 0xFF, Page.pageSize);</span></div><div class="line" id="l708">                            <span class="c">pool.unfix(pg);</span></div><div class="line" id="l709">                            <span class="c">adr += Page.pageSize;</span></div><div class="line" id="l710">                            <span class="c">len -= Page.pageSize;</span></div><div class="line" id="l711">                        }
</div><div class="line" id="l712">                        // fill part of last page responsible for allocation of object space
</div><div class="line" id="l713">                        <span class="c">pg = pool.putPage(adr);</span></div><div class="line" id="l714">                        <span class="c">memset(pg, 0, 0xFF, len);</span></div><div class="line" id="l715">                        <span class="c">pg.data[len] = (byte)((1 &lt;&lt; (objBitSize&amp;7))-1);</span></div><div class="line" id="l716">                        <span class="c">pool.unfix(pg);</span></div><div class="line" id="l717"><br></div><div class="line" id="l718">                        // mark in bitmap newly allocated object
</div><div class="line" id="l719">                        <span class="c">fillBitmap(pos + (skip&gt;&gt;3), morePages * (Page.pageSize/dbAllocationQuantum/8));</span></div><div class="line" id="l720"><br></div><div class="line" id="l721">                        <span class="c">j = i;</span></div><div class="line" id="l722">                        <span class="c">while (--morePages &gt;= 0)</span></div><div class="line" id="l723">                        { 
</div><div class="line" id="l724">                            <span class="c">setPos(getBitmapPageId(j++), pos | dbPageObjectFlag | dbModifiedFlag);</span></div><div class="line" id="l725">                            <span class="c">pos += Page.pageSize;</span></div><div class="line" id="l726">                        }
</div><div class="line" id="l727">                        <span class="c">header.root[curr].bitmapEnd = j + dbBitmapId;</span></div><div class="line" id="l728">                        <span class="c">j = i + objBitSize / pageBits;</span></div><div class="line" id="l729">                        <span class="c">if (alignment != 0)</span></div><div class="line" id="l730">                        { 
</div><div class="line" id="l731">                            <span class="c">currRBitmapPage = j;</span></div><div class="line" id="l732">                            <span class="c">currRBitmapOffs = 0;</span></div><div class="line" id="l733">                        } 
</div><div class="line" id="l734">                        else 
</div><div class="line" id="l735">                        { 
</div><div class="line" id="l736">                            <span class="c">currPBitmapPage = j;</span></div><div class="line" id="l737">                            <span class="c">currPBitmapOffs = 0;</span></div><div class="line" id="l738">                        }
</div><div class="line" id="l739">                        <span class="c">while (j &gt; i)</span></div><div class="line" id="l740">                        { 
</div><div class="line" id="l741">                            <span class="c">bitmapPageAvailableSpace[--j] = 0;</span></div><div class="line" id="l742">                        }
</div><div class="line" id="l743"><br></div><div class="line" id="l744">                        <span class="c">pos = ((long)i*Page.pageSize*8 - holeBitSize)  &lt;&lt; dbAllocationQuantumBits;</span></div><div class="line" id="l745">                        <span class="c">if (oid != 0)</span></div><div class="line" id="l746">                        { 
</div><div class="line" id="l747">                            <span class="c">long prev = getPos(oid);</span></div><div class="line" id="l748">                            <span class="c">uint marker = (uint)prev &amp; dbFlagsMask;</span></div><div class="line" id="l749">                            <span class="c">pool.copy(pos, prev - marker, size);</span></div><div class="line" id="l750">                            <span class="c">setPos(oid, pos | marker | dbModifiedFlag);</span></div><div class="line" id="l751">                        }
</div><div class="line" id="l752"><br></div><div class="line" id="l753">                        <span class="c">if (holeBitSize != 0)</span></div><div class="line" id="l754">                        { 
</div><div class="line" id="l755">                            <span class="c">reserveLocation(pos, size);</span></div><div class="line" id="l756">                            <span class="c">while (holeBitSize &gt; pageBits)</span></div><div class="line" id="l757">                            { 
</div><div class="line" id="l758">                                <span class="c">holeBitSize -= pageBits;</span></div><div class="line" id="l759">                                <span class="c">pg = putBitmapPage(--i);</span></div><div class="line" id="l760">                                <span class="c">memset(pg, 0, 0xFF, Page.pageSize);</span></div><div class="line" id="l761">                                <span class="c">bitmapPageAvailableSpace[i] = 0;</span></div><div class="line" id="l762">                                <span class="c">pool.unfix(pg);</span></div><div class="line" id="l763">                            }
</div><div class="line" id="l764">                            <span class="c">pg = putBitmapPage(--i);</span></div><div class="line" id="l765">                            <span class="c">offs = Page.pageSize;</span></div><div class="line" id="l766">                            <span class="c">while ((holeBitSize -= 8) &gt; 0)</span></div><div class="line" id="l767">                            { 
</div><div class="line" id="l768">                                <span class="c">pg.data[--offs] = (byte)0xFF;</span></div><div class="line" id="l769">                            }
</div><div class="line" id="l770">                            <span class="c">pg.data[offs-1] |= (byte)~((1 &lt;&lt; -holeBitSize) - 1);</span></div><div class="line" id="l771">                            <span class="c">pool.unfix(pg);</span></div><div class="line" id="l772">                            <span class="c">commitLocation();</span></div><div class="line" id="l773">                        }
</div><div class="line" id="l774">                        <span class="c">if (oldIndex != 0)</span></div><div class="line" id="l775">                        { 
</div><div class="line" id="l776">                            <span class="c">free(oldIndex, oldIndexSize*8L);</span></div><div class="line" id="l777">                        }
</div><div class="line" id="l778">                        <span class="c">return pos;</span></div><div class="line" id="l779">                    }
</div><div class="line" id="l780">                    <span class="c">if (gcThreshold != Int64.MaxValue &amp;&amp; !gcDone)</span></div><div class="line" id="l781">                    {
</div><div class="line" id="l782">                        <span class="c">allocatedDelta -= size;</span></div><div class="line" id="l783">                        <span class="c">usedSize -= size;</span></div><div class="line" id="l784">                        <span class="c">gc0();</span></div><div class="line" id="l785">                        <span class="c">currRBitmapPage = currPBitmapPage = 0;</span></div><div class="line" id="l786">                        <span class="c">currRBitmapOffs = currPBitmapOffs = 0;</span></div><div class="line" id="l787">                        <span class="c">return allocate(size, oid);</span></div><div class="line" id="l788">                    }
</div><div class="line" id="l789">                    <span class="c">freeBitmapPage = i;</span></div><div class="line" id="l790">                    <span class="c">holeBeforeFreePage = holeBitSize;</span></div><div class="line" id="l791">                    <span class="c">holeBitSize = 0;</span></div><div class="line" id="l792">                    <span class="c">lastPage = firstPage + 1;</span></div><div class="line" id="l793">                    <span class="c">firstPage = 0;</span></div><div class="line" id="l794">                    <span class="c">offs = 0;</span></div><div class="line" id="l795">                }
</div><div class="line" id="l796">            }
</div><div class="line" id="l797">        <span class="c">}</span></div><div class="line" id="l798"><br></div><div class="line" id="l799">        void fillBitmap(long adr, int len) 
</div><div class="line" id="l800">        { 
</div><div class="line" id="l801">            while (true) 
</div><div class="line" id="l802">            { 
</div><div class="line" id="l803">                int off = (int)adr &amp; (Page.pageSize-1);
</div><div class="line" id="l804">                Page pg = pool.putPage(adr - off);
</div><div class="line" id="l805">                if (Page.pageSize - off &gt;= len) 
</div><div class="line" id="l806">                { 
</div><div class="line" id="l807">                    memset(pg, off, 0xFF, len);
</div><div class="line" id="l808">                    pool.unfix(pg);
</div><div class="line" id="l809">                    break;
</div><div class="line" id="l810">                } 
</div><div class="line" id="l811">                else 
</div><div class="line" id="l812">                { 
</div><div class="line" id="l813">                    memset(pg, off, 0xFF, Page.pageSize - off);
</div><div class="line" id="l814">                    pool.unfix(pg);
</div><div class="line" id="l815">                    adr += Page.pageSize - off;
</div><div class="line" id="l816">                    len -= Page.pageSize - off;
</div><div class="line" id="l817">                }
</div><div class="line" id="l818">            }
</div><div class="line" id="l819">        }
</div><div class="line" id="l820"><br></div><div class="line" id="l821">        internal void free(long pos, long size)
</div><div class="line" id="l822">        {
</div><div class="line" id="l823">            <span class="c">lock (objectCache)</span></div><div class="line" id="l824">            {
</div><div class="line" id="l825">                Debug.Assert(pos != 0 &amp;&amp; (pos &amp; (dbAllocationQuantum - 1)) == 0);
</div><div class="line" id="l826">                <span class="c">long quantNo = pos &gt;&gt; dbAllocationQuantumBits;</span></div><div class="line" id="l827">                <span class="c">int objBitSize = (int)((size+dbAllocationQuantum-1) &gt;&gt; dbAllocationQuantumBits);</span></div><div class="line" id="l828">                <span class="c">int pageId = (int) (quantNo &gt;&gt; (Page.pageBits + 3));</span></div><div class="line" id="l829">                <span class="c">int offs = (int) (quantNo &amp; (Page.pageSize * 8 - 1)) &gt;&gt; 3;</span></div><div class="line" id="l830">                <span class="c">Page pg = putBitmapPage(pageId);</span></div><div class="line" id="l831">                <span class="c">int bitOffs = (int) quantNo &amp; 7;</span></div><div class="line" id="l832"><br></div><div class="line" id="l833">                <span class="c">allocatedDelta -= (long)objBitSize &lt;&lt; dbAllocationQuantumBits;</span></div><div class="line" id="l834">                <span class="c">usedSize -= (long)objBitSize &lt;&lt; dbAllocationQuantumBits;</span></div><div class="line" id="l835"><br></div><div class="line" id="l836">                <span class="c">if ((pos &amp; (Page.pageSize - 1)) == 0 &amp;&amp; size &gt;= Page.pageSize)</span></div><div class="line" id="l837">                {
</div><div class="line" id="l838">                    <span class="c">if (pageId == currPBitmapPage &amp;&amp; offs &lt; currPBitmapOffs)</span></div><div class="line" id="l839">                    {
</div><div class="line" id="l840">                        <span class="c">currPBitmapOffs = offs;</span></div><div class="line" id="l841">                    }
</div><div class="line" id="l842">                }
</div><div class="line" id="l843">                <span class="c">if (pageId == currRBitmapPage &amp;&amp; offs &lt; currRBitmapOffs)</span></div><div class="line" id="l844">                {
</div><div class="line" id="l845">                    <span class="c">currRBitmapOffs = offs;</span></div><div class="line" id="l846">                }
</div><div class="line" id="l847">                <span class="c">bitmapPageAvailableSpace[pageId] = System.Int32.MaxValue;</span></div><div class="line" id="l848"><br></div><div class="line" id="l849">                <span class="c">if (objBitSize &gt; 8 - bitOffs)</span></div><div class="line" id="l850">                {
</div><div class="line" id="l851">                    <span class="c">objBitSize -= 8 - bitOffs;</span></div><div class="line" id="l852">                    <span class="c">pg.data[offs++] &amp;= (byte)((1 &lt;&lt; bitOffs) - 1);</span></div><div class="line" id="l853">                    <span class="c">while (objBitSize + offs * 8 &gt; Page.pageSize * 8)</span></div><div class="line" id="l854">                    {
</div><div class="line" id="l855">                        <span class="c">memset(pg, offs, 0, Page.pageSize - offs);</span></div><div class="line" id="l856">                        <span class="c">pool.unfix(pg);</span></div><div class="line" id="l857">                        <span class="c">pg = putBitmapPage(++pageId);</span></div><div class="line" id="l858">                        <span class="c">bitmapPageAvailableSpace[pageId] = System.Int32.MaxValue;</span></div><div class="line" id="l859">                        <span class="c">objBitSize -= (Page.pageSize - offs) * 8;</span></div><div class="line" id="l860">                        <span class="c">offs = 0;</span></div><div class="line" id="l861">                    }
</div><div class="line" id="l862">                    <span class="c">while ((objBitSize -= 8) &gt; 0)</span></div><div class="line" id="l863">                    {
</div><div class="line" id="l864">                        <span class="c">pg.data[offs++] = (byte) 0;</span></div><div class="line" id="l865">                    }
</div><div class="line" id="l866">                    <span class="c">pg.data[offs] &amp;= (byte) (~ ((1 &lt;&lt; (objBitSize + 8)) - 1));</span></div><div class="line" id="l867">                }
</div><div class="line" id="l868">                else
</div><div class="line" id="l869">                {
</div><div class="line" id="l870">                    <span class="c">pg.data[offs] &amp;= (byte) (~ (((1 &lt;&lt; objBitSize) - 1) &lt;&lt; bitOffs));</span></div><div class="line" id="l871">                }
</div><div class="line" id="l872">                <span class="c">pool.unfix(pg);</span></div><div class="line" id="l873">            }
</div><div class="line" id="l874">        <span class="c">}</span></div><div class="line" id="l875"><br></div><div class="line" id="l876">        internal void cloneBitmap(long pos, long size)
</div><div class="line" id="l877">        {
</div><div class="line" id="l878">            <span class="c">lock (objectCache)</span></div><div class="line" id="l879">            {
</div><div class="line" id="l880">                <span class="c">long quantNo = pos &gt;&gt; dbAllocationQuantumBits;</span></div><div class="line" id="l881">                <span class="c">int  objBitSize = (int)((size + dbAllocationQuantum - 1) &gt;&gt; dbAllocationQuantumBits);</span></div><div class="line" id="l882">                <span class="c">int  pageId = (int)(quantNo &gt;&gt; (Page.pageBits + 3));</span></div><div class="line" id="l883">                <span class="c">int  offs = (int) (quantNo &amp; (Page.pageSize * 8 - 1)) &gt;&gt; 3;</span></div><div class="line" id="l884">                <span class="c">int  bitOffs = (int) quantNo &amp; 7;</span></div><div class="line" id="l885">                <span class="c">int  oid = getBitmapPageId(pageId);</span></div><div class="line" id="l886">                <span class="c">pos = getPos(oid);</span></div><div class="line" id="l887">                <span class="c">if ((pos &amp; dbModifiedFlag) == 0)</span></div><div class="line" id="l888">                {
</div><div class="line" id="l889">                    <span class="c">dirtyPagesMap[oid &gt;&gt; (dbHandlesPerPageBits + 5)]</span></div><div class="line" id="l890">                        |= 1 &lt;&lt; ((oid &gt;&gt; dbHandlesPerPageBits) &amp; 31)<span class="c">;</span></div><div class="line" id="l891">                    <span class="c">allocate(Page.pageSize, oid);</span></div><div class="line" id="l892">                    <span class="c">cloneBitmap(pos &amp; ~ dbFlagsMask, Page.pageSize);</span></div><div class="line" id="l893">                }
</div><div class="line" id="l894"><br></div><div class="line" id="l895">                <span class="c">if (objBitSize &gt; 8 - bitOffs)</span></div><div class="line" id="l896">                {
</div><div class="line" id="l897">                    <span class="c">objBitSize -= 8 - bitOffs;</span></div><div class="line" id="l898">                    <span class="c">offs += 1;</span></div><div class="line" id="l899">                    <span class="c">while (objBitSize + offs * 8 &gt; Page.pageSize * 8)</span></div><div class="line" id="l900">                    {
</div><div class="line" id="l901">                        <span class="c">oid = getBitmapPageId(++pageId);</span></div><div class="line" id="l902">                        <span class="c">pos = getPos(oid);</span></div><div class="line" id="l903">                        <span class="c">if ((pos &amp; dbModifiedFlag) == 0)</span></div><div class="line" id="l904">                        {
</div><div class="line" id="l905">                            <span class="c">dirtyPagesMap[oid &gt;&gt; (dbHandlesPerPageBits + 5)]</span></div><div class="line" id="l906">                                |= 1 &lt;&lt; ((oid &gt;&gt; dbHandlesPerPageBits) &amp; 31)<span class="c">;</span></div><div class="line" id="l907">                            <span class="c">allocate(Page.pageSize, oid);</span></div><div class="line" id="l908">                            <span class="c">cloneBitmap(pos &amp; ~ dbFlagsMask, Page.pageSize);</span></div><div class="line" id="l909">                        }
</div><div class="line" id="l910">                        <span class="c">objBitSize -= (Page.pageSize - offs) * 8;</span></div><div class="line" id="l911">                        <span class="c">offs = 0;</span></div><div class="line" id="l912">                    }
</div><div class="line" id="l913">                }
</div><div class="line" id="l914">            }
</div><div class="line" id="l915">        <span class="c">}</span></div><div class="line" id="l916"><br></div><div class="line" id="l917">        public void Open(String filePath)
</div><div class="line" id="l918">        {
</div><div class="line" id="l919">            <span class="c">Open(filePath, DEFAULT_PAGE_POOL_SIZE);</span></div><div class="line" id="l920">        <span class="c">}</span></div><div class="line" id="l921"><br></div><div class="line" id="l922">        public void Open(IFile file)
</div><div class="line" id="l923">        {
</div><div class="line" id="l924">            Open(file, DEFAULT_PAGE_POOL_SIZE);
</div><div class="line" id="l925">        }
</div><div class="line" id="l926"><br></div><div class="line" id="l927">        public void Open(String filePath, int pagePoolSize)
</div><div class="line" id="l928">        {
</div><div class="line" id="l929">            <span class="c">OSFile file = new OSFile(filePath, readOnly, noFlush);</span></div><div class="line" id="l930">            try 
</div><div class="line" id="l931">            {
</div><div class="line" id="l932">                <span class="c">Open(file, pagePoolSize);</span></div><div class="line" id="l933">            } 
</div><div class="line" id="l934">            <span class="c">catch (StorageError)</span></div><div class="line" id="l935">            {
</div><div class="line" id="l936">                <span class="c">file.Close();</span></div><div class="line" id="l937">                <span class="c">throw;</span></div><div class="line" id="l938">            }
</div><div class="line" id="l939">        <span class="c">}</span></div><div class="line" id="l940"><br></div><div class="line" id="l941">        protected virtual OidHashTable createObjectCache(CacheType kind, int pagePoolSize, int objectCacheSize) 
</div><div class="line" id="l942">        { 
</div><div class="line" id="l943">            <span class="c">if (pagePoolSize == 0 || kind == CacheType.Strong)</span></div><div class="line" id="l944">            {
</div><div class="line" id="l945">                <span class="c">return new StrongHashTable(objectCacheSize);</span></div><div class="line" id="l946">            }
</div><div class="line" id="l947">            <span class="c">if (kind == CacheType.Weak)</span></div><div class="line" id="l948">            { 
</div><div class="line" id="l949">                <span class="c">return new WeakHashTable(objectCacheSize);</span></div><div class="line" id="l950">            }
</div><div class="line" id="l951">            Debug.Assert(kind == CacheType.Lru);
</div><div class="line" id="l952">            <span class="c">return new LruObjectCache(objectCacheSize);</span></div><div class="line" id="l953">        }
</div><div class="line" id="l954"><br></div><div class="line" id="l955">        public void Open(String filePath, int pagePoolSize, String cipherKey)
</div><div class="line" id="l956">        {
</div><div class="line" id="l957">            Rc4File file = new Rc4File(filePath, readOnly, noFlush, cipherKey);      
</div><div class="line" id="l958">            try 
</div><div class="line" id="l959">            {
</div><div class="line" id="l960">                Open(file, pagePoolSize);
</div><div class="line" id="l961">            } 
</div><div class="line" id="l962">            catch (StorageError) 
</div><div class="line" id="l963">            {
</div><div class="line" id="l964">                file.Close();            
</div><div class="line" id="l965">                throw;
</div><div class="line" id="l966">            }
</div><div class="line" id="l967">        }
</div><div class="line" id="l968"><br></div><div class="line" id="l969">        public virtual void Open(IFile file, int pagePoolSize)
</div><div class="line" id="l970">        {
</div><div class="line" id="l971">            <span class="c">lock (this)</span></div><div class="line" id="l972">            {
</div><div class="line" id="l973">                <span class="c">if (opened)</span></div><div class="line" id="l974">                {
</div><div class="line" id="l975">                    <span class="c">throw new StorageError(StorageError.ErrorCode.STORAGE_ALREADY_OPENED);</span></div><div class="line" id="l976">                }
</div><div class="line" id="l977">                <span class="c">file.Lock();</span></div><div class="line" id="l978">                Page pg;
</div><div class="line" id="l979">                int i;
</div><div class="line" id="l980">                <span class="c">int indexSize = initIndexSize;</span></div><div class="line" id="l981">                <span class="c">if (indexSize &lt; dbFirstUserId)</span></div><div class="line" id="l982">                {
</div><div class="line" id="l983">                    <span class="c">indexSize = dbFirstUserId;</span></div><div class="line" id="l984">                }
</div><div class="line" id="l985">                <span class="c">indexSize = (indexSize + dbHandlesPerPage - 1) &amp; ~ (dbHandlesPerPage - 1);</span></div><div class="line" id="l986"><br></div><div class="line" id="l987">                <span class="c">dirtyPagesMap = new int[dbDirtyPageBitmapSize / 4 + 1];</span></div><div class="line" id="l988">                <span class="c">gcThreshold = Int64.MaxValue;</span></div><div class="line" id="l989">                <span class="c">backgroundGcMonitor = new object();</span></div><div class="line" id="l990">                <span class="c">backgroundGcStartMonitor = new object();</span></div><div class="line" id="l991">                <span class="c">gcThread = null;</span></div><div class="line" id="l992">                <span class="c">gcGo = false;</span></div><div class="line" id="l993">                <span class="c">gcActive = false;</span></div><div class="line" id="l994">                <span class="c">gcDone = false;</span></div><div class="line" id="l995">                <span class="c">allocatedDelta = 0;</span></div><div class="line" id="l996"><br></div><div class="line" id="l997">                <span class="c">resolvedTypes = new Hashtable();</span></div><div class="line" id="l998"><br></div><div class="line" id="l999">                <span class="c">nNestedTransactions = 0;</span></div><div class="line" id="l1000">                <span class="c">nBlockedTransactions = 0;</span></div><div class="line" id="l1001">                <span class="c">nCommittedTransactions = 0;</span></div><div class="line" id="l1002">                <span class="c">scheduledCommitTime = Int64.MaxValue;</span></div><div class="line" id="l1003">#if COMPACT_NET_FRAMEWORK
</div><div class="line" id="l1004">                transactionMonitor = new CNetMonitor();
</div><div class="line" id="l1005">#else
</div><div class="line" id="l1006">                <span class="c">transactionMonitor = new object();</span></div><div class="line" id="l1007">#endif
</div><div class="line" id="l1008">                <span class="c">transactionLock = new PersistentResource();</span></div><div class="line" id="l1009"><br></div><div class="line" id="l1010">                <span class="c">modified = false;</span></div><div class="line" id="l1011"><br></div><div class="line" id="l1012">                <span class="c">objectCache =  createObjectCache(cacheKind, pagePoolSize, objectCacheInitSize);</span></div><div class="line" id="l1013"><br></div><div class="line" id="l1014">                <span class="c">classDescMap = new Hashtable();</span></div><div class="line" id="l1015">                <span class="c">descList = null;</span></div><div class="line" id="l1016"><br></div><div class="line" id="l1017">#if SUPPORT_RAW_TYPE
</div><div class="line" id="l1018">                <span class="c">objectFormatter = new System.Runtime.Serialization.Formatters.Binary.BinaryFormatter();</span></div><div class="line" id="l1019">#endif                
</div><div class="line" id="l1020">                <span class="c">header = new Header();</span></div><div class="line" id="l1021">                <span class="c">byte[] buf = new byte[Header.Sizeof];</span></div><div class="line" id="l1022">                <span class="c">int rc = file.Read(0, buf);</span></div><div class="line" id="l1023">                <span class="c">if (rc &gt; 0 &amp;&amp; rc &lt; Header.Sizeof)</span></div><div class="line" id="l1024">                {
</div><div class="line" id="l1025">                    <span class="c">throw new StorageError(StorageError.ErrorCode.DATABASE_CORRUPTED);</span></div><div class="line" id="l1026">                }
</div><div class="line" id="l1027">                <span class="c">header.unpack(buf);</span></div><div class="line" id="l1028">                <span class="c">if (header.curr &lt; 0 || header.curr &gt; 1)</span></div><div class="line" id="l1029">                {
</div><div class="line" id="l1030">                    <span class="c">throw new StorageError(StorageError.ErrorCode.DATABASE_CORRUPTED);</span></div><div class="line" id="l1031">                }
</div><div class="line" id="l1032">                <span class="c">if (pool == null)</span></div><div class="line" id="l1033">                {
</div><div class="line" id="l1034">                    <span class="c">pool = new PagePool(pagePoolSize / Page.pageSize);</span></div><div class="line" id="l1035">                    <span class="c">pool.open(file);</span></div><div class="line" id="l1036">                }
</div><div class="line" id="l1037">                <span class="c">if (!header.initialized)</span></div><div class="line" id="l1038">                {
</div><div class="line" id="l1039">                    <span class="c">header.curr = currIndex = 0;</span></div><div class="line" id="l1040">                    <span class="c">long used = Page.pageSize;</span></div><div class="line" id="l1041">                    <span class="c">header.root[0].index = used;</span></div><div class="line" id="l1042">                    <span class="c">header.root[0].indexSize = indexSize;</span></div><div class="line" id="l1043">                    <span class="c">header.root[0].indexUsed = dbFirstUserId;</span></div><div class="line" id="l1044">                    <span class="c">header.root[0].freeList = 0;</span></div><div class="line" id="l1045">                    <span class="c">used += indexSize * 8L;</span></div><div class="line" id="l1046">                    <span class="c">header.root[1].index = used;</span></div><div class="line" id="l1047">                    <span class="c">header.root[1].indexSize = indexSize;</span></div><div class="line" id="l1048">                    <span class="c">header.root[1].indexUsed = dbFirstUserId;</span></div><div class="line" id="l1049">                    <span class="c">header.root[1].freeList = 0;</span></div><div class="line" id="l1050">                    <span class="c">used += indexSize * 8L;</span></div><div class="line" id="l1051"><br></div><div class="line" id="l1052">                    <span class="c">header.root[0].shadowIndex = header.root[1].index;</span></div><div class="line" id="l1053">                    <span class="c">header.root[1].shadowIndex = header.root[0].index;</span></div><div class="line" id="l1054">                    <span class="c">header.root[0].shadowIndexSize = indexSize;</span></div><div class="line" id="l1055">                    <span class="c">header.root[1].shadowIndexSize = indexSize;</span></div><div class="line" id="l1056"><br></div><div class="line" id="l1057">                    <span class="c">int bitmapPages = (int) ((used + Page.pageSize * (dbAllocationQuantum * 8 - 1) - 1) / (Page.pageSize * (dbAllocationQuantum * 8 - 1)));</span></div><div class="line" id="l1058">                    <span class="c">long bitmapSize = (long)bitmapPages * Page.pageSize;</span></div><div class="line" id="l1059">                    <span class="c">int usedBitmapSize = (int) ((used + bitmapSize) &gt;&gt; (dbAllocationQuantumBits + 3));</span></div><div class="line" id="l1060"><br></div><div class="line" id="l1061">                    for (<span class="c">i = 0</span>; <span class="c">i &lt; bitmapPages</span>; <span class="c">i++</span>)</div><div class="line" id="l1062">                    { 
</div><div class="line" id="l1063">                        <span class="c">pg = pool.putPage(used + (long)i*Page.pageSize);</span></div><div class="line" id="l1064">                        <span class="c">byte[] bitmap = pg.data;</span></div><div class="line" id="l1065">                        <span class="c">int n = usedBitmapSize &gt; Page.pageSize ? Page.pageSize : usedBitmapSize;</span></div><div class="line" id="l1066">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; n</span>; <span class="c">j++</span>)</div><div class="line" id="l1067">                        { 
</div><div class="line" id="l1068">                            <span class="c">bitmap[j] = (byte)0xFF;</span></div><div class="line" id="l1069">                        }
</div><div class="line" id="l1070">                        <span class="c">pool.unfix(pg);</span></div><div class="line" id="l1071">                    }
</div><div class="line" id="l1072"><br></div><div class="line" id="l1073">                    <span class="c">int bitmapIndexSize = ((dbBitmapId + dbBitmapPages) * 8 + Page.pageSize - 1) &amp; ~ (Page.pageSize - 1);</span></div><div class="line" id="l1074">                    <span class="c">byte[] index = new byte[bitmapIndexSize];</span></div><div class="line" id="l1075">                    <span class="c">Bytes.pack8(index, dbInvalidId * 8, dbFreeHandleFlag);</span></div><div class="line" id="l1076">                    for (<span class="c">i = 0</span>; <span class="c">i &lt; bitmapPages</span>; <span class="c">i++</span>)</div><div class="line" id="l1077">                    {
</div><div class="line" id="l1078">                        <span class="c">Bytes.pack8(index, (dbBitmapId + i) * 8, used | dbPageObjectFlag);</span></div><div class="line" id="l1079">                        <span class="c">used += Page.pageSize;</span></div><div class="line" id="l1080">                    }
</div><div class="line" id="l1081">                    <span class="c">header.root[0].bitmapEnd = dbBitmapId + i;</span></div><div class="line" id="l1082">                    <span class="c">header.root[1].bitmapEnd = dbBitmapId + i;</span></div><div class="line" id="l1083">                    <span class="c">while (i &lt; dbBitmapPages)</span></div><div class="line" id="l1084">                    {
</div><div class="line" id="l1085">                        <span class="c">Bytes.pack8(index, (dbBitmapId + i) * 8, dbFreeHandleFlag);</span></div><div class="line" id="l1086">                        <span class="c">i += 1;</span></div><div class="line" id="l1087">                    }
</div><div class="line" id="l1088">                    <span class="c">header.root[0].size = used;</span></div><div class="line" id="l1089">                    <span class="c">header.root[1].size = used;</span></div><div class="line" id="l1090">                    <span class="c">usedSize = used;</span></div><div class="line" id="l1091">                    <span class="c">committedIndexSize = currIndexSize = dbFirstUserId;</span></div><div class="line" id="l1092"><br></div><div class="line" id="l1093">                    <span class="c">pool.write(header.root[1].index, index);</span></div><div class="line" id="l1094">                    <span class="c">pool.write(header.root[0].index, index);</span></div><div class="line" id="l1095"><br></div><div class="line" id="l1096">                    <span class="c">header.dirty = true;</span></div><div class="line" id="l1097">                    <span class="c">header.root[0].size = header.root[1].size;</span></div><div class="line" id="l1098">                    <span class="c">pg = pool.putPage(0);</span></div><div class="line" id="l1099">                    <span class="c">header.pack(pg.data);</span></div><div class="line" id="l1100">                    <span class="c">pool.flush();</span></div><div class="line" id="l1101">                    <span class="c">pool.modify(pg);</span></div><div class="line" id="l1102">                    <span class="c">header.initialized = true;</span></div><div class="line" id="l1103">                    <span class="c">header.pack(pg.data);</span></div><div class="line" id="l1104">                    <span class="c">pool.unfix(pg);</span></div><div class="line" id="l1105">                    <span class="c">pool.flush();</span></div><div class="line" id="l1106">                }
</div><div class="line" id="l1107">                else
</div><div class="line" id="l1108">                {
</div><div class="line" id="l1109">                    <span class="c">int curr = header.curr;</span></div><div class="line" id="l1110">                    <span class="c">currIndex = curr;</span></div><div class="line" id="l1111">                    <span class="c">if (header.root[curr].indexSize != header.root[curr].shadowIndexSize)</span></div><div class="line" id="l1112">                    {
</div><div class="line" id="l1113">                        <span class="c">throw new StorageError(StorageError.ErrorCode.DATABASE_CORRUPTED);</span></div><div class="line" id="l1114">                    }
</div><div class="line" id="l1115">                    <span class="c">if (isDirty())</span></div><div class="line" id="l1116">                    {
</div><div class="line" id="l1117">                        <span class="c">if (listener != null)</span></div><div class="line" id="l1118">                        {
</div><div class="line" id="l1119">                            <span class="c">listener.DatabaseCorrupted();</span></div><div class="line" id="l1120">                        }
</div><div class="line" id="l1121">                        <span class="c">System.Console.WriteLine("Database was not normally closed: start recovery");</span></div><div class="line" id="l1122">                        <span class="c">header.root[1-curr].size = header.root[curr].size;</span></div><div class="line" id="l1123">                        <span class="c">header.root[1-curr].indexUsed = header.root[curr].indexUsed;</span></div><div class="line" id="l1124">                        <span class="c">header.root[1-curr].freeList = header.root[curr].freeList;</span></div><div class="line" id="l1125">                        <span class="c">header.root[1-curr].index = header.root[curr].shadowIndex;</span></div><div class="line" id="l1126">                        <span class="c">header.root[1-curr].indexSize = header.root[curr].shadowIndexSize;</span></div><div class="line" id="l1127">                        <span class="c">header.root[1-curr].shadowIndex = header.root[curr].index;</span></div><div class="line" id="l1128">                        <span class="c">header.root[1-curr].shadowIndexSize = header.root[curr].indexSize;</span></div><div class="line" id="l1129">                        <span class="c">header.root[1-curr].bitmapEnd = header.root[curr].bitmapEnd;</span></div><div class="line" id="l1130">                        <span class="c">header.root[1-curr].rootObject = header.root[curr].rootObject;</span></div><div class="line" id="l1131">                        <span class="c">header.root[1-curr].classDescList = header.root[curr].classDescList;</span></div><div class="line" id="l1132">                        <span class="c">header.root[1-curr].bitmapExtent = header.root[curr].bitmapExtent;</span></div><div class="line" id="l1133"><br></div><div class="line" id="l1134">                        <span class="c">pg = pool.putPage(0);</span></div><div class="line" id="l1135">                        <span class="c">header.pack(pg.data);</span></div><div class="line" id="l1136">                        <span class="c">pool.unfix(pg);</span></div><div class="line" id="l1137"><br></div><div class="line" id="l1138">                        <span class="c">pool.copy(header.root[1-curr].index,</span></div><div class="line" id="l1139"><span class="c">                                  header.root[curr].index,</span></div><div class="line" id="l1140">                                  (header.root[curr].indexUsed * 8L + Page.pageSize - 1) &amp; ~ (Page.pageSize - 1))<span class="c">;</span></div><div class="line" id="l1141">                        <span class="c">if (listener != null)</span></div><div class="line" id="l1142">                        {
</div><div class="line" id="l1143">                            <span class="c">listener.RecoveryCompleted();</span></div><div class="line" id="l1144">                        }
</div><div class="line" id="l1145">                        <span class="c">System.Console.WriteLine("Recovery completed");</span></div><div class="line" id="l1146">                    }
</div><div class="line" id="l1147">                    <span class="c">currIndexSize = header.root[1-curr].indexUsed;</span></div><div class="line" id="l1148">                    <span class="c">committedIndexSize = currIndexSize;</span></div><div class="line" id="l1149">                    <span class="c">usedSize = header.root[curr].size;</span></div><div class="line" id="l1150">                }
</div><div class="line" id="l1151">                <span class="c">int nBitmapPages = header.root[1-currIndex].bitmapExtent == 0 ? dbBitmapPages : dbLargeBitmapPages;</span></div><div class="line" id="l1152">                <span class="c">bitmapPageAvailableSpace = new int[nBitmapPages];</span></div><div class="line" id="l1153">                for (<span class="c">i = 0</span>; <span class="c">i &lt; bitmapPageAvailableSpace.Length</span>; <span class="c">i++</span>)</div><div class="line" id="l1154">                { 
</div><div class="line" id="l1155">                    <span class="c">bitmapPageAvailableSpace[i] = int.MaxValue;</span></div><div class="line" id="l1156">                }        
</div><div class="line" id="l1157">                <span class="c">currRBitmapPage = currPBitmapPage = 0;</span></div><div class="line" id="l1158">                <span class="c">currRBitmapOffs = currPBitmapOffs = 0;</span></div><div class="line" id="l1159"><br></div><div class="line" id="l1160">                <span class="c">opened = true;</span></div><div class="line" id="l1161">                <span class="c">reloadScheme();</span></div><div class="line" id="l1162">            }
</div><div class="line" id="l1163">        <span class="c">}</span></div><div class="line" id="l1164"><br></div><div class="line" id="l1165">        public bool IsOpened() 
</div><div class="line" id="l1166">        { 
</div><div class="line" id="l1167">            return opened;
</div><div class="line" id="l1168">        }
</div><div class="line" id="l1169"><br></div><div class="line" id="l1170">        internal static void  checkIfFinal(ClassDescriptor desc)
</div><div class="line" id="l1171">        {
</div><div class="line" id="l1172">            <span class="c">System.Type cls = desc.cls;</span></div><div class="line" id="l1173">            for (<span class="c">ClassDescriptor next = desc.next;</span> <span class="c">next != null</span>; <span class="c">next = next.next</span>)</div><div class="line" id="l1174">            {
</div><div class="line" id="l1175">                <span class="c">next.Load();</span></div><div class="line" id="l1176">                <span class="c">if (cls.IsAssignableFrom(next.cls))</span></div><div class="line" id="l1177">                {
</div><div class="line" id="l1178">                    <span class="c">desc.hasSubclasses = true;</span></div><div class="line" id="l1179">                }
</div><div class="line" id="l1180">                else <span class="c">if (next.cls.IsAssignableFrom(cls))</span></div><div class="line" id="l1181">                {
</div><div class="line" id="l1182">                    <span class="c">next.hasSubclasses = true;</span></div><div class="line" id="l1183">                }
</div><div class="line" id="l1184">            }
</div><div class="line" id="l1185">        <span class="c">}</span></div><div class="line" id="l1186"><br></div><div class="line" id="l1187">        internal void  reloadScheme()
</div><div class="line" id="l1188">        {
</div><div class="line" id="l1189">            <span class="c">classDescMap.Clear();</span></div><div class="line" id="l1190">            <span class="c">int descListOid = header.root[1-currIndex].classDescList;</span></div><div class="line" id="l1191">            <span class="c">classDescMap[typeof(ClassDescriptor)] = new ClassDescriptor(this, typeof(ClassDescriptor));</span></div><div class="line" id="l1192">            <span class="c">classDescMap[typeof(ClassDescriptor.FieldDescriptor)] = new ClassDescriptor(this, typeof(ClassDescriptor.FieldDescriptor));</span></div><div class="line" id="l1193">            <span class="c">if (descListOid != 0)</span></div><div class="line" id="l1194">            {
</div><div class="line" id="l1195">                ClassDescriptor desc;
</div><div class="line" id="l1196">                <span class="c">descList = findClassDescriptor(descListOid);</span></div><div class="line" id="l1197">                for (<span class="c">desc = descList</span>; <span class="c">desc != null</span>; <span class="c">desc = desc.next</span>)</div><div class="line" id="l1198">                {
</div><div class="line" id="l1199">                    <span class="c">desc.Load();</span></div><div class="line" id="l1200">                }
</div><div class="line" id="l1201">                for (<span class="c">desc = descList</span>; <span class="c">desc != null</span>; <span class="c">desc = desc.next</span>)</div><div class="line" id="l1202">                {
</div><div class="line" id="l1203">                    <span class="c">if (classDescMap[desc.cls] == desc)</span></div><div class="line" id="l1204">                    { 
</div><div class="line" id="l1205">                        <span class="c">desc.resolve();</span></div><div class="line" id="l1206">                    }
</div><div class="line" id="l1207">                    <span class="c">checkIfFinal(desc);</span></div><div class="line" id="l1208">                }
</div><div class="line" id="l1209">            }
</div><div class="line" id="l1210">            else
</div><div class="line" id="l1211">            {
</div><div class="line" id="l1212">                <span class="c">descList = null;</span></div><div class="line" id="l1213">            }
</div><div class="line" id="l1214">#if !COMPACT_NET_FRAMEWORK
</div><div class="line" id="l1215">            <span class="c">if (enableCodeGeneration)</span></div><div class="line" id="l1216">            { 
</div><div class="line" id="l1217">                <span class="c">codeGenerationThread = new Thread(new ThreadStart(generateSerializers));</span></div><div class="line" id="l1218">                <span class="c">codeGenerationThread.Priority = ThreadPriority.BelowNormal;</span></div><div class="line" id="l1219">                <span class="c">codeGenerationThread.IsBackground = true;</span></div><div class="line" id="l1220">                <span class="c">codeGenerationThread.Start();</span></div><div class="line" id="l1221">            }
</div><div class="line" id="l1222">#endif
</div><div class="line" id="l1223">        <span class="c">}</span></div><div class="line" id="l1224"><br></div><div class="line" id="l1225">        internal void generateSerializers() 
</div><div class="line" id="l1226">        {
</div><div class="line" id="l1227">            for (<span class="c">ClassDescriptor desc = descList;</span> <span class="c">desc != null</span>; <span class="c">desc = desc.next</span>)</div><div class="line" id="l1228">            {
</div><div class="line" id="l1229">                <span class="c">desc.generateSerializer();</span></div><div class="line" id="l1230">            }
</div><div class="line" id="l1231">        <span class="c">}</span></div><div class="line" id="l1232"><br></div><div class="line" id="l1233">        internal void  assignOid(IPersistent obj, int oid)
</div><div class="line" id="l1234">        {
</div><div class="line" id="l1235">            <span class="c">obj.AssignOid(this, oid, false);</span></div><div class="line" id="l1236">        <span class="c">}</span></div><div class="line" id="l1237"><br></div><div class="line" id="l1238">        internal void registerClassDescriptor(ClassDescriptor desc) 
</div><div class="line" id="l1239">        { 
</div><div class="line" id="l1240">            <span class="c">classDescMap[desc.cls] = desc;</span></div><div class="line" id="l1241">            <span class="c">desc.next = descList;</span></div><div class="line" id="l1242">            <span class="c">descList = desc;</span></div><div class="line" id="l1243">            <span class="c">checkIfFinal(desc);</span></div><div class="line" id="l1244">            <span class="c">storeObject0(desc);</span></div><div class="line" id="l1245">            <span class="c">header.root[1-currIndex].classDescList = desc.Oid;</span></div><div class="line" id="l1246">            <span class="c">modified = true;</span></div><div class="line" id="l1247">        <span class="c">}</span></div><div class="line" id="l1248"><br></div><div class="line" id="l1249">        internal ClassDescriptor getClassDescriptor(System.Type cls)
</div><div class="line" id="l1250">        {
</div><div class="line" id="l1251">            <span class="c">ClassDescriptor desc = (ClassDescriptor) classDescMap[cls];</span></div><div class="line" id="l1252">            <span class="c">if (desc == null)</span></div><div class="line" id="l1253">            {
</div><div class="line" id="l1254">                <span class="c">desc = new ClassDescriptor(this, cls);</span></div><div class="line" id="l1255">                <span class="c">desc.generateSerializer();</span></div><div class="line" id="l1256">                <span class="c">registerClassDescriptor(desc);</span></div><div class="line" id="l1257">            }
</div><div class="line" id="l1258">            <span class="c">return desc;</span></div><div class="line" id="l1259">        }
</div><div class="line" id="l1260"><br></div><div class="line" id="l1261">        public void Commit()
</div><div class="line" id="l1262">        {
</div><div class="line" id="l1263">            <span class="c">lock (backgroundGcMonitor)</span></div><div class="line" id="l1264">            { 
</div><div class="line" id="l1265">                <span class="c">lock (this)</span></div><div class="line" id="l1266">                {
</div><div class="line" id="l1267">                    <span class="c">ensureOpened();</span></div><div class="line" id="l1268">                    <span class="c">objectCache.flush();</span></div><div class="line" id="l1269"><br></div><div class="line" id="l1270">                    <span class="c">if (!modified)</span></div><div class="line" id="l1271">                    {
</div><div class="line" id="l1272">                        <span class="c">return;</span></div><div class="line" id="l1273">                    }
</div><div class="line" id="l1274">                    <span class="c">commit0();</span></div><div class="line" id="l1275">                    <span class="c">modified = false;</span></div><div class="line" id="l1276">                }
</div><div class="line" id="l1277">            }
</div><div class="line" id="l1278">        <span class="c">}</span></div><div class="line" id="l1279"><br></div><div class="line" id="l1280">        private void commit0()
</div><div class="line" id="l1281">        {
</div><div class="line" id="l1282">            <span class="c">int curr = currIndex;</span></div><div class="line" id="l1283">            int i, j, n;
</div><div class="line" id="l1284">            <span class="c">int[] map = dirtyPagesMap;</span></div><div class="line" id="l1285">            <span class="c">int oldIndexSize = header.root[curr].indexSize;</span></div><div class="line" id="l1286">            <span class="c">int newIndexSize = header.root[1-curr].indexSize;</span></div><div class="line" id="l1287">            <span class="c">int nPages = committedIndexSize &gt;&gt; dbHandlesPerPageBits;</span></div><div class="line" id="l1288">            Page pg;
</div><div class="line" id="l1289"><br></div><div class="line" id="l1290">            <span class="c">if (newIndexSize &gt; oldIndexSize)</span></div><div class="line" id="l1291">            {
</div><div class="line" id="l1292">                <span class="c">cloneBitmap(header.root[curr].index, oldIndexSize*8L);</span></div><div class="line" id="l1293">                long newIndex;
</div><div class="line" id="l1294">                <span class="c">while (true)</span></div><div class="line" id="l1295">                { 
</div><div class="line" id="l1296">                    <span class="c">newIndex = allocate(newIndexSize*8L, 0);</span></div><div class="line" id="l1297">                    <span class="c">if (newIndexSize == header.root[1-curr].indexSize)</span></div><div class="line" id="l1298">                    { 
</div><div class="line" id="l1299">                        break;
</div><div class="line" id="l1300">                    }
</div><div class="line" id="l1301">                    <span class="c">free(newIndex, newIndexSize*8L);</span></div><div class="line" id="l1302">                    <span class="c">newIndexSize = header.root[1-curr].indexSize;</span></div><div class="line" id="l1303">                }
</div><div class="line" id="l1304">                <span class="c">header.root[1-curr].shadowIndex = newIndex;</span></div><div class="line" id="l1305">                <span class="c">header.root[1-curr].shadowIndexSize = newIndexSize;</span></div><div class="line" id="l1306">                <span class="c">free(header.root[curr].index, oldIndexSize*8L);</span></div><div class="line" id="l1307">            }
</div><div class="line" id="l1308"><br></div><div class="line" id="l1309">            for (<span class="c">i = 0</span>; <span class="c">i &lt; nPages</span>; <span class="c">i++</span>)</div><div class="line" id="l1310">            {
</div><div class="line" id="l1311">                <span class="c">if ((map[i &gt;&gt; 5] &amp; (1 &lt;&lt; (i &amp; 31))) != 0)</span></div><div class="line" id="l1312">                {
</div><div class="line" id="l1313">                    <span class="c">Page srcIndex = pool.getPage(header.root[1-curr].index + (long)i * Page.pageSize);</span></div><div class="line" id="l1314">                    <span class="c">Page dstIndex = pool.getPage(header.root[curr].index + (long)i * Page.pageSize);</span></div><div class="line" id="l1315">                    for (<span class="c">j = 0</span>; <span class="c">j &lt; Page.pageSize</span>; <span class="c">j += 8</span>)</div><div class="line" id="l1316">                    {
</div><div class="line" id="l1317">                        <span class="c">long pos = Bytes.unpack8(dstIndex.data, j);</span></div><div class="line" id="l1318">                        <span class="c">if (Bytes.unpack8(srcIndex.data, j) != pos)</span></div><div class="line" id="l1319">                        {
</div><div class="line" id="l1320">                            <span class="c">if ((pos &amp; dbFreeHandleFlag) == 0)</span></div><div class="line" id="l1321">                            {
</div><div class="line" id="l1322">                                <span class="c">if ((pos &amp; dbPageObjectFlag) != 0)</span></div><div class="line" id="l1323">                                {
</div><div class="line" id="l1324">                                    <span class="c">free(pos &amp; ~ dbFlagsMask, Page.pageSize);</span></div><div class="line" id="l1325">                                }
</div><div class="line" id="l1326">                                else <span class="c">if (pos != 0)</span></div><div class="line" id="l1327">                                {
</div><div class="line" id="l1328">                                    <span class="c">int offs = (int) pos &amp; (Page.pageSize - 1);</span></div><div class="line" id="l1329">                                    <span class="c">pg = pool.getPage(pos - offs);</span></div><div class="line" id="l1330">                                    <span class="c">free(pos, ObjectHeader.getSize(pg.data, offs));</span></div><div class="line" id="l1331">                                    <span class="c">pool.unfix(pg);</span></div><div class="line" id="l1332">                                }
</div><div class="line" id="l1333">                            }
</div><div class="line" id="l1334">                        }
</div><div class="line" id="l1335">                    }
</div><div class="line" id="l1336">                    <span class="c">pool.unfix(srcIndex);</span></div><div class="line" id="l1337">                    <span class="c">pool.unfix(dstIndex);</span></div><div class="line" id="l1338">                }
</div><div class="line" id="l1339">            }
</div><div class="line" id="l1340">            <span class="c">n = committedIndexSize &amp; (dbHandlesPerPage - 1);</span></div><div class="line" id="l1341">            <span class="c">if (n != 0 &amp;&amp; (map[i &gt;&gt; 5] &amp; (1 &lt;&lt; (i &amp; 31))) != 0)</span></div><div class="line" id="l1342">            {
</div><div class="line" id="l1343">                <span class="c">Page srcIndex = pool.getPage(header.root[1-curr].index + (long)i * Page.pageSize);</span></div><div class="line" id="l1344">                <span class="c">Page dstIndex = pool.getPage(header.root[curr].index + (long)i * Page.pageSize);</span></div><div class="line" id="l1345">                <span class="c">j = 0;</span></div><div class="line" id="l1346">                do 
</div><div class="line" id="l1347">                {
</div><div class="line" id="l1348">                    <span class="c">long pos = Bytes.unpack8(dstIndex.data, j);</span></div><div class="line" id="l1349">                    <span class="c">if (Bytes.unpack8(srcIndex.data, j) != pos)</span></div><div class="line" id="l1350">                    {
</div><div class="line" id="l1351">                        <span class="c">if ((pos &amp; dbFreeHandleFlag) == 0)</span></div><div class="line" id="l1352">                        {
</div><div class="line" id="l1353">                            <span class="c">if ((pos &amp; dbPageObjectFlag) != 0)</span></div><div class="line" id="l1354">                            {
</div><div class="line" id="l1355">                                <span class="c">free(pos &amp; ~ dbFlagsMask, Page.pageSize);</span></div><div class="line" id="l1356">                            }
</div><div class="line" id="l1357">                            else <span class="c">if (pos != 0)</span></div><div class="line" id="l1358">                            {
</div><div class="line" id="l1359">                                <span class="c">int offs = (int) pos &amp; (Page.pageSize - 1);</span></div><div class="line" id="l1360">                                <span class="c">pg = pool.getPage(pos - offs);</span></div><div class="line" id="l1361">                                <span class="c">free(pos, ObjectHeader.getSize(pg.data, offs));</span></div><div class="line" id="l1362">                                <span class="c">pool.unfix(pg);</span></div><div class="line" id="l1363">                            }
</div><div class="line" id="l1364">                        }
</div><div class="line" id="l1365">                    }
</div><div class="line" id="l1366">                    <span class="c">j += 8;</span></div><div class="line" id="l1367">                }
</div><div class="line" id="l1368">                <span class="c">while (--n != 0);</span></div><div class="line" id="l1369"><br></div><div class="line" id="l1370">                <span class="c">pool.unfix(srcIndex);</span></div><div class="line" id="l1371">                <span class="c">pool.unfix(dstIndex);</span></div><div class="line" id="l1372">            }
</div><div class="line" id="l1373"><br></div><div class="line" id="l1374">            for (<span class="c">i = 0</span>; <span class="c">i &lt;= nPages</span>; <span class="c">i++</span>)</div><div class="line" id="l1375">            {
</div><div class="line" id="l1376">                <span class="c">if ((map[i &gt;&gt; 5] &amp; (1 &lt;&lt; (i &amp; 31))) != 0)</span></div><div class="line" id="l1377">                {
</div><div class="line" id="l1378">                    <span class="c">pg = pool.putPage(header.root[1-curr].index + (long)i * Page.pageSize);</span></div><div class="line" id="l1379">                    for (<span class="c">j = 0</span>; <span class="c">j &lt; Page.pageSize</span>; <span class="c">j += 8</span>)</div><div class="line" id="l1380">                    {
</div><div class="line" id="l1381">                        <span class="c">Bytes.pack8(pg.data, j, Bytes.unpack8(pg.data, j) &amp; ~ dbModifiedFlag);</span></div><div class="line" id="l1382">                    }
</div><div class="line" id="l1383">                    <span class="c">pool.unfix(pg);</span></div><div class="line" id="l1384">                }
</div><div class="line" id="l1385">            }
</div><div class="line" id="l1386"><br></div><div class="line" id="l1387">            <span class="c">if (currIndexSize &gt; committedIndexSize)</span></div><div class="line" id="l1388">            {
</div><div class="line" id="l1389">                <span class="c">long page = (header.root[1-curr].index + committedIndexSize * 8L) &amp; ~ (Page.pageSize - 1);</span></div><div class="line" id="l1390">                <span class="c">long end = (header.root[1-curr].index + Page.pageSize - 1 + currIndexSize * 8L) &amp; ~ (Page.pageSize - 1);</span></div><div class="line" id="l1391">                <span class="c">while (page &lt; end)</span></div><div class="line" id="l1392">                {
</div><div class="line" id="l1393">                    <span class="c">pg = pool.putPage(page);</span></div><div class="line" id="l1394">                    for (<span class="c">j = 0</span>; <span class="c">j &lt; Page.pageSize</span>; <span class="c">j += 8</span>)</div><div class="line" id="l1395">                    {
</div><div class="line" id="l1396">                        <span class="c">Bytes.pack8(pg.data, j, Bytes.unpack8(pg.data, j) &amp; ~ dbModifiedFlag);</span></div><div class="line" id="l1397">                    }
</div><div class="line" id="l1398">                    <span class="c">pool.unfix(pg);</span></div><div class="line" id="l1399">                    <span class="c">page += Page.pageSize;</span></div><div class="line" id="l1400">                }
</div><div class="line" id="l1401">            }
</div><div class="line" id="l1402">            <span class="c">header.root[1-curr].usedSize = usedSize;</span></div><div class="line" id="l1403">            <span class="c">pg = pool.putPage(0);</span></div><div class="line" id="l1404">            <span class="c">header.pack(pg.data);</span></div><div class="line" id="l1405">            <span class="c">pool.flush();</span></div><div class="line" id="l1406">            <span class="c">pool.modify(pg);</span></div><div class="line" id="l1407">            <span class="c">header.curr = curr ^= 1;</span></div><div class="line" id="l1408">            <span class="c">header.dirty = true;</span></div><div class="line" id="l1409">            <span class="c">header.pack(pg.data);</span></div><div class="line" id="l1410">            <span class="c">pool.unfix(pg);</span></div><div class="line" id="l1411">            <span class="c">pool.flush();</span></div><div class="line" id="l1412"><br></div><div class="line" id="l1413">            <span class="c">header.root[1-curr].size = header.root[curr].size;</span></div><div class="line" id="l1414">            <span class="c">header.root[1-curr].indexUsed = currIndexSize;</span></div><div class="line" id="l1415">            <span class="c">header.root[1-curr].freeList = header.root[curr].freeList;</span></div><div class="line" id="l1416">            <span class="c">header.root[1-curr].bitmapEnd = header.root[curr].bitmapEnd;</span></div><div class="line" id="l1417">            <span class="c">header.root[1-curr].rootObject = header.root[curr].rootObject;</span></div><div class="line" id="l1418">            <span class="c">header.root[1-curr].classDescList = header.root[curr].classDescList;</span></div><div class="line" id="l1419">            <span class="c">header.root[1-curr].bitmapExtent = header.root[curr].bitmapExtent;</span></div><div class="line" id="l1420"><br></div><div class="line" id="l1421">            <span class="c">if (currIndexSize == 0 || newIndexSize != oldIndexSize)</span></div><div class="line" id="l1422">            {
</div><div class="line" id="l1423">                <span class="c">if (currIndexSize == 0)</span></div><div class="line" id="l1424">                {
</div><div class="line" id="l1425">                    <span class="c">currIndexSize = header.root[1-curr].indexUsed;</span></div><div class="line" id="l1426">                }
</div><div class="line" id="l1427">                <span class="c">header.root[1-curr].index = header.root[curr].shadowIndex;</span></div><div class="line" id="l1428">                <span class="c">header.root[1-curr].indexSize = header.root[curr].shadowIndexSize;</span></div><div class="line" id="l1429">                <span class="c">header.root[1-curr].shadowIndex = header.root[curr].index;</span></div><div class="line" id="l1430">                <span class="c">header.root[1-curr].shadowIndexSize = header.root[curr].indexSize;</span></div><div class="line" id="l1431">                <span class="c">pool.copy(header.root[1-curr].index, header.root[curr].index, currIndexSize * 8L);</span></div><div class="line" id="l1432">                <span class="c">i = (currIndexSize + dbHandlesPerPage * 32 - 1) &gt;&gt; (dbHandlesPerPageBits + 5);</span></div><div class="line" id="l1433">                <span class="c">while (--i &gt;= 0)</span></div><div class="line" id="l1434">                {
</div><div class="line" id="l1435">                    <span class="c">map[i] = 0;</span></div><div class="line" id="l1436">                }
</div><div class="line" id="l1437">            }
</div><div class="line" id="l1438">            else
</div><div class="line" id="l1439">            {
</div><div class="line" id="l1440">                for (<span class="c">i = 0</span>; <span class="c">i &lt; nPages</span>; <span class="c">i++</span>)</div><div class="line" id="l1441">                {
</div><div class="line" id="l1442">                    <span class="c">if ((map[i &gt;&gt; 5] &amp; (1 &lt;&lt; (i &amp; 31))) != 0)</span></div><div class="line" id="l1443">                    {
</div><div class="line" id="l1444">                        <span class="c">map[i &gt;&gt; 5] -= (1 &lt;&lt; (i &amp; 31));</span></div><div class="line" id="l1445">                        <span class="c">pool.copy(header.root[1-curr].index + (long)i * Page.pageSize,</span></div><div class="line" id="l1446"><span class="c">                                  header.root[curr].index + (long)i * Page.pageSize,</span></div><div class="line" id="l1447">                                  Page.pageSize)<span class="c">;</span></div><div class="line" id="l1448">                    }
</div><div class="line" id="l1449">                }
</div><div class="line" id="l1450">                <span class="c">if (currIndexSize &gt; i * dbHandlesPerPage &amp;&amp; ((map[i &gt;&gt; 5] &amp; (1 &lt;&lt; (i &amp; 31))) != 0 || currIndexSize != committedIndexSize))</span></div><div class="line" id="l1451">                {
</div><div class="line" id="l1452">                    <span class="c">pool.copy(header.root[1-curr].index + (long)i * Page.pageSize,</span></div><div class="line" id="l1453"><span class="c">                              header.root[curr].index + (long)i * Page.pageSize,</span></div><div class="line" id="l1454">                              8L * currIndexSize - (long)i * Page.pageSize)<span class="c">;</span></div><div class="line" id="l1455">                    <span class="c">j = i &gt;&gt; 5;</span></div><div class="line" id="l1456">                    <span class="c">n = (currIndexSize + dbHandlesPerPage * 32 - 1) &gt;&gt; (dbHandlesPerPageBits + 5);</span></div><div class="line" id="l1457">                    <span class="c">while (j &lt; n)</span></div><div class="line" id="l1458">                    {
</div><div class="line" id="l1459">                        <span class="c">map[j++] = 0;</span></div><div class="line" id="l1460">                    }
</div><div class="line" id="l1461">                }
</div><div class="line" id="l1462">            }
</div><div class="line" id="l1463">            <span class="c">gcDone = false;</span></div><div class="line" id="l1464">            <span class="c">currIndex = curr;</span></div><div class="line" id="l1465">            <span class="c">committedIndexSize = currIndexSize;</span></div><div class="line" id="l1466">        <span class="c">}</span></div><div class="line" id="l1467"><br></div><div class="line" id="l1468">        public void Rollback()
</div><div class="line" id="l1469">        {
</div><div class="line" id="l1470">            lock (this)
</div><div class="line" id="l1471">            {
</div><div class="line" id="l1472">                ensureOpened();
</div><div class="line" id="l1473">                objectCache.invalidate();
</div><div class="line" id="l1474"><br></div><div class="line" id="l1475">                if (!modified) 
</div><div class="line" id="l1476">                { 
</div><div class="line" id="l1477">                    return;
</div><div class="line" id="l1478">                }
</div><div class="line" id="l1479">                rollback0();
</div><div class="line" id="l1480">                modified = false;
</div><div class="line" id="l1481">            }
</div><div class="line" id="l1482">        }
</div><div class="line" id="l1483"><br></div><div class="line" id="l1484">        private void rollback0()
</div><div class="line" id="l1485">        {
</div><div class="line" id="l1486">            int curr = currIndex;
</div><div class="line" id="l1487">            int[] map = dirtyPagesMap;
</div><div class="line" id="l1488">            if (header.root[1-curr].index != header.root[curr].shadowIndex)
</div><div class="line" id="l1489">            {
</div><div class="line" id="l1490">                pool.copy(header.root[curr].shadowIndex, header.root[curr].index, 8L * committedIndexSize);
</div><div class="line" id="l1491">            }
</div><div class="line" id="l1492">            else
</div><div class="line" id="l1493">            {
</div><div class="line" id="l1494">                int nPages = (committedIndexSize + dbHandlesPerPage - 1) &gt;&gt; dbHandlesPerPageBits;
</div><div class="line" id="l1495">                for (int i = 0; i &lt; nPages; i++)
</div><div class="line" id="l1496">                {
</div><div class="line" id="l1497">                    if ((map[i &gt;&gt; 5] &amp; (1 &lt;&lt; (i &amp; 31))) != 0)
</div><div class="line" id="l1498">                    {
</div><div class="line" id="l1499">                        pool.copy(header.root[curr].shadowIndex + (long)i * Page.pageSize, 
</div><div class="line" id="l1500">                                  header.root[curr].index + (long)i * Page.pageSize, 
</div><div class="line" id="l1501">                                  Page.pageSize);
</div><div class="line" id="l1502">                    }
</div><div class="line" id="l1503">                }
</div><div class="line" id="l1504">            }
</div><div class="line" id="l1505">            for (int j = (currIndexSize + dbHandlesPerPage * 32 - 1) &gt;&gt; (dbHandlesPerPageBits + 5); --j &gt;= 0; map[j] = 0)
</div><div class="line" id="l1506">                ;
</div><div class="line" id="l1507">            header.root[1-curr].index = header.root[curr].shadowIndex;
</div><div class="line" id="l1508">            header.root[1-curr].indexSize = header.root[curr].shadowIndexSize;
</div><div class="line" id="l1509">            header.root[1-curr].indexUsed = committedIndexSize;
</div><div class="line" id="l1510">            header.root[1-curr].freeList = header.root[curr].freeList;
</div><div class="line" id="l1511">            header.root[1-curr].bitmapEnd = header.root[curr].bitmapEnd;
</div><div class="line" id="l1512">            header.root[1-curr].size = header.root[curr].size;
</div><div class="line" id="l1513">            header.root[1-curr].rootObject = header.root[curr].rootObject;
</div><div class="line" id="l1514">            header.root[1-curr].classDescList = header.root[curr].classDescList;
</div><div class="line" id="l1515">            header.root[1-curr].bitmapExtent = header.root[curr].bitmapExtent;
</div><div class="line" id="l1516">            header.dirty = true;
</div><div class="line" id="l1517">            usedSize = header.root[curr].size;
</div><div class="line" id="l1518">            currIndexSize = committedIndexSize;
</div><div class="line" id="l1519"><br></div><div class="line" id="l1520">            currRBitmapPage = currPBitmapPage = 0;
</div><div class="line" id="l1521">            currRBitmapOffs = currPBitmapOffs = 0;
</div><div class="line" id="l1522"><br></div><div class="line" id="l1523">            reloadScheme();
</div><div class="line" id="l1524">        }
</div><div class="line" id="l1525"><br></div><div class="line" id="l1526">        private void memset(byte[] arr, int off, int len, byte val) 
</div><div class="line" id="l1527">        { 
</div><div class="line" id="l1528">            while (--len &gt;= 0) 
</div><div class="line" id="l1529">            { 
</div><div class="line" id="l1530">                arr[off++] = val;
</div><div class="line" id="l1531">            }
</div><div class="line" id="l1532">        }
</div><div class="line" id="l1533"><br></div><div class="line" id="l1534">#if COMPACT_NET_FRAMEWORK
</div><div class="line" id="l1535">        class PositionComparer : System.Collections.IComparer 
</div><div class="line" id="l1536">        {
</div><div class="line" id="l1537">            public int Compare(object o1, object o2) 
</div><div class="line" id="l1538">            {
</div><div class="line" id="l1539">                long i1 = (long)o1;
</div><div class="line" id="l1540">                long i2 = (long)o2;
</div><div class="line" id="l1541">                return i1 &lt; i2 ? -1 : i1 == i2 ? 0 : 1;
</div><div class="line" id="l1542">            }
</div><div class="line" id="l1543">        }
</div><div class="line" id="l1544">#else
</div><div class="line" id="l1545">        public IPersistent CreateClass(Type type) 
</div><div class="line" id="l1546">        {
</div><div class="line" id="l1547">            lock (this) 
</div><div class="line" id="l1548">            {
</div><div class="line" id="l1549">                ensureOpened();
</div><div class="line" id="l1550"><br></div><div class="line" id="l1551">                lock (objectCache) 
</div><div class="line" id="l1552">                {
</div><div class="line" id="l1553">                    Type wrapper = getWrapper(type);
</div><div class="line" id="l1554">                    IPersistent obj = (IPersistent)wrapper.Assembly.CreateInstance(wrapper.Name);
</div><div class="line" id="l1555">                    int oid = allocateId();
</div><div class="line" id="l1556">                    obj.AssignOid(this, oid, false);
</div><div class="line" id="l1557">                    setPos(oid, 0);
</div><div class="line" id="l1558">                    objectCache.put(oid, obj);
</div><div class="line" id="l1559">                    obj.Modify();
</div><div class="line" id="l1560">                    return obj;
</div><div class="line" id="l1561">                }
</div><div class="line" id="l1562">            }
</div><div class="line" id="l1563">        }
</div><div class="line" id="l1564"><br></div><div class="line" id="l1565">        internal Type getWrapper(Type original) 
</div><div class="line" id="l1566">        {
</div><div class="line" id="l1567">            Type wrapper = (Type)wrapperHash[original];
</div><div class="line" id="l1568">            if (wrapper == null) 
</div><div class="line" id="l1569">            { 
</div><div class="line" id="l1570">                wrapper = CodeGenerator.Instance.CreateWrapper(original);
</div><div class="line" id="l1571">                wrapperHash[original] = wrapper;
</div><div class="line" id="l1572">            }
</div><div class="line" id="l1573">            return wrapper;
</div><div class="line" id="l1574">        }
</div><div class="line" id="l1575">#endif
</div><div class="line" id="l1576">        public int MakePersistent(IPersistent obj) 
</div><div class="line" id="l1577">        {
</div><div class="line" id="l1578">            <span class="c">if (obj == null)</span></div><div class="line" id="l1579">            {
</div><div class="line" id="l1580">                <span class="c">return 0;</span></div><div class="line" id="l1581">            }
</div><div class="line" id="l1582">            <span class="c">if (obj.Oid != 0)</span></div><div class="line" id="l1583">            {
</div><div class="line" id="l1584">                <span class="c">return obj.Oid;</span></div><div class="line" id="l1585">            }
</div><div class="line" id="l1586">            <span class="c">lock (this)</span></div><div class="line" id="l1587">            {
</div><div class="line" id="l1588">                <span class="c">ensureOpened();</span></div><div class="line" id="l1589">                <span class="c">lock (objectCache)</span></div><div class="line" id="l1590">                {
</div><div class="line" id="l1591">                    <span class="c">int oid = allocateId();</span></div><div class="line" id="l1592">                    <span class="c">obj.AssignOid(this, oid, false);</span></div><div class="line" id="l1593">                    <span class="c">setPos(oid, 0);</span></div><div class="line" id="l1594">                    <span class="c">objectCache.put(oid, obj);</span></div><div class="line" id="l1595">                    <span class="c">obj.Modify();</span></div><div class="line" id="l1596">                    <span class="c">return oid;</span></div><div class="line" id="l1597">                }
</div><div class="line" id="l1598">            }
</div><div class="line" id="l1599">        <span class="c">}</span></div><div class="line" id="l1600"><br></div><div class="line" id="l1601">        public void Backup(System.IO.Stream stream)
</div><div class="line" id="l1602">        {
</div><div class="line" id="l1603">            lock (this)
</div><div class="line" id="l1604">            {
</div><div class="line" id="l1605">                ensureOpened();
</div><div class="line" id="l1606">                objectCache.flush();
</div><div class="line" id="l1607">                int    curr = 1-currIndex;
</div><div class="line" id="l1608">                int    nObjects = header.root[curr].indexUsed;
</div><div class="line" id="l1609">                long   indexOffs = header.root[curr].index;
</div><div class="line" id="l1610">                int    i, j, k;
</div><div class="line" id="l1611">                int    nUsedIndexPages = (nObjects + dbHandlesPerPage - 1) / dbHandlesPerPage;
</div><div class="line" id="l1612">                int    nIndexPages = (int)((header.root[curr].indexSize + dbHandlesPerPage - 1) / dbHandlesPerPage);
</div><div class="line" id="l1613">                long   totalRecordsSize = 0;
</div><div class="line" id="l1614">                long   nPagedObjects = 0;
</div><div class="line" id="l1615">                int    bitmapExtent = header.root[curr].bitmapExtent;
</div><div class="line" id="l1616">                long[] index = new long[nObjects];
</div><div class="line" id="l1617">                int[]  oids = new int[nObjects];
</div><div class="line" id="l1618"><br></div><div class="line" id="l1619">                if (bitmapExtent == 0) 
</div><div class="line" id="l1620">                { 
</div><div class="line" id="l1621">                    bitmapExtent = int.MaxValue;
</div><div class="line" id="l1622">                }
</div><div class="line" id="l1623">                for (i = 0, j = 0; i &lt; nUsedIndexPages; i++) 
</div><div class="line" id="l1624">                {
</div><div class="line" id="l1625">                    Page pg = pool.getPage(indexOffs + (long)i*Page.pageSize);
</div><div class="line" id="l1626">                    for (k = 0; k &lt; dbHandlesPerPage &amp;&amp; j &lt; nObjects; k++, j++) 
</div><div class="line" id="l1627">                    { 
</div><div class="line" id="l1628">                        long pos = Bytes.unpack8(pg.data, k*8);
</div><div class="line" id="l1629">                        index[j] = pos;
</div><div class="line" id="l1630">                        oids[j] = j;
</div><div class="line" id="l1631">                        if ((pos &amp; dbFreeHandleFlag) == 0) 
</div><div class="line" id="l1632">                        { 
</div><div class="line" id="l1633">                            if ((pos &amp; dbPageObjectFlag) != 0) 
</div><div class="line" id="l1634">                            {
</div><div class="line" id="l1635">                                nPagedObjects += 1;
</div><div class="line" id="l1636">                            } 
</div><div class="line" id="l1637">                            else if (pos != 0) 
</div><div class="line" id="l1638">                            { 
</div><div class="line" id="l1639">                                int offs = (int)pos &amp; (Page.pageSize-1);
</div><div class="line" id="l1640">                                Page op = pool.getPage(pos - offs);
</div><div class="line" id="l1641">                                int size = ObjectHeader.getSize(op.data, offs &amp; ~dbFlagsMask);
</div><div class="line" id="l1642">                                size = (size + dbAllocationQuantum-1) &amp; ~(dbAllocationQuantum-1);
</div><div class="line" id="l1643">                                totalRecordsSize += size; 
</div><div class="line" id="l1644">                                pool.unfix(op);
</div><div class="line" id="l1645">                            }
</div><div class="line" id="l1646">                        }
</div><div class="line" id="l1647">                    }
</div><div class="line" id="l1648">                    pool.unfix(pg);
</div><div class="line" id="l1649"><br></div><div class="line" id="l1650">                } 
</div><div class="line" id="l1651">                Header newHeader = new Header();
</div><div class="line" id="l1652">                newHeader.curr = 0;
</div><div class="line" id="l1653">                newHeader.dirty = false;
</div><div class="line" id="l1654">                newHeader.initialized = true;
</div><div class="line" id="l1655">                long newFileSize = (long)(nPagedObjects + nIndexPages*2 + 1)*Page.pageSize + totalRecordsSize;
</div><div class="line" id="l1656">                newFileSize = (newFileSize + Page.pageSize-1) &amp; ~(Page.pageSize-1);	
</div><div class="line" id="l1657">                newHeader.root = new RootPage[2];
</div><div class="line" id="l1658">                newHeader.root[0] = new RootPage();
</div><div class="line" id="l1659">                newHeader.root[1] = new RootPage();
</div><div class="line" id="l1660">                newHeader.root[0].size = newHeader.root[1].size = newFileSize;
</div><div class="line" id="l1661">                newHeader.root[0].index = newHeader.root[1].shadowIndex = Page.pageSize;
</div><div class="line" id="l1662">                newHeader.root[0].shadowIndex = newHeader.root[1].index = Page.pageSize + (long)nIndexPages*Page.pageSize;
</div><div class="line" id="l1663">                newHeader.root[0].shadowIndexSize = newHeader.root[0].indexSize = 
</div><div class="line" id="l1664">                    newHeader.root[1].shadowIndexSize = newHeader.root[1].indexSize = nIndexPages*dbHandlesPerPage;
</div><div class="line" id="l1665">                newHeader.root[0].indexUsed = newHeader.root[1].indexUsed = nObjects;
</div><div class="line" id="l1666">                newHeader.root[0].freeList = newHeader.root[1].freeList = header.root[curr].freeList;
</div><div class="line" id="l1667">                newHeader.root[0].bitmapEnd = newHeader.root[1].bitmapEnd = header.root[curr].bitmapEnd;
</div><div class="line" id="l1668"><br></div><div class="line" id="l1669">                newHeader.root[0].rootObject = newHeader.root[1].rootObject = header.root[curr].rootObject;
</div><div class="line" id="l1670">                newHeader.root[0].classDescList = newHeader.root[1].classDescList = header.root[curr].classDescList;
</div><div class="line" id="l1671">                newHeader.root[0].bitmapExtent = newHeader.root[1].bitmapExtent = bitmapExtent;
</div><div class="line" id="l1672"><br></div><div class="line" id="l1673">                byte[] page = new byte[Page.pageSize];
</div><div class="line" id="l1674">                newHeader.pack(page);
</div><div class="line" id="l1675">                stream.Write(page, 0, Page.pageSize);
</div><div class="line" id="l1676"><br></div><div class="line" id="l1677">                long pageOffs = (long)(nIndexPages*2 + 1)*Page.pageSize;
</div><div class="line" id="l1678">                long recOffs = (long)(nPagedObjects + nIndexPages*2 + 1)*Page.pageSize;
</div><div class="line" id="l1679">#if COMPACT_NET_FRAMEWORK
</div><div class="line" id="l1680">                Array.Sort(index, oids, 0, nObjects, new PositionComparer());
</div><div class="line" id="l1681">#else
</div><div class="line" id="l1682">                Array.Sort(index, oids);
</div><div class="line" id="l1683">#endif
</div><div class="line" id="l1684">                byte[] newIndex = new byte[nIndexPages*dbHandlesPerPage*8];
</div><div class="line" id="l1685">                for (i = 0; i &lt; nObjects; i++) 
</div><div class="line" id="l1686">                {
</div><div class="line" id="l1687">                    long pos = index[i];
</div><div class="line" id="l1688">                    int oid = oids[i];
</div><div class="line" id="l1689">                    if (pos != 0 &amp;&amp; (pos &amp; dbFreeHandleFlag) == 0) 
</div><div class="line" id="l1690">                    { 
</div><div class="line" id="l1691">                        if ((pos &amp; dbPageObjectFlag) != 0) 
</div><div class="line" id="l1692">                        {
</div><div class="line" id="l1693">                            Bytes.pack8(newIndex, oid*8, pageOffs | dbPageObjectFlag);
</div><div class="line" id="l1694">                            pageOffs += Page.pageSize;
</div><div class="line" id="l1695">                        } 
</div><div class="line" id="l1696">                        else
</div><div class="line" id="l1697">                        { 
</div><div class="line" id="l1698">                            Bytes.pack8(newIndex, oid*8, recOffs);
</div><div class="line" id="l1699">                            int offs = (int)pos &amp; (Page.pageSize-1);
</div><div class="line" id="l1700">                            Page op = pool.getPage(pos - offs);
</div><div class="line" id="l1701">                            int size = ObjectHeader.getSize(op.data, offs &amp; ~dbFlagsMask);
</div><div class="line" id="l1702">                            size = (size + dbAllocationQuantum-1) &amp; ~(dbAllocationQuantum-1);
</div><div class="line" id="l1703">                            recOffs += size; 
</div><div class="line" id="l1704">                            pool.unfix(op);
</div><div class="line" id="l1705">                        }
</div><div class="line" id="l1706">                    } 
</div><div class="line" id="l1707">                    else 
</div><div class="line" id="l1708">                    { 
</div><div class="line" id="l1709">                        Bytes.pack8(newIndex, oid*8, pos);
</div><div class="line" id="l1710">                    }
</div><div class="line" id="l1711">                }
</div><div class="line" id="l1712">                stream.Write(newIndex, 0, newIndex.Length);
</div><div class="line" id="l1713">                stream.Write(newIndex, 0, newIndex.Length);
</div><div class="line" id="l1714"><br></div><div class="line" id="l1715">                for (i = 0; i &lt; nObjects; i++) 
</div><div class="line" id="l1716">                {
</div><div class="line" id="l1717">                    long pos = index[i];
</div><div class="line" id="l1718">                    if (((int)pos &amp; (dbFreeHandleFlag|dbPageObjectFlag)) == dbPageObjectFlag) 
</div><div class="line" id="l1719">                    { 
</div><div class="line" id="l1720">                        if (oids[i] &lt; dbBitmapId + dbBitmapPages 
</div><div class="line" id="l1721">                            || (oids[i] &gt;= bitmapExtent &amp;&amp; oids[i] &lt; bitmapExtent + dbLargeBitmapPages - dbBitmapPages))
</div><div class="line" id="l1722">                        { 
</div><div class="line" id="l1723">                            int pageId = oids[i] &lt; dbBitmapId + dbBitmapPages 
</div><div class="line" id="l1724">                                ? oids[i] - dbBitmapId : oids[i] - bitmapExtent;
</div><div class="line" id="l1725">                            long mappedSpace = (long)pageId*Page.pageSize*8*dbAllocationQuantum;
</div><div class="line" id="l1726">                            if (mappedSpace &gt;= newFileSize) 
</div><div class="line" id="l1727">                            { 
</div><div class="line" id="l1728">                                memset(page, 0, Page.pageSize, (byte)0);
</div><div class="line" id="l1729">                            } 
</div><div class="line" id="l1730">                            else if (mappedSpace + Page.pageSize*8*dbAllocationQuantum &lt;= newFileSize) 
</div><div class="line" id="l1731">                            { 
</div><div class="line" id="l1732">                                memset(page, 0, Page.pageSize, (byte)0xFF);
</div><div class="line" id="l1733">                            } 
</div><div class="line" id="l1734">                            else 
</div><div class="line" id="l1735">                            { 
</div><div class="line" id="l1736">                                int nBits = (int)((newFileSize - mappedSpace) &gt;&gt; dbAllocationQuantumBits);
</div><div class="line" id="l1737">                                memset(page, 0, nBits &gt;&gt; 3, (byte)0xFF);
</div><div class="line" id="l1738">                                page[nBits &gt;&gt; 3] = (byte)((1 &lt;&lt; (nBits &amp; 7)) - 1);
</div><div class="line" id="l1739">                                memset(page, (nBits &gt;&gt; 3) + 1, Page.pageSize - (nBits &gt;&gt; 3) - 1, (byte)0);
</div><div class="line" id="l1740">                            }
</div><div class="line" id="l1741">                            stream.Write(page, 0, Page.pageSize);
</div><div class="line" id="l1742">                        } 
</div><div class="line" id="l1743">                        else 
</div><div class="line" id="l1744">                        {                        
</div><div class="line" id="l1745">                            Page pg = pool.getPage(pos &amp; ~dbFlagsMask);
</div><div class="line" id="l1746">                            stream.Write(pg.data, 0, Page.pageSize);
</div><div class="line" id="l1747">                            pool.unfix(pg);
</div><div class="line" id="l1748">                        }
</div><div class="line" id="l1749">                    }
</div><div class="line" id="l1750">                }
</div><div class="line" id="l1751"><br></div><div class="line" id="l1752">                for (i = 0; i &lt; nObjects; i++) 
</div><div class="line" id="l1753">                {
</div><div class="line" id="l1754">                    long pos = index[i];
</div><div class="line" id="l1755">                    if (pos != 0 &amp;&amp; ((int)pos &amp; (dbFreeHandleFlag|dbPageObjectFlag)) == 0) 
</div><div class="line" id="l1756">                    { 
</div><div class="line" id="l1757">                        pos &amp;= ~dbFlagsMask;
</div><div class="line" id="l1758">                        int offs = (int)pos &amp; (Page.pageSize-1);
</div><div class="line" id="l1759">                        Page pg = pool.getPage(pos - offs);
</div><div class="line" id="l1760">                        int size = ObjectHeader.getSize(pg.data, offs);
</div><div class="line" id="l1761">                        size = (size + dbAllocationQuantum-1) &amp; ~(dbAllocationQuantum-1);
</div><div class="line" id="l1762"><br></div><div class="line" id="l1763">                        while (true) 
</div><div class="line" id="l1764">                        { 
</div><div class="line" id="l1765">                            if (Page.pageSize - offs &gt;= size) 
</div><div class="line" id="l1766">                            { 
</div><div class="line" id="l1767">                                stream.Write(pg.data, offs, size);
</div><div class="line" id="l1768">                                break;
</div><div class="line" id="l1769">                            }
</div><div class="line" id="l1770">                            stream.Write(pg.data, offs, Page.pageSize - offs);
</div><div class="line" id="l1771">                            size -= Page.pageSize - offs;
</div><div class="line" id="l1772">                            pos += Page.pageSize - offs;
</div><div class="line" id="l1773">                            offs = 0;
</div><div class="line" id="l1774">                            pool.unfix(pg); 
</div><div class="line" id="l1775">                            pg = pool.getPage(pos);
</div><div class="line" id="l1776">                        }
</div><div class="line" id="l1777">                        pool.unfix(pg);
</div><div class="line" id="l1778">                    }
</div><div class="line" id="l1779">                }
</div><div class="line" id="l1780">                if (recOffs != newFileSize) 
</div><div class="line" id="l1781">                {       
</div><div class="line" id="l1782">                    Debug.Assert(newFileSize - recOffs &lt; Page.pageSize);
</div><div class="line" id="l1783">                    int align = (int)(newFileSize - recOffs);
</div><div class="line" id="l1784">                    memset(page, 0, align, (byte)0);
</div><div class="line" id="l1785">                    stream.Write(page, 0, align);
</div><div class="line" id="l1786">                }
</div><div class="line" id="l1787">            }
</div><div class="line" id="l1788">        }
</div><div class="line" id="l1789"><br></div><div class="line" id="l1790">        public Index&lt;K,V&gt; CreateIndex&lt;K,V&gt;(bool unique) where V:class,IPersistent
</div><div class="line" id="l1791">        {
</div><div class="line" id="l1792">            <span class="c">lock (this)</span></div><div class="line" id="l1793">            {
</div><div class="line" id="l1794">                <span class="c">ensureOpened();</span></div><div class="line" id="l1795"><br></div><div class="line" id="l1796">                <span class="c">Index&lt;K,V&gt; index = alternativeBtree</span></div><div class="line" id="l1797"><span class="c">                    ? (Index&lt;K,V&gt;)new AltBtree&lt;K,V&gt;(unique)</span></div><div class="line" id="l1798">                    : (Index&lt;K,V&gt;)new Btree&lt;K,V&gt;(unique)<span class="c">;</span></div><div class="line" id="l1799">                <span class="c">index.AssignOid(this, 0, false);</span></div><div class="line" id="l1800">                <span class="c">return index;</span></div><div class="line" id="l1801">            }
</div><div class="line" id="l1802">        <span class="c">}</span></div><div class="line" id="l1803"><br></div><div class="line" id="l1804">        public Index&lt;K,V&gt; CreateThickIndex&lt;K,V&gt;() where V:class,IPersistent
</div><div class="line" id="l1805">        {
</div><div class="line" id="l1806">            lock (this)
</div><div class="line" id="l1807">            {
</div><div class="line" id="l1808">                ensureOpened();
</div><div class="line" id="l1809">                return new ThickIndex&lt;K,V&gt;(this);
</div><div class="line" id="l1810">            }
</div><div class="line" id="l1811">        }
</div><div class="line" id="l1812"><br></div><div class="line" id="l1813">        public BitIndex&lt;T&gt; CreateBitIndex&lt;T&gt;() where T:class,IPersistent
</div><div class="line" id="l1814">        {
</div><div class="line" id="l1815">            lock (this)
</div><div class="line" id="l1816">            {
</div><div class="line" id="l1817">                ensureOpened();
</div><div class="line" id="l1818">                BitIndex&lt;T&gt; index = new BitIndexImpl&lt;T&gt;();
</div><div class="line" id="l1819">                index.AssignOid(this, 0, false);
</div><div class="line" id="l1820">                return index;
</div><div class="line" id="l1821">            }
</div><div class="line" id="l1822">        }
</div><div class="line" id="l1823"><br></div><div class="line" id="l1824">        public SpatialIndex&lt;T&gt; CreateSpatialIndex&lt;T&gt;() where T:class,IPersistent
</div><div class="line" id="l1825">        {
</div><div class="line" id="l1826">            lock (this)
</div><div class="line" id="l1827">            {
</div><div class="line" id="l1828">                ensureOpened();
</div><div class="line" id="l1829">                Rtree&lt;T&gt; index = new Rtree&lt;T&gt;();
</div><div class="line" id="l1830">                index.AssignOid(this, 0, false);
</div><div class="line" id="l1831">                return index;
</div><div class="line" id="l1832">            }
</div><div class="line" id="l1833">        }
</div><div class="line" id="l1834"><br></div><div class="line" id="l1835">        public SpatialIndexR2&lt;T&gt; CreateSpatialIndexR2&lt;T&gt;() where T:class,IPersistent
</div><div class="line" id="l1836">        {
</div><div class="line" id="l1837">            lock (this)
</div><div class="line" id="l1838">            {
</div><div class="line" id="l1839">                ensureOpened();
</div><div class="line" id="l1840">                RtreeR2&lt;T&gt; index = new RtreeR2&lt;T&gt;();
</div><div class="line" id="l1841">                index.AssignOid(this, 0, false);
</div><div class="line" id="l1842">                return index;
</div><div class="line" id="l1843">            }
</div><div class="line" id="l1844">        }
</div><div class="line" id="l1845"><br></div><div class="line" id="l1846">        public SortedCollection&lt;K,V&gt; CreateSortedCollection&lt;K,V&gt;(PersistentComparator&lt;K,V&gt; comparator, bool unique) where V:class,IPersistent
</div><div class="line" id="l1847">        {
</div><div class="line" id="l1848">            ensureOpened();       
</div><div class="line" id="l1849">            return new Ttree&lt;K,V&gt;(comparator, unique);
</div><div class="line" id="l1850">        }
</div><div class="line" id="l1851"><br></div><div class="line" id="l1852">        public SortedCollection&lt;K,V&gt; CreateSortedCollection&lt;K,V&gt;(bool unique) where V:class,IPersistent,IComparable&lt;K&gt;,IComparable&lt;V&gt;
</div><div class="line" id="l1853">        {
</div><div class="line" id="l1854">            ensureOpened();    
</div><div class="line" id="l1855">            return new Ttree&lt;K,V&gt;(new DefaultPersistentComparator&lt;K,V&gt;(), unique);
</div><div class="line" id="l1856">        }
</div><div class="line" id="l1857"><br></div><div class="line" id="l1858">        public ISet&lt;T&gt; CreateSet&lt;T&gt;() where T:class,IPersistent
</div><div class="line" id="l1859">        {
</div><div class="line" id="l1860">            lock (this)
</div><div class="line" id="l1861">            {
</div><div class="line" id="l1862">                ensureOpened();
</div><div class="line" id="l1863"><br></div><div class="line" id="l1864">                ISet&lt;T&gt; s = alternativeBtree 
</div><div class="line" id="l1865">                    ? (ISet&lt;T&gt;)new AltPersistentSet&lt;T&gt;()
</div><div class="line" id="l1866">                    : (ISet&lt;T&gt;)new PersistentSet&lt;T&gt;();
</div><div class="line" id="l1867">                s.AssignOid(this, 0, false);
</div><div class="line" id="l1868">                return s;
</div><div class="line" id="l1869">            }
</div><div class="line" id="l1870">        }
</div><div class="line" id="l1871"><br></div><div class="line" id="l1872">        public ISet&lt;T&gt; CreateScalableSet&lt;T&gt;() where T:class,IPersistent
</div><div class="line" id="l1873">        {
</div><div class="line" id="l1874">            return CreateScalableSet&lt;T&gt;(8);
</div><div class="line" id="l1875">        }
</div><div class="line" id="l1876"><br></div><div class="line" id="l1877">        public ISet&lt;T&gt; CreateScalableSet&lt;T&gt;(int initialSize) where T:class,IPersistent
</div><div class="line" id="l1878">        {
</div><div class="line" id="l1879">            lock (this)
</div><div class="line" id="l1880">            {
</div><div class="line" id="l1881">                ensureOpened();
</div><div class="line" id="l1882"><br></div><div class="line" id="l1883">                return new ScalableSet&lt;T&gt;(this, initialSize);
</div><div class="line" id="l1884">            }
</div><div class="line" id="l1885">        }
</div><div class="line" id="l1886"><br></div><div class="line" id="l1887">        public FieldIndex&lt;K,V&gt; CreateFieldIndex&lt;K,V&gt;(String fieldName, bool unique) where V:class,IPersistent
</div><div class="line" id="l1888">        {
</div><div class="line" id="l1889">            <span class="c">lock (this)</span></div><div class="line" id="l1890">            {
</div><div class="line" id="l1891">                <span class="c">ensureOpened();</span></div><div class="line" id="l1892">                <span class="c">FieldIndex&lt;K,V&gt; index = alternativeBtree</span></div><div class="line" id="l1893"><span class="c">                    ? (FieldIndex&lt;K,V&gt;)new AltBtreeFieldIndex&lt;K,V&gt;(fieldName, unique)</span></div><div class="line" id="l1894">                    : (FieldIndex&lt;K,V&gt;)new BtreeFieldIndex&lt;K,V&gt;(fieldName, unique)<span class="c">;</span></div><div class="line" id="l1895">                <span class="c">index.AssignOid(this, 0, false);</span></div><div class="line" id="l1896">                <span class="c">return index;</span></div><div class="line" id="l1897">            }
</div><div class="line" id="l1898">        <span class="c">}</span></div><div class="line" id="l1899"><br></div><div class="line" id="l1900">        public MultiFieldIndex&lt;T&gt; CreateFieldIndex&lt;T&gt;(string[] fieldNames, bool unique) where T:class,IPersistent
</div><div class="line" id="l1901">        {
</div><div class="line" id="l1902">            lock (this)
</div><div class="line" id="l1903">            {
</div><div class="line" id="l1904">                ensureOpened();
</div><div class="line" id="l1905"><br></div><div class="line" id="l1906">#if COMPACT_NET_FRAMEWORK
</div><div class="line" id="l1907">                if (alternativeBtree) 
</div><div class="line" id="l1908">                {
</div><div class="line" id="l1909">                    throw new StorageError(StorageError.ErrorCode.UNSUPPORTED_INDEX_TYPE);
</div><div class="line" id="l1910">                }
</div><div class="line" id="l1911">                MultiFieldIndex&lt;T&gt; index = new BtreeMultiFieldIndex&lt;T&gt;(fieldNames, unique);
</div><div class="line" id="l1912">#else
</div><div class="line" id="l1913">                MultiFieldIndex&lt;T&gt; index = alternativeBtree
</div><div class="line" id="l1914">                    ? (MultiFieldIndex&lt;T&gt;)new AltBtreeMultiFieldIndex&lt;T&gt;(fieldNames, unique)
</div><div class="line" id="l1915">                    : (MultiFieldIndex&lt;T&gt;)new BtreeMultiFieldIndex&lt;T&gt;(fieldNames, unique);
</div><div class="line" id="l1916">#endif
</div><div class="line" id="l1917">                index.AssignOid(this, 0, false);
</div><div class="line" id="l1918">                return index;
</div><div class="line" id="l1919">            }
</div><div class="line" id="l1920">        }
</div><div class="line" id="l1921"><br></div><div class="line" id="l1922">        public Link&lt;T&gt; CreateLink&lt;T&gt;() where T:class,IPersistent
</div><div class="line" id="l1923">        {
</div><div class="line" id="l1924">            return CreateLink&lt;T&gt;(8);
</div><div class="line" id="l1925">        }
</div><div class="line" id="l1926"><br></div><div class="line" id="l1927">        public Link&lt;T&gt; CreateLink&lt;T&gt;(int initialSize) where T:class,IPersistent
</div><div class="line" id="l1928">        {
</div><div class="line" id="l1929">            <span class="c">return new LinkImpl&lt;T&gt;(initialSize);</span></div><div class="line" id="l1930">        }
</div><div class="line" id="l1931"><br></div><div class="line" id="l1932">        internal Link&lt;T&gt; ConstructLink&lt;T&gt;(IPersistent[] arr, IPersistent owner) where T:class,IPersistent
</div><div class="line" id="l1933">        {
</div><div class="line" id="l1934">            <span class="c">return new LinkImpl&lt;T&gt;(arr, owner);</span></div><div class="line" id="l1935">        }
</div><div class="line" id="l1936"><br></div><div class="line" id="l1937">        public PArray&lt;T&gt; CreateArray&lt;T&gt;() where T:class,IPersistent
</div><div class="line" id="l1938">        {
</div><div class="line" id="l1939">            return CreateArray&lt;T&gt;(8);
</div><div class="line" id="l1940">        }
</div><div class="line" id="l1941"><br></div><div class="line" id="l1942">        public PArray&lt;T&gt; CreateArray&lt;T&gt;(int initialSize) where T:class,IPersistent
</div><div class="line" id="l1943">        {
</div><div class="line" id="l1944">            return new PArrayImpl&lt;T&gt;(this, initialSize);
</div><div class="line" id="l1945">        }
</div><div class="line" id="l1946"><br></div><div class="line" id="l1947">        internal PArray&lt;T&gt; ConstructArray&lt;T&gt;(int[] arr, IPersistent owner) where T:class,IPersistent
</div><div class="line" id="l1948">        {
</div><div class="line" id="l1949">            return new PArrayImpl&lt;T&gt;(this, arr, owner);
</div><div class="line" id="l1950">        }
</div><div class="line" id="l1951"><br></div><div class="line" id="l1952">        public Relation&lt;M,O&gt; CreateRelation&lt;M,O&gt;(O owner) where M:class,IPersistent where O:class,IPersistent
</div><div class="line" id="l1953">        {
</div><div class="line" id="l1954">            return new RelationImpl&lt;M,O&gt;(owner);
</div><div class="line" id="l1955">        }
</div><div class="line" id="l1956"><br></div><div class="line" id="l1957">        public TimeSeries&lt;T&gt; CreateTimeSeries&lt;T&gt;(int blockSize, long maxBlockTimeInterval) where T:TimeSeriesTick
</div><div class="line" id="l1958">        {
</div><div class="line" id="l1959">            return new TimeSeriesImpl&lt;T&gt;(this, blockSize, maxBlockTimeInterval);
</div><div class="line" id="l1960">        }
</div><div class="line" id="l1961"><br></div><div class="line" id="l1962">        public PatriciaTrie&lt;T&gt; CreatePatriciaTrie&lt;T&gt;() where T:class,IPersistent
</div><div class="line" id="l1963">        {
</div><div class="line" id="l1964">            return new PTrie&lt;T&gt;();
</div><div class="line" id="l1965">        }
</div><div class="line" id="l1966"><br></div><div class="line" id="l1967">        public ISet&lt;IPersistent&gt; CreateSet() 
</div><div class="line" id="l1968">        {
</div><div class="line" id="l1969">             return CreateSet&lt;IPersistent&gt;();
</div><div class="line" id="l1970">        } 
</div><div class="line" id="l1971"><br></div><div class="line" id="l1972">        public Link&lt;IPersistent&gt; CreateLink()
</div><div class="line" id="l1973">        {
</div><div class="line" id="l1974">            return CreateLink&lt;IPersistent&gt;(8);
</div><div class="line" id="l1975">        }
</div><div class="line" id="l1976"><br></div><div class="line" id="l1977">        public Link&lt;IPersistent&gt; CreateLink(int initialSize)
</div><div class="line" id="l1978">        {
</div><div class="line" id="l1979">            <span class="c">return CreateLink&lt;IPersistent&gt;(initialSize);</span></div><div class="line" id="l1980">        }
</div><div class="line" id="l1981"><br></div><div class="line" id="l1982">        public PArray&lt;IPersistent&gt; CreateArray()
</div><div class="line" id="l1983">        {
</div><div class="line" id="l1984">            return CreateArray&lt;IPersistent&gt;(8);
</div><div class="line" id="l1985">        }
</div><div class="line" id="l1986"><br></div><div class="line" id="l1987">        public PArray&lt;IPersistent&gt; CreateArray(int initialSize)
</div><div class="line" id="l1988">        {
</div><div class="line" id="l1989">            return CreateArray&lt;IPersistent&gt;(initialSize);
</div><div class="line" id="l1990">        }
</div><div class="line" id="l1991"><br></div><div class="line" id="l1992">        public Blob CreateBlob() 
</div><div class="line" id="l1993">        {
</div><div class="line" id="l1994">            return new BlobImpl(Page.pageSize - ObjectHeader.Sizeof - 16);
</div><div class="line" id="l1995">        }
</div><div class="line" id="l1996"><br></div><div class="line" id="l1997">#if !OMIT_XML
</div><div class="line" id="l1998">        public void  ExportXML(System.IO.StreamWriter writer)
</div><div class="line" id="l1999">        {
</div><div class="line" id="l2000">            <span class="c">lock (this)</span></div><div class="line" id="l2001">            {
</div><div class="line" id="l2002">                <span class="c">ensureOpened();</span></div><div class="line" id="l2003">                <span class="c">int rootOid = header.root[1-currIndex].rootObject;</span></div><div class="line" id="l2004">                <span class="c">if (rootOid != 0)</span></div><div class="line" id="l2005">                {
</div><div class="line" id="l2006">                    <span class="c">XMLExporter xmlExporter = new XMLExporter(this, writer);</span></div><div class="line" id="l2007">                    <span class="c">xmlExporter.exportDatabase(rootOid);</span></div><div class="line" id="l2008">                }
</div><div class="line" id="l2009">            }
</div><div class="line" id="l2010">        <span class="c">}</span></div><div class="line" id="l2011"><br></div><div class="line" id="l2012">        public void  ImportXML(System.IO.StreamReader reader)
</div><div class="line" id="l2013">        {
</div><div class="line" id="l2014">            <span class="c">lock (this)</span></div><div class="line" id="l2015">            {
</div><div class="line" id="l2016">                <span class="c">ensureOpened();</span></div><div class="line" id="l2017">                <span class="c">XMLImporter xmlImporter = new XMLImporter(this, reader);</span></div><div class="line" id="l2018">                <span class="c">xmlImporter.importDatabase();</span></div><div class="line" id="l2019">            }
</div><div class="line" id="l2020">        <span class="c">}</span></div><div class="line" id="l2021">#endif
</div><div class="line" id="l2022"><br></div><div class="line" id="l2023">        internal long getGCPos(int oid) 
</div><div class="line" id="l2024">        { 
</div><div class="line" id="l2025">            Page pg = pool.getPage(header.root[currIndex].index 
</div><div class="line" id="l2026">                + ((long)(oid &gt;&gt; dbHandlesPerPageBits) &lt;&lt; Page.pageBits));
</div><div class="line" id="l2027">            long pos = Bytes.unpack8(pg.data, (oid &amp; (dbHandlesPerPage-1)) &lt;&lt; 3);
</div><div class="line" id="l2028">            pool.unfix(pg);
</div><div class="line" id="l2029">            return pos;
</div><div class="line" id="l2030">        }
</div><div class="line" id="l2031"><br></div><div class="line" id="l2032">        internal void markOid(int oid) 
</div><div class="line" id="l2033">        { 
</div><div class="line" id="l2034">            if (oid != 0) 
</div><div class="line" id="l2035">            {  
</div><div class="line" id="l2036">                long pos = getGCPos(oid);
</div><div class="line" id="l2037">                if ((pos &amp; (dbFreeHandleFlag|dbPageObjectFlag)) != 0) 
</div><div class="line" id="l2038">                { 
</div><div class="line" id="l2039">                    throw new StorageError(StorageError.ErrorCode.INVALID_OID);
</div><div class="line" id="l2040">                }     
</div><div class="line" id="l2041">                int bit = (int)((ulong)pos &gt;&gt; dbAllocationQuantumBits);
</div><div class="line" id="l2042">                if ((blackBitmap[(uint)bit &gt;&gt; 5] &amp; (1 &lt;&lt; (bit &amp; 31))) == 0) 
</div><div class="line" id="l2043">                { 
</div><div class="line" id="l2044">                    greyBitmap[(uint)bit &gt;&gt; 5] |= 1 &lt;&lt; (bit &amp; 31);
</div><div class="line" id="l2045">                }
</div><div class="line" id="l2046">            }
</div><div class="line" id="l2047">        }
</div><div class="line" id="l2048"><br></div><div class="line" id="l2049">        internal Page getGCPage(int oid) 
</div><div class="line" id="l2050">        {  
</div><div class="line" id="l2051">            return pool.getPage(getGCPos(oid) &amp; ~dbFlagsMask);
</div><div class="line" id="l2052">        }
</div><div class="line" id="l2053"><br></div><div class="line" id="l2054">        public int Gc() 
</div><div class="line" id="l2055">        { 
</div><div class="line" id="l2056">            lock (this) 
</div><div class="line" id="l2057">            { 
</div><div class="line" id="l2058">                return gc0();
</div><div class="line" id="l2059">            }
</div><div class="line" id="l2060">        }
</div><div class="line" id="l2061"><br></div><div class="line" id="l2062">        internal Btree createBtreeStub(byte[] data, int offs) 
</div><div class="line" id="l2063">        { 
</div><div class="line" id="l2064">            <span class="c">return new Btree&lt;int,IPersistent&gt;(data, ObjectHeader.Sizeof + offs);</span></div><div class="line" id="l2065">        }
</div><div class="line" id="l2066"><br></div><div class="line" id="l2067">        private void mark()
</div><div class="line" id="l2068">        {
</div><div class="line" id="l2069">            // Console.WriteLine("Start GC, allocatedDelta=" + allocatedDelta + ", header[" + currIndex + "].size=" + header.root[currIndex].size + ", gcTreshold=" + gcThreshold);
</div><div class="line" id="l2070">            int bitmapSize = (int)((ulong)header.root[currIndex].size &gt;&gt; (dbAllocationQuantumBits + 5)) + 1;
</div><div class="line" id="l2071">            bool existsNotMarkedObjects;
</div><div class="line" id="l2072">            long pos;
</div><div class="line" id="l2073">            int  i, j;
</div><div class="line" id="l2074"><br></div><div class="line" id="l2075">            if (listener != null) 
</div><div class="line" id="l2076">            { 
</div><div class="line" id="l2077">                listener.GcStarted();
</div><div class="line" id="l2078">            }          
</div><div class="line" id="l2079"><br></div><div class="line" id="l2080">            greyBitmap = new int[bitmapSize];
</div><div class="line" id="l2081">            blackBitmap = new int[bitmapSize];
</div><div class="line" id="l2082">            int rootOid = header.root[currIndex].rootObject;
</div><div class="line" id="l2083">            if (rootOid != 0) 
</div><div class="line" id="l2084">            { 
</div><div class="line" id="l2085">                markOid(rootOid);
</div><div class="line" id="l2086">                do 
</div><div class="line" id="l2087">                { 
</div><div class="line" id="l2088">                    existsNotMarkedObjects = false;
</div><div class="line" id="l2089">                    for (i = 0; i &lt; bitmapSize; i++) 
</div><div class="line" id="l2090">                    { 
</div><div class="line" id="l2091">                        if (greyBitmap[i] != 0) 
</div><div class="line" id="l2092">                        { 
</div><div class="line" id="l2093">                            existsNotMarkedObjects = true;
</div><div class="line" id="l2094">                            for (j = 0; j &lt; 32; j++) 
</div><div class="line" id="l2095">                            { 
</div><div class="line" id="l2096">                                if ((greyBitmap[i] &amp; (1 &lt;&lt; j)) != 0) 
</div><div class="line" id="l2097">                                { 
</div><div class="line" id="l2098">                                    pos = (((long)i &lt;&lt; 5) + j) &lt;&lt; dbAllocationQuantumBits;
</div><div class="line" id="l2099">                                    greyBitmap[i] &amp;= ~(1 &lt;&lt; j);
</div><div class="line" id="l2100">                                    blackBitmap[i] |= 1 &lt;&lt; j;
</div><div class="line" id="l2101">                                    int offs = (int)pos &amp; (Page.pageSize-1);
</div><div class="line" id="l2102">                                    Page pg = pool.getPage(pos - offs);
</div><div class="line" id="l2103">                                    int typeOid = ObjectHeader.getType(pg.data, offs);
</div><div class="line" id="l2104">                                    if (typeOid != 0) 
</div><div class="line" id="l2105">                                    { 
</div><div class="line" id="l2106">                                        ClassDescriptor desc = (ClassDescriptor)lookupObject(typeOid, typeof(ClassDescriptor));
</div><div class="line" id="l2107">                                        if (typeof(Btree).IsAssignableFrom(desc.cls)) 
</div><div class="line" id="l2108">                                        { 
</div><div class="line" id="l2109">                                            Btree btree = createBtreeStub(pg.data, offs);
</div><div class="line" id="l2110">                                            btree.AssignOid(this, 0, false);
</div><div class="line" id="l2111">                                            btree.markTree();
</div><div class="line" id="l2112">                                        } 
</div><div class="line" id="l2113">                                        else if (desc.hasReferences) 
</div><div class="line" id="l2114">                                        { 
</div><div class="line" id="l2115">                                            markObject(pool.get(pos), ObjectHeader.Sizeof, desc);
</div><div class="line" id="l2116"><br></div><div class="line" id="l2117">                                        }
</div><div class="line" id="l2118">                                    }
</div><div class="line" id="l2119">                                    pool.unfix(pg);                                
</div><div class="line" id="l2120">                                }
</div><div class="line" id="l2121">                            }
</div><div class="line" id="l2122">                        }
</div><div class="line" id="l2123">                    }
</div><div class="line" id="l2124">                } while (existsNotMarkedObjects);
</div><div class="line" id="l2125">            }
</div><div class="line" id="l2126">        }
</div><div class="line" id="l2127"><br></div><div class="line" id="l2128">        private int sweep() 
</div><div class="line" id="l2129">        {
</div><div class="line" id="l2130">            int nDeallocated = 0;
</div><div class="line" id="l2131">            long pos;
</div><div class="line" id="l2132">            gcDone = true;
</div><div class="line" id="l2133">            for (int i = dbFirstUserId, j = committedIndexSize; i &lt; j; i++) 
</div><div class="line" id="l2134">            {
</div><div class="line" id="l2135">                pos = getGCPos(i);
</div><div class="line" id="l2136">                if (pos != 0 &amp;&amp; ((int)pos &amp; (dbPageObjectFlag|dbFreeHandleFlag)) == 0) 
</div><div class="line" id="l2137">                {
</div><div class="line" id="l2138">                    int bit = (int)((ulong)pos &gt;&gt; dbAllocationQuantumBits);
</div><div class="line" id="l2139">                    if ((blackBitmap[(uint)bit &gt;&gt; 5] &amp; (1 &lt;&lt; (bit &amp; 31))) == 0) 
</div><div class="line" id="l2140">                    { 
</div><div class="line" id="l2141">                        // object is not accessible
</div><div class="line" id="l2142">                        if (getPos(i) != pos) 
</div><div class="line" id="l2143">                        { 
</div><div class="line" id="l2144">                            throw new StorageError(StorageError.ErrorCode.INVALID_OID);
</div><div class="line" id="l2145">                        }
</div><div class="line" id="l2146">                        int offs = (int)pos &amp; (Page.pageSize-1);
</div><div class="line" id="l2147">                        Page pg = pool.getPage(pos - offs);
</div><div class="line" id="l2148">                        int typeOid = ObjectHeader.getType(pg.data, offs);
</div><div class="line" id="l2149">                        if (typeOid != 0) 
</div><div class="line" id="l2150">                        { 
</div><div class="line" id="l2151">                            ClassDescriptor desc = findClassDescriptor(typeOid);
</div><div class="line" id="l2152">                            nDeallocated += 1;
</div><div class="line" id="l2153">                            if (desc != null 
</div><div class="line" id="l2154">                                &amp;&amp; (typeof(Btree).IsAssignableFrom(desc.cls))) 
</div><div class="line" id="l2155">                            { 
</div><div class="line" id="l2156">                                Btree btree = createBtreeStub(pg.data, offs);
</div><div class="line" id="l2157">                                pool.unfix(pg);
</div><div class="line" id="l2158">                                btree.AssignOid(this, i, false);
</div><div class="line" id="l2159">                                btree.Deallocate();
</div><div class="line" id="l2160">                            }
</div><div class="line" id="l2161">                            else 
</div><div class="line" id="l2162">                            { 
</div><div class="line" id="l2163">                                int size = ObjectHeader.getSize(pg.data, offs);
</div><div class="line" id="l2164">                                pool.unfix(pg);
</div><div class="line" id="l2165">                                freeId(i);
</div><div class="line" id="l2166">                                objectCache.remove(i);                        
</div><div class="line" id="l2167">                                cloneBitmap(pos, size);
</div><div class="line" id="l2168">                            }
</div><div class="line" id="l2169">                            if (listener != null) 
</div><div class="line" id="l2170">                            { 
</div><div class="line" id="l2171">                                listener.DeallocateObject(desc.cls, i);
</div><div class="line" id="l2172">                            }
</div><div class="line" id="l2173">                        }
</div><div class="line" id="l2174">                    }
</div><div class="line" id="l2175">                }   
</div><div class="line" id="l2176">            }
</div><div class="line" id="l2177"><br></div><div class="line" id="l2178">            greyBitmap = null;
</div><div class="line" id="l2179">            blackBitmap = null;
</div><div class="line" id="l2180">            allocatedDelta = 0;
</div><div class="line" id="l2181">            gcActive = false;
</div><div class="line" id="l2182"><br></div><div class="line" id="l2183">            if (listener != null) 
</div><div class="line" id="l2184">            {
</div><div class="line" id="l2185">                listener.GcCompleted(nDeallocated);
</div><div class="line" id="l2186">            }
</div><div class="line" id="l2187">            return nDeallocated;
</div><div class="line" id="l2188">        }
</div><div class="line" id="l2189"><br></div><div class="line" id="l2190">#if !COMPACT_NET_FRAMEWORK
</div><div class="line" id="l2191">        public void backgroundGcThread() 
</div><div class="line" id="l2192">        { 
</div><div class="line" id="l2193">            while (true) 
</div><div class="line" id="l2194">            { 
</div><div class="line" id="l2195">                lock (backgroundGcStartMonitor) 
</div><div class="line" id="l2196">                { 
</div><div class="line" id="l2197">                    while (!gcGo &amp;&amp; opened) 
</div><div class="line" id="l2198">                    { 
</div><div class="line" id="l2199">                        Monitor.Wait(backgroundGcStartMonitor);
</div><div class="line" id="l2200">                    }
</div><div class="line" id="l2201">                    if (!opened) 
</div><div class="line" id="l2202">                    { 
</div><div class="line" id="l2203">                        return;
</div><div class="line" id="l2204">                    }
</div><div class="line" id="l2205">                    gcGo = false;
</div><div class="line" id="l2206">                }
</div><div class="line" id="l2207">                lock (backgroundGcMonitor) 
</div><div class="line" id="l2208">                {
</div><div class="line" id="l2209">                    if (!opened) 
</div><div class="line" id="l2210">                    { 
</div><div class="line" id="l2211">                        return;
</div><div class="line" id="l2212">                    }
</div><div class="line" id="l2213">                    mark();
</div><div class="line" id="l2214">                    lock (this) 
</div><div class="line" id="l2215">                    { 
</div><div class="line" id="l2216">                        lock (objectCache) 
</div><div class="line" id="l2217">                        { 
</div><div class="line" id="l2218">                            sweep();
</div><div class="line" id="l2219">                        }
</div><div class="line" id="l2220">                    }
</div><div class="line" id="l2221">                }
</div><div class="line" id="l2222">            }
</div><div class="line" id="l2223">        }
</div><div class="line" id="l2224"><br></div><div class="line" id="l2225">        private void activateGc() 
</div><div class="line" id="l2226">        { 
</div><div class="line" id="l2227">            lock (backgroundGcStartMonitor) 
</div><div class="line" id="l2228">            {
</div><div class="line" id="l2229">                gcGo = true;
</div><div class="line" id="l2230">                Monitor.Pulse(backgroundGcStartMonitor);
</div><div class="line" id="l2231">            }
</div><div class="line" id="l2232">        }
</div><div class="line" id="l2233">#endif
</div><div class="line" id="l2234"><br></div><div class="line" id="l2235">        private int gc0()
</div><div class="line" id="l2236">        {
</div><div class="line" id="l2237">            lock (objectCache) 
</div><div class="line" id="l2238">            { 
</div><div class="line" id="l2239">                ensureOpened();
</div><div class="line" id="l2240"><br></div><div class="line" id="l2241">                if (gcDone || gcActive) 
</div><div class="line" id="l2242">                { 
</div><div class="line" id="l2243">                    return 0;
</div><div class="line" id="l2244">                }
</div><div class="line" id="l2245">                gcActive = true;
</div><div class="line" id="l2246">#if !COMPACT_NET_FRAMEWORK
</div><div class="line" id="l2247">                if (backgroundGc) 
</div><div class="line" id="l2248">                { 
</div><div class="line" id="l2249">                    if (gcThread == null) 
</div><div class="line" id="l2250">                    { 
</div><div class="line" id="l2251">                        gcThread = new Thread(new ThreadStart(backgroundGcThread));
</div><div class="line" id="l2252">                        gcThread.Start();
</div><div class="line" id="l2253">                    }
</div><div class="line" id="l2254">                    activateGc();
</div><div class="line" id="l2255">                    return 0;
</div><div class="line" id="l2256">                }
</div><div class="line" id="l2257">#endif
</div><div class="line" id="l2258">                // System.out.println("Start GC, allocatedDelta=" + allocatedDelta + ", header[" + currIndex + "].size=" + header.root[currIndex].size + ", gcTreshold=" + gcThreshold);
</div><div class="line" id="l2259"><br></div><div class="line" id="l2260">                mark();
</div><div class="line" id="l2261">                return sweep();
</div><div class="line" id="l2262">            }
</div><div class="line" id="l2263">        }
</div><div class="line" id="l2264"><br></div><div class="line" id="l2265">        public Hashtable GetMemoryDump() 
</div><div class="line" id="l2266">        { 
</div><div class="line" id="l2267">            lock (this) 
</div><div class="line" id="l2268">            { 
</div><div class="line" id="l2269">                lock (objectCache) 
</div><div class="line" id="l2270">                { 
</div><div class="line" id="l2271">                    ensureOpened();
</div><div class="line" id="l2272"><br></div><div class="line" id="l2273">                    int bitmapSize = (int)(header.root[currIndex].size &gt;&gt; (dbAllocationQuantumBits + 5)) + 1;
</div><div class="line" id="l2274">                    bool existsNotMarkedObjects;
</div><div class="line" id="l2275">                    long pos;
</div><div class="line" id="l2276">                    int  i, j;
</div><div class="line" id="l2277"><br></div><div class="line" id="l2278">                    // mark
</div><div class="line" id="l2279">                    greyBitmap = new int[bitmapSize];
</div><div class="line" id="l2280">                    blackBitmap = new int[bitmapSize];
</div><div class="line" id="l2281">                    int rootOid = header.root[currIndex].rootObject;
</div><div class="line" id="l2282">                    Hashtable map = new Hashtable();
</div><div class="line" id="l2283"><br></div><div class="line" id="l2284">                    if (rootOid != 0) 
</div><div class="line" id="l2285">                    { 
</div><div class="line" id="l2286">                        MemoryUsage indexUsage = new MemoryUsage(typeof(GenericIndex));
</div><div class="line" id="l2287">                        MemoryUsage classUsage = new MemoryUsage(typeof(Type));
</div><div class="line" id="l2288"><br></div><div class="line" id="l2289">                        markOid(rootOid);
</div><div class="line" id="l2290">                        do 
</div><div class="line" id="l2291">                        { 
</div><div class="line" id="l2292">                            existsNotMarkedObjects = false;
</div><div class="line" id="l2293">                            for (i = 0; i &lt; bitmapSize; i++) 
</div><div class="line" id="l2294">                            { 
</div><div class="line" id="l2295">                                if (greyBitmap[i] != 0) 
</div><div class="line" id="l2296">                                { 
</div><div class="line" id="l2297">                                    existsNotMarkedObjects = true;
</div><div class="line" id="l2298">                                    for (j = 0; j &lt; 32; j++) 
</div><div class="line" id="l2299">                                    { 
</div><div class="line" id="l2300">                                        if ((greyBitmap[i] &amp; (1 &lt;&lt; j)) != 0) 
</div><div class="line" id="l2301">                                        { 
</div><div class="line" id="l2302">                                            pos = (((long)i &lt;&lt; 5) + j) &lt;&lt; dbAllocationQuantumBits;
</div><div class="line" id="l2303">                                            greyBitmap[i] &amp;= ~(1 &lt;&lt; j);
</div><div class="line" id="l2304">                                            blackBitmap[i] |= 1 &lt;&lt; j;
</div><div class="line" id="l2305">                                            int offs = (int)pos &amp; (Page.pageSize-1);
</div><div class="line" id="l2306">                                            Page pg = pool.getPage(pos - offs);
</div><div class="line" id="l2307">                                            int typeOid = ObjectHeader.getType(pg.data, offs);
</div><div class="line" id="l2308">                                            int objSize = ObjectHeader.getSize(pg.data, offs);
</div><div class="line" id="l2309">                                            int alignedSize = (objSize + dbAllocationQuantum - 1) &amp; ~(dbAllocationQuantum-1);                                    
</div><div class="line" id="l2310">                                            if (typeOid != 0) 
</div><div class="line" id="l2311">                                            { 
</div><div class="line" id="l2312">                                                markOid(typeOid);
</div><div class="line" id="l2313">                                                ClassDescriptor desc = findClassDescriptor(typeOid);
</div><div class="line" id="l2314">                                                if (typeof(Btree).IsAssignableFrom(desc.cls)) 
</div><div class="line" id="l2315">                                                { 
</div><div class="line" id="l2316">                                                    Btree btree = createBtreeStub(pg.data, offs);
</div><div class="line" id="l2317">                                                    btree.AssignOid(this, 0, false);
</div><div class="line" id="l2318">                                                    int nPages = btree.markTree();
</div><div class="line" id="l2319">                                                    indexUsage.nInstances += 1;
</div><div class="line" id="l2320">                                                    indexUsage.totalSize += (long)nPages*Page.pageSize + objSize;
</div><div class="line" id="l2321">                                                    indexUsage.allocatedSize += (long)nPages*Page.pageSize + alignedSize;
</div><div class="line" id="l2322">                                                } 
</div><div class="line" id="l2323">                                                else 
</div><div class="line" id="l2324">                                                { 
</div><div class="line" id="l2325">                                                    MemoryUsage usage = (MemoryUsage)map[desc.cls];
</div><div class="line" id="l2326">                                                    if (usage == null) 
</div><div class="line" id="l2327">                                                    { 
</div><div class="line" id="l2328">                                                        usage = new MemoryUsage(desc.cls);
</div><div class="line" id="l2329">                                                        map[desc.cls] = usage;
</div><div class="line" id="l2330">                                                    }
</div><div class="line" id="l2331">                                                    usage.nInstances += 1;
</div><div class="line" id="l2332">                                                    usage.totalSize += objSize;
</div><div class="line" id="l2333">                                                    usage.allocatedSize += alignedSize;
</div><div class="line" id="l2334"><br></div><div class="line" id="l2335">                                                    if (desc.hasReferences) 
</div><div class="line" id="l2336">                                                    { 
</div><div class="line" id="l2337">                                                        markObject(pool.get(pos), ObjectHeader.Sizeof, desc);
</div><div class="line" id="l2338">                                                    }
</div><div class="line" id="l2339">                                                }
</div><div class="line" id="l2340">                                            } 
</div><div class="line" id="l2341">                                            else 
</div><div class="line" id="l2342">                                            { 
</div><div class="line" id="l2343">                                                classUsage.nInstances += 1;
</div><div class="line" id="l2344">                                                classUsage.totalSize += objSize;
</div><div class="line" id="l2345">                                                classUsage.allocatedSize += alignedSize;
</div><div class="line" id="l2346">                                            }
</div><div class="line" id="l2347">                                            pool.unfix(pg);                                
</div><div class="line" id="l2348">                                        }
</div><div class="line" id="l2349">                                    }
</div><div class="line" id="l2350">                                }
</div><div class="line" id="l2351">                            }
</div><div class="line" id="l2352">                        } while (existsNotMarkedObjects);
</div><div class="line" id="l2353"><br></div><div class="line" id="l2354">                        if (indexUsage.nInstances != 0) 
</div><div class="line" id="l2355">                        { 
</div><div class="line" id="l2356">                            map[typeof(GenericIndex)] = indexUsage;
</div><div class="line" id="l2357">                        }
</div><div class="line" id="l2358">                        if (classUsage.nInstances != 0) 
</div><div class="line" id="l2359">                        { 
</div><div class="line" id="l2360">                            map[typeof(Type)] = classUsage;
</div><div class="line" id="l2361">                        }
</div><div class="line" id="l2362">                        MemoryUsage system = new MemoryUsage(typeof(Storage));
</div><div class="line" id="l2363">                        system.totalSize += header.root[0].indexSize*8L;
</div><div class="line" id="l2364">                        system.totalSize += header.root[1].indexSize*8L;
</div><div class="line" id="l2365">                        system.totalSize += (long)(header.root[currIndex].bitmapEnd-dbBitmapId)*Page.pageSize;
</div><div class="line" id="l2366">                        system.totalSize += Page.pageSize; // root page
</div><div class="line" id="l2367"><br></div><div class="line" id="l2368">                        if (header.root[currIndex].bitmapExtent != 0) 
</div><div class="line" id="l2369">                        { 
</div><div class="line" id="l2370">                            system.allocatedSize = getBitmapUsedSpace(dbBitmapId, dbBitmapId+dbBitmapPages)
</div><div class="line" id="l2371">                                +  getBitmapUsedSpace(header.root[currIndex].bitmapExtent, 
</div><div class="line" id="l2372">                                header.root[currIndex].bitmapExtent + header.root[currIndex].bitmapEnd-dbBitmapId);
</div><div class="line" id="l2373">                        } 
</div><div class="line" id="l2374">                        else 
</div><div class="line" id="l2375">                        { 
</div><div class="line" id="l2376">                            system.allocatedSize = getBitmapUsedSpace(dbBitmapId, header.root[currIndex].bitmapEnd);
</div><div class="line" id="l2377">                        }
</div><div class="line" id="l2378">                        system.nInstances = header.root[currIndex].indexSize;
</div><div class="line" id="l2379">                        map[typeof(Storage)] = system;
</div><div class="line" id="l2380">                    } 
</div><div class="line" id="l2381">                    return map;
</div><div class="line" id="l2382">                }
</div><div class="line" id="l2383">            }
</div><div class="line" id="l2384">        }
</div><div class="line" id="l2385"><br></div><div class="line" id="l2386">        long getBitmapUsedSpace(int from, int till) 
</div><div class="line" id="l2387">        { 
</div><div class="line" id="l2388">            long allocated = 0;
</div><div class="line" id="l2389">            while (from &lt; till) 
</div><div class="line" id="l2390">            {
</div><div class="line" id="l2391">                Page pg = getGCPage(from);
</div><div class="line" id="l2392">                for (int j = 0; j &lt; Page.pageSize; j++) 
</div><div class="line" id="l2393">                {
</div><div class="line" id="l2394">                    int mask = pg.data[j] &amp; 0xFF;
</div><div class="line" id="l2395">                    while (mask != 0) 
</div><div class="line" id="l2396">                    { 
</div><div class="line" id="l2397">                        if ((mask &amp; 1) != 0) 
</div><div class="line" id="l2398">                        { 
</div><div class="line" id="l2399">                            allocated += dbAllocationQuantum;
</div><div class="line" id="l2400">                        }
</div><div class="line" id="l2401">                        mask &gt;&gt;= 1;
</div><div class="line" id="l2402">                    }
</div><div class="line" id="l2403">                }
</div><div class="line" id="l2404">                pool.unfix(pg);
</div><div class="line" id="l2405">                from += 1;
</div><div class="line" id="l2406">            }
</div><div class="line" id="l2407">            return allocated;
</div><div class="line" id="l2408">        }
</div><div class="line" id="l2409"><br></div><div class="line" id="l2410">        internal int markObject(byte[] obj, int offs,  ClassDescriptor desc)
</div><div class="line" id="l2411">        { 
</div><div class="line" id="l2412">            ClassDescriptor.FieldDescriptor[] all = desc.allFields;
</div><div class="line" id="l2413"><br></div><div class="line" id="l2414">            for (int i = 0, n = all.Length; i &lt; n; i++) 
</div><div class="line" id="l2415">            { 
</div><div class="line" id="l2416">                ClassDescriptor.FieldDescriptor fd = all[i];
</div><div class="line" id="l2417">                switch (fd.type) 
</div><div class="line" id="l2418">                { 
</div><div class="line" id="l2419">                    case ClassDescriptor.FieldType.tpBoolean:
</div><div class="line" id="l2420">                    case ClassDescriptor.FieldType.tpByte:
</div><div class="line" id="l2421">                    case ClassDescriptor.FieldType.tpSByte:
</div><div class="line" id="l2422">                        offs += 1;
</div><div class="line" id="l2423">                        continue;
</div><div class="line" id="l2424">                    case ClassDescriptor.FieldType.tpChar:
</div><div class="line" id="l2425">                    case ClassDescriptor.FieldType.tpShort:
</div><div class="line" id="l2426">                    case ClassDescriptor.FieldType.tpUShort:
</div><div class="line" id="l2427">                        offs += 2;
</div><div class="line" id="l2428">                        continue;
</div><div class="line" id="l2429">                    case ClassDescriptor.FieldType.tpInt:
</div><div class="line" id="l2430">                    case ClassDescriptor.FieldType.tpUInt:
</div><div class="line" id="l2431">                    case ClassDescriptor.FieldType.tpEnum:
</div><div class="line" id="l2432">                    case ClassDescriptor.FieldType.tpFloat:
</div><div class="line" id="l2433">                        offs += 4;
</div><div class="line" id="l2434">                        continue;
</div><div class="line" id="l2435">                    case ClassDescriptor.FieldType.tpLong:
</div><div class="line" id="l2436">                    case ClassDescriptor.FieldType.tpULong:
</div><div class="line" id="l2437">                    case ClassDescriptor.FieldType.tpDouble:
</div><div class="line" id="l2438">                    case ClassDescriptor.FieldType.tpDate:
</div><div class="line" id="l2439">                        offs += 8;
</div><div class="line" id="l2440">                        continue;
</div><div class="line" id="l2441">                    case ClassDescriptor.FieldType.tpDecimal:
</div><div class="line" id="l2442">                    case ClassDescriptor.FieldType.tpGuid:
</div><div class="line" id="l2443">                        offs += 16;
</div><div class="line" id="l2444">                        continue;
</div><div class="line" id="l2445">                    case ClassDescriptor.FieldType.tpString:
</div><div class="line" id="l2446">                    {
</div><div class="line" id="l2447">                        int strlen = Bytes.unpack4(obj, offs);
</div><div class="line" id="l2448">                        offs += 4;
</div><div class="line" id="l2449">                        if (strlen &gt; 0) 
</div><div class="line" id="l2450">                        {
</div><div class="line" id="l2451">                            offs += strlen*2;
</div><div class="line" id="l2452">                        } 
</div><div class="line" id="l2453">                        else if (strlen &lt; -1) 
</div><div class="line" id="l2454">                        {
</div><div class="line" id="l2455">                            offs -= strlen+2;
</div><div class="line" id="l2456">                        }
</div><div class="line" id="l2457">                        continue;
</div><div class="line" id="l2458">                    }
</div><div class="line" id="l2459">                    case ClassDescriptor.FieldType.tpObject:
</div><div class="line" id="l2460">                    case ClassDescriptor.FieldType.tpOid:
</div><div class="line" id="l2461">                        markOid(Bytes.unpack4(obj, offs));
</div><div class="line" id="l2462">                        offs += 4;
</div><div class="line" id="l2463">                        continue;
</div><div class="line" id="l2464">                    case ClassDescriptor.FieldType.tpValue:
</div><div class="line" id="l2465">                        offs = markObject(obj, offs, fd.valueDesc);
</div><div class="line" id="l2466">                        continue;
</div><div class="line" id="l2467">#if SUPPORT_RAW_TYPE
</div><div class="line" id="l2468">                    case ClassDescriptor.FieldType.tpRaw:
</div><div class="line" id="l2469">                    {
</div><div class="line" id="l2470">                        int len = Bytes.unpack4(obj, offs);
</div><div class="line" id="l2471">                        offs += 4;
</div><div class="line" id="l2472">                        if (len &gt; 0) 
</div><div class="line" id="l2473">                        { 
</div><div class="line" id="l2474">                            offs += len;
</div><div class="line" id="l2475">                        } 
</div><div class="line" id="l2476">                        else if (len == -2-(int)ClassDescriptor.FieldType.tpObject) 
</div><div class="line" id="l2477">                        {
</div><div class="line" id="l2478">                            markOid(Bytes.unpack4(obj, offs));
</div><div class="line" id="l2479">                            offs += 4;
</div><div class="line" id="l2480">                        }
</div><div class="line" id="l2481">                        else if (len &lt; -1) 
</div><div class="line" id="l2482">                        { 
</div><div class="line" id="l2483">                            offs += ClassDescriptor.Sizeof[-2-len];
</div><div class="line" id="l2484">                        }
</div><div class="line" id="l2485">                        continue;
</div><div class="line" id="l2486">                    }
</div><div class="line" id="l2487">#endif
</div><div class="line" id="l2488">                    case ClassDescriptor.FieldType.tpArrayOfByte:
</div><div class="line" id="l2489">                    case ClassDescriptor.FieldType.tpArrayOfSByte:
</div><div class="line" id="l2490">                    case ClassDescriptor.FieldType.tpArrayOfBoolean:
</div><div class="line" id="l2491">                    {
</div><div class="line" id="l2492">                        int len = Bytes.unpack4(obj, offs);
</div><div class="line" id="l2493">                        offs += 4;
</div><div class="line" id="l2494">                        if (len &gt; 0) 
</div><div class="line" id="l2495">                        { 
</div><div class="line" id="l2496">                            offs += len;
</div><div class="line" id="l2497">                        } 
</div><div class="line" id="l2498">                        continue;
</div><div class="line" id="l2499">                    }
</div><div class="line" id="l2500">                    case ClassDescriptor.FieldType.tpArrayOfShort:
</div><div class="line" id="l2501">                    case ClassDescriptor.FieldType.tpArrayOfUShort:
</div><div class="line" id="l2502">                    case ClassDescriptor.FieldType.tpArrayOfChar:
</div><div class="line" id="l2503">                    {
</div><div class="line" id="l2504">                        int len = Bytes.unpack4(obj, offs);
</div><div class="line" id="l2505">                        offs += 4;
</div><div class="line" id="l2506">                        if (len &gt; 0) 
</div><div class="line" id="l2507">                        { 
</div><div class="line" id="l2508">                            offs += len*2;
</div><div class="line" id="l2509">                        }
</div><div class="line" id="l2510">                        continue;
</div><div class="line" id="l2511">                    }
</div><div class="line" id="l2512">                    case ClassDescriptor.FieldType.tpArrayOfInt:
</div><div class="line" id="l2513">                    case ClassDescriptor.FieldType.tpArrayOfUInt:
</div><div class="line" id="l2514">                    case ClassDescriptor.FieldType.tpArrayOfEnum:
</div><div class="line" id="l2515">                    case ClassDescriptor.FieldType.tpArrayOfFloat:
</div><div class="line" id="l2516">                    {
</div><div class="line" id="l2517">                        int len = Bytes.unpack4(obj, offs);
</div><div class="line" id="l2518">                        offs += 4;
</div><div class="line" id="l2519">                        if (len &gt; 0) 
</div><div class="line" id="l2520">                        { 
</div><div class="line" id="l2521">                            offs += len*4;
</div><div class="line" id="l2522">                        }
</div><div class="line" id="l2523">                        continue;
</div><div class="line" id="l2524">                    }
</div><div class="line" id="l2525">                    case ClassDescriptor.FieldType.tpArrayOfLong:
</div><div class="line" id="l2526">                    case ClassDescriptor.FieldType.tpArrayOfULong:
</div><div class="line" id="l2527">                    case ClassDescriptor.FieldType.tpArrayOfDouble:
</div><div class="line" id="l2528">                    case ClassDescriptor.FieldType.tpArrayOfDate:
</div><div class="line" id="l2529">                    {
</div><div class="line" id="l2530">                        int len = Bytes.unpack4(obj, offs);
</div><div class="line" id="l2531">                        offs += 4;
</div><div class="line" id="l2532">                        if (len &gt; 0) 
</div><div class="line" id="l2533">                        { 
</div><div class="line" id="l2534">                            offs += len*8;
</div><div class="line" id="l2535">                        }
</div><div class="line" id="l2536">                        continue;
</div><div class="line" id="l2537">                    }
</div><div class="line" id="l2538">                    case ClassDescriptor.FieldType.tpArrayOfString:
</div><div class="line" id="l2539">                    {
</div><div class="line" id="l2540">                        int len = Bytes.unpack4(obj, offs);
</div><div class="line" id="l2541">                        offs += 4;
</div><div class="line" id="l2542">                        while (--len &gt;= 0) 
</div><div class="line" id="l2543">                        {
</div><div class="line" id="l2544">                            int strlen = Bytes.unpack4(obj, offs);
</div><div class="line" id="l2545">                            offs += 4;
</div><div class="line" id="l2546">                            if (strlen &gt; 0) 
</div><div class="line" id="l2547">                            { 
</div><div class="line" id="l2548">                                offs += strlen*2;
</div><div class="line" id="l2549">                            }                       
</div><div class="line" id="l2550">                            else if (strlen &lt; -1) 
</div><div class="line" id="l2551">                            {
</div><div class="line" id="l2552">                                offs -= strlen+2;
</div><div class="line" id="l2553">                            }
</div><div class="line" id="l2554">                        }
</div><div class="line" id="l2555">                        continue;
</div><div class="line" id="l2556">                    }
</div><div class="line" id="l2557">                    case ClassDescriptor.FieldType.tpArrayOfObject:
</div><div class="line" id="l2558">                    case ClassDescriptor.FieldType.tpArrayOfOid:
</div><div class="line" id="l2559">                    case ClassDescriptor.FieldType.tpLink:
</div><div class="line" id="l2560">                    {
</div><div class="line" id="l2561">                        int len = Bytes.unpack4(obj, offs);
</div><div class="line" id="l2562">                        offs += 4;
</div><div class="line" id="l2563">                        while (--len &gt;= 0) 
</div><div class="line" id="l2564">                        {
</div><div class="line" id="l2565">                            markOid(Bytes.unpack4(obj, offs));
</div><div class="line" id="l2566">                            offs += 4;
</div><div class="line" id="l2567">                        }
</div><div class="line" id="l2568">                        continue;
</div><div class="line" id="l2569">                    }
</div><div class="line" id="l2570">                    case ClassDescriptor.FieldType.tpArrayOfValue:
</div><div class="line" id="l2571">                    {
</div><div class="line" id="l2572">                        int len = Bytes.unpack4(obj, offs);
</div><div class="line" id="l2573">                        offs += 4;
</div><div class="line" id="l2574">                        ClassDescriptor valueDesc = fd.valueDesc;
</div><div class="line" id="l2575">                        while (--len &gt;= 0) 
</div><div class="line" id="l2576">                        {
</div><div class="line" id="l2577">                            offs = markObject(obj, offs, valueDesc);
</div><div class="line" id="l2578">                        }
</div><div class="line" id="l2579">                        continue;
</div><div class="line" id="l2580">                    }
</div><div class="line" id="l2581">#if SUPPORT_RAW_TYPE
</div><div class="line" id="l2582">                    case ClassDescriptor.FieldType.tpArrayOfRaw:
</div><div class="line" id="l2583">                    {
</div><div class="line" id="l2584">                        int len = Bytes.unpack4(obj, offs);
</div><div class="line" id="l2585">                        offs += 4;
</div><div class="line" id="l2586">                        while (--len &gt;= 0) 
</div><div class="line" id="l2587">                        {
</div><div class="line" id="l2588">                            int rawlen = Bytes.unpack4(obj, offs);
</div><div class="line" id="l2589">                            offs += 4;
</div><div class="line" id="l2590">                            if (rawlen &gt;= 0) 
</div><div class="line" id="l2591">                            { 
</div><div class="line" id="l2592">                                offs += rawlen;
</div><div class="line" id="l2593">                            }
</div><div class="line" id="l2594">                            else if (rawlen == -2-(int)ClassDescriptor.FieldType.tpObject) 
</div><div class="line" id="l2595">                            {
</div><div class="line" id="l2596">                                markOid(Bytes.unpack4(obj, offs));
</div><div class="line" id="l2597">                                offs += 4;
</div><div class="line" id="l2598">                            }
</div><div class="line" id="l2599">                            else if (rawlen &lt; -1) 
</div><div class="line" id="l2600">                            { 
</div><div class="line" id="l2601">                                offs += ClassDescriptor.Sizeof[-2-rawlen];
</div><div class="line" id="l2602">                            }
</div><div class="line" id="l2603">                        }
</div><div class="line" id="l2604">                        continue;
</div><div class="line" id="l2605">                    }
</div><div class="line" id="l2606">#endif
</div><div class="line" id="l2607">                }
</div><div class="line" id="l2608">            }
</div><div class="line" id="l2609">            return offs;
</div><div class="line" id="l2610">        }
</div><div class="line" id="l2611"><br></div><div class="line" id="l2612">        internal class ThreadTransactionContext 
</div><div class="line" id="l2613">        {
</div><div class="line" id="l2614">            internal int       nested;
</div><div class="line" id="l2615">            internal ArrayList locked;
</div><div class="line" id="l2616">            internal ArrayList modified;
</div><div class="line" id="l2617"><br></div><div class="line" id="l2618">            internal ThreadTransactionContext() 
</div><div class="line" id="l2619">            { 
</div><div class="line" id="l2620">                locked = new ArrayList();
</div><div class="line" id="l2621">                modified = new ArrayList();
</div><div class="line" id="l2622">            }
</div><div class="line" id="l2623">        }
</div><div class="line" id="l2624"><br></div><div class="line" id="l2625">        internal static ThreadTransactionContext TransactionContext
</div><div class="line" id="l2626">        {
</div><div class="line" id="l2627">            get
</div><div class="line" id="l2628">            {
</div><div class="line" id="l2629">                ThreadTransactionContext ctx = (ThreadTransactionContext)Thread.GetData(transactionContext);
</div><div class="line" id="l2630">                if (ctx == null) 
</div><div class="line" id="l2631">                { 
</div><div class="line" id="l2632">                    ctx = new ThreadTransactionContext();
</div><div class="line" id="l2633">                    Thread.SetData(transactionContext, ctx);
</div><div class="line" id="l2634">                }
</div><div class="line" id="l2635">                return ctx;
</div><div class="line" id="l2636">            }			
</div><div class="line" id="l2637">        }
</div><div class="line" id="l2638"><br></div><div class="line" id="l2639">        public void EndThreadTransaction() 
</div><div class="line" id="l2640">        { 
</div><div class="line" id="l2641">            EndThreadTransaction(Int32.MaxValue);
</div><div class="line" id="l2642">        }
</div><div class="line" id="l2643"><br></div><div class="line" id="l2644">#if COMPACT_NET_FRAMEWORK
</div><div class="line" id="l2645">        public void RegisterAssembly(System.Reflection.Assembly assembly) 
</div><div class="line" id="l2646">        {
</div><div class="line" id="l2647">            assemblies.Add(assembly);
</div><div class="line" id="l2648">        }
</div><div class="line" id="l2649"><br></div><div class="line" id="l2650">        public void BeginThreadTransaction(TransactionMode mode)
</div><div class="line" id="l2651">        {
</div><div class="line" id="l2652">            if (mode == TransactionMode.Serializable) 
</div><div class="line" id="l2653">            { 
</div><div class="line" id="l2654">                useSerializableTransactions = true;
</div><div class="line" id="l2655">                TransactionContext.nested += 1;;
</div><div class="line" id="l2656">            } 
</div><div class="line" id="l2657">            else 
</div><div class="line" id="l2658">            { 
</div><div class="line" id="l2659">                transactionMonitor.Enter(); 
</div><div class="line" id="l2660">                try {
</div><div class="line" id="l2661">                    if (scheduledCommitTime != Int64.MaxValue) 
</div><div class="line" id="l2662">                    { 
</div><div class="line" id="l2663">                        nBlockedTransactions += 1;
</div><div class="line" id="l2664">                        while (DateTime.Now.Ticks &gt;= scheduledCommitTime) 
</div><div class="line" id="l2665">                        { 
</div><div class="line" id="l2666">                            transactionMonitor.Wait();
</div><div class="line" id="l2667">                        }
</div><div class="line" id="l2668">                        nBlockedTransactions -= 1;
</div><div class="line" id="l2669">                    }
</div><div class="line" id="l2670">                    nNestedTransactions += 1;
</div><div class="line" id="l2671">                } finally { 
</div><div class="line" id="l2672">                    transactionMonitor.Exit(); 
</div><div class="line" id="l2673">                }
</div><div class="line" id="l2674">                if (mode == TransactionMode.Exclusive) 
</div><div class="line" id="l2675">                { 
</div><div class="line" id="l2676">                    transactionLock.ExclusiveLock();
</div><div class="line" id="l2677">                } 
</div><div class="line" id="l2678">                else 
</div><div class="line" id="l2679">                { 
</div><div class="line" id="l2680">                    transactionLock.SharedLock();
</div><div class="line" id="l2681">                }
</div><div class="line" id="l2682">            }
</div><div class="line" id="l2683">        }
</div><div class="line" id="l2684"><br></div><div class="line" id="l2685">        public void EndThreadTransaction(int maxDelay)
</div><div class="line" id="l2686">        {
</div><div class="line" id="l2687">            ThreadTransactionContext ctx = TransactionContext;
</div><div class="line" id="l2688">            if (ctx.nested != 0) 
</div><div class="line" id="l2689">            { // serializable transaction
</div><div class="line" id="l2690">                if (--ctx.nested == 0) 
</div><div class="line" id="l2691">                { 
</div><div class="line" id="l2692">                    int i = ctx.modified.Count;
</div><div class="line" id="l2693">                    if (i != 0) 
</div><div class="line" id="l2694">                    { 
</div><div class="line" id="l2695">                        do 
</div><div class="line" id="l2696">                        { 
</div><div class="line" id="l2697">                            ((IPersistent)ctx.modified[--i]).Store();
</div><div class="line" id="l2698">                        } while (i != 0);
</div><div class="line" id="l2699"><br></div><div class="line" id="l2700">                        lock (backgroundGcMonitor) 
</div><div class="line" id="l2701">                        { 
</div><div class="line" id="l2702">                            lock (this) 
</div><div class="line" id="l2703">                            { 
</div><div class="line" id="l2704">                                commit0();
</div><div class="line" id="l2705">                            }
</div><div class="line" id="l2706">                        }
</div><div class="line" id="l2707">                    }
</div><div class="line" id="l2708">                    for (i = ctx.locked.Count; --i &gt;= 0;) 
</div><div class="line" id="l2709">                    { 
</div><div class="line" id="l2710">                        ((IResource)ctx.locked[i]).Reset();
</div><div class="line" id="l2711">                    }
</div><div class="line" id="l2712">                    ctx.modified.Clear();
</div><div class="line" id="l2713">                    ctx.locked.Clear();
</div><div class="line" id="l2714">                } 
</div><div class="line" id="l2715">            } 
</div><div class="line" id="l2716">            else 
</div><div class="line" id="l2717">            { // exclusive or cooperative transaction        
</div><div class="line" id="l2718">                transactionMonitor.Enter(); 
</div><div class="line" id="l2719">                try { 
</div><div class="line" id="l2720">                    transactionLock.Unlock();
</div><div class="line" id="l2721">                    if (nNestedTransactions != 0) 
</div><div class="line" id="l2722">                    { // may be everything is already aborted
</div><div class="line" id="l2723">                        if (--nNestedTransactions == 0) 
</div><div class="line" id="l2724">                        { 
</div><div class="line" id="l2725">                            nCommittedTransactions += 1;
</div><div class="line" id="l2726">                            Commit();
</div><div class="line" id="l2727">                            scheduledCommitTime = Int64.MaxValue;
</div><div class="line" id="l2728">                            if (nBlockedTransactions != 0) 
</div><div class="line" id="l2729">                            { 
</div><div class="line" id="l2730">                                transactionMonitor.PulseAll();
</div><div class="line" id="l2731">                            }
</div><div class="line" id="l2732">                        } 
</div><div class="line" id="l2733">                        else 
</div><div class="line" id="l2734">                        {
</div><div class="line" id="l2735">                            if (maxDelay != Int32.MaxValue) 
</div><div class="line" id="l2736">                            { 
</div><div class="line" id="l2737">                                long nextCommit = DateTime.Now.Ticks + maxDelay;
</div><div class="line" id="l2738">                                if (nextCommit &lt; scheduledCommitTime) 
</div><div class="line" id="l2739">                                { 
</div><div class="line" id="l2740">                                    scheduledCommitTime = nextCommit;
</div><div class="line" id="l2741">                                }
</div><div class="line" id="l2742">                                if (maxDelay == 0) 
</div><div class="line" id="l2743">                                { 
</div><div class="line" id="l2744">                                    int n = nCommittedTransactions;
</div><div class="line" id="l2745">                                    nBlockedTransactions += 1;
</div><div class="line" id="l2746">                                    do 
</div><div class="line" id="l2747">                                    { 
</div><div class="line" id="l2748">                                        transactionMonitor.Wait();
</div><div class="line" id="l2749">                                    } while (nCommittedTransactions == n);
</div><div class="line" id="l2750">                                    nBlockedTransactions -= 1;
</div><div class="line" id="l2751">                                }				    
</div><div class="line" id="l2752">                            }
</div><div class="line" id="l2753">                        }
</div><div class="line" id="l2754">                    }
</div><div class="line" id="l2755">                } finally { 
</div><div class="line" id="l2756">                    transactionMonitor.Exit();
</div><div class="line" id="l2757">                }
</div><div class="line" id="l2758">            }
</div><div class="line" id="l2759">        }
</div><div class="line" id="l2760"><br></div><div class="line" id="l2761">        public void RollbackThreadTransaction()
</div><div class="line" id="l2762">        {
</div><div class="line" id="l2763">            ThreadTransactionContext ctx = TransactionContext;
</div><div class="line" id="l2764">            if (ctx.nested != 0) 
</div><div class="line" id="l2765">            { // serializable transaction
</div><div class="line" id="l2766">                ctx.nested = 0; 
</div><div class="line" id="l2767">                int i = ctx.modified.Count;
</div><div class="line" id="l2768">                if (i != 0) 
</div><div class="line" id="l2769">                { 
</div><div class="line" id="l2770">                    do 
</div><div class="line" id="l2771">                    { 
</div><div class="line" id="l2772">                        ((IPersistent)ctx.modified[--i]).Invalidate();
</div><div class="line" id="l2773">                    } while (i != 0);
</div><div class="line" id="l2774"><br></div><div class="line" id="l2775">                    lock (this) 
</div><div class="line" id="l2776">                    { 
</div><div class="line" id="l2777">                        rollback0();
</div><div class="line" id="l2778">                    }
</div><div class="line" id="l2779">                }
</div><div class="line" id="l2780">                for (i = ctx.locked.Count; --i &gt;= 0;) 
</div><div class="line" id="l2781">                { 
</div><div class="line" id="l2782">                    ((IResource)ctx.locked[i]).Reset();
</div><div class="line" id="l2783">                } 
</div><div class="line" id="l2784">                ctx.modified.Clear();
</div><div class="line" id="l2785">                ctx.locked.Clear();
</div><div class="line" id="l2786">            } 
</div><div class="line" id="l2787">            else 
</div><div class="line" id="l2788">            { 
</div><div class="line" id="l2789">                try { 
</div><div class="line" id="l2790">                    transactionMonitor.Enter(); 
</div><div class="line" id="l2791">                    transactionLock.Reset();
</div><div class="line" id="l2792">                    nNestedTransactions = 0;
</div><div class="line" id="l2793">                    if (nBlockedTransactions != 0) 
</div><div class="line" id="l2794">                    { 
</div><div class="line" id="l2795">                        transactionMonitor.PulseAll();
</div><div class="line" id="l2796">                    }
</div><div class="line" id="l2797">                    Rollback();
</div><div class="line" id="l2798">                } finally { 
</div><div class="line" id="l2799">                   transactionMonitor.Exit();
</div><div class="line" id="l2800">                }
</div><div class="line" id="l2801">            }
</div><div class="line" id="l2802">        }
</div><div class="line" id="l2803">#else
</div><div class="line" id="l2804">        public virtual void BeginThreadTransaction(TransactionMode mode)
</div><div class="line" id="l2805">        {
</div><div class="line" id="l2806">            if (mode == TransactionMode.Serializable) 
</div><div class="line" id="l2807">            { 
</div><div class="line" id="l2808">                useSerializableTransactions = true;
</div><div class="line" id="l2809">                TransactionContext.nested += 1;;
</div><div class="line" id="l2810">            } 
</div><div class="line" id="l2811">            else 
</div><div class="line" id="l2812">            { 
</div><div class="line" id="l2813">                lock (transactionMonitor) 
</div><div class="line" id="l2814">                {
</div><div class="line" id="l2815">                    if (scheduledCommitTime != Int64.MaxValue) 
</div><div class="line" id="l2816">                    { 
</div><div class="line" id="l2817">                        nBlockedTransactions += 1;
</div><div class="line" id="l2818">                        while (DateTime.Now.Ticks &gt;= scheduledCommitTime) 
</div><div class="line" id="l2819">                        { 
</div><div class="line" id="l2820">                            Monitor.Wait(transactionMonitor);
</div><div class="line" id="l2821">                        }
</div><div class="line" id="l2822">                        nBlockedTransactions -= 1;
</div><div class="line" id="l2823">                    }
</div><div class="line" id="l2824">                    nNestedTransactions += 1;
</div><div class="line" id="l2825">                }	    
</div><div class="line" id="l2826">                if (mode == TransactionMode.Exclusive) 
</div><div class="line" id="l2827">                { 
</div><div class="line" id="l2828">                    transactionLock.ExclusiveLock();
</div><div class="line" id="l2829">                } 
</div><div class="line" id="l2830">                else 
</div><div class="line" id="l2831">                { 
</div><div class="line" id="l2832">                    transactionLock.SharedLock();
</div><div class="line" id="l2833">                }
</div><div class="line" id="l2834">            }
</div><div class="line" id="l2835">        }
</div><div class="line" id="l2836"><br></div><div class="line" id="l2837">        public virtual void EndThreadTransaction(int maxDelay)
</div><div class="line" id="l2838">        {
</div><div class="line" id="l2839">            ThreadTransactionContext ctx = TransactionContext;
</div><div class="line" id="l2840">            if (ctx.nested != 0) 
</div><div class="line" id="l2841">            { // serializable transaction
</div><div class="line" id="l2842">                if (--ctx.nested == 0) 
</div><div class="line" id="l2843">                { 
</div><div class="line" id="l2844">                    int i = ctx.modified.Count;
</div><div class="line" id="l2845">                    if (i != 0) 
</div><div class="line" id="l2846">                    { 
</div><div class="line" id="l2847">                        do 
</div><div class="line" id="l2848">                        { 
</div><div class="line" id="l2849">                            ((IPersistent)ctx.modified[--i]).Store();
</div><div class="line" id="l2850">                        } while (i != 0);
</div><div class="line" id="l2851"><br></div><div class="line" id="l2852">                        lock (backgroundGcMonitor) 
</div><div class="line" id="l2853">                        { 
</div><div class="line" id="l2854">                            lock (this) 
</div><div class="line" id="l2855">                            { 
</div><div class="line" id="l2856">                                commit0();
</div><div class="line" id="l2857">                            }
</div><div class="line" id="l2858">                        }
</div><div class="line" id="l2859">                    }
</div><div class="line" id="l2860">                    for (i = ctx.locked.Count; --i &gt;= 0;) 
</div><div class="line" id="l2861">                    { 
</div><div class="line" id="l2862">                        ((IResource)ctx.locked[i]).Reset();
</div><div class="line" id="l2863">                    }
</div><div class="line" id="l2864">                    ctx.modified.Clear();
</div><div class="line" id="l2865">                    ctx.locked.Clear();
</div><div class="line" id="l2866">                } 
</div><div class="line" id="l2867">            } 
</div><div class="line" id="l2868">            else 
</div><div class="line" id="l2869">            { // exclusive or cooperative transaction        
</div><div class="line" id="l2870">                lock (transactionMonitor) 
</div><div class="line" id="l2871">                { 
</div><div class="line" id="l2872">                    transactionLock.Unlock();
</div><div class="line" id="l2873">                    if (nNestedTransactions != 0) 
</div><div class="line" id="l2874">                    { // may be everything is already aborted
</div><div class="line" id="l2875">                        if (--nNestedTransactions == 0) 
</div><div class="line" id="l2876">                        { 
</div><div class="line" id="l2877">                            nCommittedTransactions += 1;
</div><div class="line" id="l2878">                            Commit();
</div><div class="line" id="l2879">                            scheduledCommitTime = Int64.MaxValue;
</div><div class="line" id="l2880">                            if (nBlockedTransactions != 0) 
</div><div class="line" id="l2881">                            { 
</div><div class="line" id="l2882">                                Monitor.PulseAll(transactionMonitor);
</div><div class="line" id="l2883">                            }
</div><div class="line" id="l2884">                        } 
</div><div class="line" id="l2885">                        else 
</div><div class="line" id="l2886">                        {
</div><div class="line" id="l2887">                            if (maxDelay != Int32.MaxValue) 
</div><div class="line" id="l2888">                            { 
</div><div class="line" id="l2889">                                long nextCommit = DateTime.Now.Ticks + maxDelay;
</div><div class="line" id="l2890">                                if (nextCommit &lt; scheduledCommitTime) 
</div><div class="line" id="l2891">                                { 
</div><div class="line" id="l2892">                                    scheduledCommitTime = nextCommit;
</div><div class="line" id="l2893">                                }
</div><div class="line" id="l2894">                                if (maxDelay == 0) 
</div><div class="line" id="l2895">                                { 
</div><div class="line" id="l2896">                                    int n = nCommittedTransactions;
</div><div class="line" id="l2897">                                    nBlockedTransactions += 1;
</div><div class="line" id="l2898">                                    do 
</div><div class="line" id="l2899">                                    { 
</div><div class="line" id="l2900">                                        Monitor.Wait(transactionMonitor);
</div><div class="line" id="l2901">                                    } while (nCommittedTransactions == n);
</div><div class="line" id="l2902">                                    nBlockedTransactions -= 1;
</div><div class="line" id="l2903">                                }				    
</div><div class="line" id="l2904">                            }
</div><div class="line" id="l2905">                        }
</div><div class="line" id="l2906">                    }
</div><div class="line" id="l2907">                }
</div><div class="line" id="l2908">            }
</div><div class="line" id="l2909">        }
</div><div class="line" id="l2910"><br></div><div class="line" id="l2911">        public void RollbackThreadTransaction()
</div><div class="line" id="l2912">        {
</div><div class="line" id="l2913">            ThreadTransactionContext ctx = TransactionContext;
</div><div class="line" id="l2914">            if (ctx.nested != 0) 
</div><div class="line" id="l2915">            { // serializable transaction
</div><div class="line" id="l2916">                ctx.nested = 0; 
</div><div class="line" id="l2917">                int i = ctx.modified.Count;
</div><div class="line" id="l2918">                if (i != 0) 
</div><div class="line" id="l2919">                { 
</div><div class="line" id="l2920">                    do 
</div><div class="line" id="l2921">                    { 
</div><div class="line" id="l2922">                        ((IPersistent)ctx.modified[--i]).Invalidate();
</div><div class="line" id="l2923">                    } while (i != 0);
</div><div class="line" id="l2924"><br></div><div class="line" id="l2925">                    lock (this) 
</div><div class="line" id="l2926">                    { 
</div><div class="line" id="l2927">                        rollback0();
</div><div class="line" id="l2928">                    }
</div><div class="line" id="l2929">                }
</div><div class="line" id="l2930">                for (i = ctx.locked.Count; --i &gt;= 0;) 
</div><div class="line" id="l2931">                { 
</div><div class="line" id="l2932">                    ((IResource)ctx.locked[i]).Reset();
</div><div class="line" id="l2933">                } 
</div><div class="line" id="l2934">                ctx.modified.Clear();
</div><div class="line" id="l2935">                ctx.locked.Clear();
</div><div class="line" id="l2936">            } 
</div><div class="line" id="l2937">            else 
</div><div class="line" id="l2938">            { 
</div><div class="line" id="l2939">                lock (transactionMonitor) 
</div><div class="line" id="l2940">                { 
</div><div class="line" id="l2941">                    transactionLock.Reset();
</div><div class="line" id="l2942">                    nNestedTransactions = 0;
</div><div class="line" id="l2943">                    if (nBlockedTransactions != 0) 
</div><div class="line" id="l2944">                    { 
</div><div class="line" id="l2945">                        Monitor.PulseAll(transactionMonitor);
</div><div class="line" id="l2946">                    }
</div><div class="line" id="l2947">                    Rollback();
</div><div class="line" id="l2948">                }
</div><div class="line" id="l2949">            }
</div><div class="line" id="l2950">        }
</div><div class="line" id="l2951"><br></div><div class="line" id="l2952">#endif
</div><div class="line" id="l2953"><br></div><div class="line" id="l2954">        public virtual void Close()
</div><div class="line" id="l2955">        {
</div><div class="line" id="l2956">            <span class="c">lock (backgroundGcMonitor)</span> {</div><div class="line" id="l2957">                <span class="c">Commit();</span></div><div class="line" id="l2958">                <span class="c">opened = false;</span></div><div class="line" id="l2959">            }
</div><div class="line" id="l2960">#if !COMPACT_NET_FRAMEWORK
</div><div class="line" id="l2961">            <span class="c">if (codeGenerationThread != null)</span></div><div class="line" id="l2962">            {   
</div><div class="line" id="l2963">                <span class="c">codeGenerationThread.Abort();</span></div><div class="line" id="l2964">                <span class="c">codeGenerationThread.Join();</span></div><div class="line" id="l2965">                <span class="c">codeGenerationThread = null;</span></div><div class="line" id="l2966">            }               
</div><div class="line" id="l2967">            <span class="c">if (gcThread != null)</span></div><div class="line" id="l2968">            {             
</div><div class="line" id="l2969">                <span class="c">activateGc();</span></div><div class="line" id="l2970">                <span class="c">gcThread.Join();</span></div><div class="line" id="l2971">            }
</div><div class="line" id="l2972">#endif
</div><div class="line" id="l2973">            <span class="c">if (isDirty())</span></div><div class="line" id="l2974">            {
</div><div class="line" id="l2975">                <span class="c">Page pg = pool.putPage(0);</span></div><div class="line" id="l2976">                <span class="c">header.pack(pg.data);</span></div><div class="line" id="l2977">                <span class="c">pool.flush();</span></div><div class="line" id="l2978">                <span class="c">pool.modify(pg);</span></div><div class="line" id="l2979">                <span class="c">header.dirty = false;</span></div><div class="line" id="l2980">                <span class="c">header.pack(pg.data);</span></div><div class="line" id="l2981">                <span class="c">pool.unfix(pg);</span></div><div class="line" id="l2982">                <span class="c">pool.flush();</span></div><div class="line" id="l2983">            }
</div><div class="line" id="l2984">            <span class="c">pool.close();</span></div><div class="line" id="l2985">            <span class="c">pool = null;</span></div><div class="line" id="l2986">            <span class="c">objectCache = null;</span></div><div class="line" id="l2987">            <span class="c">classDescMap = null;</span></div><div class="line" id="l2988">            <span class="c">resolvedTypes = null;</span></div><div class="line" id="l2989">            <span class="c">bitmapPageAvailableSpace = null;</span></div><div class="line" id="l2990">            <span class="c">dirtyPagesMap = null;</span></div><div class="line" id="l2991">            <span class="c">descList = null;</span></div><div class="line" id="l2992">        <span class="c">}</span></div><div class="line" id="l2993"><br></div><div class="line" id="l2994">        public bool AlternativeBtree 
</div><div class="line" id="l2995">        {
</div><div class="line" id="l2996">            set { <span class="c">alternativeBtree = value;</span> <span class="c">}</span></div><div class="line" id="l2997">            get { return alternativeBtree; }
</div><div class="line" id="l2998">        }
</div><div class="line" id="l2999"><br></div><div class="line" id="l3000">        public bool SerializeTransientObjects
</div><div class="line" id="l3001">        {
</div><div class="line" id="l3002">            set { ClassDescriptor.serializeNonPersistentObjects = value; }
</div><div class="line" id="l3003">            get { return ClassDescriptor.serializeNonPersistentObjects; }
</div><div class="line" id="l3004">        }
</div><div class="line" id="l3005"><br></div><div class="line" id="l3006">        // TODO: needs tests
</div><div class="line" id="l3007">        public int ObjectIndexInitSize
</div><div class="line" id="l3008">        {
</div><div class="line" id="l3009">            set { initIndexSize = value; }
</div><div class="line" id="l3010">            get { return initIndexSize; }
</div><div class="line" id="l3011">        }        
</div><div class="line" id="l3012"><br></div><div class="line" id="l3013">        // TODO: needs tests
</div><div class="line" id="l3014">        public long ExtensionQuantum
</div><div class="line" id="l3015">        {
</div><div class="line" id="l3016">            set { extensionQuantum = value; }
</div><div class="line" id="l3017">            get { return extensionQuantum; }
</div><div class="line" id="l3018">        }
</div><div class="line" id="l3019"><br></div><div class="line" id="l3020">        // TODO: needs tests
</div><div class="line" id="l3021">        public long GcThreshold
</div><div class="line" id="l3022">        {
</div><div class="line" id="l3023">            set { gcThreshold = value; }
</div><div class="line" id="l3024">            get { return gcThreshold; }
</div><div class="line" id="l3025">        }
</div><div class="line" id="l3026"><br></div><div class="line" id="l3027">        // TODO: needs tests
</div><div class="line" id="l3028">        public bool CodeGeneration
</div><div class="line" id="l3029">        {
</div><div class="line" id="l3030">            set { enableCodeGeneration = value; }
</div><div class="line" id="l3031">            get { return enableCodeGeneration; }
</div><div class="line" id="l3032">        }
</div><div class="line" id="l3033"><br></div><div class="line" id="l3034">        // TODO: needs tests
</div><div class="line" id="l3035">        public bool FileReadOnly
</div><div class="line" id="l3036">        {
</div><div class="line" id="l3037">            set { readOnly = value; }
</div><div class="line" id="l3038">            get { return readOnly; }
</div><div class="line" id="l3039">        }
</div><div class="line" id="l3040"><br></div><div class="line" id="l3041">        // TODO: needs tests
</div><div class="line" id="l3042">        //TODO: won't work for Open(IFile) method. Java code has the same problem
</div><div class="line" id="l3043">        public bool FileNoFlush
</div><div class="line" id="l3044">        {
</div><div class="line" id="l3045">            set
</div><div class="line" id="l3046">            {
</div><div class="line" id="l3047">                noFlush = value;
</div><div class="line" id="l3048">                if (opened)
</div><div class="line" id="l3049">                {
</div><div class="line" id="l3050">                    pool.file.NoFlush = value;
</div><div class="line" id="l3051">                }
</div><div class="line" id="l3052">            }
</div><div class="line" id="l3053">            get
</div><div class="line" id="l3054">            {
</div><div class="line" id="l3055">                if (opened)
</div><div class="line" id="l3056">                {
</div><div class="line" id="l3057">                    return pool.file.NoFlush;
</div><div class="line" id="l3058">                }
</div><div class="line" id="l3059">                return noFlush;
</div><div class="line" id="l3060">            }
</div><div class="line" id="l3061">        }
</div><div class="line" id="l3062"><br></div><div class="line" id="l3063">        // TODO: needs tests
</div><div class="line" id="l3064">        public bool BackgroundGc
</div><div class="line" id="l3065">        {
</div><div class="line" id="l3066">            set { backgroundGc = value; }
</div><div class="line" id="l3067">            get { return backgroundGc; }
</div><div class="line" id="l3068">        }
</div><div class="line" id="l3069"><br></div><div class="line" id="l3070">        public bool ReplicationAck
</div><div class="line" id="l3071">        {
</div><div class="line" id="l3072">            set { replicationAck = value; }
</div><div class="line" id="l3073">            get { return replicationAck; }
</div><div class="line" id="l3074">        }
</div><div class="line" id="l3075"><br></div><div class="line" id="l3076">        // TODO: needs tests
</div><div class="line" id="l3077">        public int ObjectCacheInitSize
</div><div class="line" id="l3078">        {
</div><div class="line" id="l3079">            set { objectCacheInitSize = value; }
</div><div class="line" id="l3080">            get { return objectCacheInitSize; }
</div><div class="line" id="l3081">        }
</div><div class="line" id="l3082"><br></div><div class="line" id="l3083">        // TODO: needs tests
</div><div class="line" id="l3084">        public Encoding StringEncoding
</div><div class="line" id="l3085">        {
</div><div class="line" id="l3086">            set { encoding = value; }
</div><div class="line" id="l3087">            get { return encoding; }
</div><div class="line" id="l3088">        }
</div><div class="line" id="l3089"><br></div><div class="line" id="l3090">        //TODO: needs tests
</div><div class="line" id="l3091">        public CacheType CacheKind
</div><div class="line" id="l3092">        {
</div><div class="line" id="l3093">            set { cacheKind = value; }
</div><div class="line" id="l3094">            get { return cacheKind; }
</div><div class="line" id="l3095">        }
</div><div class="line" id="l3096"><br></div><div class="line" id="l3097">        public StorageListener SetListener(StorageListener listener)
</div><div class="line" id="l3098">        {
</div><div class="line" id="l3099">            StorageListener prevListener = this.listener;
</div><div class="line" id="l3100">            this.listener = listener;
</div><div class="line" id="l3101">            return prevListener;
</div><div class="line" id="l3102">        }
</div><div class="line" id="l3103"><br></div><div class="line" id="l3104">        public IPersistent GetObjectByOID(int oid)
</div><div class="line" id="l3105">        {
</div><div class="line" id="l3106">            lock (this) 
</div><div class="line" id="l3107">            { 
</div><div class="line" id="l3108">                return oid == 0 ? null : lookupObject(oid, null);
</div><div class="line" id="l3109">            }
</div><div class="line" id="l3110">        }
</div><div class="line" id="l3111"><br></div><div class="line" id="l3112">        public void modifyObject(IPersistent obj) 
</div><div class="line" id="l3113">        {
</div><div class="line" id="l3114">            <span class="c">lock (this)</span></div><div class="line" id="l3115">            {                 
</div><div class="line" id="l3116">                <span class="c">lock (objectCache)</span></div><div class="line" id="l3117">                { 
</div><div class="line" id="l3118">                    <span class="c">if (!obj.IsModified())</span></div><div class="line" id="l3119">                    { 
</div><div class="line" id="l3120">                        <span class="c">if (useSerializableTransactions)</span></div><div class="line" id="l3121">                        { 
</div><div class="line" id="l3122">                            <span class="c">ThreadTransactionContext ctx = TransactionContext;</span></div><div class="line" id="l3123">                            <span class="c">if (ctx.nested != 0)</span></div><div class="line" id="l3124">                            { // serializable transaction
</div><div class="line" id="l3125">                                <span class="c">ctx.modified.Add(obj);</span></div><div class="line" id="l3126">                            }
</div><div class="line" id="l3127">                        }
</div><div class="line" id="l3128">                        <span class="c">objectCache.setDirty(obj.Oid);</span></div><div class="line" id="l3129">                    }
</div><div class="line" id="l3130">                }
</div><div class="line" id="l3131">            }
</div><div class="line" id="l3132">        <span class="c">}</span></div><div class="line" id="l3133"><br></div><div class="line" id="l3134">        public void lockObject(IPersistent obj) 
</div><div class="line" id="l3135">        { 
</div><div class="line" id="l3136">            if (useSerializableTransactions) 
</div><div class="line" id="l3137">            { 
</div><div class="line" id="l3138">                ThreadTransactionContext ctx = TransactionContext;
</div><div class="line" id="l3139">                if (ctx.nested != 0) 
</div><div class="line" id="l3140">                { // serializable transaction
</div><div class="line" id="l3141">                    ctx.locked.Add(obj);
</div><div class="line" id="l3142">                }
</div><div class="line" id="l3143">            }
</div><div class="line" id="l3144">        }
</div><div class="line" id="l3145"><br></div><div class="line" id="l3146">        public void storeObject(IPersistent obj) 
</div><div class="line" id="l3147">        {
</div><div class="line" id="l3148">            <span class="c">lock (this)</span></div><div class="line" id="l3149">            {
</div><div class="line" id="l3150">                <span class="c">ensureOpened();</span></div><div class="line" id="l3151"><br></div><div class="line" id="l3152">                <span class="c">lock (objectCache)</span></div><div class="line" id="l3153">                { 
</div><div class="line" id="l3154">                    <span class="c">storeObject0(obj);</span></div><div class="line" id="l3155">                }
</div><div class="line" id="l3156">            }
</div><div class="line" id="l3157">        <span class="c">}</span></div><div class="line" id="l3158"><br></div><div class="line" id="l3159">        public void storeFinalizedObject(IPersistent obj) 
</div><div class="line" id="l3160">        {
</div><div class="line" id="l3161">            <span class="c">if (opened)</span></div><div class="line" id="l3162">            { 
</div><div class="line" id="l3163">                <span class="c">lock (objectCache)</span></div><div class="line" id="l3164">                { 
</div><div class="line" id="l3165">                    <span class="c">if (obj.Oid != 0)</span></div><div class="line" id="l3166">                    { 
</div><div class="line" id="l3167">                        <span class="c">storeObject0(obj);</span></div><div class="line" id="l3168">                    }
</div><div class="line" id="l3169">                }
</div><div class="line" id="l3170">            }
</div><div class="line" id="l3171">        <span class="c">}</span></div><div class="line" id="l3172"><br></div><div class="line" id="l3173">        void storeObject0(IPersistent obj) 
</div><div class="line" id="l3174">        {
</div><div class="line" id="l3175">            <span class="c">obj.OnStore();</span></div><div class="line" id="l3176">            <span class="c">int oid = obj.Oid;</span></div><div class="line" id="l3177">            <span class="c">bool newObject = false;</span></div><div class="line" id="l3178">            <span class="c">if (oid == 0)</span></div><div class="line" id="l3179">            {
</div><div class="line" id="l3180">                <span class="c">oid = allocateId();</span></div><div class="line" id="l3181">                <span class="c">if (!obj.IsDeleted())</span></div><div class="line" id="l3182">                {
</div><div class="line" id="l3183">                    <span class="c">objectCache.put(oid, obj);</span></div><div class="line" id="l3184">                }
</div><div class="line" id="l3185">                <span class="c">obj.AssignOid(this, oid, false);</span></div><div class="line" id="l3186">                <span class="c">newObject = true;</span></div><div class="line" id="l3187">            } 
</div><div class="line" id="l3188">            else <span class="c">if (obj.IsModified())</span></div><div class="line" id="l3189">            {
</div><div class="line" id="l3190">                <span class="c">objectCache.clearDirty(oid);</span></div><div class="line" id="l3191">            } 
</div><div class="line" id="l3192">            <span class="c">byte[] data = packObject(obj);</span></div><div class="line" id="l3193">            long pos;
</div><div class="line" id="l3194">            <span class="c">int newSize = ObjectHeader.getSize(data, 0);</span></div><div class="line" id="l3195">            <span class="c">if (newObject || (pos = getPos(oid)) == 0)</span></div><div class="line" id="l3196">            {
</div><div class="line" id="l3197">                <span class="c">pos = allocate(newSize, 0);</span></div><div class="line" id="l3198">                <span class="c">setPos(oid, pos | dbModifiedFlag);</span></div><div class="line" id="l3199">            }
</div><div class="line" id="l3200">            else
</div><div class="line" id="l3201">            {
</div><div class="line" id="l3202">                <span class="c">int offs = (int) pos &amp; (Page.pageSize - 1);</span></div><div class="line" id="l3203">                <span class="c">if ((offs &amp; (dbFreeHandleFlag | dbPageObjectFlag)) != 0)</span></div><div class="line" id="l3204">                {
</div><div class="line" id="l3205">                    <span class="c">throw new StorageError(StorageError.ErrorCode.DELETED_OBJECT);</span></div><div class="line" id="l3206">                }
</div><div class="line" id="l3207">                <span class="c">Page pg = pool.getPage(pos - offs);</span></div><div class="line" id="l3208">                <span class="c">offs &amp;= ~ dbFlagsMask;</span></div><div class="line" id="l3209">                <span class="c">int size = ObjectHeader.getSize(pg.data, offs);</span></div><div class="line" id="l3210">                <span class="c">pool.unfix(pg);</span></div><div class="line" id="l3211">                <span class="c">if ((pos &amp; dbModifiedFlag) == 0)</span></div><div class="line" id="l3212">                {
</div><div class="line" id="l3213">                    <span class="c">cloneBitmap(pos &amp; ~ dbFlagsMask, size);</span></div><div class="line" id="l3214">                    <span class="c">pos = allocate(newSize, 0);</span></div><div class="line" id="l3215">                    <span class="c">setPos(oid, pos | dbModifiedFlag);</span></div><div class="line" id="l3216">                }
</div><div class="line" id="l3217">                else
</div><div class="line" id="l3218">                {
</div><div class="line" id="l3219">                    <span class="c">if (((newSize + dbAllocationQuantum - 1) &amp; ~ (dbAllocationQuantum - 1)) &gt; ((size + dbAllocationQuantum - 1) &amp; ~ (dbAllocationQuantum - 1)))</span></div><div class="line" id="l3220">                    {
</div><div class="line" id="l3221">                        <span class="c">long newPos = allocate(newSize, 0);</span></div><div class="line" id="l3222">                        <span class="c">cloneBitmap(pos &amp; ~ dbFlagsMask, size);</span></div><div class="line" id="l3223">                        <span class="c">free(pos &amp; ~ dbFlagsMask, size);</span></div><div class="line" id="l3224">                        <span class="c">pos = newPos;</span></div><div class="line" id="l3225">                        <span class="c">setPos(oid, pos | dbModifiedFlag);</span></div><div class="line" id="l3226">                    }
</div><div class="line" id="l3227">                    else <span class="c">if (newSize &lt; size)</span></div><div class="line" id="l3228">                    {
</div><div class="line" id="l3229">                        <span class="c">ObjectHeader.setSize(data, 0, size);</span></div><div class="line" id="l3230">                    }
</div><div class="line" id="l3231">                }
</div><div class="line" id="l3232">            }
</div><div class="line" id="l3233">            <span class="c">modified = true;</span></div><div class="line" id="l3234">            <span class="c">pool.put(pos &amp; ~dbFlagsMask, data, newSize);</span></div><div class="line" id="l3235">        <span class="c">}</span></div><div class="line" id="l3236"><br></div><div class="line" id="l3237">        public void loadObject(IPersistent obj)
</div><div class="line" id="l3238">        {
</div><div class="line" id="l3239">            <span class="c">lock (this)</span></div><div class="line" id="l3240">            {
</div><div class="line" id="l3241">                <span class="c">if (obj.IsRaw())</span></div><div class="line" id="l3242">                { 
</div><div class="line" id="l3243">                    <span class="c">loadStub(obj.Oid, obj, obj.GetType());</span></div><div class="line" id="l3244">                }
</div><div class="line" id="l3245">            }
</div><div class="line" id="l3246">        <span class="c">}</span></div><div class="line" id="l3247"><br></div><div class="line" id="l3248">        internal IPersistent lookupObject(int oid, System.Type cls)
</div><div class="line" id="l3249">        {
</div><div class="line" id="l3250">            <span class="c">IPersistent obj = objectCache.get(oid);</span></div><div class="line" id="l3251">            <span class="c">if (obj == null || obj.IsRaw())</span></div><div class="line" id="l3252">            {
</div><div class="line" id="l3253">                <span class="c">obj = loadStub(oid, obj, cls);</span></div><div class="line" id="l3254">            }
</div><div class="line" id="l3255">            <span class="c">return obj;</span></div><div class="line" id="l3256">        }
</div><div class="line" id="l3257"><br></div><div class="line" id="l3258">        protected virtual int swizzle(IPersistent obj)
</div><div class="line" id="l3259">        {
</div><div class="line" id="l3260">            <span class="c">int oid = 0;</span></div><div class="line" id="l3261">            <span class="c">if (obj != null)</span></div><div class="line" id="l3262">            {
</div><div class="line" id="l3263">                <span class="c">if (!obj.IsPersistent())</span></div><div class="line" id="l3264">                {
</div><div class="line" id="l3265">                    <span class="c">storeObject0(obj);</span></div><div class="line" id="l3266">                }
</div><div class="line" id="l3267">                <span class="c">oid = obj.Oid;</span></div><div class="line" id="l3268">            }
</div><div class="line" id="l3269">            <span class="c">return oid;</span></div><div class="line" id="l3270">        }
</div><div class="line" id="l3271"><br></div><div class="line" id="l3272">        internal ClassDescriptor findClassDescriptor(int oid) 
</div><div class="line" id="l3273">        { 
</div><div class="line" id="l3274">            <span class="c">return (ClassDescriptor)lookupObject(oid, typeof(ClassDescriptor));</span></div><div class="line" id="l3275">        }
</div><div class="line" id="l3276"><br></div><div class="line" id="l3277">        protected virtual IPersistent unswizzle(int oid, System.Type cls, bool recursiveLoading)
</div><div class="line" id="l3278">        {
</div><div class="line" id="l3279">            <span class="c">if (oid == 0)</span></div><div class="line" id="l3280">            {
</div><div class="line" id="l3281">                <span class="c">return null;</span></div><div class="line" id="l3282">            }
</div><div class="line" id="l3283">            <span class="c">if (recursiveLoading)</span></div><div class="line" id="l3284">            {
</div><div class="line" id="l3285">                <span class="c">return lookupObject(oid, cls);</span></div><div class="line" id="l3286">            }
</div><div class="line" id="l3287">            <span class="c">IPersistent stub = objectCache.get(oid);</span></div><div class="line" id="l3288">            <span class="c">if (stub != null)</span></div><div class="line" id="l3289">            {
</div><div class="line" id="l3290">                <span class="c">return stub;</span></div><div class="line" id="l3291">            }
</div><div class="line" id="l3292">            ClassDescriptor desc;
</div><div class="line" id="l3293">            <span class="c">if (cls == typeof(Persistent) || (desc = (ClassDescriptor) classDescMap[cls]) == null || desc.hasSubclasses)</span></div><div class="line" id="l3294">            {
</div><div class="line" id="l3295">                <span class="c">long pos = getPos(oid);</span></div><div class="line" id="l3296">                <span class="c">int offs = (int) pos &amp; (Page.pageSize - 1);</span></div><div class="line" id="l3297">                <span class="c">if ((offs &amp; (dbFreeHandleFlag | dbPageObjectFlag)) != 0)</span></div><div class="line" id="l3298">                {
</div><div class="line" id="l3299">                    <span class="c">throw new StorageError(StorageError.ErrorCode.DELETED_OBJECT);</span></div><div class="line" id="l3300">                }
</div><div class="line" id="l3301">                <span class="c">Page pg = pool.getPage(pos - offs);</span></div><div class="line" id="l3302">                <span class="c">int typeOid = ObjectHeader.getType(pg.data, offs &amp; ~ dbFlagsMask);</span></div><div class="line" id="l3303">                <span class="c">pool.unfix(pg);</span></div><div class="line" id="l3304">                <span class="c">desc = findClassDescriptor(typeOid);</span></div><div class="line" id="l3305">            }
</div><div class="line" id="l3306">            <span class="c">if (desc.serializer != null)</span></div><div class="line" id="l3307">            { 
</div><div class="line" id="l3308">                <span class="c">stub = desc.serializer.newInstance();</span></div><div class="line" id="l3309">            } 
</div><div class="line" id="l3310">            else 
</div><div class="line" id="l3311">            {
</div><div class="line" id="l3312">                <span class="c">stub = (IPersistent)desc.newInstance();</span></div><div class="line" id="l3313">            }
</div><div class="line" id="l3314">            <span class="c">stub.AssignOid(this, oid, true);</span></div><div class="line" id="l3315">            <span class="c">objectCache.put(oid, stub);</span></div><div class="line" id="l3316">            <span class="c">return stub;</span></div><div class="line" id="l3317">        }
</div><div class="line" id="l3318"><br></div><div class="line" id="l3319">        internal IPersistent loadStub(int oid, IPersistent obj, System.Type cls)
</div><div class="line" id="l3320">        {
</div><div class="line" id="l3321">            <span class="c">long pos = getPos(oid);</span></div><div class="line" id="l3322">            <span class="c">if ((pos &amp; (dbFreeHandleFlag | dbPageObjectFlag)) != 0)</span></div><div class="line" id="l3323">            {
</div><div class="line" id="l3324">                <span class="c">throw new StorageError(StorageError.ErrorCode.DELETED_OBJECT);</span></div><div class="line" id="l3325">            }
</div><div class="line" id="l3326">            <span class="c">byte[] body = pool.get(pos &amp; ~ dbFlagsMask);</span></div><div class="line" id="l3327">            ClassDescriptor desc;
</div><div class="line" id="l3328">            <span class="c">int typeOid = ObjectHeader.getType(body, 0);</span></div><div class="line" id="l3329">            <span class="c">if (typeOid == 0)</span></div><div class="line" id="l3330">            { 
</div><div class="line" id="l3331">                <span class="c">desc = (ClassDescriptor)classDescMap[cls];</span></div><div class="line" id="l3332">            } 
</div><div class="line" id="l3333">            else 
</div><div class="line" id="l3334">            { 
</div><div class="line" id="l3335">                <span class="c">desc = findClassDescriptor(typeOid);</span></div><div class="line" id="l3336">            }
</div><div class="line" id="l3337">            <span class="c">if (obj == null)</span></div><div class="line" id="l3338">            { 
</div><div class="line" id="l3339">                <span class="c">if (desc.serializer != null)</span></div><div class="line" id="l3340">                {
</div><div class="line" id="l3341">                    <span class="c">obj = desc.serializer.newInstance();</span></div><div class="line" id="l3342">                } 
</div><div class="line" id="l3343">                else 
</div><div class="line" id="l3344">                {
</div><div class="line" id="l3345">                    <span class="c">obj = (IPersistent)desc.newInstance();</span></div><div class="line" id="l3346">                }
</div><div class="line" id="l3347">                <span class="c">objectCache.put(oid, obj);</span></div><div class="line" id="l3348">            }
</div><div class="line" id="l3349">            <span class="c">obj.AssignOid(this, oid, false);</span></div><div class="line" id="l3350">            <span class="c">if (desc.serializer != null)</span></div><div class="line" id="l3351">            { 
</div><div class="line" id="l3352">                <span class="c">desc.serializer.unpack(this, obj, body, obj.RecursiveLoading(), encoding);</span></div><div class="line" id="l3353">            } 
</div><div class="line" id="l3354">            else 
</div><div class="line" id="l3355">            { 
</div><div class="line" id="l3356">                <span class="c">unpackObject(obj, desc, obj.RecursiveLoading(), body, ObjectHeader.Sizeof, obj);</span></div><div class="line" id="l3357">            }
</div><div class="line" id="l3358">            <span class="c">obj.OnLoad();</span></div><div class="line" id="l3359">            <span class="c">return obj;</span></div><div class="line" id="l3360">        }
</div><div class="line" id="l3361"><br></div><div class="line" id="l3362">        internal int unpackObject(object obj, ClassDescriptor desc, bool recursiveLoading, byte[] body, int offs, IPersistent po) 
</div><div class="line" id="l3363">        {
</div><div class="line" id="l3364">            <span class="c">ClassDescriptor.FieldDescriptor[] all = desc.allFields;</span></div><div class="line" id="l3365">            for (<span class="c">int i = 0,</span> <span class="c">n = all.Length;</span> <span class="c">i &lt; n</span>; <span class="c">i++</span>)</div><div class="line" id="l3366">            {
</div><div class="line" id="l3367">                <span class="c">ClassDescriptor.FieldDescriptor fd = all[i];</span></div><div class="line" id="l3368">                <span class="c">if (obj == null || fd.field == null)</span></div><div class="line" id="l3369">                {
</div><div class="line" id="l3370">                    <span class="c">offs = skipField(body, offs, fd, fd.type);</span></div><div class="line" id="l3371">                } 
</div><div class="line" id="l3372">                else 
</div><div class="line" id="l3373">                {
</div><div class="line" id="l3374">                    <span class="c">object val = obj;</span></div><div class="line" id="l3375">                    <span class="c">offs = unpackField(body, offs, recursiveLoading, ref val, fd, fd.type, po);</span></div><div class="line" id="l3376">                    <span class="c">fd.field.SetValue(obj, val);</span></div><div class="line" id="l3377">                }
</div><div class="line" id="l3378">            }  
</div><div class="line" id="l3379">            <span class="c">return offs;</span></div><div class="line" id="l3380">        }
</div><div class="line" id="l3381"><br></div><div class="line" id="l3382">        public int skipField(byte[] body, int offs, ClassDescriptor.FieldDescriptor fd, ClassDescriptor.FieldType type)
</div><div class="line" id="l3383">        {
</div><div class="line" id="l3384">            int len;
</div><div class="line" id="l3385">            switch (type) 
</div><div class="line" id="l3386">            { 
</div><div class="line" id="l3387">                case ClassDescriptor.FieldType.tpBoolean:
</div><div class="line" id="l3388">                case ClassDescriptor.FieldType.tpByte:
</div><div class="line" id="l3389">                case ClassDescriptor.FieldType.tpSByte:
</div><div class="line" id="l3390">                    return offs + 1;
</div><div class="line" id="l3391">                case ClassDescriptor.FieldType.tpChar:
</div><div class="line" id="l3392">                case ClassDescriptor.FieldType.tpShort:
</div><div class="line" id="l3393">                case ClassDescriptor.FieldType.tpUShort:
</div><div class="line" id="l3394">                    return offs + 2;
</div><div class="line" id="l3395">                case ClassDescriptor.FieldType.tpInt:
</div><div class="line" id="l3396">                case ClassDescriptor.FieldType.tpUInt:
</div><div class="line" id="l3397">                case ClassDescriptor.FieldType.tpFloat:
</div><div class="line" id="l3398">                case ClassDescriptor.FieldType.tpObject:
</div><div class="line" id="l3399">                case ClassDescriptor.FieldType.tpOid:
</div><div class="line" id="l3400">                    return offs + 4;
</div><div class="line" id="l3401">                case ClassDescriptor.FieldType.tpLong:
</div><div class="line" id="l3402">                case ClassDescriptor.FieldType.tpULong:
</div><div class="line" id="l3403">                case ClassDescriptor.FieldType.tpDouble:
</div><div class="line" id="l3404">                case ClassDescriptor.FieldType.tpDate:
</div><div class="line" id="l3405">                    return offs + 8;
</div><div class="line" id="l3406">                case ClassDescriptor.FieldType.tpDecimal:
</div><div class="line" id="l3407">                case ClassDescriptor.FieldType.tpGuid:
</div><div class="line" id="l3408">                    return offs + 16;
</div><div class="line" id="l3409">                case ClassDescriptor.FieldType.tpString:
</div><div class="line" id="l3410">                    len = Bytes.unpack4(body, offs);
</div><div class="line" id="l3411">                    offs += 4;
</div><div class="line" id="l3412">                    if (len &gt; 0) 
</div><div class="line" id="l3413">                    { 
</div><div class="line" id="l3414">                        offs += len*2;
</div><div class="line" id="l3415">                    }                        
</div><div class="line" id="l3416">                    else if (len &lt; -1) 
</div><div class="line" id="l3417">                    {
</div><div class="line" id="l3418">                        offs -= len+2;
</div><div class="line" id="l3419">                    }
</div><div class="line" id="l3420"><br></div><div class="line" id="l3421">                    break;
</div><div class="line" id="l3422">                case ClassDescriptor.FieldType.tpValue:
</div><div class="line" id="l3423">                    return unpackObject(null, fd.valueDesc, false, body, offs, null);
</div><div class="line" id="l3424">#if SUPPORT_RAW_TYPE
</div><div class="line" id="l3425">                case ClassDescriptor.FieldType.tpRaw:
</div><div class="line" id="l3426">#endif
</div><div class="line" id="l3427">                case ClassDescriptor.FieldType.tpArrayOfByte:
</div><div class="line" id="l3428">                case ClassDescriptor.FieldType.tpArrayOfSByte:
</div><div class="line" id="l3429">                case ClassDescriptor.FieldType.tpArrayOfBoolean:
</div><div class="line" id="l3430">                    len = Bytes.unpack4(body, offs);
</div><div class="line" id="l3431">                    offs += 4;
</div><div class="line" id="l3432">                    if (len &gt; 0) 
</div><div class="line" id="l3433">                    { 
</div><div class="line" id="l3434">                        offs += len;
</div><div class="line" id="l3435">                    }
</div><div class="line" id="l3436">                    else if (len &lt; -1) 
</div><div class="line" id="l3437">                    { 
</div><div class="line" id="l3438">                        offs += ClassDescriptor.Sizeof[-2-len];
</div><div class="line" id="l3439">                    }
</div><div class="line" id="l3440">                    break;
</div><div class="line" id="l3441">                case ClassDescriptor.FieldType.tpArrayOfShort:
</div><div class="line" id="l3442">                case ClassDescriptor.FieldType.tpArrayOfUShort:
</div><div class="line" id="l3443">                case ClassDescriptor.FieldType.tpArrayOfChar:
</div><div class="line" id="l3444">                    len = Bytes.unpack4(body, offs);
</div><div class="line" id="l3445">                    offs += 4;
</div><div class="line" id="l3446">                    if (len &gt; 0) 
</div><div class="line" id="l3447">                    { 
</div><div class="line" id="l3448">                        offs += len*2;
</div><div class="line" id="l3449">                    }
</div><div class="line" id="l3450">                    break;
</div><div class="line" id="l3451">                case ClassDescriptor.FieldType.tpArrayOfInt:
</div><div class="line" id="l3452">                case ClassDescriptor.FieldType.tpArrayOfUInt:
</div><div class="line" id="l3453">                case ClassDescriptor.FieldType.tpArrayOfFloat:
</div><div class="line" id="l3454">                case ClassDescriptor.FieldType.tpArrayOfObject:
</div><div class="line" id="l3455">                case ClassDescriptor.FieldType.tpArrayOfOid:
</div><div class="line" id="l3456">                case ClassDescriptor.FieldType.tpLink:
</div><div class="line" id="l3457">                    len = Bytes.unpack4(body, offs);
</div><div class="line" id="l3458">                    offs += 4;
</div><div class="line" id="l3459">                    if (len &gt; 0) 
</div><div class="line" id="l3460">                    { 
</div><div class="line" id="l3461">                        offs += len*4;
</div><div class="line" id="l3462">                    }
</div><div class="line" id="l3463">                    break;
</div><div class="line" id="l3464">                case ClassDescriptor.FieldType.tpArrayOfLong:
</div><div class="line" id="l3465">                case ClassDescriptor.FieldType.tpArrayOfULong:
</div><div class="line" id="l3466">                case ClassDescriptor.FieldType.tpArrayOfDouble:
</div><div class="line" id="l3467">                case ClassDescriptor.FieldType.tpArrayOfDate:
</div><div class="line" id="l3468">                    len = Bytes.unpack4(body, offs);
</div><div class="line" id="l3469">                    offs += 4;
</div><div class="line" id="l3470">                    if (len &gt; 0) 
</div><div class="line" id="l3471">                    { 
</div><div class="line" id="l3472">                        offs += len*8;
</div><div class="line" id="l3473">                    }
</div><div class="line" id="l3474">                    break;
</div><div class="line" id="l3475">                case ClassDescriptor.FieldType.tpArrayOfString:
</div><div class="line" id="l3476">                    len = Bytes.unpack4(body, offs);
</div><div class="line" id="l3477">                    offs += 4;
</div><div class="line" id="l3478">                    if (len &gt; 0) 
</div><div class="line" id="l3479">                    { 
</div><div class="line" id="l3480">                        for (int j = 0; j &lt; len; j++) 
</div><div class="line" id="l3481">                        {
</div><div class="line" id="l3482">                            int strlen = Bytes.unpack4(body, offs);
</div><div class="line" id="l3483">                            offs += 4;
</div><div class="line" id="l3484">                            if (strlen &gt; 0) 
</div><div class="line" id="l3485">                            {
</div><div class="line" id="l3486">                                offs += strlen*2;
</div><div class="line" id="l3487">                            }                       
</div><div class="line" id="l3488">                            else if (strlen &lt; -1) 
</div><div class="line" id="l3489">                            {
</div><div class="line" id="l3490">                                offs -= strlen+2;
</div><div class="line" id="l3491">                            }
</div><div class="line" id="l3492"><br></div><div class="line" id="l3493">                        }
</div><div class="line" id="l3494">                    }
</div><div class="line" id="l3495">                    break;
</div><div class="line" id="l3496"><br></div><div class="line" id="l3497">                case ClassDescriptor.FieldType.tpArrayOfValue:
</div><div class="line" id="l3498">                    len = Bytes.unpack4(body, offs);
</div><div class="line" id="l3499">                    offs += 4;
</div><div class="line" id="l3500">                    if (len &gt; 0) 
</div><div class="line" id="l3501">                    { 
</div><div class="line" id="l3502">                        ClassDescriptor valueDesc = fd.valueDesc;
</div><div class="line" id="l3503">                        for (int j = 0; j &lt; len; j++) 
</div><div class="line" id="l3504">                        { 
</div><div class="line" id="l3505">                            offs = unpackObject(null, valueDesc, false, body, offs, null);
</div><div class="line" id="l3506">                        }
</div><div class="line" id="l3507">                    }
</div><div class="line" id="l3508">                    break;
</div><div class="line" id="l3509">#if SUPPORT_RAW_TYPE
</div><div class="line" id="l3510">                case ClassDescriptor.FieldType.tpArrayOfRaw:
</div><div class="line" id="l3511">                    len = Bytes.unpack4(body, offs);
</div><div class="line" id="l3512">                    offs += 4;
</div><div class="line" id="l3513">                    if (len &gt; 0) 
</div><div class="line" id="l3514">                    { 
</div><div class="line" id="l3515">                        for (int j = 0; j &lt; len; j++) 
</div><div class="line" id="l3516">                        {
</div><div class="line" id="l3517">                            int rawlen = Bytes.unpack4(body, offs);
</div><div class="line" id="l3518">                            offs += 4;
</div><div class="line" id="l3519">                            if (rawlen &gt; 0) 
</div><div class="line" id="l3520">                            {
</div><div class="line" id="l3521">                                len += rawlen;
</div><div class="line" id="l3522">                            }
</div><div class="line" id="l3523">                            else if (rawlen &lt; -1) 
</div><div class="line" id="l3524">                            { 
</div><div class="line" id="l3525">                                offs += ClassDescriptor.Sizeof[-2-rawlen];
</div><div class="line" id="l3526">                            }
</div><div class="line" id="l3527">                        }
</div><div class="line" id="l3528">                    }
</div><div class="line" id="l3529">                    break;
</div><div class="line" id="l3530">#endif
</div><div class="line" id="l3531">            }                 
</div><div class="line" id="l3532">            return offs;
</div><div class="line" id="l3533">        }
</div><div class="line" id="l3534"><br></div><div class="line" id="l3535">#if SUPPORT_RAW_TYPE
</div><div class="line" id="l3536">        private int unpackRawValue(byte[] body, int offs, out object val, bool recursiveLoading) 
</div><div class="line" id="l3537">        {
</div><div class="line" id="l3538">            int len = Bytes.unpack4(body, offs);
</div><div class="line" id="l3539">            offs += 4;
</div><div class="line" id="l3540">            if (len &gt;= 0)
</div><div class="line" id="l3541">            {
</div><div class="line" id="l3542">                System.IO.MemoryStream ms = new System.IO.MemoryStream(body, offs, len);
</div><div class="line" id="l3543">                val = objectFormatter.Deserialize(ms);
</div><div class="line" id="l3544">                ms.Close();
</div><div class="line" id="l3545">                offs += len;
</div><div class="line" id="l3546">            } 
</div><div class="line" id="l3547">            else 
</div><div class="line" id="l3548">            { 
</div><div class="line" id="l3549">                switch ((ClassDescriptor.FieldType)(-2-len)) 
</div><div class="line" id="l3550">                { 
</div><div class="line" id="l3551">                    case ClassDescriptor.FieldType.tpBoolean:
</div><div class="line" id="l3552">                        val = body[offs++] != 0;
</div><div class="line" id="l3553">                        break;
</div><div class="line" id="l3554">                    case ClassDescriptor.FieldType.tpByte:
</div><div class="line" id="l3555">                        val = body[offs++];
</div><div class="line" id="l3556">                        break;                            
</div><div class="line" id="l3557">                    case ClassDescriptor.FieldType.tpSByte:
</div><div class="line" id="l3558">                        val = (sbyte)body[offs++];
</div><div class="line" id="l3559">                        break;                            
</div><div class="line" id="l3560">                    case ClassDescriptor.FieldType.tpChar:
</div><div class="line" id="l3561">                        val = (char)Bytes.unpack2(body, offs);
</div><div class="line" id="l3562">                        offs += 2;
</div><div class="line" id="l3563">                        break;                            
</div><div class="line" id="l3564">                    case ClassDescriptor.FieldType.tpShort:
</div><div class="line" id="l3565">                        val = Bytes.unpack2(body, offs);
</div><div class="line" id="l3566">                        offs += 2;
</div><div class="line" id="l3567">                        break;                            
</div><div class="line" id="l3568">                    case ClassDescriptor.FieldType.tpUShort:
</div><div class="line" id="l3569">                        val = (ushort)Bytes.unpack2(body, offs);
</div><div class="line" id="l3570">                        offs += 2;
</div><div class="line" id="l3571">                        break;                            
</div><div class="line" id="l3572">                    case ClassDescriptor.FieldType.tpInt:
</div><div class="line" id="l3573">                    case ClassDescriptor.FieldType.tpOid:
</div><div class="line" id="l3574">                        val = Bytes.unpack4(body, offs);
</div><div class="line" id="l3575">                        offs += 4;
</div><div class="line" id="l3576">                        break;                            
</div><div class="line" id="l3577">                    case ClassDescriptor.FieldType.tpUInt:
</div><div class="line" id="l3578">                        val = (uint)Bytes.unpack4(body, offs);
</div><div class="line" id="l3579">                        offs += 4;
</div><div class="line" id="l3580">                        break;                            
</div><div class="line" id="l3581">                    case ClassDescriptor.FieldType.tpLong:
</div><div class="line" id="l3582">                        val = Bytes.unpack8(body, offs);
</div><div class="line" id="l3583">                        offs += 8;
</div><div class="line" id="l3584">                        break;                            
</div><div class="line" id="l3585">                    case ClassDescriptor.FieldType.tpULong:
</div><div class="line" id="l3586">                        val = (ulong)Bytes.unpack8(body, offs);
</div><div class="line" id="l3587">                        offs += 8;
</div><div class="line" id="l3588">                        break;                            
</div><div class="line" id="l3589">                    case ClassDescriptor.FieldType.tpFloat:
</div><div class="line" id="l3590">                        val = Bytes.unpackF4(body, offs);
</div><div class="line" id="l3591">                        offs += 4;
</div><div class="line" id="l3592">                        break;                            
</div><div class="line" id="l3593">                    case ClassDescriptor.FieldType.tpDouble:
</div><div class="line" id="l3594">                        val = Bytes.unpackF8(body, offs);
</div><div class="line" id="l3595">                        offs += 8;
</div><div class="line" id="l3596">                        break;                            
</div><div class="line" id="l3597">                    case ClassDescriptor.FieldType.tpDate:
</div><div class="line" id="l3598">                        val = Bytes.unpackDate(body, offs);
</div><div class="line" id="l3599">                        offs += 8;
</div><div class="line" id="l3600">                        break;                                                       
</div><div class="line" id="l3601">                    case ClassDescriptor.FieldType.tpGuid:
</div><div class="line" id="l3602">                        val = Bytes.unpackGuid(body, offs);
</div><div class="line" id="l3603">                        offs += 8;
</div><div class="line" id="l3604">                        break;                                                       
</div><div class="line" id="l3605">                    case ClassDescriptor.FieldType.tpDecimal:
</div><div class="line" id="l3606">                        val = Bytes.unpackDecimal(body, offs);
</div><div class="line" id="l3607">                        offs += 8;
</div><div class="line" id="l3608">                        break;                                                       
</div><div class="line" id="l3609">                    case ClassDescriptor.FieldType.tpObject:
</div><div class="line" id="l3610">                        val = unswizzle(Bytes.unpack4(body, offs), 
</div><div class="line" id="l3611">                            typeof(Persistent), 
</div><div class="line" id="l3612">                            recursiveLoading);
</div><div class="line" id="l3613">                        offs += 4;
</div><div class="line" id="l3614">                        break;
</div><div class="line" id="l3615">                    default:
</div><div class="line" id="l3616">                        val = null;
</div><div class="line" id="l3617">                        break;
</div><div class="line" id="l3618">                }
</div><div class="line" id="l3619">            }    
</div><div class="line" id="l3620">            return offs;
</div><div class="line" id="l3621">        }
</div><div class="line" id="l3622">#endif
</div><div class="line" id="l3623"><br></div><div class="line" id="l3624">        public int unpackField(byte[] body, int offs, bool recursiveLoading, ref object val, ClassDescriptor.FieldDescriptor fd, ClassDescriptor.FieldType type, IPersistent po)
</div><div class="line" id="l3625"><br></div><div class="line" id="l3626">        { 
</div><div class="line" id="l3627">            int len;
</div><div class="line" id="l3628">            <span class="c">switch (type)</span></div><div class="line" id="l3629">            {
</div><div class="line" id="l3630">                case ClassDescriptor.FieldType.tpBoolean: 
</div><div class="line" id="l3631">                    <span class="c">val = body[offs++] != 0;</span></div><div class="line" id="l3632">                    <span class="c">break;</span></div><div class="line" id="l3633"><br></div><div class="line" id="l3634">                case ClassDescriptor.FieldType.tpByte: 
</div><div class="line" id="l3635">                    <span class="c">val = body[offs++];</span></div><div class="line" id="l3636">                    <span class="c">break;</span></div><div class="line" id="l3637"><br></div><div class="line" id="l3638">                case ClassDescriptor.FieldType.tpSByte: 
</div><div class="line" id="l3639">                    <span class="c">val = (sbyte)body[offs++];</span></div><div class="line" id="l3640">                    <span class="c">break;</span></div><div class="line" id="l3641"><br></div><div class="line" id="l3642">                case ClassDescriptor.FieldType.tpChar: 
</div><div class="line" id="l3643">                    <span class="c">val = (char)Bytes.unpack2(body, offs);</span></div><div class="line" id="l3644">                    <span class="c">offs += 2;</span></div><div class="line" id="l3645">                    <span class="c">break;</span></div><div class="line" id="l3646"><br></div><div class="line" id="l3647">                case ClassDescriptor.FieldType.tpShort: 
</div><div class="line" id="l3648">                    <span class="c">val = Bytes.unpack2(body, offs);</span></div><div class="line" id="l3649">                    <span class="c">offs += 2;</span></div><div class="line" id="l3650">                    <span class="c">break;</span></div><div class="line" id="l3651"><br></div><div class="line" id="l3652">                case ClassDescriptor.FieldType.tpUShort: 
</div><div class="line" id="l3653">                    <span class="c">val = (ushort)Bytes.unpack2(body, offs);</span></div><div class="line" id="l3654">                    <span class="c">offs += 2;</span></div><div class="line" id="l3655">                    <span class="c">break;</span></div><div class="line" id="l3656"><br></div><div class="line" id="l3657">                case ClassDescriptor.FieldType.tpEnum: 
</div><div class="line" id="l3658">                    <span class="c">val = Enum.ToObject(fd.field.FieldType, Bytes.unpack4(body, offs));</span></div><div class="line" id="l3659">                    <span class="c">offs += 4;</span></div><div class="line" id="l3660">                    <span class="c">break;</span></div><div class="line" id="l3661"><br></div><div class="line" id="l3662">                case ClassDescriptor.FieldType.tpInt: 
</div><div class="line" id="l3663">                case ClassDescriptor.FieldType.tpOid: 
</div><div class="line" id="l3664">                    <span class="c">val = Bytes.unpack4(body, offs);</span></div><div class="line" id="l3665">                    <span class="c">offs += 4;</span></div><div class="line" id="l3666">                    <span class="c">break;</span></div><div class="line" id="l3667"><br></div><div class="line" id="l3668">                case ClassDescriptor.FieldType.tpUInt: 
</div><div class="line" id="l3669">                    <span class="c">val = (uint)Bytes.unpack4(body, offs);</span></div><div class="line" id="l3670">                    <span class="c">offs += 4;</span></div><div class="line" id="l3671">                    <span class="c">break;</span></div><div class="line" id="l3672"><br></div><div class="line" id="l3673">                case ClassDescriptor.FieldType.tpLong: 
</div><div class="line" id="l3674">                    <span class="c">val = Bytes.unpack8(body, offs);</span></div><div class="line" id="l3675">                    <span class="c">offs += 8;</span></div><div class="line" id="l3676">                    <span class="c">break;</span></div><div class="line" id="l3677"><br></div><div class="line" id="l3678">                case ClassDescriptor.FieldType.tpULong: 
</div><div class="line" id="l3679">                    <span class="c">val = (ulong)Bytes.unpack8(body, offs);</span></div><div class="line" id="l3680">                    <span class="c">offs += 8;</span></div><div class="line" id="l3681">                    <span class="c">break;</span></div><div class="line" id="l3682"><br></div><div class="line" id="l3683">                case ClassDescriptor.FieldType.tpFloat: 
</div><div class="line" id="l3684">                    <span class="c">val = Bytes.unpackF4(body, offs);</span></div><div class="line" id="l3685">                    <span class="c">offs += 4;</span></div><div class="line" id="l3686">                    <span class="c">break;</span></div><div class="line" id="l3687"><br></div><div class="line" id="l3688">                case ClassDescriptor.FieldType.tpDouble: 
</div><div class="line" id="l3689">                    <span class="c">val = Bytes.unpackF8(body, offs);</span></div><div class="line" id="l3690">                    <span class="c">offs += 8;</span></div><div class="line" id="l3691">                    <span class="c">break;</span></div><div class="line" id="l3692"><br></div><div class="line" id="l3693">                case ClassDescriptor.FieldType.tpDecimal:
</div><div class="line" id="l3694">                    <span class="c">val = Bytes.unpackDecimal(body, offs);</span></div><div class="line" id="l3695">                    <span class="c">offs += 16;</span></div><div class="line" id="l3696">                    <span class="c">break;</span></div><div class="line" id="l3697"><br></div><div class="line" id="l3698">                case ClassDescriptor.FieldType.tpGuid:
</div><div class="line" id="l3699">                    <span class="c">val = Bytes.unpackGuid(body, offs);</span></div><div class="line" id="l3700">                    <span class="c">offs += 16;</span></div><div class="line" id="l3701">                    <span class="c">break;</span></div><div class="line" id="l3702"><br></div><div class="line" id="l3703">                case ClassDescriptor.FieldType.tpString: 
</div><div class="line" id="l3704">                {
</div><div class="line" id="l3705">                    string str;
</div><div class="line" id="l3706">                    <span class="c">offs = Bytes.unpackString(body, offs, out str, encoding);</span></div><div class="line" id="l3707">                    <span class="c">val = str;</span></div><div class="line" id="l3708">                    <span class="c">break;</span></div><div class="line" id="l3709">                }
</div><div class="line" id="l3710"><br></div><div class="line" id="l3711">                case ClassDescriptor.FieldType.tpDate: 
</div><div class="line" id="l3712">                    <span class="c">val = Bytes.unpackDate(body, offs);</span></div><div class="line" id="l3713">                    <span class="c">offs += 8;</span></div><div class="line" id="l3714">                    <span class="c">break;</span></div><div class="line" id="l3715"><br></div><div class="line" id="l3716">                case ClassDescriptor.FieldType.tpObject: 
</div><div class="line" id="l3717">                    <span class="c">if (fd == null)</span></div><div class="line" id="l3718">                    { 
</div><div class="line" id="l3719">                        <span class="c">val = unswizzle(Bytes.unpack4(body, offs), typeof(Persistent), recursiveLoading);</span></div><div class="line" id="l3720">                    } 
</div><div class="line" id="l3721">                    else 
</div><div class="line" id="l3722">                    { 
</div><div class="line" id="l3723">                        <span class="c">val = unswizzle(Bytes.unpack4(body, offs), fd.field.FieldType,</span></div><div class="line" id="l3724">                                        fd.recursiveLoading|recursiveLoading)<span class="c">;</span></div><div class="line" id="l3725">                    }
</div><div class="line" id="l3726">                    <span class="c">offs += 4;</span></div><div class="line" id="l3727">                    <span class="c">break;</span></div><div class="line" id="l3728"><br></div><div class="line" id="l3729">                case ClassDescriptor.FieldType.tpValue: 
</div><div class="line" id="l3730">                    <span class="c">val = fd.field.GetValue(val);</span></div><div class="line" id="l3731">                    <span class="c">offs = unpackObject(val, fd.valueDesc, recursiveLoading, body, offs, po);</span></div><div class="line" id="l3732">                    <span class="c">break;</span></div><div class="line" id="l3733"><br></div><div class="line" id="l3734">#if SUPPORT_RAW_TYPE
</div><div class="line" id="l3735">                case ClassDescriptor.FieldType.tpRaw: 
</div><div class="line" id="l3736">                    <span class="c">offs = unpackRawValue(body, offs, out val, recursiveLoading);</span></div><div class="line" id="l3737">                    <span class="c">break;</span></div><div class="line" id="l3738">#endif
</div><div class="line" id="l3739">                case ClassDescriptor.FieldType.tpArrayOfByte: 
</div><div class="line" id="l3740">                    <span class="c">len = Bytes.unpack4(body, offs);</span></div><div class="line" id="l3741">                    <span class="c">offs += 4;</span></div><div class="line" id="l3742">                    <span class="c">if (len &lt; 0)</span></div><div class="line" id="l3743">                    {
</div><div class="line" id="l3744">                        <span class="c">val = null;</span></div><div class="line" id="l3745">                    }
</div><div class="line" id="l3746">                    else
</div><div class="line" id="l3747">                    {
</div><div class="line" id="l3748">                        <span class="c">byte[] arr = new byte[len];</span></div><div class="line" id="l3749">                        <span class="c">Array.Copy(body, offs, arr, 0, len);</span></div><div class="line" id="l3750">                        <span class="c">offs += len;</span></div><div class="line" id="l3751">                        <span class="c">val = arr;</span></div><div class="line" id="l3752">                    }
</div><div class="line" id="l3753">                    <span class="c">break;</span></div><div class="line" id="l3754"><br></div><div class="line" id="l3755">                case ClassDescriptor.FieldType.tpArrayOfSByte: 
</div><div class="line" id="l3756">                    <span class="c">len = Bytes.unpack4(body, offs);</span></div><div class="line" id="l3757">                    <span class="c">offs += 4;</span></div><div class="line" id="l3758">                    <span class="c">if (len &lt; 0)</span></div><div class="line" id="l3759">                    {
</div><div class="line" id="l3760">                        <span class="c">val = null;</span></div><div class="line" id="l3761">                    }
</div><div class="line" id="l3762">                    else
</div><div class="line" id="l3763">                    {
</div><div class="line" id="l3764">                        <span class="c">sbyte[] arr = new sbyte[len];</span></div><div class="line" id="l3765">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l3766">                        {
</div><div class="line" id="l3767">                            <span class="c">arr[j] = (sbyte)body[offs++];</span></div><div class="line" id="l3768">                        }
</div><div class="line" id="l3769">                        <span class="c">val = arr;</span></div><div class="line" id="l3770">                    }
</div><div class="line" id="l3771">                    <span class="c">break;</span></div><div class="line" id="l3772"><br></div><div class="line" id="l3773">                case ClassDescriptor.FieldType.tpArrayOfBoolean: 
</div><div class="line" id="l3774">                    <span class="c">len = Bytes.unpack4(body, offs);</span></div><div class="line" id="l3775">                    <span class="c">offs += 4;</span></div><div class="line" id="l3776">                    <span class="c">if (len &lt; 0)</span></div><div class="line" id="l3777">                    {
</div><div class="line" id="l3778">                        <span class="c">val = null;</span></div><div class="line" id="l3779">                    }
</div><div class="line" id="l3780">                    else
</div><div class="line" id="l3781">                    {
</div><div class="line" id="l3782">                        <span class="c">bool[] arr = new bool[len];</span></div><div class="line" id="l3783">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l3784">                        {
</div><div class="line" id="l3785">                            <span class="c">arr[j] = body[offs++] != 0;</span></div><div class="line" id="l3786">                        }
</div><div class="line" id="l3787">                        <span class="c">val = arr;</span></div><div class="line" id="l3788">                    }
</div><div class="line" id="l3789">                    <span class="c">break;</span></div><div class="line" id="l3790"><br></div><div class="line" id="l3791">                case ClassDescriptor.FieldType.tpArrayOfShort: 
</div><div class="line" id="l3792">                    <span class="c">len = Bytes.unpack4(body, offs);</span></div><div class="line" id="l3793">                    <span class="c">offs += 4;</span></div><div class="line" id="l3794">                    <span class="c">if (len &lt; 0)</span></div><div class="line" id="l3795">                    {
</div><div class="line" id="l3796">                        <span class="c">val = null;</span></div><div class="line" id="l3797">                    }
</div><div class="line" id="l3798">                    else
</div><div class="line" id="l3799">                    {
</div><div class="line" id="l3800">                        <span class="c">short[] arr = new short[len];</span></div><div class="line" id="l3801">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l3802">                        {
</div><div class="line" id="l3803">                            <span class="c">arr[j] = Bytes.unpack2(body, offs);</span></div><div class="line" id="l3804">                            <span class="c">offs += 2;</span></div><div class="line" id="l3805">                        }
</div><div class="line" id="l3806">                        <span class="c">val = arr;</span></div><div class="line" id="l3807">                    }
</div><div class="line" id="l3808">                    <span class="c">break;</span></div><div class="line" id="l3809"><br></div><div class="line" id="l3810">                case ClassDescriptor.FieldType.tpArrayOfUShort: 
</div><div class="line" id="l3811">                    <span class="c">len = Bytes.unpack4(body, offs);</span></div><div class="line" id="l3812">                    <span class="c">offs += 4;</span></div><div class="line" id="l3813">                    <span class="c">if (len &lt; 0)</span></div><div class="line" id="l3814">                    {
</div><div class="line" id="l3815">                        <span class="c">val = null;</span></div><div class="line" id="l3816">                    }
</div><div class="line" id="l3817">                    else
</div><div class="line" id="l3818">                    {
</div><div class="line" id="l3819">                        <span class="c">ushort[] arr = new ushort[len];</span></div><div class="line" id="l3820">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l3821">                        {
</div><div class="line" id="l3822">                            <span class="c">arr[j] = (ushort)Bytes.unpack2(body, offs);</span></div><div class="line" id="l3823">                            <span class="c">offs += 2;</span></div><div class="line" id="l3824">                        }
</div><div class="line" id="l3825">                        <span class="c">val = arr;</span></div><div class="line" id="l3826">                    }
</div><div class="line" id="l3827">                    <span class="c">break;</span></div><div class="line" id="l3828"><br></div><div class="line" id="l3829">                case ClassDescriptor.FieldType.tpArrayOfChar: 
</div><div class="line" id="l3830">                    <span class="c">len = Bytes.unpack4(body, offs);</span></div><div class="line" id="l3831">                    <span class="c">offs += 4;</span></div><div class="line" id="l3832">                    <span class="c">if (len &lt; 0)</span></div><div class="line" id="l3833">                    {
</div><div class="line" id="l3834">                        <span class="c">val = null;</span></div><div class="line" id="l3835">                    }
</div><div class="line" id="l3836">                    else
</div><div class="line" id="l3837">                    {
</div><div class="line" id="l3838">                        <span class="c">char[] arr = new char[len];</span></div><div class="line" id="l3839">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l3840">                        {
</div><div class="line" id="l3841">                            <span class="c">arr[j] = (char) Bytes.unpack2(body, offs);</span></div><div class="line" id="l3842">                            <span class="c">offs += 2;</span></div><div class="line" id="l3843">                        }
</div><div class="line" id="l3844">                        <span class="c">val = arr;</span></div><div class="line" id="l3845">                    }
</div><div class="line" id="l3846">                    <span class="c">break;</span></div><div class="line" id="l3847"><br></div><div class="line" id="l3848">                case ClassDescriptor.FieldType.tpArrayOfEnum: 
</div><div class="line" id="l3849">                    <span class="c">len = Bytes.unpack4(body, offs);</span></div><div class="line" id="l3850">                    <span class="c">offs += 4;</span></div><div class="line" id="l3851">                    <span class="c">if (len &lt; 0)</span></div><div class="line" id="l3852">                    {
</div><div class="line" id="l3853">                        <span class="c">val = null;</span></div><div class="line" id="l3854">                    }
</div><div class="line" id="l3855">                    else
</div><div class="line" id="l3856">                    {
</div><div class="line" id="l3857">                        <span class="c">System.Type elemType = fd.field.FieldType.GetElementType();</span></div><div class="line" id="l3858">                        <span class="c">Array arr = Array.CreateInstance(elemType, len);</span></div><div class="line" id="l3859">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l3860">                        {
</div><div class="line" id="l3861">                            <span class="c">arr.SetValue(Enum.ToObject(elemType, Bytes.unpack4(body, offs)), j);</span></div><div class="line" id="l3862">                            <span class="c">offs += 4;</span></div><div class="line" id="l3863">                        }
</div><div class="line" id="l3864">                        <span class="c">val = arr;</span></div><div class="line" id="l3865">                    }
</div><div class="line" id="l3866">                    <span class="c">break;</span></div><div class="line" id="l3867"><br></div><div class="line" id="l3868">                case ClassDescriptor.FieldType.tpArrayOfInt: 
</div><div class="line" id="l3869">                    <span class="c">len = Bytes.unpack4(body, offs);</span></div><div class="line" id="l3870">                    <span class="c">offs += 4;</span></div><div class="line" id="l3871">                    <span class="c">if (len &lt; 0)</span></div><div class="line" id="l3872">                    {
</div><div class="line" id="l3873">                        <span class="c">val = null;</span></div><div class="line" id="l3874">                    }
</div><div class="line" id="l3875">                    else
</div><div class="line" id="l3876">                    {
</div><div class="line" id="l3877">                        <span class="c">int[] arr = new int[len];</span></div><div class="line" id="l3878">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l3879">                        {
</div><div class="line" id="l3880">                            <span class="c">arr[j] = Bytes.unpack4(body, offs);</span></div><div class="line" id="l3881">                            <span class="c">offs += 4;</span></div><div class="line" id="l3882">                        }
</div><div class="line" id="l3883">                        <span class="c">val = arr;</span></div><div class="line" id="l3884">                    }
</div><div class="line" id="l3885">                    <span class="c">break;</span></div><div class="line" id="l3886"><br></div><div class="line" id="l3887">                case ClassDescriptor.FieldType.tpArrayOfUInt: 
</div><div class="line" id="l3888">                    <span class="c">len = Bytes.unpack4(body, offs);</span></div><div class="line" id="l3889">                    <span class="c">offs += 4;</span></div><div class="line" id="l3890">                    <span class="c">if (len &lt; 0)</span></div><div class="line" id="l3891">                    {
</div><div class="line" id="l3892">                        <span class="c">val = null;</span></div><div class="line" id="l3893">                    }
</div><div class="line" id="l3894">                    else
</div><div class="line" id="l3895">                    {
</div><div class="line" id="l3896">                        <span class="c">uint[] arr = new uint[len];</span></div><div class="line" id="l3897">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l3898">                        {
</div><div class="line" id="l3899">                            <span class="c">arr[j] = (uint)Bytes.unpack4(body, offs);</span></div><div class="line" id="l3900">                            <span class="c">offs += 4;</span></div><div class="line" id="l3901">                        }
</div><div class="line" id="l3902">                        <span class="c">val = arr;</span></div><div class="line" id="l3903">                    }
</div><div class="line" id="l3904">                    <span class="c">break;</span></div><div class="line" id="l3905"><br></div><div class="line" id="l3906">                case ClassDescriptor.FieldType.tpArrayOfLong: 
</div><div class="line" id="l3907">                    <span class="c">len = Bytes.unpack4(body, offs);</span></div><div class="line" id="l3908">                    <span class="c">offs += 4;</span></div><div class="line" id="l3909">                    <span class="c">if (len &lt; 0)</span></div><div class="line" id="l3910">                    {
</div><div class="line" id="l3911">                        <span class="c">val = null;</span></div><div class="line" id="l3912">                    }
</div><div class="line" id="l3913">                    else
</div><div class="line" id="l3914">                    {
</div><div class="line" id="l3915">                        <span class="c">long[] arr = new long[len];</span></div><div class="line" id="l3916">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l3917">                        {
</div><div class="line" id="l3918">                            <span class="c">arr[j] = Bytes.unpack8(body, offs);</span></div><div class="line" id="l3919">                            <span class="c">offs += 8;</span></div><div class="line" id="l3920">                        }
</div><div class="line" id="l3921">                        <span class="c">val = arr;</span></div><div class="line" id="l3922">                    }
</div><div class="line" id="l3923">                    <span class="c">break;</span></div><div class="line" id="l3924"><br></div><div class="line" id="l3925">                case ClassDescriptor.FieldType.tpArrayOfULong: 
</div><div class="line" id="l3926">                    <span class="c">len = Bytes.unpack4(body, offs);</span></div><div class="line" id="l3927">                    <span class="c">offs += 4;</span></div><div class="line" id="l3928">                    <span class="c">if (len &lt; 0)</span></div><div class="line" id="l3929">                    {
</div><div class="line" id="l3930">                        <span class="c">val = null;</span></div><div class="line" id="l3931">                    }
</div><div class="line" id="l3932">                    else
</div><div class="line" id="l3933">                    {
</div><div class="line" id="l3934">                        <span class="c">ulong[] arr = new ulong[len];</span></div><div class="line" id="l3935">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l3936">                        {
</div><div class="line" id="l3937">                            <span class="c">arr[j] = (ulong)Bytes.unpack8(body, offs);</span></div><div class="line" id="l3938">                            <span class="c">offs += 8;</span></div><div class="line" id="l3939">                        }
</div><div class="line" id="l3940">                        <span class="c">val = arr;</span></div><div class="line" id="l3941">                    }
</div><div class="line" id="l3942">                    <span class="c">break;</span></div><div class="line" id="l3943"><br></div><div class="line" id="l3944">                case ClassDescriptor.FieldType.tpArrayOfFloat: 
</div><div class="line" id="l3945">                    <span class="c">len = Bytes.unpack4(body, offs);</span></div><div class="line" id="l3946">                    <span class="c">offs += 4;</span></div><div class="line" id="l3947">                    <span class="c">if (len &lt; 0)</span></div><div class="line" id="l3948">                    {
</div><div class="line" id="l3949">                        <span class="c">val = null;</span></div><div class="line" id="l3950">                    }
</div><div class="line" id="l3951">                    else
</div><div class="line" id="l3952">                    {
</div><div class="line" id="l3953">                        <span class="c">float[] arr = new float[len];</span></div><div class="line" id="l3954">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l3955">                        {
</div><div class="line" id="l3956">                            <span class="c">arr[j] = Bytes.unpackF4(body, offs);</span></div><div class="line" id="l3957">                            <span class="c">offs += 4;</span></div><div class="line" id="l3958">                        }
</div><div class="line" id="l3959">                        <span class="c">val = arr;</span></div><div class="line" id="l3960">                    }
</div><div class="line" id="l3961">                    <span class="c">break;</span></div><div class="line" id="l3962"><br></div><div class="line" id="l3963">                case ClassDescriptor.FieldType.tpArrayOfDouble: 
</div><div class="line" id="l3964">                    <span class="c">len = Bytes.unpack4(body, offs);</span></div><div class="line" id="l3965">                    <span class="c">offs += 4;</span></div><div class="line" id="l3966">                    <span class="c">if (len &lt; 0)</span></div><div class="line" id="l3967">                    {
</div><div class="line" id="l3968">                        <span class="c">val = null;</span></div><div class="line" id="l3969">                    }
</div><div class="line" id="l3970">                    else
</div><div class="line" id="l3971">                    {
</div><div class="line" id="l3972">                        <span class="c">double[] arr = new double[len];</span></div><div class="line" id="l3973">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l3974">                        {
</div><div class="line" id="l3975">                            <span class="c">arr[j] = Bytes.unpackF8(body, offs);</span></div><div class="line" id="l3976">                            <span class="c">offs += 8;</span></div><div class="line" id="l3977">                        }
</div><div class="line" id="l3978">                        <span class="c">val = arr;</span></div><div class="line" id="l3979">                    }
</div><div class="line" id="l3980">                    <span class="c">break;</span></div><div class="line" id="l3981"><br></div><div class="line" id="l3982">                case ClassDescriptor.FieldType.tpArrayOfDate: 
</div><div class="line" id="l3983">                    <span class="c">len = Bytes.unpack4(body, offs);</span></div><div class="line" id="l3984">                    <span class="c">offs += 4;</span></div><div class="line" id="l3985">                    <span class="c">if (len &lt; 0)</span></div><div class="line" id="l3986">                    {
</div><div class="line" id="l3987">                        <span class="c">val = null;</span></div><div class="line" id="l3988">                    }
</div><div class="line" id="l3989">                    else
</div><div class="line" id="l3990">                    {
</div><div class="line" id="l3991">                        <span class="c">System.DateTime[] arr = new System.DateTime[len];</span></div><div class="line" id="l3992">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l3993">                        {
</div><div class="line" id="l3994">                            <span class="c">arr[j] = Bytes.unpackDate(body, offs);</span></div><div class="line" id="l3995">                            <span class="c">offs += 8;</span></div><div class="line" id="l3996">                        }
</div><div class="line" id="l3997">                        <span class="c">val = arr;</span></div><div class="line" id="l3998">                    }
</div><div class="line" id="l3999">                    <span class="c">break;</span></div><div class="line" id="l4000"><br></div><div class="line" id="l4001">                case ClassDescriptor.FieldType.tpArrayOfString: 
</div><div class="line" id="l4002">                    <span class="c">len = Bytes.unpack4(body, offs);</span></div><div class="line" id="l4003">                    <span class="c">offs += 4;</span></div><div class="line" id="l4004">                    <span class="c">if (len &lt; 0)</span></div><div class="line" id="l4005">                    {
</div><div class="line" id="l4006">                        <span class="c">val = null;</span></div><div class="line" id="l4007">                    }
</div><div class="line" id="l4008">                    else
</div><div class="line" id="l4009">                    {
</div><div class="line" id="l4010">                        <span class="c">string[] arr = new string[len];</span></div><div class="line" id="l4011">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l4012">                        {
</div><div class="line" id="l4013">                            <span class="c">offs = Bytes.unpackString(body, offs, out arr[j], encoding);</span></div><div class="line" id="l4014">                        }
</div><div class="line" id="l4015">                        <span class="c">val = arr;</span></div><div class="line" id="l4016">                    }
</div><div class="line" id="l4017">                    <span class="c">break;</span></div><div class="line" id="l4018"><br></div><div class="line" id="l4019">                case ClassDescriptor.FieldType.tpArrayOfDecimal: 
</div><div class="line" id="l4020">                    <span class="c">len = Bytes.unpack4(body, offs);</span></div><div class="line" id="l4021">                    <span class="c">offs += 4;</span></div><div class="line" id="l4022">                    <span class="c">if (len &lt; 0)</span></div><div class="line" id="l4023">                    {
</div><div class="line" id="l4024">                        <span class="c">val = null;</span></div><div class="line" id="l4025">                    }
</div><div class="line" id="l4026">                    else
</div><div class="line" id="l4027">                    {
</div><div class="line" id="l4028">                        <span class="c">decimal[] arr = new decimal[len];</span></div><div class="line" id="l4029">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l4030">                        {
</div><div class="line" id="l4031">                            <span class="c">arr[j] = Bytes.unpackDecimal(body, offs);</span></div><div class="line" id="l4032">                            <span class="c">offs += 16;</span></div><div class="line" id="l4033">                        }
</div><div class="line" id="l4034">                        <span class="c">val = arr;</span></div><div class="line" id="l4035">                    }
</div><div class="line" id="l4036">                    <span class="c">break;</span></div><div class="line" id="l4037"><br></div><div class="line" id="l4038">                case ClassDescriptor.FieldType.tpArrayOfGuid: 
</div><div class="line" id="l4039">                    <span class="c">len = Bytes.unpack4(body, offs);</span></div><div class="line" id="l4040">                    <span class="c">offs += 4;</span></div><div class="line" id="l4041">                    <span class="c">if (len &lt; 0)</span></div><div class="line" id="l4042">                    {
</div><div class="line" id="l4043">                        <span class="c">val = null;</span></div><div class="line" id="l4044">                    }
</div><div class="line" id="l4045">                    else
</div><div class="line" id="l4046">                    {
</div><div class="line" id="l4047">                        <span class="c">Guid[] arr = new Guid[len];</span></div><div class="line" id="l4048">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l4049">                        {
</div><div class="line" id="l4050">                            <span class="c">arr[j] = Bytes.unpackGuid(body, offs);</span></div><div class="line" id="l4051">                            <span class="c">offs += 16;</span></div><div class="line" id="l4052">                        }
</div><div class="line" id="l4053">                        <span class="c">val = arr;</span></div><div class="line" id="l4054">                    }
</div><div class="line" id="l4055">                    <span class="c">break;</span></div><div class="line" id="l4056"><br></div><div class="line" id="l4057">                case ClassDescriptor.FieldType.tpArrayOfObject: 
</div><div class="line" id="l4058">                    <span class="c">len = Bytes.unpack4(body, offs);</span></div><div class="line" id="l4059">                    <span class="c">offs += 4;</span></div><div class="line" id="l4060">                    <span class="c">if (len &lt; 0)</span></div><div class="line" id="l4061">                    {
</div><div class="line" id="l4062">                        <span class="c">val = null;</span></div><div class="line" id="l4063">                    }
</div><div class="line" id="l4064">                    else
</div><div class="line" id="l4065">                    {
</div><div class="line" id="l4066">                        <span class="c">Type elemType = fd.field.FieldType.GetElementType();</span></div><div class="line" id="l4067">                        <span class="c">IPersistent[] arr = (IPersistent[])Array.CreateInstance(elemType, len);</span></div><div class="line" id="l4068">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l4069">                        {
</div><div class="line" id="l4070">                            <span class="c">arr[j] = unswizzle(Bytes.unpack4(body, offs), elemType, recursiveLoading);</span></div><div class="line" id="l4071">                            <span class="c">offs += 4;</span></div><div class="line" id="l4072">                        }
</div><div class="line" id="l4073">                        <span class="c">val = arr;</span></div><div class="line" id="l4074">                    }
</div><div class="line" id="l4075">                    <span class="c">break;</span></div><div class="line" id="l4076"><br></div><div class="line" id="l4077">                case ClassDescriptor.FieldType.tpArrayOfValue:
</div><div class="line" id="l4078">                    <span class="c">len = Bytes.unpack4(body, offs);</span></div><div class="line" id="l4079">                    <span class="c">offs += 4;</span></div><div class="line" id="l4080">                    <span class="c">if (len &lt; 0)</span></div><div class="line" id="l4081">                    { 
</div><div class="line" id="l4082">                        <span class="c">val = null;</span></div><div class="line" id="l4083">                    } 
</div><div class="line" id="l4084">                    else 
</div><div class="line" id="l4085">                    {
</div><div class="line" id="l4086">                        <span class="c">Type elemType = fd.field.FieldType.GetElementType();</span></div><div class="line" id="l4087">                        <span class="c">Array arr = Array.CreateInstance(elemType, len);</span></div><div class="line" id="l4088">                        <span class="c">ClassDescriptor valueDesc = fd.valueDesc;</span></div><div class="line" id="l4089">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l4090">                        { 
</div><div class="line" id="l4091">                            <span class="c">object elem = arr.GetValue(j);</span></div><div class="line" id="l4092">                            <span class="c">offs = unpackObject(elem, valueDesc, recursiveLoading, body, offs, po);</span></div><div class="line" id="l4093">                            <span class="c">arr.SetValue(elem, j);</span></div><div class="line" id="l4094">                        }
</div><div class="line" id="l4095">                        <span class="c">val = arr;</span></div><div class="line" id="l4096">                    }
</div><div class="line" id="l4097">                    <span class="c">break;</span></div><div class="line" id="l4098"><br></div><div class="line" id="l4099">#if SUPPORT_RAW_TYPE
</div><div class="line" id="l4100">                case ClassDescriptor.FieldType.tpArrayOfRaw:
</div><div class="line" id="l4101">                    <span class="c">len = Bytes.unpack4(body, offs);</span></div><div class="line" id="l4102">                    <span class="c">offs += 4;</span></div><div class="line" id="l4103">                    <span class="c">if (len &lt; 0)</span></div><div class="line" id="l4104">                    {
</div><div class="line" id="l4105">                        <span class="c">val = null;</span></div><div class="line" id="l4106">                    }
</div><div class="line" id="l4107">                    else 
</div><div class="line" id="l4108">                    {
</div><div class="line" id="l4109">                        <span class="c">Type elemType = fd.field.FieldType.GetElementType();</span></div><div class="line" id="l4110">                        <span class="c">Array arr = Array.CreateInstance(elemType, len);</span></div><div class="line" id="l4111">                        <span class="c">ClassDescriptor valueDesc = fd.valueDesc;</span></div><div class="line" id="l4112">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l4113">                        { 
</div><div class="line" id="l4114">                            object elem;
</div><div class="line" id="l4115">                            <span class="c">offs = unpackRawValue(body, offs, out elem, recursiveLoading);</span></div><div class="line" id="l4116">                            <span class="c">arr.SetValue(elem, j);</span></div><div class="line" id="l4117">                        }
</div><div class="line" id="l4118">                        <span class="c">val = arr;</span></div><div class="line" id="l4119">                    }
</div><div class="line" id="l4120">                    <span class="c">break;</span></div><div class="line" id="l4121">#endif                    
</div><div class="line" id="l4122">                case ClassDescriptor.FieldType.tpLink: 
</div><div class="line" id="l4123">                    <span class="c">len = Bytes.unpack4(body, offs);</span></div><div class="line" id="l4124">                    <span class="c">offs += 4;</span></div><div class="line" id="l4125">                    <span class="c">if (len &lt; 0)</span></div><div class="line" id="l4126">                    {
</div><div class="line" id="l4127">                        <span class="c">val = null;</span></div><div class="line" id="l4128">                    }
</div><div class="line" id="l4129">                    else
</div><div class="line" id="l4130">                    {
</div><div class="line" id="l4131">                        <span class="c">IPersistent[] arr = new IPersistent[len];</span></div><div class="line" id="l4132">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l4133">                        {
</div><div class="line" id="l4134">                            <span class="c">int elemOid = Bytes.unpack4(body, offs);</span></div><div class="line" id="l4135">                            <span class="c">offs += 4;</span></div><div class="line" id="l4136">                            <span class="c">if (elemOid != 0)</span></div><div class="line" id="l4137">                            {
</div><div class="line" id="l4138">                                <span class="c">arr[j] = new PersistentStub(this, elemOid);</span></div><div class="line" id="l4139">                            }
</div><div class="line" id="l4140">                        }
</div><div class="line" id="l4141">                        <span class="c">val = fd.constructor.Invoke(this, new object[]{arr, po});</span></div><div class="line" id="l4142">                    }
</div><div class="line" id="l4143">                    <span class="c">break;</span></div><div class="line" id="l4144"><br></div><div class="line" id="l4145">                case ClassDescriptor.FieldType.tpArrayOfOid: 
</div><div class="line" id="l4146">                    <span class="c">len = Bytes.unpack4(body, offs);</span></div><div class="line" id="l4147">                    <span class="c">offs += 4;</span></div><div class="line" id="l4148">                    <span class="c">if (len &lt; 0)</span></div><div class="line" id="l4149">                    {
</div><div class="line" id="l4150">                        <span class="c">val = null;</span></div><div class="line" id="l4151">                    }
</div><div class="line" id="l4152">                    else
</div><div class="line" id="l4153">                    {
</div><div class="line" id="l4154">                        <span class="c">int[] arr = new int[len];</span></div><div class="line" id="l4155">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l4156">                        {
</div><div class="line" id="l4157">                            <span class="c">arr[j] = Bytes.unpack4(body, offs);</span></div><div class="line" id="l4158">                            <span class="c">offs += 4;</span></div><div class="line" id="l4159">                        }
</div><div class="line" id="l4160">                        <span class="c">val = fd.constructor.Invoke(this, new object[]{arr, po});</span></div><div class="line" id="l4161">                    }
</div><div class="line" id="l4162">                    break;
</div><div class="line" id="l4163">            }
</div><div class="line" id="l4164">            <span class="c">return offs;</span></div><div class="line" id="l4165">        }
</div><div class="line" id="l4166"><br></div><div class="line" id="l4167">        internal byte[] packObject(IPersistent obj)
</div><div class="line" id="l4168">        {
</div><div class="line" id="l4169">            <span class="c">ByteBuffer buf = new ByteBuffer(encoding);</span></div><div class="line" id="l4170">            <span class="c">int offs = ObjectHeader.Sizeof;</span></div><div class="line" id="l4171">            <span class="c">buf.extend(offs);</span></div><div class="line" id="l4172">            <span class="c">ClassDescriptor desc = getClassDescriptor(obj.GetType());</span></div><div class="line" id="l4173">            <span class="c">if (desc.serializer != null)</span></div><div class="line" id="l4174">            { 
</div><div class="line" id="l4175">                <span class="c">offs = desc.serializer.pack(this, obj, buf);</span></div><div class="line" id="l4176">            } 
</div><div class="line" id="l4177">            else 
</div><div class="line" id="l4178">            { 
</div><div class="line" id="l4179">                <span class="c">offs = packObject(obj, desc, offs, buf, obj);</span></div><div class="line" id="l4180">            }
</div><div class="line" id="l4181">            <span class="c">ObjectHeader.setSize(buf.arr, 0, offs);</span></div><div class="line" id="l4182">            <span class="c">ObjectHeader.setType(buf.arr, 0, desc.Oid);</span></div><div class="line" id="l4183">            <span class="c">return buf.arr;</span></div><div class="line" id="l4184">        }
</div><div class="line" id="l4185"><br></div><div class="line" id="l4186">        public int packObject(object obj, ClassDescriptor desc, int offs, ByteBuffer buf, IPersistent po)
</div><div class="line" id="l4187">        { 
</div><div class="line" id="l4188">            <span class="c">ClassDescriptor.FieldDescriptor[] flds = desc.allFields;</span></div><div class="line" id="l4189"><br></div><div class="line" id="l4190">            for (<span class="c">int i = 0,</span> <span class="c">n = flds.Length;</span> <span class="c">i &lt; n</span>; <span class="c">i++</span>)</div><div class="line" id="l4191">            {
</div><div class="line" id="l4192">                <span class="c">ClassDescriptor.FieldDescriptor fd = flds[i];</span></div><div class="line" id="l4193">                <span class="c">offs = packField(buf, offs, fd.field.GetValue(obj), fd, fd.type, po);</span></div><div class="line" id="l4194">            }
</div><div class="line" id="l4195">            <span class="c">return offs;</span></div><div class="line" id="l4196">        }            
</div><div class="line" id="l4197"><br></div><div class="line" id="l4198">#if SUPPORT_RAW_TYPE
</div><div class="line" id="l4199">        public int packRawValue(ByteBuffer buf, int offs, object val)
</div><div class="line" id="l4200">        {
</div><div class="line" id="l4201">            if (val == null)
</div><div class="line" id="l4202">            {
</div><div class="line" id="l4203">                buf.extend(offs + 4);
</div><div class="line" id="l4204">                Bytes.pack4(buf.arr, offs, - 1);
</div><div class="line" id="l4205">                offs += 4;
</div><div class="line" id="l4206">            }
</div><div class="line" id="l4207">            else if (val is IPersistent) 
</div><div class="line" id="l4208">            { 
</div><div class="line" id="l4209">                buf.extend(offs + 8);
</div><div class="line" id="l4210">                Bytes.pack4(buf.arr, offs, -2-(int)ClassDescriptor.FieldType.tpObject);
</div><div class="line" id="l4211">                Bytes.pack4(buf.arr, offs+4, swizzle((IPersistent)val));
</div><div class="line" id="l4212">                offs += 8;                        
</div><div class="line" id="l4213">            } 
</div><div class="line" id="l4214">            else 
</div><div class="line" id="l4215">            {
</div><div class="line" id="l4216">                Type t = val.GetType();
</div><div class="line" id="l4217">                if (t == typeof(bool)) 
</div><div class="line" id="l4218">                {
</div><div class="line" id="l4219">                    buf.extend(offs + 5);
</div><div class="line" id="l4220">                    Bytes.pack4(buf.arr, offs, -2-(int)ClassDescriptor.FieldType.tpBoolean);
</div><div class="line" id="l4221">                    buf.arr[offs+4] = (byte)((bool)val ? 1 : 0);
</div><div class="line" id="l4222">                    offs += 5;                   
</div><div class="line" id="l4223">                } 
</div><div class="line" id="l4224">                else if (t == typeof(char)) 
</div><div class="line" id="l4225">                {
</div><div class="line" id="l4226">                    buf.extend(offs + 6);
</div><div class="line" id="l4227">                    Bytes.pack4(buf.arr, offs, -2-(int)ClassDescriptor.FieldType.tpChar);
</div><div class="line" id="l4228">                    Bytes.pack2(buf.arr, offs+4, (short)(char)val);
</div><div class="line" id="l4229">                    offs += 6;                         
</div><div class="line" id="l4230">                } 
</div><div class="line" id="l4231">                else if (t == typeof(byte)) 
</div><div class="line" id="l4232">                { 
</div><div class="line" id="l4233">                    buf.extend(offs + 5);
</div><div class="line" id="l4234">                    Bytes.pack4(buf.arr, offs, -2-(int)ClassDescriptor.FieldType.tpByte);
</div><div class="line" id="l4235">                    buf.arr[offs+4] = (byte)val;
</div><div class="line" id="l4236">                    offs += 5; 
</div><div class="line" id="l4237">                } 
</div><div class="line" id="l4238">                else if (t == typeof(sbyte)) 
</div><div class="line" id="l4239">                { 
</div><div class="line" id="l4240">                    buf.extend(offs + 5);
</div><div class="line" id="l4241">                    Bytes.pack4(buf.arr, offs, -2-(int)ClassDescriptor.FieldType.tpSByte);
</div><div class="line" id="l4242">                    buf.arr[offs+4] = (byte)(sbyte)val;
</div><div class="line" id="l4243">                    offs += 5; 
</div><div class="line" id="l4244">                } 
</div><div class="line" id="l4245">                else if (t == typeof(short)) 
</div><div class="line" id="l4246">                {
</div><div class="line" id="l4247">                    buf.extend(offs + 6);
</div><div class="line" id="l4248">                    Bytes.pack4(buf.arr, offs, -2-(int)ClassDescriptor.FieldType.tpShort);
</div><div class="line" id="l4249">                    Bytes.pack2(buf.arr, offs+4, (short)val);
</div><div class="line" id="l4250">                    offs += 6;                                                   
</div><div class="line" id="l4251">                } 
</div><div class="line" id="l4252">                else if (t == typeof(ushort)) 
</div><div class="line" id="l4253">                {
</div><div class="line" id="l4254">                    buf.extend(offs + 6);
</div><div class="line" id="l4255">                    Bytes.pack4(buf.arr, offs, -2-(int)ClassDescriptor.FieldType.tpUShort);
</div><div class="line" id="l4256">                    Bytes.pack2(buf.arr, offs+4, (short)(ushort)val);
</div><div class="line" id="l4257">                    offs += 6; 
</div><div class="line" id="l4258">                } 
</div><div class="line" id="l4259">                else if (t == typeof(int)) 
</div><div class="line" id="l4260">                {
</div><div class="line" id="l4261">                    buf.extend(offs + 8);
</div><div class="line" id="l4262">                    Bytes.pack4(buf.arr, offs, -2-(int)ClassDescriptor.FieldType.tpInt);
</div><div class="line" id="l4263">                    Bytes.pack4(buf.arr, offs+4, (int)val);
</div><div class="line" id="l4264">                    offs += 8;                       
</div><div class="line" id="l4265">                } 
</div><div class="line" id="l4266">                else if (t == typeof(uint)) 
</div><div class="line" id="l4267">                {
</div><div class="line" id="l4268">                    buf.extend(offs + 8);
</div><div class="line" id="l4269">                    Bytes.pack4(buf.arr, offs, -2-(int)ClassDescriptor.FieldType.tpUInt);
</div><div class="line" id="l4270">                    Bytes.pack4(buf.arr, offs+4, (int)(uint)val);
</div><div class="line" id="l4271">                    offs += 8;                       
</div><div class="line" id="l4272">                } 
</div><div class="line" id="l4273">                else if (t == typeof(long)) 
</div><div class="line" id="l4274">                {
</div><div class="line" id="l4275">                    buf.extend(offs + 12);
</div><div class="line" id="l4276">                    Bytes.pack4(buf.arr, offs, -2-(int)ClassDescriptor.FieldType.tpLong);
</div><div class="line" id="l4277">                    Bytes.pack8(buf.arr, offs+4, (long)val);
</div><div class="line" id="l4278">                    offs += 12; 
</div><div class="line" id="l4279">                } 
</div><div class="line" id="l4280">                else if (t == typeof(ulong)) 
</div><div class="line" id="l4281">                {   
</div><div class="line" id="l4282">                    buf.extend(offs + 12);
</div><div class="line" id="l4283">                    Bytes.pack4(buf.arr, offs, -2-(int)ClassDescriptor.FieldType.tpULong);
</div><div class="line" id="l4284">                    Bytes.pack8(buf.arr, offs+4, (long)(ulong)val);
</div><div class="line" id="l4285">                    offs += 12; 
</div><div class="line" id="l4286">                } 
</div><div class="line" id="l4287">                else if (t == typeof(float)) 
</div><div class="line" id="l4288">                {
</div><div class="line" id="l4289">                    buf.extend(offs + 8);
</div><div class="line" id="l4290">                    Bytes.pack4(buf.arr, offs, -2-(int)ClassDescriptor.FieldType.tpFloat);
</div><div class="line" id="l4291">                    Bytes.packF4(buf.arr, offs+4, (float)val);
</div><div class="line" id="l4292">                    offs += 8;                              
</div><div class="line" id="l4293">                } 
</div><div class="line" id="l4294">                else if (t == typeof(double)) 
</div><div class="line" id="l4295">                {
</div><div class="line" id="l4296">                    buf.extend(offs + 12);
</div><div class="line" id="l4297">                    Bytes.pack4(buf.arr, offs, -2-(int)ClassDescriptor.FieldType.tpDouble);
</div><div class="line" id="l4298">                    Bytes.packF8(buf.arr, offs+4, (double)val);
</div><div class="line" id="l4299">                    offs += 12;
</div><div class="line" id="l4300">                } 
</div><div class="line" id="l4301">                else if (t == typeof(DateTime)) 
</div><div class="line" id="l4302">                {
</div><div class="line" id="l4303">                    buf.extend(offs + 12);
</div><div class="line" id="l4304">                    Bytes.pack4(buf.arr, offs, -2-(int)ClassDescriptor.FieldType.tpDate);
</div><div class="line" id="l4305">                    Bytes.packDate(buf.arr, offs+4, (DateTime)val);
</div><div class="line" id="l4306">                    offs += 12;                                                   
</div><div class="line" id="l4307">                } 
</div><div class="line" id="l4308">                else if (t == typeof(Guid)) 
</div><div class="line" id="l4309">                {
</div><div class="line" id="l4310">                    buf.extend(offs + 12);
</div><div class="line" id="l4311">                    Bytes.pack4(buf.arr, offs, -2-(int)ClassDescriptor.FieldType.tpGuid);
</div><div class="line" id="l4312">                    Bytes.packGuid(buf.arr, offs+4, (Guid)val);
</div><div class="line" id="l4313">                    offs += 12;                                                   
</div><div class="line" id="l4314">                } 
</div><div class="line" id="l4315">                else if (t == typeof(Decimal)) 
</div><div class="line" id="l4316">                {
</div><div class="line" id="l4317">                    buf.extend(offs + 12);
</div><div class="line" id="l4318">                    Bytes.pack4(buf.arr, offs, -2-(int)ClassDescriptor.FieldType.tpDecimal);
</div><div class="line" id="l4319">                    Bytes.packDecimal(buf.arr, offs+4, (decimal)val);
</div><div class="line" id="l4320">                    offs += 12;                                                   
</div><div class="line" id="l4321">                } 
</div><div class="line" id="l4322">                else 
</div><div class="line" id="l4323">                {
</div><div class="line" id="l4324">                    System.IO.MemoryStream ms = new System.IO.MemoryStream();
</div><div class="line" id="l4325">                    objectFormatter.Serialize(ms, val);
</div><div class="line" id="l4326">                    ms.Close();
</div><div class="line" id="l4327">                    byte[] arr = ms.ToArray();
</div><div class="line" id="l4328">                    int len = arr.Length;
</div><div class="line" id="l4329">                    buf.extend(offs + 4 + len);
</div><div class="line" id="l4330">                    Bytes.pack4(buf.arr, offs, len);
</div><div class="line" id="l4331">                    offs += 4;
</div><div class="line" id="l4332">                    Array.Copy(arr, 0, buf.arr, offs, len);
</div><div class="line" id="l4333">                    offs += len;
</div><div class="line" id="l4334">                }
</div><div class="line" id="l4335">            }
</div><div class="line" id="l4336">            return offs;
</div><div class="line" id="l4337">        }
</div><div class="line" id="l4338">#endif
</div><div class="line" id="l4339"><br></div><div class="line" id="l4340">        public int packField(ByteBuffer buf, int offs, object val, ClassDescriptor.FieldDescriptor fd, ClassDescriptor.FieldType type, IPersistent po)
</div><div class="line" id="l4341">        {
</div><div class="line" id="l4342">            <span class="c">switch (type)</span></div><div class="line" id="l4343">            {
</div><div class="line" id="l4344">                case ClassDescriptor.FieldType.tpByte: 
</div><div class="line" id="l4345">                    <span class="c">return buf.packI1(offs, (byte)val);</span></div><div class="line" id="l4346">                case ClassDescriptor.FieldType.tpSByte: 
</div><div class="line" id="l4347">                    <span class="c">return buf.packI1(offs, (sbyte)val);</span></div><div class="line" id="l4348">                case ClassDescriptor.FieldType.tpBoolean: 
</div><div class="line" id="l4349">                    <span class="c">return buf.packBool(offs, (bool)val);</span></div><div class="line" id="l4350">                case ClassDescriptor.FieldType.tpShort: 
</div><div class="line" id="l4351">                    <span class="c">return buf.packI2(offs, (short)val);</span></div><div class="line" id="l4352">                case ClassDescriptor.FieldType.tpUShort: 
</div><div class="line" id="l4353">                    <span class="c">return buf.packI2(offs, (ushort)val);</span></div><div class="line" id="l4354">                case ClassDescriptor.FieldType.tpChar: 
</div><div class="line" id="l4355">                    <span class="c">return buf.packI2(offs, (char)val);</span></div><div class="line" id="l4356">                case ClassDescriptor.FieldType.tpEnum: 
</div><div class="line" id="l4357">                case ClassDescriptor.FieldType.tpInt: 
</div><div class="line" id="l4358">                case ClassDescriptor.FieldType.tpOid: 
</div><div class="line" id="l4359">                    <span class="c">return buf.packI4(offs, (int)val);</span></div><div class="line" id="l4360">                case ClassDescriptor.FieldType.tpUInt: 
</div><div class="line" id="l4361">                    <span class="c">return buf.packI4(offs, (int)(uint)val);</span></div><div class="line" id="l4362">                case ClassDescriptor.FieldType.tpLong: 
</div><div class="line" id="l4363">                    <span class="c">return buf.packI8(offs, (long)val);</span></div><div class="line" id="l4364">                case ClassDescriptor.FieldType.tpULong: 
</div><div class="line" id="l4365">                    <span class="c">return buf.packI8(offs, (long)(ulong)val);</span></div><div class="line" id="l4366">                case ClassDescriptor.FieldType.tpFloat: 
</div><div class="line" id="l4367">                    <span class="c">return buf.packF4(offs, (float)val);</span></div><div class="line" id="l4368">                case ClassDescriptor.FieldType.tpDouble: 
</div><div class="line" id="l4369">                    <span class="c">return buf.packF8(offs, (double)val);</span></div><div class="line" id="l4370">                case ClassDescriptor.FieldType.tpDecimal:
</div><div class="line" id="l4371">                    <span class="c">return buf.packDecimal(offs, (decimal)val);</span></div><div class="line" id="l4372">                case ClassDescriptor.FieldType.tpGuid:
</div><div class="line" id="l4373">                    <span class="c">return buf.packGuid(offs, (Guid)val);</span></div><div class="line" id="l4374">                case ClassDescriptor.FieldType.tpDate: 
</div><div class="line" id="l4375">                    <span class="c">return buf.packDate(offs, (DateTime)val);</span></div><div class="line" id="l4376">                case ClassDescriptor.FieldType.tpString: 
</div><div class="line" id="l4377">                    <span class="c">return buf.packString(offs, (string)val);</span></div><div class="line" id="l4378">                case ClassDescriptor.FieldType.tpValue:
</div><div class="line" id="l4379">                    <span class="c">return packObject(val, fd.valueDesc, offs, buf, po);</span></div><div class="line" id="l4380">                case ClassDescriptor.FieldType.tpObject: 
</div><div class="line" id="l4381">                    <span class="c">return buf.packI4(offs, swizzle((IPersistent)val));</span></div><div class="line" id="l4382"><br></div><div class="line" id="l4383">#if SUPPORT_RAW_TYPE
</div><div class="line" id="l4384">                case ClassDescriptor.FieldType.tpRaw:
</div><div class="line" id="l4385">                    <span class="c">offs = packRawValue(buf, offs, val);</span></div><div class="line" id="l4386">                    <span class="c">break;</span></div><div class="line" id="l4387">#endif
</div><div class="line" id="l4388">                case ClassDescriptor.FieldType.tpArrayOfByte: 
</div><div class="line" id="l4389">                    <span class="c">if (val == null)</span></div><div class="line" id="l4390">                    {
</div><div class="line" id="l4391">                        <span class="c">buf.extend(offs + 4);</span></div><div class="line" id="l4392">                        <span class="c">Bytes.pack4(buf.arr, offs, - 1);</span></div><div class="line" id="l4393">                        <span class="c">offs += 4;</span></div><div class="line" id="l4394">                    }
</div><div class="line" id="l4395">                    else
</div><div class="line" id="l4396">                    {
</div><div class="line" id="l4397">                        <span class="c">byte[] arr = (byte[])val;</span></div><div class="line" id="l4398">                        <span class="c">int len = arr.Length;</span></div><div class="line" id="l4399">                        <span class="c">buf.extend(offs + 4 + len);</span></div><div class="line" id="l4400">                        <span class="c">Bytes.pack4(buf.arr, offs, len);</span></div><div class="line" id="l4401">                        <span class="c">offs += 4;</span></div><div class="line" id="l4402">                        <span class="c">Array.Copy(arr, 0, buf.arr, offs, len);</span></div><div class="line" id="l4403">                        <span class="c">offs += len;</span></div><div class="line" id="l4404">                    }
</div><div class="line" id="l4405">                    <span class="c">break;</span></div><div class="line" id="l4406"><br></div><div class="line" id="l4407">                case ClassDescriptor.FieldType.tpArrayOfSByte: 
</div><div class="line" id="l4408">                    <span class="c">if (val == null)</span></div><div class="line" id="l4409">                    {
</div><div class="line" id="l4410">                        <span class="c">buf.extend(offs + 4);</span></div><div class="line" id="l4411">                        <span class="c">Bytes.pack4(buf.arr, offs, - 1);</span></div><div class="line" id="l4412">                        <span class="c">offs += 4;</span></div><div class="line" id="l4413">                    }
</div><div class="line" id="l4414">                    else
</div><div class="line" id="l4415">                    {
</div><div class="line" id="l4416">                        <span class="c">sbyte[] arr = (sbyte[])val;</span></div><div class="line" id="l4417">                        <span class="c">int len = arr.Length;</span></div><div class="line" id="l4418">                        <span class="c">buf.extend(offs + 4 + len);</span></div><div class="line" id="l4419">                        <span class="c">Bytes.pack4(buf.arr, offs, len);</span></div><div class="line" id="l4420">                        <span class="c">offs += 4;</span></div><div class="line" id="l4421">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++, offs++</span>)</div><div class="line" id="l4422">                        {
</div><div class="line" id="l4423">                            <span class="c">buf.arr[offs] = (byte)arr[j];</span></div><div class="line" id="l4424">                        }
</div><div class="line" id="l4425">                        <span class="c">offs += len;</span></div><div class="line" id="l4426">                    }
</div><div class="line" id="l4427">                    <span class="c">break;</span></div><div class="line" id="l4428"><br></div><div class="line" id="l4429">                case ClassDescriptor.FieldType.tpArrayOfBoolean: 
</div><div class="line" id="l4430">                    <span class="c">if (val == null)</span></div><div class="line" id="l4431">                    {
</div><div class="line" id="l4432">                        <span class="c">buf.extend(offs + 4);</span></div><div class="line" id="l4433">                        <span class="c">Bytes.pack4(buf.arr, offs, - 1);</span></div><div class="line" id="l4434">                        <span class="c">offs += 4;</span></div><div class="line" id="l4435">                    }
</div><div class="line" id="l4436">                    else
</div><div class="line" id="l4437">                    {
</div><div class="line" id="l4438">                        <span class="c">bool[] arr = (bool[])val;</span></div><div class="line" id="l4439">                        <span class="c">int len = arr.Length;</span></div><div class="line" id="l4440">                        <span class="c">buf.extend(offs + 4 + len);</span></div><div class="line" id="l4441">                        <span class="c">Bytes.pack4(buf.arr, offs, len);</span></div><div class="line" id="l4442">                        <span class="c">offs += 4;</span></div><div class="line" id="l4443">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++, offs++</span>)</div><div class="line" id="l4444">                        {
</div><div class="line" id="l4445">                            <span class="c">buf.arr[offs] = (byte) (arr[j]?1:0);</span></div><div class="line" id="l4446">                        }
</div><div class="line" id="l4447">                    }
</div><div class="line" id="l4448">                    <span class="c">break;</span></div><div class="line" id="l4449"><br></div><div class="line" id="l4450">                case ClassDescriptor.FieldType.tpArrayOfShort: 
</div><div class="line" id="l4451">                    <span class="c">if (val == null)</span></div><div class="line" id="l4452">                    {
</div><div class="line" id="l4453">                        <span class="c">buf.extend(offs + 4);</span></div><div class="line" id="l4454">                        <span class="c">Bytes.pack4(buf.arr, offs, - 1);</span></div><div class="line" id="l4455">                        <span class="c">offs += 4;</span></div><div class="line" id="l4456">                    }
</div><div class="line" id="l4457">                    else
</div><div class="line" id="l4458">                    {
</div><div class="line" id="l4459">                        <span class="c">short[] arr = (short[])val;</span></div><div class="line" id="l4460">                        <span class="c">int len = arr.Length;</span></div><div class="line" id="l4461">                        <span class="c">buf.extend(offs + 4 + len * 2);</span></div><div class="line" id="l4462">                        <span class="c">Bytes.pack4(buf.arr, offs, len);</span></div><div class="line" id="l4463">                        <span class="c">offs += 4;</span></div><div class="line" id="l4464">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l4465">                        {
</div><div class="line" id="l4466">                            <span class="c">Bytes.pack2(buf.arr, offs, arr[j]);</span></div><div class="line" id="l4467">                            <span class="c">offs += 2;</span></div><div class="line" id="l4468">                        }
</div><div class="line" id="l4469">                    }
</div><div class="line" id="l4470">                    <span class="c">break;</span></div><div class="line" id="l4471"><br></div><div class="line" id="l4472">                case ClassDescriptor.FieldType.tpArrayOfUShort: 
</div><div class="line" id="l4473">                    <span class="c">if (val == null)</span></div><div class="line" id="l4474">                    {
</div><div class="line" id="l4475">                        <span class="c">buf.extend(offs + 4);</span></div><div class="line" id="l4476">                        <span class="c">Bytes.pack4(buf.arr, offs, - 1);</span></div><div class="line" id="l4477">                        <span class="c">offs += 4;</span></div><div class="line" id="l4478">                    }
</div><div class="line" id="l4479">                    else
</div><div class="line" id="l4480">                    {
</div><div class="line" id="l4481">                        <span class="c">ushort[] arr = (ushort[])val;</span></div><div class="line" id="l4482">                        <span class="c">int len = arr.Length;</span></div><div class="line" id="l4483">                        <span class="c">buf.extend(offs + 4 + len * 2);</span></div><div class="line" id="l4484">                        <span class="c">Bytes.pack4(buf.arr, offs, len);</span></div><div class="line" id="l4485">                        <span class="c">offs += 4;</span></div><div class="line" id="l4486">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l4487">                        {
</div><div class="line" id="l4488">                            <span class="c">Bytes.pack2(buf.arr, offs, (short)arr[j]);</span></div><div class="line" id="l4489">                            <span class="c">offs += 2;</span></div><div class="line" id="l4490">                        }
</div><div class="line" id="l4491">                    }
</div><div class="line" id="l4492">                    <span class="c">break;</span></div><div class="line" id="l4493"><br></div><div class="line" id="l4494">                case ClassDescriptor.FieldType.tpArrayOfChar: 
</div><div class="line" id="l4495">                    <span class="c">if (val == null)</span></div><div class="line" id="l4496">                    {
</div><div class="line" id="l4497">                        <span class="c">buf.extend(offs + 4);</span></div><div class="line" id="l4498">                        <span class="c">Bytes.pack4(buf.arr, offs, - 1);</span></div><div class="line" id="l4499">                        <span class="c">offs += 4;</span></div><div class="line" id="l4500">                    }
</div><div class="line" id="l4501">                    else
</div><div class="line" id="l4502">                    {
</div><div class="line" id="l4503">                        <span class="c">char[] arr = (char[])val;</span></div><div class="line" id="l4504">                        <span class="c">int len = arr.Length;</span></div><div class="line" id="l4505">                        <span class="c">buf.extend(offs + 4 + len * 2);</span></div><div class="line" id="l4506">                        <span class="c">Bytes.pack4(buf.arr, offs, len);</span></div><div class="line" id="l4507">                        <span class="c">offs += 4;</span></div><div class="line" id="l4508">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l4509">                        {
</div><div class="line" id="l4510">                            <span class="c">Bytes.pack2(buf.arr, offs, (short) arr[j]);</span></div><div class="line" id="l4511">                            <span class="c">offs += 2;</span></div><div class="line" id="l4512">                        }
</div><div class="line" id="l4513">                    }
</div><div class="line" id="l4514">                    <span class="c">break;</span></div><div class="line" id="l4515"><br></div><div class="line" id="l4516">                case ClassDescriptor.FieldType.tpArrayOfEnum: 
</div><div class="line" id="l4517">                    <span class="c">if (val == null)</span></div><div class="line" id="l4518">                    {
</div><div class="line" id="l4519">                        <span class="c">buf.extend(offs + 4);</span></div><div class="line" id="l4520">                        <span class="c">Bytes.pack4(buf.arr, offs, - 1);</span></div><div class="line" id="l4521">                        <span class="c">offs += 4;</span></div><div class="line" id="l4522">                    }
</div><div class="line" id="l4523">                    else
</div><div class="line" id="l4524">                    {
</div><div class="line" id="l4525">                        <span class="c">Array arr = (Array)val;</span></div><div class="line" id="l4526">                        <span class="c">int len = arr.Length;</span></div><div class="line" id="l4527">                        <span class="c">buf.extend(offs + 4 + len * 4);</span></div><div class="line" id="l4528">                        <span class="c">Bytes.pack4(buf.arr, offs, len);</span></div><div class="line" id="l4529">                        <span class="c">offs += 4;</span></div><div class="line" id="l4530">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l4531">                        {
</div><div class="line" id="l4532">                            <span class="c">Bytes.pack4(buf.arr, offs, (int)arr.GetValue(j));</span></div><div class="line" id="l4533">                            <span class="c">offs += 4;</span></div><div class="line" id="l4534">                        }
</div><div class="line" id="l4535">                    }
</div><div class="line" id="l4536">                    <span class="c">break;</span></div><div class="line" id="l4537"><br></div><div class="line" id="l4538">                case ClassDescriptor.FieldType.tpArrayOfInt: 
</div><div class="line" id="l4539">                    <span class="c">if (val == null)</span></div><div class="line" id="l4540">                    {
</div><div class="line" id="l4541">                        <span class="c">buf.extend(offs + 4);</span></div><div class="line" id="l4542">                        <span class="c">Bytes.pack4(buf.arr, offs, - 1);</span></div><div class="line" id="l4543">                        <span class="c">offs += 4;</span></div><div class="line" id="l4544">                    }
</div><div class="line" id="l4545">                    else
</div><div class="line" id="l4546">                    {
</div><div class="line" id="l4547">                        <span class="c">int[] arr = (int[])val;</span></div><div class="line" id="l4548">                        <span class="c">int len = arr.Length;</span></div><div class="line" id="l4549">                        <span class="c">buf.extend(offs + 4 + len * 4);</span></div><div class="line" id="l4550">                        <span class="c">Bytes.pack4(buf.arr, offs, len);</span></div><div class="line" id="l4551">                        <span class="c">offs += 4;</span></div><div class="line" id="l4552">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l4553">                        {
</div><div class="line" id="l4554">                            <span class="c">Bytes.pack4(buf.arr, offs, arr[j]);</span></div><div class="line" id="l4555">                            <span class="c">offs += 4;</span></div><div class="line" id="l4556">                        }
</div><div class="line" id="l4557">                    }
</div><div class="line" id="l4558">                    <span class="c">break;</span></div><div class="line" id="l4559"><br></div><div class="line" id="l4560">                case ClassDescriptor.FieldType.tpArrayOfUInt: 
</div><div class="line" id="l4561">                    <span class="c">if (val == null)</span></div><div class="line" id="l4562">                    {
</div><div class="line" id="l4563">                        <span class="c">buf.extend(offs + 4);</span></div><div class="line" id="l4564">                        <span class="c">Bytes.pack4(buf.arr, offs, - 1);</span></div><div class="line" id="l4565">                        <span class="c">offs += 4;</span></div><div class="line" id="l4566">                    }
</div><div class="line" id="l4567">                    else
</div><div class="line" id="l4568">                    {
</div><div class="line" id="l4569">                        <span class="c">uint[] arr = (uint[])val;</span></div><div class="line" id="l4570">                        <span class="c">int len = arr.Length;</span></div><div class="line" id="l4571">                        <span class="c">buf.extend(offs + 4 + len * 4);</span></div><div class="line" id="l4572">                        <span class="c">Bytes.pack4(buf.arr, offs, len);</span></div><div class="line" id="l4573">                        <span class="c">offs += 4;</span></div><div class="line" id="l4574">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l4575">                        {
</div><div class="line" id="l4576">                            <span class="c">Bytes.pack4(buf.arr, offs, (int)arr[j]);</span></div><div class="line" id="l4577">                            <span class="c">offs += 4;</span></div><div class="line" id="l4578">                        }
</div><div class="line" id="l4579">                    }
</div><div class="line" id="l4580">                    <span class="c">break;</span></div><div class="line" id="l4581"><br></div><div class="line" id="l4582">                case ClassDescriptor.FieldType.tpArrayOfLong: 
</div><div class="line" id="l4583">                    <span class="c">if (val == null)</span></div><div class="line" id="l4584">                    {
</div><div class="line" id="l4585">                        <span class="c">buf.extend(offs + 4);</span></div><div class="line" id="l4586">                        <span class="c">Bytes.pack4(buf.arr, offs, - 1);</span></div><div class="line" id="l4587">                        <span class="c">offs += 4;</span></div><div class="line" id="l4588">                    }
</div><div class="line" id="l4589">                    else
</div><div class="line" id="l4590">                    {
</div><div class="line" id="l4591">                        <span class="c">long[] arr = (long[])val;</span></div><div class="line" id="l4592">                        <span class="c">int len = arr.Length;</span></div><div class="line" id="l4593">                        <span class="c">buf.extend(offs + 4 + len * 8);</span></div><div class="line" id="l4594">                        <span class="c">Bytes.pack4(buf.arr, offs, len);</span></div><div class="line" id="l4595">                        <span class="c">offs += 4;</span></div><div class="line" id="l4596">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l4597">                        {
</div><div class="line" id="l4598">                            <span class="c">Bytes.pack8(buf.arr, offs, arr[j]);</span></div><div class="line" id="l4599">                            <span class="c">offs += 8;</span></div><div class="line" id="l4600">                        }
</div><div class="line" id="l4601">                    }
</div><div class="line" id="l4602">                    <span class="c">break;</span></div><div class="line" id="l4603"><br></div><div class="line" id="l4604">                case ClassDescriptor.FieldType.tpArrayOfULong: 
</div><div class="line" id="l4605">                    <span class="c">if (val == null)</span></div><div class="line" id="l4606">                    {
</div><div class="line" id="l4607">                        <span class="c">buf.extend(offs + 4);</span></div><div class="line" id="l4608">                        <span class="c">Bytes.pack4(buf.arr, offs, - 1);</span></div><div class="line" id="l4609">                        <span class="c">offs += 4;</span></div><div class="line" id="l4610">                    }
</div><div class="line" id="l4611">                    else
</div><div class="line" id="l4612">                    {
</div><div class="line" id="l4613">                        <span class="c">ulong[] arr = (ulong[])val;</span></div><div class="line" id="l4614">                        <span class="c">int len = arr.Length;</span></div><div class="line" id="l4615">                        <span class="c">buf.extend(offs + 4 + len * 8);</span></div><div class="line" id="l4616">                        <span class="c">Bytes.pack4(buf.arr, offs, len);</span></div><div class="line" id="l4617">                        <span class="c">offs += 4;</span></div><div class="line" id="l4618">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l4619">                        {
</div><div class="line" id="l4620">                            <span class="c">Bytes.pack8(buf.arr, offs, (long)arr[j]);</span></div><div class="line" id="l4621">                            <span class="c">offs += 8;</span></div><div class="line" id="l4622">                        }
</div><div class="line" id="l4623">                    }
</div><div class="line" id="l4624">                    <span class="c">break;</span></div><div class="line" id="l4625"><br></div><div class="line" id="l4626">                case ClassDescriptor.FieldType.tpArrayOfFloat: 
</div><div class="line" id="l4627">                    <span class="c">if (val == null)</span></div><div class="line" id="l4628">                    {
</div><div class="line" id="l4629">                        <span class="c">buf.extend(offs + 4);</span></div><div class="line" id="l4630">                        <span class="c">Bytes.pack4(buf.arr, offs, - 1);</span></div><div class="line" id="l4631">                        <span class="c">offs += 4;</span></div><div class="line" id="l4632">                    }
</div><div class="line" id="l4633">                    else
</div><div class="line" id="l4634">                    {
</div><div class="line" id="l4635">                        <span class="c">float[] arr = (float[])val;</span></div><div class="line" id="l4636">                        <span class="c">int len = arr.Length;</span></div><div class="line" id="l4637">                        <span class="c">buf.extend(offs + 4 + len * 4);</span></div><div class="line" id="l4638">                        <span class="c">Bytes.pack4(buf.arr, offs, len);</span></div><div class="line" id="l4639">                        <span class="c">offs += 4;</span></div><div class="line" id="l4640">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l4641">                        {
</div><div class="line" id="l4642">                            <span class="c">Bytes.packF4(buf.arr, offs, arr[j]);</span></div><div class="line" id="l4643">                            <span class="c">offs += 4;</span></div><div class="line" id="l4644">                        }
</div><div class="line" id="l4645">                    }
</div><div class="line" id="l4646">                    <span class="c">break;</span></div><div class="line" id="l4647"><br></div><div class="line" id="l4648">                case ClassDescriptor.FieldType.tpArrayOfDouble: 
</div><div class="line" id="l4649">                    <span class="c">if (val == null)</span></div><div class="line" id="l4650">                    {
</div><div class="line" id="l4651">                        <span class="c">buf.extend(offs + 4);</span></div><div class="line" id="l4652">                        <span class="c">Bytes.pack4(buf.arr, offs, - 1);</span></div><div class="line" id="l4653">                        <span class="c">offs += 4;</span></div><div class="line" id="l4654">                    }
</div><div class="line" id="l4655">                    else
</div><div class="line" id="l4656">                    {
</div><div class="line" id="l4657">                        <span class="c">double[] arr = (double[])val;</span></div><div class="line" id="l4658">                        <span class="c">int len = arr.Length;</span></div><div class="line" id="l4659">                        <span class="c">buf.extend(offs + 4 + len * 8);</span></div><div class="line" id="l4660">                        <span class="c">Bytes.pack4(buf.arr, offs, len);</span></div><div class="line" id="l4661">                        <span class="c">offs += 4;</span></div><div class="line" id="l4662">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l4663">                        {
</div><div class="line" id="l4664">                            <span class="c">Bytes.packF8(buf.arr, offs, arr[j]);</span></div><div class="line" id="l4665">                            <span class="c">offs += 8;</span></div><div class="line" id="l4666">                        }
</div><div class="line" id="l4667">                    }
</div><div class="line" id="l4668">                    <span class="c">break;</span></div><div class="line" id="l4669"><br></div><div class="line" id="l4670">                case ClassDescriptor.FieldType.tpArrayOfValue: 
</div><div class="line" id="l4671">                    <span class="c">if (val == null)</span></div><div class="line" id="l4672">                    {
</div><div class="line" id="l4673">                        <span class="c">buf.extend(offs + 4);</span></div><div class="line" id="l4674">                        <span class="c">Bytes.pack4(buf.arr, offs, - 1);</span></div><div class="line" id="l4675">                        <span class="c">offs += 4;</span></div><div class="line" id="l4676">                    }
</div><div class="line" id="l4677">                    else
</div><div class="line" id="l4678">                    {
</div><div class="line" id="l4679">                        <span class="c">Array arr = (Array)val;</span></div><div class="line" id="l4680">                        <span class="c">int len = arr.Length;</span></div><div class="line" id="l4681">                        <span class="c">buf.extend(offs + 4);</span></div><div class="line" id="l4682">                        <span class="c">Bytes.pack4(buf.arr, offs, len);</span></div><div class="line" id="l4683">                        <span class="c">offs += 4;</span></div><div class="line" id="l4684">                        <span class="c">ClassDescriptor elemDesc = fd.valueDesc;</span></div><div class="line" id="l4685">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l4686">                        {
</div><div class="line" id="l4687">                            <span class="c">offs = packObject(arr.GetValue(j), elemDesc, offs, buf, po);</span></div><div class="line" id="l4688">                        }
</div><div class="line" id="l4689">                    }
</div><div class="line" id="l4690">                    <span class="c">break;</span></div><div class="line" id="l4691"><br></div><div class="line" id="l4692">                case ClassDescriptor.FieldType.tpArrayOfDate: 
</div><div class="line" id="l4693">                    <span class="c">if (val == null)</span></div><div class="line" id="l4694">                    {
</div><div class="line" id="l4695">                        <span class="c">buf.extend(offs + 4);</span></div><div class="line" id="l4696">                        <span class="c">Bytes.pack4(buf.arr, offs, - 1);</span></div><div class="line" id="l4697">                        <span class="c">offs += 4;</span></div><div class="line" id="l4698">                    }
</div><div class="line" id="l4699">                    else
</div><div class="line" id="l4700">                    {
</div><div class="line" id="l4701">                        <span class="c">DateTime[] arr = (DateTime[])val;</span></div><div class="line" id="l4702">                        <span class="c">int len = arr.Length;</span></div><div class="line" id="l4703">                        <span class="c">buf.extend(offs + 4 + len * 8);</span></div><div class="line" id="l4704">                        <span class="c">Bytes.pack4(buf.arr, offs, len);</span></div><div class="line" id="l4705">                        <span class="c">offs += 4;</span></div><div class="line" id="l4706">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l4707">                        {
</div><div class="line" id="l4708">                            <span class="c">Bytes.packDate(buf.arr, offs, arr[j]);</span></div><div class="line" id="l4709">                            <span class="c">offs += 8;</span></div><div class="line" id="l4710">                        }
</div><div class="line" id="l4711">                    }
</div><div class="line" id="l4712">                    <span class="c">break;</span></div><div class="line" id="l4713"><br></div><div class="line" id="l4714">                case ClassDescriptor.FieldType.tpArrayOfDecimal: 
</div><div class="line" id="l4715">                    <span class="c">if (val == null)</span></div><div class="line" id="l4716">                    {
</div><div class="line" id="l4717">                        <span class="c">buf.extend(offs + 4);</span></div><div class="line" id="l4718">                        <span class="c">Bytes.pack4(buf.arr, offs, - 1);</span></div><div class="line" id="l4719">                        <span class="c">offs += 4;</span></div><div class="line" id="l4720">                    }
</div><div class="line" id="l4721">                    else
</div><div class="line" id="l4722">                    {
</div><div class="line" id="l4723">                        <span class="c">decimal[] arr = (decimal[])val;</span></div><div class="line" id="l4724">                        <span class="c">int len = arr.Length;</span></div><div class="line" id="l4725">                        <span class="c">buf.extend(offs + 4 + len * 16);</span></div><div class="line" id="l4726">                        <span class="c">Bytes.pack4(buf.arr, offs, len);</span></div><div class="line" id="l4727">                        <span class="c">offs += 4;</span></div><div class="line" id="l4728">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l4729">                        {
</div><div class="line" id="l4730">                            <span class="c">Bytes.packDecimal(buf.arr, offs, arr[j]);</span></div><div class="line" id="l4731">                            <span class="c">offs += 16;</span></div><div class="line" id="l4732">                        }
</div><div class="line" id="l4733">                    }
</div><div class="line" id="l4734">                    <span class="c">break;</span></div><div class="line" id="l4735"><br></div><div class="line" id="l4736">                case ClassDescriptor.FieldType.tpArrayOfGuid: 
</div><div class="line" id="l4737">                    <span class="c">if (val == null)</span></div><div class="line" id="l4738">                    {
</div><div class="line" id="l4739">                        <span class="c">buf.extend(offs + 4);</span></div><div class="line" id="l4740">                        <span class="c">Bytes.pack4(buf.arr, offs, - 1);</span></div><div class="line" id="l4741">                        <span class="c">offs += 4;</span></div><div class="line" id="l4742">                    }
</div><div class="line" id="l4743">                    else
</div><div class="line" id="l4744">                    {
</div><div class="line" id="l4745">                        <span class="c">Guid[] arr = (Guid[])val;</span></div><div class="line" id="l4746">                        <span class="c">int len = arr.Length;</span></div><div class="line" id="l4747">                        <span class="c">buf.extend(offs + 4 + len * 16);</span></div><div class="line" id="l4748">                        <span class="c">Bytes.pack4(buf.arr, offs, len);</span></div><div class="line" id="l4749">                        <span class="c">offs += 4;</span></div><div class="line" id="l4750">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l4751">                        {
</div><div class="line" id="l4752">                            <span class="c">Bytes.packGuid(buf.arr, offs, arr[j]);</span></div><div class="line" id="l4753">                            <span class="c">offs += 16;</span></div><div class="line" id="l4754">                        }
</div><div class="line" id="l4755">                    }
</div><div class="line" id="l4756">                    <span class="c">break;</span></div><div class="line" id="l4757"><br></div><div class="line" id="l4758">                case ClassDescriptor.FieldType.tpArrayOfString: 
</div><div class="line" id="l4759">                    <span class="c">if (val == null)</span></div><div class="line" id="l4760">                    {
</div><div class="line" id="l4761">                        <span class="c">buf.extend(offs + 4);</span></div><div class="line" id="l4762">                        <span class="c">Bytes.pack4(buf.arr, offs, - 1);</span></div><div class="line" id="l4763">                        <span class="c">offs += 4;</span></div><div class="line" id="l4764">                    }
</div><div class="line" id="l4765">                    else
</div><div class="line" id="l4766">                    {
</div><div class="line" id="l4767">                        <span class="c">string[] arr = (string[])val;</span></div><div class="line" id="l4768">                        <span class="c">int len = arr.Length;</span></div><div class="line" id="l4769">                        <span class="c">buf.extend(offs + 4 + len * 4);</span></div><div class="line" id="l4770">                        <span class="c">Bytes.pack4(buf.arr, offs, len);</span></div><div class="line" id="l4771">                        <span class="c">offs += 4;</span></div><div class="line" id="l4772">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l4773">                        {
</div><div class="line" id="l4774">                            <span class="c">offs = buf.packString(offs, arr[j]);</span></div><div class="line" id="l4775">                        }
</div><div class="line" id="l4776">                    }
</div><div class="line" id="l4777">                    <span class="c">break;</span></div><div class="line" id="l4778"><br></div><div class="line" id="l4779">                case ClassDescriptor.FieldType.tpArrayOfObject: 
</div><div class="line" id="l4780">                    <span class="c">if (val == null)</span></div><div class="line" id="l4781">                    {
</div><div class="line" id="l4782">                        <span class="c">buf.extend(offs + 4);</span></div><div class="line" id="l4783">                        <span class="c">Bytes.pack4(buf.arr, offs, - 1);</span></div><div class="line" id="l4784">                        <span class="c">offs += 4;</span></div><div class="line" id="l4785">                    }
</div><div class="line" id="l4786">                    else
</div><div class="line" id="l4787">                    {
</div><div class="line" id="l4788">                        <span class="c">IPersistent[] arr = (IPersistent[])val;</span></div><div class="line" id="l4789">                        <span class="c">int len = arr.Length;</span></div><div class="line" id="l4790">                        <span class="c">buf.extend(offs + 4 + len * 4);</span></div><div class="line" id="l4791">                        <span class="c">Bytes.pack4(buf.arr, offs, len);</span></div><div class="line" id="l4792">                        <span class="c">offs += 4;</span></div><div class="line" id="l4793">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l4794">                        {
</div><div class="line" id="l4795">                            <span class="c">Bytes.pack4(buf.arr, offs, swizzle(arr[j]));</span></div><div class="line" id="l4796">                            <span class="c">offs += 4;</span></div><div class="line" id="l4797">                        }
</div><div class="line" id="l4798">                    }
</div><div class="line" id="l4799">                    <span class="c">break;</span></div><div class="line" id="l4800">#if SUPPORT_RAW_TYPE
</div><div class="line" id="l4801">                case ClassDescriptor.FieldType.tpArrayOfRaw: 
</div><div class="line" id="l4802">                    <span class="c">if (val == null)</span></div><div class="line" id="l4803">                    {
</div><div class="line" id="l4804">                        <span class="c">buf.extend(offs + 4);</span></div><div class="line" id="l4805">                        <span class="c">Bytes.pack4(buf.arr, offs, - 1);</span></div><div class="line" id="l4806">                        <span class="c">offs += 4;</span></div><div class="line" id="l4807">                    }
</div><div class="line" id="l4808">                    else
</div><div class="line" id="l4809">                    {
</div><div class="line" id="l4810">                        <span class="c">Array arr = (Array)val;</span></div><div class="line" id="l4811">                        <span class="c">int len = arr.Length;</span></div><div class="line" id="l4812">                        <span class="c">buf.extend(offs + 4);</span></div><div class="line" id="l4813">                        <span class="c">Bytes.pack4(buf.arr, offs, len);</span></div><div class="line" id="l4814">                        <span class="c">offs += 4;</span></div><div class="line" id="l4815">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l4816">                        {
</div><div class="line" id="l4817">                            <span class="c">offs = packRawValue(buf, offs, arr.GetValue(j));</span></div><div class="line" id="l4818">                        }
</div><div class="line" id="l4819">                    }
</div><div class="line" id="l4820">                    <span class="c">break;</span></div><div class="line" id="l4821">#endif
</div><div class="line" id="l4822">                case ClassDescriptor.FieldType.tpLink: 
</div><div class="line" id="l4823">                    <span class="c">if (val == null)</span></div><div class="line" id="l4824">                    {
</div><div class="line" id="l4825">                        <span class="c">buf.extend(offs + 4);</span></div><div class="line" id="l4826">                        <span class="c">Bytes.pack4(buf.arr, offs, - 1);</span></div><div class="line" id="l4827">                        <span class="c">offs += 4;</span></div><div class="line" id="l4828">                    }
</div><div class="line" id="l4829">                    else
</div><div class="line" id="l4830">                    {
</div><div class="line" id="l4831">                        <span class="c">GenericLink link = (GenericLink)val;</span></div><div class="line" id="l4832">                        <span class="c">link.SetOwner(po);</span></div><div class="line" id="l4833">                        <span class="c">int len = link.Size();</span></div><div class="line" id="l4834">                        <span class="c">buf.extend(offs + 4 + len * 4);</span></div><div class="line" id="l4835">                        <span class="c">Bytes.pack4(buf.arr, offs, len);</span></div><div class="line" id="l4836">                        <span class="c">offs += 4;</span></div><div class="line" id="l4837">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l4838">                        {
</div><div class="line" id="l4839">                            <span class="c">Bytes.pack4(buf.arr, offs, swizzle(link.GetRaw(j)));</span></div><div class="line" id="l4840">                            <span class="c">offs += 4;</span></div><div class="line" id="l4841">                        }
</div><div class="line" id="l4842">                        <span class="c">link.Unpin();</span></div><div class="line" id="l4843">                    }
</div><div class="line" id="l4844">                    <span class="c">break;</span></div><div class="line" id="l4845"><br></div><div class="line" id="l4846">                case ClassDescriptor.FieldType.tpArrayOfOid: 
</div><div class="line" id="l4847">                    <span class="c">if (val == null)</span></div><div class="line" id="l4848">                    {
</div><div class="line" id="l4849">                        <span class="c">buf.extend(offs + 4);</span></div><div class="line" id="l4850">                        <span class="c">Bytes.pack4(buf.arr, offs, - 1);</span></div><div class="line" id="l4851">                        <span class="c">offs += 4;</span></div><div class="line" id="l4852">                    }
</div><div class="line" id="l4853">                    else
</div><div class="line" id="l4854">                    {
</div><div class="line" id="l4855">                        <span class="c">GenericPArray arr = (GenericPArray)val;</span></div><div class="line" id="l4856">                        <span class="c">arr.SetOwner(po);</span></div><div class="line" id="l4857">                        <span class="c">int len = arr.Size();</span></div><div class="line" id="l4858">                        <span class="c">buf.extend(offs + 4 + len * 4);</span></div><div class="line" id="l4859">                        <span class="c">Bytes.pack4(buf.arr, offs, len);</span></div><div class="line" id="l4860">                        <span class="c">offs += 4;</span></div><div class="line" id="l4861">                        for (<span class="c">int j = 0;</span> <span class="c">j &lt; len</span>; <span class="c">j++</span>)</div><div class="line" id="l4862">                        {
</div><div class="line" id="l4863">                            <span class="c">Bytes.pack4(buf.arr, offs, arr.GetOid(j));</span></div><div class="line" id="l4864">                            <span class="c">offs += 4;</span></div><div class="line" id="l4865">                        }
</div><div class="line" id="l4866">                    }
</div><div class="line" id="l4867">                    break;
</div><div class="line" id="l4868">            }
</div><div class="line" id="l4869">            <span class="c">return offs;</span></div><div class="line" id="l4870">        }
</div><div class="line" id="l4871"><br></div><div class="line" id="l4872">        public ClassLoader Loader
</div><div class="line" id="l4873">        {
</div><div class="line" id="l4874">            set 
</div><div class="line" id="l4875">            { 
</div><div class="line" id="l4876">                loader = value;
</div><div class="line" id="l4877">            }
</div><div class="line" id="l4878"><br></div><div class="line" id="l4879">            get 
</div><div class="line" id="l4880">            { 
</div><div class="line" id="l4881">                <span class="c">return loader;</span></div><div class="line" id="l4882">            }
</div><div class="line" id="l4883">        }
</div><div class="line" id="l4884"><br></div><div class="line" id="l4885">        <span class="c">private int  initIndexSize        = dbDefaultInitIndexSize;</span></div><div class="line" id="l4886">        <span class="c">private int  objectCacheInitSize  = dbDefaultObjectCacheInitSize;</span></div><div class="line" id="l4887">        <span class="c">private long extensionQuantum     = dbDefaultExtensionQuantum;</span></div><div class="line" id="l4888">        private CacheType cacheKind = CacheType.Lru;
</div><div class="line" id="l4889">        private bool readOnly = false;
</div><div class="line" id="l4890">        private bool noFlush = false;
</div><div class="line" id="l4891">        private bool alternativeBtree = false;
</div><div class="line" id="l4892">        private bool backgroundGc = false;
</div><div class="line" id="l4893"><br></div><div class="line" id="l4894">        internal bool replicationAck = false;
</div><div class="line" id="l4895"><br></div><div class="line" id="l4896">        internal PagePool pool;
</div><div class="line" id="l4897">        internal Header   header; // base address of database file mapping
</div><div class="line" id="l4898">        internal int[]    dirtyPagesMap; // bitmap of changed pages in current index
</div><div class="line" id="l4899">        internal bool     modified;
</div><div class="line" id="l4900"><br></div><div class="line" id="l4901">        internal int currRBitmapPage; //current bitmap page for allocating records
</div><div class="line" id="l4902">        internal int currRBitmapOffs; //offset in current bitmap page for allocating 
</div><div class="line" id="l4903">        //unaligned records
</div><div class="line" id="l4904">        internal int currPBitmapPage; //current bitmap page for allocating page objects
</div><div class="line" id="l4905">        internal int currPBitmapOffs; //offset in current bitmap page for allocating 
</div><div class="line" id="l4906">        //page objects
</div><div class="line" id="l4907">        internal Location reservedChain;
</div><div class="line" id="l4908"><br></div><div class="line" id="l4909">        internal int committedIndexSize;
</div><div class="line" id="l4910">        internal int currIndexSize;
</div><div class="line" id="l4911"><br></div><div class="line" id="l4912">        <span class="c">internal bool enableCodeGeneration = true;</span></div><div class="line" id="l4913"><br></div><div class="line" id="l4914">#if COMPACT_NET_FRAMEWORK
</div><div class="line" id="l4915">        internal static ArrayList assemblies;
</div><div class="line" id="l4916">        CNetMonitor transactionMonitor;
</div><div class="line" id="l4917">#else
</div><div class="line" id="l4918">        internal Thread codeGenerationThread;        
</div><div class="line" id="l4919">        object    transactionMonitor;
</div><div class="line" id="l4920">        <span class="c">Hashtable wrapperHash = new Hashtable();</span></div><div class="line" id="l4921">#endif
</div><div class="line" id="l4922">        int       nNestedTransactions;
</div><div class="line" id="l4923">        int       nBlockedTransactions;
</div><div class="line" id="l4924">        int       nCommittedTransactions;
</div><div class="line" id="l4925">        long      scheduledCommitTime;
</div><div class="line" id="l4926">        PersistentResource transactionLock;
</div><div class="line" id="l4927"><br></div><div class="line" id="l4928">#if SUPPORT_RAW_TYPE
</div><div class="line" id="l4929">        internal System.Runtime.Serialization.Formatters.Binary.BinaryFormatter objectFormatter;
</div><div class="line" id="l4930">#endif	
</div><div class="line" id="l4931">        internal int currIndex; // copy of header.root, used to allow read access to the database 
</div><div class="line" id="l4932">        // during transaction commit
</div><div class="line" id="l4933">        internal long usedSize; // total size of allocated objects since the beginning of the session
</div><div class="line" id="l4934">        internal int[] bitmapPageAvailableSpace;
</div><div class="line" id="l4935">        internal bool opened;
</div><div class="line" id="l4936"><br></div><div class="line" id="l4937">        internal int[]     greyBitmap; // bitmap of visited during GC but not yet marked object
</div><div class="line" id="l4938">        internal int[]     blackBitmap;    // bitmap of objects marked during GC 
</div><div class="line" id="l4939">        internal long      gcThreshold;
</div><div class="line" id="l4940">        internal long      allocatedDelta;
</div><div class="line" id="l4941">        internal bool      gcDone;
</div><div class="line" id="l4942">        internal bool      gcActive;
</div><div class="line" id="l4943">        internal bool      gcGo;
</div><div class="line" id="l4944">        internal object    backgroundGcMonitor;
</div><div class="line" id="l4945">        internal object    backgroundGcStartMonitor;
</div><div class="line" id="l4946">        internal Thread    gcThread;
</div><div class="line" id="l4947">        internal Encoding  encoding;
</div><div class="line" id="l4948"><br></div><div class="line" id="l4949">        internal StorageListener  listener;
</div><div class="line" id="l4950"><br></div><div class="line" id="l4951">        private ClassLoader loader;
</div><div class="line" id="l4952"><br></div><div class="line" id="l4953">        internal Hashtable        resolvedTypes;
</div><div class="line" id="l4954"><br></div><div class="line" id="l4955">        internal OidHashTable     objectCache;
</div><div class="line" id="l4956">        internal Hashtable        classDescMap;
</div><div class="line" id="l4957">        internal ClassDescriptor  descList;
</div><div class="line" id="l4958"><br></div><div class="line" id="l4959">        <span class="c">internal static readonly LocalDataStoreSlot transactionContext = Thread.AllocateDataSlot();</span></div><div class="line" id="l4960">        internal bool useSerializableTransactions;
</div><div class="line" id="l4961">    }
</div><div class="line" id="l4962"><br></div><div class="line" id="l4963">    class RootPage
</div><div class="line" id="l4964">    {
</div><div class="line" id="l4965">        internal long size; // database file size
</div><div class="line" id="l4966">        internal long index; // offset to object index
</div><div class="line" id="l4967">        internal long shadowIndex; // offset to shadow index
</div><div class="line" id="l4968">        internal long usedSize; // size used by objects
</div><div class="line" id="l4969">        internal int indexSize; // size of object index
</div><div class="line" id="l4970">        internal int shadowIndexSize; // size of object index
</div><div class="line" id="l4971">        internal int indexUsed; // userd part of the index   
</div><div class="line" id="l4972">        internal int freeList; // L1 list of free descriptors
</div><div class="line" id="l4973">        internal int bitmapEnd; // index of last allocated bitmap page
</div><div class="line" id="l4974">        internal int rootObject; // OID of root object
</div><div class="line" id="l4975">        internal int classDescList; // List of class descriptors
</div><div class="line" id="l4976">        internal int bitmapExtent;     // Allocation bitmap offset and size
</div><div class="line" id="l4977"><br></div><div class="line" id="l4978">        internal const int Sizeof = 64;
</div><div class="line" id="l4979">    }
</div><div class="line" id="l4980"><br></div><div class="line" id="l4981">    class Header
</div><div class="line" id="l4982">    {
</div><div class="line" id="l4983">        internal int curr; // current root
</div><div class="line" id="l4984">        internal bool dirty; // database was not closed normally
</div><div class="line" id="l4985">        internal bool initialized; // database is initilaized
</div><div class="line" id="l4986"><br></div><div class="line" id="l4987">        internal RootPage[] root;
</div><div class="line" id="l4988"><br></div><div class="line" id="l4989">        <span class="c">internal static int Sizeof = 3 + RootPage.Sizeof * 2;</span></div><div class="line" id="l4990"><br></div><div class="line" id="l4991">        internal void  pack(byte[] rec)
</div><div class="line" id="l4992">        {
</div><div class="line" id="l4993">            <span class="c">int offs = 0;</span></div><div class="line" id="l4994">            <span class="c">rec[offs++] = (byte) curr;</span></div><div class="line" id="l4995">            <span class="c">rec[offs++] = (byte) (dirty?1:0);</span></div><div class="line" id="l4996">            <span class="c">rec[offs++] = (byte) (initialized?1:0);</span></div><div class="line" id="l4997">            for (<span class="c">int i = 0;</span> <span class="c">i &lt; 2</span>; <span class="c">i++</span>)</div><div class="line" id="l4998">            {
</div><div class="line" id="l4999">                <span class="c">Bytes.pack8(rec, offs, root[i].size);</span></div><div class="line" id="l5000">                <span class="c">offs += 8;</span></div><div class="line" id="l5001">                <span class="c">Bytes.pack8(rec, offs, root[i].index);</span></div><div class="line" id="l5002">                <span class="c">offs += 8;</span></div><div class="line" id="l5003">                <span class="c">Bytes.pack8(rec, offs, root[i].shadowIndex);</span></div><div class="line" id="l5004">                <span class="c">offs += 8;</span></div><div class="line" id="l5005">                <span class="c">Bytes.pack8(rec, offs, root[i].usedSize);</span></div><div class="line" id="l5006">                <span class="c">offs += 8;</span></div><div class="line" id="l5007">                <span class="c">Bytes.pack4(rec, offs, root[i].indexSize);</span></div><div class="line" id="l5008">                <span class="c">offs += 4;</span></div><div class="line" id="l5009">                <span class="c">Bytes.pack4(rec, offs, root[i].shadowIndexSize);</span></div><div class="line" id="l5010">                <span class="c">offs += 4;</span></div><div class="line" id="l5011">                <span class="c">Bytes.pack4(rec, offs, root[i].indexUsed);</span></div><div class="line" id="l5012">                <span class="c">offs += 4;</span></div><div class="line" id="l5013">                <span class="c">Bytes.pack4(rec, offs, root[i].freeList);</span></div><div class="line" id="l5014">                <span class="c">offs += 4;</span></div><div class="line" id="l5015">                <span class="c">Bytes.pack4(rec, offs, root[i].bitmapEnd);</span></div><div class="line" id="l5016">                <span class="c">offs += 4;</span></div><div class="line" id="l5017">                <span class="c">Bytes.pack4(rec, offs, root[i].rootObject);</span></div><div class="line" id="l5018">                <span class="c">offs += 4;</span></div><div class="line" id="l5019">                <span class="c">Bytes.pack4(rec, offs, root[i].classDescList);</span></div><div class="line" id="l5020">                <span class="c">offs += 4;</span></div><div class="line" id="l5021">                <span class="c">Bytes.pack4(rec, offs, root[i].bitmapExtent);</span></div><div class="line" id="l5022">                <span class="c">offs += 4;</span></div><div class="line" id="l5023">            }
</div><div class="line" id="l5024">        <span class="c">}</span></div><div class="line" id="l5025"><br></div><div class="line" id="l5026">        internal void  unpack(byte[] rec)
</div><div class="line" id="l5027">        {
</div><div class="line" id="l5028">            <span class="c">int offs = 0;</span></div><div class="line" id="l5029">            <span class="c">curr = rec[offs++];</span></div><div class="line" id="l5030">            <span class="c">dirty = rec[offs++] != 0;</span></div><div class="line" id="l5031">            <span class="c">initialized = rec[offs++] != 0;</span></div><div class="line" id="l5032">            <span class="c">root = new RootPage[2];</span></div><div class="line" id="l5033">            for (<span class="c">int i = 0;</span> <span class="c">i &lt; 2</span>; <span class="c">i++</span>)</div><div class="line" id="l5034">            {
</div><div class="line" id="l5035">                <span class="c">root[i] = new RootPage();</span></div><div class="line" id="l5036">                <span class="c">root[i].size = Bytes.unpack8(rec, offs);</span></div><div class="line" id="l5037">                <span class="c">offs += 8;</span></div><div class="line" id="l5038">                <span class="c">root[i].index = Bytes.unpack8(rec, offs);</span></div><div class="line" id="l5039">                <span class="c">offs += 8;</span></div><div class="line" id="l5040">                <span class="c">root[i].shadowIndex = Bytes.unpack8(rec, offs);</span></div><div class="line" id="l5041">                <span class="c">offs += 8;</span></div><div class="line" id="l5042">                <span class="c">root[i].usedSize = Bytes.unpack8(rec, offs);</span></div><div class="line" id="l5043">                <span class="c">offs += 8;</span></div><div class="line" id="l5044">                <span class="c">root[i].indexSize = Bytes.unpack4(rec, offs);</span></div><div class="line" id="l5045">                <span class="c">offs += 4;</span></div><div class="line" id="l5046">                <span class="c">root[i].shadowIndexSize = Bytes.unpack4(rec, offs);</span></div><div class="line" id="l5047">                <span class="c">offs += 4;</span></div><div class="line" id="l5048">                <span class="c">root[i].indexUsed = Bytes.unpack4(rec, offs);</span></div><div class="line" id="l5049">                <span class="c">offs += 4;</span></div><div class="line" id="l5050">                <span class="c">root[i].freeList = Bytes.unpack4(rec, offs);</span></div><div class="line" id="l5051">                <span class="c">offs += 4;</span></div><div class="line" id="l5052">                <span class="c">root[i].bitmapEnd = Bytes.unpack4(rec, offs);</span></div><div class="line" id="l5053">                <span class="c">offs += 4;</span></div><div class="line" id="l5054">                <span class="c">root[i].rootObject = Bytes.unpack4(rec, offs);</span></div><div class="line" id="l5055">                <span class="c">offs += 4;</span></div><div class="line" id="l5056">                <span class="c">root[i].classDescList = Bytes.unpack4(rec, offs);</span></div><div class="line" id="l5057">                <span class="c">offs += 4;</span></div><div class="line" id="l5058">                <span class="c">root[i].bitmapExtent = Bytes.unpack4(rec, offs);</span></div><div class="line" id="l5059">                <span class="c">offs += 4;</span></div><div class="line" id="l5060">            }
</div><div class="line" id="l5061">        <span class="c">}</span></div><div class="line" id="l5062">    }
</div><div class="line" id="l5063">}
</div>
  </pre>
  </td>
  </tr>
</tbody>
</table>
</body>
</html>