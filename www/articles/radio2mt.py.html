<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<!-- Created by htmlize-0.67 in css mode. -->
<html>
  <head>
    <title>radio2mt.py</title>
    <style type="text/css">
    <!--
      body {
        color: #000000;
        background-color: #ffffff;
      } /* default */
      .function-name {
        color: #0000ff;
        background-color: #ffffff;
      } /* font-lock-function-name-face */
      .string {
        color: #bc8f8f;
        background-color: #ffffff;
      } /* font-lock-string-face */
      .keyword {
        color: #a020f0;
        background-color: #ffffff;
      } /* font-lock-keyword-face */
      .comment {
        color: #b22222;
        background-color: #ffffff;
      } /* font-lock-comment-face */
      a {
        color: inherit;
        background-color: inherit;
        font: inherit;
        text-decoration: inherit;
      }
      a:hover {
        text-decoration: underline;
      }
    -->
    </style>
  </head>
  <body>
    <pre>
<span class="comment">#
# Convert Radio Userland post archives to Movable Type import format
#
# This code is in public domain.
# There is absolutely no warranty that it'll work.
#
# To call it:
# radio2mt.py &quot;c:\Program Files\Radio UserLand\backups\weblogArchive\posts&quot;
</span>
<span class="keyword">import</span> sys, re, mx.DateTime <span class="keyword">as</span> dt, htmlentitydefs, string, os

postArchivesDir = <span class="string">&quot;c:\\Program Files\\Radio UserLand\\backups\\weblogArchive\\posts\\&quot;</span>

<span class="comment"># those are MT per-post settings
</span>fAllowComments = 0
fConvertBreaks = 0
fAllowPings = 0
primaryCategory = <span class="string">&quot;&quot;</span>
author = <span class="string">&quot;kjk&quot;</span>
status = <span class="string">&quot;publish&quot;</span>

<span class="comment"># for a fresh blog it should be 1
</span>mtPostNum = 1
radioRoot = <span class="string">&quot;http://radio.weblogs.com/0109158&quot;</span>

<span class="comment"># how many posts to convert, set to -1 for infinity
</span>maxPostsToConvert = -1

<span class="comment"># should we generate &quot;TITLE&quot; part of MT log entry
</span>fDoTitle = 1

<span class="keyword">def</span> <span class="function-name">isLetter</span>( c ):
    <span class="keyword">if</span> -1 != string.find( string.letters, c ):
        <span class="keyword">return</span> 1
    <span class="keyword">return</span> 0

<span class="keyword">def</span> <span class="function-name">stripTags</span>( txt ):
    <span class="keyword">return</span> re.sub(<span class="string">'&lt;([^&gt;]*)&gt;'</span>, <span class="string">''</span>, txt)

<span class="keyword">def</span> <span class="function-name">extractTitleFromBody</span>(body):
    <span class="comment"># intelligently extract title from the body of a post
</span>    <span class="comment"># title is either the thing that was in a first pair
</span>    <span class="comment"># of &lt;b&gt;&lt;/b&gt; or first 5 words (up to a &quot;.&quot;)
</span>    maxWordsCount = 5
    getInBold = re.compile( <span class="string">'&lt;b&gt;(.*)&lt;/b&gt;'</span>, re.S|re.M|re.I )
    inBold = getInBold.search(body)

    <span class="keyword">if</span> inBold:
        <span class="comment"># we matched something
</span>        <span class="keyword">return</span> stripTags(inBold.groups()[0])

    getInBold2 = re.compile( <span class="string">'&lt;STRONG&gt;(.*)&lt;/STRONG&gt;'</span>, re.S|re.M|re.I )
    inBold = getInBold2.search(body)
    <span class="keyword">if</span> inBold:
        <span class="keyword">return</span> stripTags(inBold.groups()[0])

    <span class="comment"># remove all markup from the text
</span>    body = stripTags(body)
    
    <span class="comment"># get first maxWordsCount words up to a dot
</span>    strLen = len(body)
    word = 0
    currPos = 0
    <span class="keyword">while</span> currPos &lt; len:
        c = body[currPos]
        <span class="keyword">if</span> c == <span class="string">'.'</span>:
            <span class="comment"># we found dot, so we think this is an end of the sentence,
</span>            <span class="comment"># so the title is everything up to here
</span>            title = body[:currPos]
            <span class="keyword">return</span> stripTags(title)
        <span class="keyword">if</span> <span class="keyword">not</span> isLetter( c ):
            word += 1
            <span class="keyword">if</span> word == 5:
                title = body[:currPos] + <span class="string">&quot;...&quot;</span>
                <span class="keyword">return</span> stripTags(title)
        currPos += 1
    <span class="comment"># the whole body is shorter than 5 words, so return it all
</span>    <span class="keyword">return</span> stripTags(body)

<span class="keyword">def</span> <span class="function-name">genTxtWithFlag</span>( txt, flag ):
    <span class="keyword">if</span> flag:
        <span class="keyword">return</span> txt + <span class="string">&quot;1\n&quot;</span>
    <span class="keyword">else:</span>
        <span class="keyword">return</span> txt + <span class="string">&quot;0\n&quot;</span>

dayToPostNumMap = {}

<span class="keyword">def</span> <span class="function-name">getOneEntryFromFile</span>( fileName ):
    <span class="keyword">global</span> fAllowComments, fConvertBreaks, fAllowPings, primaryCategory
    <span class="keyword">global</span> author, status, fDoTitle
    <span class="keyword">global</span> mtPostNum, dayToPostNumMap, radioRoot
    mtPostNum += 1

    fNice = 1

    entry = open(fileName).read()
    getText = re.compile(<span class="string">'&lt;string name=&quot;text&quot; value=&quot;([^&quot;]*)&quot;'</span>, re.S|re.M)
    getDate = re.compile(<span class="string">'&lt;date name=&quot;when&quot; value=&quot;([^&quot;]*)'</span>, re.S|re.M)

    dateTime = dt.DateTimeFrom(getDate.search(entry).groups()[0])
    date = dateTime.Format(<span class="string">'%m/%d/%Y %H:%M:%S'</span>)

    body = getText.search(entry).groups()[0]

    <span class="comment"># now add a mapping of this date in format YYYY/MM/DD to mtPostNum
</span>    <span class="comment"># create the date string in a right format
</span>    txtDate = <span class="string">&quot;%04d/%02d/%02d&quot;</span> % (dateTime.year, dateTime.month, dateTime.day)
    <span class="comment">#print &quot;date: %s matches post no %d&quot; % (txtDate,mtPostNum)
</span>    dayToPostNumMap[ txtDate ] = mtPostNum

    body = re.sub(<span class="string">'&amp;apos;'</span>, <span class="string">&quot;'&quot;</span>, body)
    <span class="keyword">for</span> e <span class="keyword">in</span> htmlentitydefs.entitydefs:
	body = re.sub(<span class="string">'&amp;'</span>+e+<span class="string">';'</span>, htmlentitydefs.entitydefs[e], body)

    <span class="comment"># now replace $radioRoot/YYYY/MM/DD.html links
</span>    <span class="comment"># with appropriate mtPostNum (i.e. /archives/000($mtPostNum).html
</span>    getDate = re.compile( radioRoot + <span class="string">'/([\d/]+).html'</span> )
    dateMatch = re.search(getDate,body)
    <span class="keyword">if</span> dateMatch:
        dateTxt = dateMatch.groups()[0]
        newUrl = <span class="string">&quot;/archives/%06d.html&quot;</span> % dayToPostNumMap[ dateTxt ]
        <span class="comment"># print &quot;found date in an url: %s, new url: %s&quot; % (dateTxt,newUrl)
</span>        <span class="comment"># now replace url
</span>        body = re.sub( radioRoot + <span class="string">'/(.*).html[^&quot;]*'</span>,newUrl,body)

    <span class="comment"># remove enclosing &lt;p&gt;...&lt;/p&gt; from posts, so that they display nicely
</span>    <span class="comment">#getInPara = re.compile( '^&lt;P&gt;(.*)&lt;/P&gt;', re.S|re.M|re.I )
</span>    inPat = re.compile( <span class="string">'^&lt;P&gt;(.*)&lt;/P&gt;$'</span>, re.S|re.M|re.I )
    inPara = inPat.search(body)
    <span class="keyword">if</span> inPara:
        body = inPara.groups()[0]

    inPat = re.compile( <span class="string">'&lt;P&gt;(.*)&lt;/P&gt;$'</span>, re.S|re.M|re.I )
    inPara = inPat.search(body)
    <span class="keyword">if</span> inPara:
        body = inPara.groups()[0]

    <span class="comment">#body = re.sub('&amp;#013;&amp;#010;', '&lt;p/&gt;', body)
</span>
    result = <span class="string">&quot;&quot;</span>

    <span class="keyword">if</span> author != <span class="string">&quot;&quot;</span>:
        result += <span class="string">&quot;AUTHOR: &quot;</span> + author + <span class="string">&quot;\n&quot;</span>

    <span class="keyword">if</span> fDoTitle:
        title = extractTitleFromBody( body )
        result += <span class="string">&quot;TITLE: &quot;</span> + title + <span class="string">&quot;\n&quot;</span>

    result += genTxtWithFlag( <span class="string">&quot;ALLOW COMMENTS: &quot;</span>, fAllowComments );
    result += genTxtWithFlag( <span class="string">&quot;CONVERT BREAKS: &quot;</span>, fConvertBreaks );
    result += genTxtWithFlag( <span class="string">&quot;ALLOW PINGS: &quot;</span>, fAllowPings );
    
    result += <span class="string">&quot;PRIMARY CATEGORY:&quot;</span> + primaryCategory + <span class="string">&quot;\n&quot;</span>

    result += <span class="string">&quot;DATE:&quot;</span> + date + <span class="string">&quot;\n&quot;</span>
    result += <span class="string">&quot;-----\n&quot;</span>
    result += <span class="string">&quot;BODY:\n&quot;</span>
    result += body + <span class="string">&quot;\n&quot;</span>
    result += <span class="string">&quot;--------\n&quot;</span>
    <span class="keyword">return</span> result

archiveDir = postArchivesDir
<span class="keyword">if</span> len(sys.argv) &gt; 1:
    archiveDir = sys.argv[1]

files = os.listdir( postArchivesDir )
files.sort()
res = <span class="string">&quot;&quot;</span>
count = maxPostsToConvert
<span class="keyword">for</span> f <span class="keyword">in</span> files:
    fileName = archiveDir + f
    res += getOneEntryFromFile( fileName )
    count -= 1
    <span class="keyword">if</span> 0 == count:
        <span class="keyword">break</span>
<span class="keyword">print</span> res
</pre>
  </body>
</html>
