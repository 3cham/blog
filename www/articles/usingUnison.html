<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
	<title>Using Unison for remote backup</title>
	<link rel="stylesheet" href="/css/wp-style.css" type="text/css" />
	<link rel="stylesheet" href="/css/article.css" type="text/css" />
</head>

<body>

<!-- search box -->
<div style="position: absolute;	top: 10px; right: 0; margin-right: 20px;">
    <form method="get" id="searchForm" action="http://google.com/search">
        <div>
            <input type="hidden" name="IncludeBlogs" value="1" />
            <input id="search" name="q" class="txt" size="25" tabindex="1" />
            <input type="hidden" name="as_sitesearch" value="blog.kowalczyk.info" />
            <input type="submit" class="btn" value="&nbsp;Search&nbsp;" />
        </div>
    </form>
</div>
<!-- end of search box -->

<div id="header">
<h1>Weblog Without Honor or Humanity</h1>
<h2>by Krzysztof Kowalczyk</h2>
</div>
<div id="banner">
<ul id="tabnav">
  <li><a href="/" title="home">Home</a></li>
  <li><a href="/articles/" title="articles" class="current">Articles</a></li>
  <li><a href="/software/" title="software">Software</a></li>
  <li><a href="/contact.html" title="contact">Contact</a></li>
</ul>
</div>

<!-- created on 2004-05-28 -->
<div id="container">

<p><a href="/">Home</a> &raquo; <a href="/articles/">Articles</a> &raquo; <strong>Using Unison for remote backup</strong> <font color="#aaaaaa" size="-1">(2004-29-05)</font></p>
<div id="article">
<h1>Using Unison for remote backups</h1>
<h3>Introduction</h3>
<p><a href="http://www.cis.upenn.edu/~bcpierce/unison/">Unison</a> is a 
file synchronizer i.e. it can efficiently synchronize (or copy) files or 
directories between remote hosts (works locally too). You might have heard 
about <a href="http://samba.anu.edu.au/rsync/">rsync</a> which pioneered 
the algorithm used by unison for efficiently synchronizing content of 2 files. 
Without going into technical details, both rsync and unison try to 
send only the differences between the files. In many cases (especially 
for incremental backup) it saves a lot of network traffic and speeds up the 
operation. Unison offers 2 main advantages over rsync: </p>
<ul>
<li>works well on Windows. In order to run rsync on Windows you need 
to install <a href="http://www.cygwin.com/">cygwin</a> which is a pain in itself. Additionally, rsync sometimes
hangs during transfers. I experienced the hangs myself and other people reported it as well 
(although there are reports that the latest version of cygwin solves this problem). Unison has a native binary 
for Windows.</li>
<li>rsync only offers one-way synchronization (i.e. copy) while unison 
does two-way synchronization i.e. it propagates changes between directories 
both ways.</li>
</ul>

<h3>Using Unison for maintaining web sites.</h3>
Now that you know what unison does, what problems can it solve? This website is hosted 
on a Linux server I rent from a hosting company. I develop it on my 
local Windows machine. What I need is an <b>easy</b> and <b>efficient</b> 
way of deploying my changes. In this case deploying means copying all 
the files from my hard-drive to a location on my server.<p>I could just 
zip the directory and copy it using ftp or sftp (secure ftp protocol - 
like ftp except traffic is encrypted using ssh protocol). That easy but 
not <b>efficient</b>.</p>
<p>In the past I kept the files under version control system (cvs). I 
would make the changes locally, check them in into cvs repository and 
update the server copy. That is more efficient but I quickly discovered 
that overhead of managing cvs was very annoying. It wasn't <b>easy.</b></p>
<p>Unison is as simple to use as copying files and even more efficient 
that cvs. Let's see how we can achieve that.</p>
<p>Locally my files are stored in <code>c:\web\blog</code> folder and 
after I'm done with changes I want to copy them to <code>/var/www/blog</code> folder 
on my server. I could just use unison to sync between those folders but 
I'm a bit paranoid so I want to set this up in such a way that allows me 
to quickly restore previous version of the website on the off-chance 
that unison will mess something up. My deployment procedure is thus 
this:</p>
<ul>
<li>sync <code>/var/www/blog-working</code> with <code>c:\web\blog</code></li>
<li>copy <code>/var/www/blog-working</code> to <code>/var/www/blog-tmp</code></li>
<li>archive <code>/var/www/blog</code> as <code>/var/www/blog-$date.tgz</code></li>
<li>remove <code>/var/www/blog</code></li>
<li>move <code>/var/www/blog-tmp</code> to <code>/var/www/blog</code></li>
</ul>

<p>Of course I'm not going to do those steps manually - a simple script 
will make all that a one-step deployment. If something goes wrong with 
syncing, I can quickly restore last version from <code>blog-$date.tgz archive</code>
($date is current date/time to make the archive name unique).</p>

<p>First you need to install unison on both computers involved 
in synchronization. I use the latest stable (at this point) version 
2.9.1. On Windows I put unison.exe binary in a folder present in <code>%PATH%</code> 
variable (I use <code>c:\tools</code> for such 
programs) so that I can use it from command line. On Linux it also must 
be installed in appropriate location (<code>/usr/local/bin</code> in my case). 
Unison supports using secure ssh protocol for transfers but it requires 
using external ssh client and I couldn't make it work with any client I 
tried (putty and few Windows ports of ssh) so instead I use (less secure 
but working) socket mode. For that before starting the sync process, 
unison must be started on the destination server as <code>unison -socket 
port</code>. First synchronization must be done manually because unison 
asks a few questions. Create a destination folder (<code>/var/www/blog-working</code>) 
and run:</p>

<pre>unison c:\web\blog socket://server.com:port//var/www/blog-working</pre>

Unison should print a message that this is a first time a sync between 
those folders is being made, press Enter to acknowledge that.
Then it should show:

<pre>local server.com dir ----&gt; www [f]</pre>

The arrow shows the direction of change propagation (since the files are 
only present locally, they'll be propagated from local directory to the 
directory on the server). Unison waits for confirmation, the option in square brackets ([f]) is the default action 
and means "follow unison's recommendation&quot; so just press enter. Then 
unison asks: 

<pre>Proceed with propagating updates? []</pre>

There's no default action so press 'y', Enter and watch the files being 
copied. Now test that synchronization works. Make a small 
change locally (e.g. add/delete/modify a file) and execute:
<pre>unison -batch c:\web\blog socket://server.com:port//var/www/blog-working -force c:\web\blog</pre>

Option <code>-batch</code> means running in batch mode i.e. without 
prompting the user. This is important if we want to run the command from the 
script. Option <code>-force</code>  tells unison that we do only one-way 
syncing (as opposed to bi-directional syncing) and that we 
propagate changes from local folder <code>c:\web\blog</code> to <code>/var/www/blog-working</code> 
folder on the server (and not the other way around). 

<p>After syncing a working copy of blog files we need to safely copy 
them to the final destination. For that we 
need to have <code>plink.exe</code> (a part of 
<a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/">putty</a> - a free Windows 
telnet/ssh client) installed. The magic incantation is:

<pre>plink -pw password user@server.com cd /var/www; tar cjvf blog-`date +%y-%m-%d_%H-%M`.tar.bz2 blog; cp -R blog-working blog-tmp; rm -rf blog; mv blog-tmp blog</pre>

This will execute all the necessary commands to archive the directory to a compressed 
(<code>-j<code> option to <code>tar</code> causes compression with <code>bzip2</code>)
archive and replaces the live site with the working copy synchronized via unison.

<p><strong>Tip for Windows .bat files:</strong> '%' signs are escaped in .bat files so if
you want to have '%' in it (as required for the <code>date</code> formatting string)
you need to enter it as '%%'.</p>

<p>Put those two lines in a batch file e.g. <code>deploy_blog.bat</code>
and you have one-step, easy and efficient way to maintain a web site.
From time to time you should probably delete those backup <code>*tgz</code> 
files.
</p>

<h3>Using Unison for incremental backups.</h3>

<p>Unison can be just as well used for doing incremental backups. Let's 
assume a simple scenario: backing up existing <code>c:\backup</code> 
folder to <code>f:\backup</code> folder. As before, first create
destination <code>f:\backup</code> folder. For the first time execute
<code>unison c:\backup f:\backup</code>, and, as before, press:
Enter, 'y', Enter. After that periodically execute
<code>unison -batch c:\backup f:\backup -force c:\backup</code>. 
</p>

<h3>Links</h3>
<p>
<ul>
  <li><a href="http://www.cis.upenn.edu/~bcpierce/unison/">Unison</a> -
  software being described</li>
  <li><a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/">putty</a> -
  telnet/ssh client for Windows.Includes <code>plink.exe</code> needed
  if we want to fully automate some scenarios using unison.</li>
  <li><a href="http://samba.anu.edu.au/rsync/">rsync</a> - similar
  software but with less features and not working well on Windows</li>
  <li><a href="http://www.cygwin.com/">cygwin</a> - required to run rsync</li>
</ul>
</p>

</div>
<!-- end article -->
</div>
<!-- end container -->

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-194516-1");
pageTracker._initData();
pageTracker._trackPageview();
</script>


</body>
</html>
