Date: 2007-04-29 21:38:15
Format: wphtml
Title: A debugging story

or how a debugger sometimes works against you.<br /><br /><a href="http://blog.kowalczyk.info/software/sumatrapdf/">SumatraPDF</a> was crashing on some PDF files and I didn't know why. On Windows you can have just-in-time debugging i.e. tell the system to automatically launch a debugger (Visual Studio or <a href="http://www.microsoft.com/whdc/devtools/debugging/installx86.mspx">WinDBG</a>) when a program crashes but the clues I could get at the time of a crash (callstack and other current state of the program) were not enough to figure out the cause (especially given that it was in core PDF rendering code that I didn't write).<br /><br />Usually I would just set a breakpoint just before the place of the crash and work backwards from that. Unfortunately, when running under the debugger (either Visual Studio or WinDBG) the crash didn't happen. The only good thing about that was that it offered another clue: apparently something about the system changes when the app is executed from within the debugger and it hides the problem.<br /><br />That stumped me for a while until I made a breakthrough: I figured out that if I put DebugBreak() call in my app, it'll break into the debugger after the app has started so I'll be able to debug.<br /><br />With a few well-placed conditional breakpoints I was able to figure out that the cause of the problem was uninitialized reference count on an object.<br /><br />My theory is that when an app was executed from within a debugger, memory allocator was using different flags and always zeroing malloc()ed memory (which masked the refcount problem) while without the debugger it was random data which exposed bad refcounting logic.<br /><br />Lessons learned:<br /><ul><li>sometimes unexplained and very perplexing has an explanation</li><li>the debugger can work against you</li><li><a href="http://www.microsoft.com/whdc/devtools/debugging/installx86.mspx">WinDBG</a> is awesome - it puts to shame anything I've used on Unix, especially gdb. Learn how to use as it can come very handy when debugging hard problems. Visual Studio is also a good debugger - I use both depending on the kind of issue I'm debugging (for example WinDBG is faster to launch, has good support for conditional breakpoints and an array of useful extensions)</li><li>refcounting is evil and don't let anyone tell you otherwise. You'll meet people telling you that "refcounting makes programming easier". "Ha, ha, ha" should be your response. <br /></li></ul><br />